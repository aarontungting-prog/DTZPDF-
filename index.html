<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>霓虹西洋棋：DTZ 完美版</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/objects/Sky.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/BufferGeometryUtils.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js",
            "firebase/database": "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"
        }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; touch-action: none; color: white; }
        
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .hud { position: absolute; pointer-events: auto; }
        
        /* 捲軸美化 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #00e5ff; }

        /* 彈窗 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000; display: none;
            justify-content: center; align-items: center; pointer-events: auto;
            backdrop-filter: blur(10px);
        }
        .auth-box {
            background: rgba(20, 20, 30, 0.95); border: 1px solid #00e5ff;
            padding: 25px; border-radius: 15px; width: 300px; text-align: center;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.25); max-height: 90vh; overflow-y: auto;
        }
        .auth-box h2 { color: #00e5ff; margin-top: 0; margin-bottom: 10px; }
        
        .auth-input {
            width: 100%; padding: 10px; margin: 5px 0;
            background: #111; border: 1px solid #444; color: #fff;
            border-radius: 5px; box-sizing: border-box;
        }
        
        /* 按鈕樣式 */
        .btn-base {
            width: 100%; padding: 10px; margin-top: 5px;
            border: none; font-weight: bold; cursor: pointer; 
            border-radius: 5px; transition: 0.2s; font-size: 14px;
        }
        .auth-btn { background: #00e5ff; color: #000; }
        .guest-btn { background: transparent; color: #aaa; border: 1px solid #444; }
        .game-btn { background: #00e5ff; color: #000; }
        .join-btn { background: #ff0055; color: #fff; }
        .ai-btn { background: #9d00ff; color: #fff; } 
        .logout-btn { background: #333; color: #aaa; border: 1px solid #444; font-size: 12px; }

        /* 左側分離式介面 */
        #left-container {
            position: absolute; top: 20px; left: 20px; width: 240px;
            display: flex; flex-direction: column; gap: 12px; pointer-events: none;
        }
        .hud-box {
            background: rgba(0,0,0,0.85); border: 1px solid #333; 
            border-radius: 10px; padding: 12px; pointer-events: auto;
            backdrop-filter: blur(5px); transition: 0.3s;
        }
        .hud-title { color: #aaa; font-size: 11px; font-weight: bold; margin-bottom: 8px; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 4px; }

        /* 頭像與框 */
        .avatar-container {
            width: 70px; height: 70px; margin: 5px auto 10px auto;
            border-radius: 50%; position: relative; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .avatar-img { width: 100%; height: 100%; border-radius: 50%; background: #333; object-fit: cover; }
        .avatar-hint { position: absolute; bottom: -15px; width: 100%; text-align: center; font-size: 10px; color: #00e5ff; opacity: 0.7; }

        /* 框特效 */
        .frame-basic-1 { border: 3px solid #555; }
        .frame-basic-2 { border: 3px solid #888; }
        .frame-basic-3 { border: 3px solid #fff; }
        .frame-basic-4 { border: 3px dashed #00e5ff; }
        .frame-basic-5 { border: 3px double #ff0055; }
        .frame-bronze { border: 4px solid #cd7f32; box-shadow: 0 0 10px #cd7f32; }
        .frame-silver { border: 4px solid #c0c0c0; box-shadow: 0 0 15px #c0c0c0; }
        .frame-gold { border: 4px solid #ffd700; box-shadow: 0 0 20px #ffd700; }
        .frame-diamond { border: 4px solid #b9f2ff; box-shadow: 0 0 20px #b9f2ff; animation: pulse-b 2s infinite; }
        .frame-master { border: 4px solid #ff0055; box-shadow: 0 0 25px #ff0055; animation: pulse-r 1.5s infinite; }
        @keyframes pulse-b { 50% { box-shadow: 0 0 35px #00e5ff; } }
        @keyframes pulse-r { 50% { box-shadow: 0 0 40px #ff0000; } }

        /* 設定網格 */
        .frames-grid, .skin-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 10px 0; }
        .option-item { 
            width: 100%; aspect-ratio: 1; border-radius: 8px; cursor: pointer; position: relative; 
            background: #222; display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: 1px solid #444;
        }
        .option-item.locked { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
        .option-item.selected { border: 2px solid #00e5ff; box-shadow: 0 0 8px #00e5ff; }

        /* AI 氣泡 (正上方防擋) */
        #ai-chat-bubble {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            width: 80%; max-width: 400px;
            background: rgba(0, 0, 0, 0.9); border: 1px solid #9d00ff;
            border-radius: 20px; padding: 12px 20px; color: #fff; font-size: 14px; text-align: center;
            display: none; box-shadow: 0 0 20px rgba(157, 0, 255, 0.5); z-index: 2000;
            pointer-events: none;
        }
        .ai-name { color: #9d00ff; font-weight: bold; margin-bottom: 4px; display: block; font-size: 12px; }

        /* 狀態列 */
        #status-panel { 
            top: 20px; right: 20px; text-align: right; 
            background: linear-gradient(to left, rgba(0, 255, 255, 0.1), rgba(0,0,0,0)); 
            padding: 15px; border-right: 3px solid #00e5ff; 
        }
        h1 { margin: 0; font-size: 1.2rem; color: #00e5ff; margin-bottom: 5px; }
        #turn-txt { font-size: 1.5rem; font-weight: 900; }

        /* 教學按鈕 */
        #tutorial-btn {
            position: absolute; bottom: 30px; right: 30px; width: 40px; height: 40px;
            border-radius: 50%; background: rgba(0,0,0,0.8); border: 2px solid #ffaa00;
            color: #ffaa00; font-weight: bold; font-size: 20px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 2500; pointer-events: auto;
        }
        #tutorial-content {
            position: absolute; bottom: 85px; right: 30px; width: 280px;
            background: rgba(0,0,0,0.95); border: 1px solid #ffaa00; border-radius: 10px;
            padding: 15px; display: none; z-index: 2500; max-height: 60vh; overflow-y: auto; pointer-events: auto;
        }

        #loading { position: absolute; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; color: #ffaa00; font-size: 18px; z-index: 4000; }
        #footer-watermark { position: absolute; bottom: 10px; width: 100%; text-align: center; color: rgba(255,255,255,0.3); font-size: 12px; pointer-events: none; }

        @media (max-width: 600px) {
            #status-panel { top: auto; bottom: 20px; right: 20px; left: 20px; text-align: center; border-right: none; border-top: 3px solid #00e5ff; background: rgba(0,0,0,0.8); }
            #left-container { top: 10px; left: 10px; width: calc(100% - 20px); }
            #tutorial-btn { bottom: 100px; right: 20px; }
            #tutorial-content { bottom: 150px; right: 20px; left: 20px; width: auto; }
            #ai-chat-bubble { top: 100px; width: 90%; }
        }
    </style>
</head>
<body>

<div id="loading">正在連線伺服器...</div>

<div id="auth-modal" class="modal-overlay" style="display: flex;">
    <div class="auth-box">
        <h2>DTZ CHESS</h2>
        <div id="auth-error" style="color:#ff0055; font-size:12px; margin-bottom:10px;"></div>
        <input type="email" id="email" class="auth-input" placeholder="Email (例如 user@gmail.com)">
        <input type="password" id="password" class="auth-input" placeholder="密碼">
        <div id="nickname-container" style="display:none; animation: slideDown 0.3s;">
            <input type="text" id="nickname" class="auth-input" placeholder="初次見面，請輸入暱稱" style="border-color:#00ff00;">
        </div>
        <button id="auth-action-btn" class="btn-base auth-btn">登入 / 註冊</button>
        <div id="forgot-pw" style="margin-top:10px; font-size:12px; color:#aaa; cursor:pointer; text-decoration:underline;">忘記密碼？</div>
        <button id="guest-btn" class="btn-base guest-btn">訪客試玩</button>
    </div>
</div>

<div id="ai-modal" class="modal-overlay">
    <div class="auth-box">
        <h2>選擇 AI 對手</h2>
        <div id="ai-list-container" style="display:flex; flex-direction:column; gap:8px;"></div>
        <button onclick="document.getElementById('ai-modal').style.display='none'" class="btn-base guest-btn">取消</button>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="auth-box" style="width: 320px;">
        <h2>個人設定</h2>
        
        <div style="margin-bottom:15px; text-align:left;">
            <label style="color:#aaa; font-size:12px;">修改暱稱:</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="setting-name" class="auth-input" style="margin:0;">
                <button onclick="saveName()" class="btn-base auth-btn" style="width:60px; margin:0;">儲存</button>
            </div>
        </div>

        <input type="file" id="file-input" accept="image/*" style="display:none;">

        <div style="text-align:left; margin-bottom:10px;">
            <label style="color:#aaa; font-size:12px;">頭像框 (排位解鎖):</label>
            <div class="frames-grid" id="frames-grid"></div>
        </div>

        <div style="text-align:left;">
            <label style="color:#aaa; font-size:12px;">棋子造型 (排位解鎖):</label>
            <div class="skin-grid" id="skins-grid"></div>
        </div>
        
        <button onclick="document.getElementById('settings-modal').style.display='none'" class="btn-base guest-btn" style="margin-top:15px;">關閉</button>
    </div>
</div>

<div id="ui" style="display:none;">
    
    <div id="left-container">
        
        <div class="hud-box">
            <button onclick="openSettings()" style="position:absolute; top:10px; right:10px; background:none; border:none; color:#aaa; cursor:pointer;">⚙️</button>
            <div class="avatar-container" onclick="document.getElementById('file-input').click()">
                <div id="user-frame" class="frame-basic-1" style="width:100%; height:100%; border-radius:50%; position:absolute; pointer-events:none;"></div>
                <img src="" class="avatar-img" id="user-avatar-img">
                <div class="avatar-hint">點擊換圖</div>
            </div>
            <div style="text-align:center;">
                <div id="user-name" style="font-weight:bold;">Player</div>
                <div style="font-size:12px; color:#aaa; margin-top:2px;">
                    <span id="user-rank" style="color:#cd7f32;">銅牌</span> | ELO: <span id="user-elo">0</span>
                </div>
            </div>
            <button id="btn-logout" class="btn-base logout-btn">登出</button>
        </div>

        <div class="hud-box">
            <div class="hud-title">連線對戰 (PVP)</div>
            <div id="room-display" style="font-size:11px; color:#0f0; margin-bottom:5px;">狀態: 閒置</div>
            <div style="display:flex; gap:5px;">
                <button id="btn-create" class="btn-base game-btn" style="margin:0;">創建</button>
                <button id="btn-join" class="btn-base join-btn" style="margin:0;">加入</button>
            </div>
        </div>

        <div class="hud-box">
            <div class="hud-title">單人挑戰 (PVE)</div>
            <button id="btn-ai" class="btn-base ai-btn" style="margin:0;">挑戰 AI 對手</button>
        </div>

    </div>

    <div id="ai-chat-bubble">
        <span class="ai-name" id="ai-name-label">GEMINI</span>
        <span id="ai-message">...</span>
    </div>

    <div id="status-panel" class="hud">
        <h1>NEON CHESS</h1>
        <div id="turn-txt">等待對戰</div>
        <div id="opponent-info" style="font-size:12px; color:#aaa;">對手: ---</div>
    </div>

    <div id="tutorial-btn">?</div>
    <div id="tutorial-content">
        <h3 style="color:#ffaa00; margin-top:0;">排位與獎勵</h3>
        <table class="rank-table" style="width:100%; color:#ccc; font-size:12px; text-align:left;">
            <tr><th>排位</th><th>積分</th><th>解鎖</th></tr>
            <tr><td>新手</td><td>0</td><td>基礎</td></tr>
            <tr><td style="color:#cd7f32">銅牌</td><td>500</td><td>銅框/棋</td></tr>
            <tr><td style="color:#c0c0c0">銀牌</td><td>1000</td><td>銀框/棋</td></tr>
            <tr><td style="color:#ffd700">金牌</td><td>1500</td><td>金框/棋</td></tr>
            <tr><td style="color:#00e5ff">鑽石</td><td>2000</td><td>鑽石棋</td></tr>
            <tr><td style="color:#ff0055">宗師</td><td>2500</td><td>宇宙棋</td></tr>
        </table>
    </div>

    <div id="footer-watermark">Made by DTZ with Gemini Pro</div>
</div>

<script type="module">
    import { initializeApp } from "firebase/app";
    import { getDatabase, ref, set, get, update, onValue } from "firebase/database";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut, sendPasswordResetEmail } from "firebase/auth";

    // --- Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyCxPppnUG864v3E2j1OzykzFmhLpsEJCSE",
        authDomain: "chess-1885a.firebaseapp.com",
        databaseURL: "https://chess-1885a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "chess-1885a",
        storageBucket: "chess-1885a.firebasestorage.app",
        messagingSenderId: "824383572856",
        appId: "1:824383572856:web:7c663d6bf0f970f6acd68d",
        measurementId: "G-0EMJ4W2KLS"
    };
    const GEMINI_API_KEY = "AIzaSyBEueRZXZUidaSKfyl8dKoCJF4ha1Y1TcY";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- State ---
    let currentUser=null, userElo=0, userSkin='skin_classic', gameId=null, playerColor='w', isOnline=false, isVsAI=false, isRegistering=false, currentAiPersona=null;
    let scene, camera, renderer, controls, raycaster, mouse={x:0,y:0}, clock, game=new Chess();
    let tilesMap={}, piecesMap={}, selectedSquare=null, isProcessing=false, grassMat, cloudParticles=[];
    const BOARD_HEIGHT=15;

    // --- Data Definitions ---
    const AI_PERSONAS = [
        { name:'波波 (Bob)', rank:'新手', elo:400, color:'#aaa', desc:'經常送頭', prompt:'You are Bob, novice player. Make mistakes. Speak cute.' },
        { name:'愛麗絲 (Alice)', rank:'銅牌', elo:800, color:'#cd7f32', desc:'性格溫和', prompt:'You are Alice, beginner. Polite and encouraging.' },
        { name:'毒蛇 (Viper)', rank:'銀牌', elo:1200, color:'#c0c0c0', desc:'喜歡嘲諷', prompt:'You are Viper, toxic player. Trash talk aggressively.' },
        { name:'策士 (Strategos)', rank:'金牌', elo:1600, color:'#ffd700', desc:'冷靜分析', prompt:'You are Strategos. Speak logically. No emotion.' },
        { name:'諾娃 (Nova)', rank:'鑽石', elo:2000, color:'#00e5ff', desc:'天才少女', prompt:'You are Nova, flashy genius. Confident and playful.' },
        { name:'奧米加 (Omega)', rank:'宗師', elo:2800, color:'#ff0055', desc:'神諭', prompt:'You are Omega, god-like AI. Speak in cryptic riddles.' }
    ];
    const FRAMES = [
        {id:'frame-basic-1', req:0}, {id:'frame-basic-2', req:0}, {id:'frame-basic-3', req:0},
        {id:'frame-bronze', req:500}, {id:'frame-silver', req:1000}, {id:'frame-gold', req:1500},
        {id:'frame-diamond', req:2000}, {id:'frame-master', req:2500}
    ];
    const SKINS = [
        {id:'skin_classic', name:'經典霓虹', req:0}, {id:'skin_bronze', name:'青銅時代', req:500},
        {id:'skin_silver', name:'白銀科技', req:1000}, {id:'skin_gold', name:'黃金奢華', req:1500},
        {id:'skin_crystal', name:'水晶稜鏡', req:2000}, {id:'skin_cosmic', name:'宇宙核心', req:2500}
    ];

    // --- UI Logic ---
    document.getElementById('tutorial-btn').onclick = (e) => {
        e.stopPropagation();
        const el = document.getElementById('tutorial-content');
        el.style.display = el.style.display==='none'?'block':'none';
    };

    window.openSettings = function() {
        document.getElementById('settings-modal').style.display='flex';
        document.getElementById('setting-name').value = document.getElementById('user-name').innerText;
        
        const fGrid = document.getElementById('frames-grid'); fGrid.innerHTML='';
        const currFrame = document.getElementById('user-frame').className;
        FRAMES.forEach(f => {
            const d = document.createElement('div'); d.className = `option-item ${f.id}`;
            if(userElo < f.req) d.classList.add('locked');
            else { d.onclick=()=>setFrame(f.id); if(f.id===currFrame) d.classList.add('selected'); }
            fGrid.appendChild(d);
        });

        const sGrid = document.getElementById('skins-grid'); sGrid.innerHTML='';
        SKINS.forEach(s => {
            const d = document.createElement('div'); d.className = 'option-item';
            d.innerHTML = `<div style="font-size:20px;">♟️</div><div style="font-size:10px;margin-top:2px;">${s.name}</div>`;
            if(userElo < s.req) d.classList.add('locked');
            else { d.onclick=()=>setSkin(s.id); if(s.id===userSkin) d.classList.add('selected'); }
            sGrid.appendChild(d);
        });
    };

    function setFrame(id) { update(ref(db,'users/'+currentUser.uid), {selectedFrame:id}); document.getElementById('settings-modal').style.display='none'; }
    function setSkin(id) { 
        update(ref(db,'users/'+currentUser.uid), {selectedSkin:id}); 
        userSkin=id; 
        if(!isOnline) syncPieces(); 
        document.getElementById('settings-modal').style.display='none'; 
    }
    window.saveName = function() {
        const n = document.getElementById('setting-name').value.trim();
        if(n) update(ref(db,'users/'+currentUser.uid), {name:n});
    };

    // 檔案上傳
    document.getElementById('file-input').onchange = function(e) {
        const f = e.target.files[0];
        if(!f) return;
        if(f.size > 1024*1024) return alert("圖片需小於 1MB");
        const r = new FileReader();
        r.onload = (ev) => update(ref(db,'users/'+currentUser.uid), {avatarUrl:ev.target.result});
        r.readAsDataURL(f);
    };

    // --- Auth Logic ---
    onAuthStateChanged(auth, (user) => {
        document.getElementById('loading').style.display='none';
        if(user) {
            currentUser = user;
            document.getElementById('auth-modal').style.display='none';
            document.getElementById('ui').style.display='block';
            checkUser(user);
        } else {
            currentUser = null;
            document.getElementById('auth-modal').style.display='flex';
            document.getElementById('ui').style.display='none';
            resetAuth();
        }
    });

    function resetAuth() { isRegistering=false; document.getElementById('nickname-container').style.display='none'; document.getElementById('auth-action-btn').innerText="登入 / 註冊"; document.getElementById('auth-error').innerText=""; }
    function checkUser(u) {
        const r = ref(db,'users/'+u.uid);
        get(r).then(s => {
            if(!s.exists()) {
                const nick = document.getElementById('nickname').value.trim() || (u.isAnonymous?`Guest_${u.uid.substr(0,4)}`:u.email.split('@')[0]);
                set(r, {name:nick, email:u.email||"guest", elo:0, selectedFrame:'frame-basic-1', selectedSkin:'skin_classic'}).then(loadUser);
            } else loadUser();
        });
    }
    function loadUser() {
        onValue(ref(db,'users/'+currentUser.uid), (s) => {
            const d = s.val(); if(!d) return;
            userElo = d.elo; userSkin = d.selectedSkin || 'skin_classic';
            document.getElementById('user-name').innerText = d.name;
            document.getElementById('user-elo').innerText = d.elo;
            document.getElementById('user-rank').innerText = getRankName(d.elo);
            document.getElementById('user-frame').className = d.selectedFrame || 'frame-basic-1';
            document.getElementById('user-avatar-img').src = d.avatarUrl || `https://api.dicebear.com/7.x/bottts/svg?seed=${d.name}`;
            if(!isOnline) syncPieces();
        });
    }
    function getRankName(elo) {
        if(elo<500)return "新手"; if(elo<1000)return "銅牌"; if(elo<1500)return "銀牌";
        if(elo<2000)return "金牌"; if(elo<2500)return "鑽石"; return "宗師";
    }

    document.getElementById('auth-action-btn').onclick = async () => {
        const e = document.getElementById('email').value.trim(), p = document.getElementById('password').value.trim();
        if(!e || !p) return document.getElementById('auth-error').innerText = "請輸入帳密";
        if(isRegistering) {
            if(!document.getElementById('nickname').value.trim()) return;
            try { await createUserWithEmailAndPassword(auth, e, p); } catch(err) { document.getElementById('auth-error').innerText = err.message; }
            return;
        }
        try { await signInWithEmailAndPassword(auth, e, p); } catch(err) {
            if(err.code.includes('user-not-found') || err.code.includes('invalid-credential')) {
                isRegistering=true; document.getElementById('nickname-container').style.display='block';
                document.getElementById('auth-action-btn').innerText="確認註冊"; document.getElementById('auth-error').innerText="初次見面，請輸入暱稱";
            } else document.getElementById('auth-error').innerText = err.message;
        }
    };
    document.getElementById('guest-btn').onclick = async () => { try{await signInAnonymously(auth);}catch(e){} };
    document.getElementById('btn-logout').onclick = () => signOut(auth);

    // --- PVP Logic ---
    document.getElementById('btn-create').onclick = () => {
        isVsAI=false; gameId = Math.floor(1000+Math.random()*9000).toString();
        get(ref(db,'users/'+currentUser.uid)).then(s=>{
            const u=s.val();
            set(ref(db,'games/'+gameId), {
                fen:game.fen(), turn:'w', status:'waiting',
                white:{uid:currentUser.uid, name:u.name, elo:u.elo, skin:u.selectedSkin||'skin_classic'}
            }).then(()=>{
                playerColor='w'; isOnline=true;
                document.getElementById('room-display').innerText = `房號: ${gameId} (等待)`;
                moveCam(0,60,100); listenGame(); alert(`房號: ${gameId}`);
            });
        });
    };
    document.getElementById('btn-join').onclick = () => {
        const id = prompt("輸入房號"); if(!id) return;
        gameId = id; isVsAI=false;
        get(ref(db,'games/'+id)).then(s=>{
            if(!s.exists() || s.val().status!=='waiting') return alert("無法加入");
            get(ref(db,'users/'+currentUser.uid)).then(us=>{
                const u=us.val();
                update(ref(db,'games/'+id), {
                    status:'playing', black:{uid:currentUser.uid, name:u.name, elo:u.elo, skin:u.selectedSkin||'skin_classic'}
                });
                playerColor='b'; isOnline=true;
                document.getElementById('room-display').innerText = `房號: ${id} (對戰)`;
                moveCam(0,60,-100); listenGame();
            });
        });
    };

    function listenGame() {
        onValue(ref(db,'games/'+gameId), (s) => {
            const d = s.val(); if(!d) return;
            if(d.status==='playing' && !d.winner && document.getElementById('turn-txt').innerText.includes("等待")) {
                const opp = playerColor==='w'?d.black:d.white;
                if(opp) { document.getElementById('opponent-info').innerText = `VS: ${opp.name}`; syncPieces(d); }
            }
            if(d.fen !== game.fen()) { game.load(d.fen); syncPieces(d); updateHUD(); }
            if(d.winner) { isProcessing=true; alert(d.winner===playerColor?"勝利！":"戰敗..."); }
        });
    }

    function sendMove(m) {
        if(!isOnline) return;
        let up = {fen:game.fen(), turn:game.turn(), lastMove:m};
        if(game.in_checkmate()) { up.winner = game.turn()==='w'?'b':'w'; up.status='finished'; calcElo(up.winner); }
        update(ref(db,'games/'+gameId), up);
    }

    function calcElo(win) {
        get(ref(db,'games/'+gameId)).then(s=>{
            const d=s.val(); if(d.calculated) return;
            if(playerColor==='w') {
                const K=32, wE=d.white.elo, bE=d.black.elo;
                const eW=1/(1+Math.pow(10,(bE-wE)/400)), eB=1/(1+Math.pow(10,(wE-bE)/400));
                update(ref(db,'users/'+d.white.uid), {elo:Math.round(wE+K*((win==='w'?1:0)-eW))});
                update(ref(db,'users/'+d.black.uid), {elo:Math.round(bE+K*((win==='b'?1:0)-eB))});
                update(ref(db,'games/'+gameId), {calculated:true});
            }
        });
    }

    // --- AI Logic ---
    document.getElementById('btn-ai').onclick = () => {
        const list = document.getElementById('ai-list-container'); list.innerHTML='';
        AI_PERSONAS.forEach((ai,i) => {
            const d=document.createElement('div'); d.className='ai-card';
            d.innerHTML=`<div><span style="color:${ai.color};font-weight:bold;">${ai.name}</span><span style="display:block;font-size:10px;color:#888;">${ai.desc}</span></div><span style="font-size:12px;color:${ai.color};">${ai.rank}</span>`;
            d.onclick=()=>startAI(i); list.appendChild(d);
        });
        document.getElementById('ai-modal').style.display='flex';
    };

    function startAI(idx) {
        document.getElementById('ai-modal').style.display='none';
        currentAiPersona = AI_PERSONAS[idx];
        isVsAI=true; isOnline=false; gameId="vs-ai"; playerColor='w';
        game.reset(); syncPieces(); moveCam(0,60,100);
        document.getElementById('opponent-info').innerText = `VS: ${currentAiPersona.name}`;
        updateHUD(); aiSpeak("我是 "+currentAiPersona.name+"，準備好了嗎？");
    }

    function aiSpeak(msg) {
        const b = document.getElementById('ai-chat-bubble');
        document.getElementById('ai-message').innerText = msg;
        document.getElementById('ai-name-label').innerText = currentAiPersona.name.split(' ')[0];
        document.getElementById('ai-name-label').style.color = currentAiPersona.color;
        b.style.display='block'; setTimeout(()=>b.style.display='none', 5000);
    }

    async function makeAiMove() {
        if(game.game_over()) return;
        isProcessing=true; document.getElementById('turn-txt').innerText="思考中...";
        const fen=game.fen(), moves=game.moves({verbose:true}).map(m=>m.san).join(',');
        const prompt=`${currentAiPersona.prompt} Black. FEN:"${fen}". Valid:[${moves}]. Pick best move. Output: MOVE|MESSAGE. Ex:"e5|Good." SAN only. Msg max 10 words.`;
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
            });
            const d = await responseSafe(r);
            let txt = d.candidates[0].content.parts[0].text.trim().split('|');
            let move = txt[0].replace(/[\n\r."]/g,'').trim(), msg = txt[1]||"";
            if(msg) aiSpeak(msg);
            if(!game.move(move)) makeRandomAI(); else animateMove(game.history({verbose:true}).pop());
        } catch(e) { console.error(e); aiSpeak("(AI 離線)"); makeRandomAI(); }
    }
    async function responseSafe(r) { if(!r.ok) throw new Error('API Fail'); return await r.json(); }

    // --- 3D & Game Core ---
    function init() {
        clock=new THREE.Clock(); scene=new THREE.Scene(); scene.background=new THREE.Color(0x220000); scene.fog=new THREE.FogExp2(0x990044,0.0005);
        camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,0.1,6000); camera.position.set(0,60,100);
        renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(window.innerWidth,window.innerHeight); renderer.shadowMap.enabled=true;
        renderer.toneMapping=THREE.ACESFilmicToneMapping; document.body.appendChild(renderer.domElement);
        controls=new THREE.OrbitControls(camera,renderer.domElement); controls.enableDamping=true; controls.target.set(0,15,0);
        
        // Environment
        const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
        const sun = new THREE.DirectionalLight(0xffaa00, 2); sun.position.set(-100,100,-100); sun.castShadow=true; scene.add(sun);
        const sky = new THREE.Sky(); sky.scale.setScalar(450000); scene.add(sky); sky.material.uniforms.sunPosition.value.copy(sun.position);
        
        createBoard();
        window.addEventListener('resize', onResize);
        window.addEventListener('touchstart', onTouch, {passive:false});
        window.addEventListener('click', onClick);
        animate();
    }

    function createBoard() {
        const boardBox = new THREE.Mesh(new THREE.BoxGeometry(9,0.5,9), new THREE.MeshStandardMaterial({color:0x111111, roughness:0.5}));
        boardBox.position.y = 14.75; boardBox.receiveShadow=true; scene.add(boardBox);
        for(let r=0;r<8;r++) for(let c=0;c<8;c++) {
            const isW = (r+c)%2!==0;
            const tile = new THREE.Mesh(new THREE.BoxGeometry(1,0.2,1), new THREE.MeshStandardMaterial({color:isW?0xeeeeee:0x222222}));
            tile.position.set(c-3.5, 15, 3.5-r); tile.userData={sq:String.fromCharCode(97+c)+(r+1)};
            scene.add(tile); tilesMap[tile.userData.sq] = tile;
        }
        syncPieces();
    }

    function createPiece(type, color, skin) {
        const grp = new THREE.Group();
        let col = color==='w'?0xeeeeee:0x222222, emi = color==='w'?0x00e5ff:0xff0055;
        // Simple Skin Logic
        if(skin==='skin_gold') { col=0xffd700; emi=0xffaa00; }
        if(skin==='skin_silver') { col=0xcccccc; emi=0xffffff; }
        if(skin==='skin_bronze') { col=0xcd7f32; emi=0xff4400; }
        if(skin==='skin_crystal') { col=color==='w'?0xaaddff:0xaa00ff; emi=col; }
        if(skin==='skin_cosmic') { col=0x000000; emi=color==='w'?0x00ffff:0xff00ff; }

        const mat = new THREE.MeshStandardMaterial({color:col, roughness:0.3, metalness:0.8, emissive:emi, emissiveIntensity:0.4});
        
        // Simplified Geometry based on type
        let geo;
        if(type==='p') geo = new THREE.CylinderGeometry(0.2,0.3,0.6,16);
        else if(type==='r') geo = new THREE.BoxGeometry(0.5,0.8,0.5);
        else if(type==='n') geo = new THREE.ConeGeometry(0.3,0.8,16); // Knight substitute
        else if(type==='b') geo = new THREE.CylinderGeometry(0.1,0.3,1.0,16);
        else if(type==='q') geo = new THREE.CylinderGeometry(0.3,0.3,1.4,16);
        else geo = new THREE.CylinderGeometry(0.3,0.4,1.6,16); // King

        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.y = 0.5; mesh.castShadow=true; grp.add(mesh);
        return grp;
    }

    function syncPieces(d) {
        for(let k in piecesMap) scene.remove(piecesMap[k]); piecesMap={};
        const b = game.board();
        let wSkin = userSkin, bSkin = userSkin;
        if(d && d.white) wSkin = d.white.skin;
        if(d && d.black) bSkin = d.black.skin;

        for(let r=0;r<8;r++) for(let c=0;c<8;c++) {
            const p = b[r][c];
            if(p) {
                const s = createPiece(p.type, p.color, p.color==='w'?wSkin:bSkin);
                s.position.set(c-3.5, 15, r-3.5); // Chess.js board is 0,0 at top-left (a8). ThreeJS z is inverted logic relative to r. 
                // Fix position: Chess.js row 0 is rank 8. ThreeJS z 3.5 is rank 1.
                // Actual mapping: r=0 -> rank 8 -> z = -3.5. r=7 -> rank 1 -> z = 3.5.
                // My createBoard loop: r=0 (rank 1 in my loop) z=3.5. Chess.js logic is inverted.
                // Let's fix mapping:
                // Three world: x: -3.5(a) to 3.5(h). z: -3.5(8) to 3.5(1).
                // Chess.js: b[0][0] is a8.
                s.position.set(c-3.5, 15, (r-3.5)); 
                scene.add(s); piecesMap[String.fromCharCode(97+c)+(8-r)] = s;
            }
        }
    }

    function onTouch(e) {
        if(e.target.closest('.modal-overlay') || e.target.closest('.hud') || e.target.tagName==='BUTTON' || e.target.tagName==='INPUT') return;
        if(e.touches.length>1) return;
        e.preventDefault();
        mouse.x = (e.touches[0].clientX/window.innerWidth)*2-1;
        mouse.y = -(e.touches[0].clientY/window.innerHeight)*2+1;
        checkHit();
    }
    function onClick(e) { if(isProcessing) return; mouse.x=(e.clientX/window.innerWidth)*2-1; mouse.y=-(e.clientY/window.innerHeight)*2+1; checkHit(); }
    
    function checkHit() {
        raycaster.setFromCamera(mouse, camera);
        const i = raycaster.intersectObjects(scene.children.filter(o=>o.geometry && o.userData.sq));
        if(i.length>0) handleSq(i[0].object.userData.sq);
    }

    function handleSq(sq) {
        if(isVsAI && game.turn()==='b') return;
        if(isOnline && game.turn()!==playerColor) return;
        
        // Move Logic
        if(selectedSquare) {
            const m = game.move({from:selectedSquare, to:sq, promotion:'q'});
            if(m) {
                animateMove(m);
                if(isOnline) sendMove(m);
                if(isVsAI) setTimeout(makeAiMove, 500);
            }
            selectedSquare=null; clearHigh();
        } else {
            const p = game.get(sq);
            if(p && p.color === game.turn()) {
                if(isOnline && p.color!==playerColor) return;
                selectedSquare=sq; highlight(sq);
            }
        }
    }

    function highlight(sq) {
        clearHigh(); tilesMap[sq].material.emissive.setHex(0x00ff00);
        game.moves({square:sq, verbose:true}).forEach(m => tilesMap[m.to].material.emissive.setHex(0x555500));
    }
    function clearHigh() { for(let k in tilesMap) tilesMap[k].material.emissive.setHex(0x000000); }

    function animateMove(m) {
        isProcessing=true; clearHigh();
        const p = piecesMap[m.from];
        const dest = tilesMap[m.to].position.clone();
        if(m.captured) scene.remove(piecesMap[m.to]);
        
        new TWEEN.Tween(p.position).to({x:dest.x, z:dest.z}, 300).easing(TWEEN.Easing.Quadratic.Out)
            .onComplete(() => {
                syncPieces(isOnline?{white:{skin:userSkin},black:{skin:userSkin}}:null); // Refresh visual state
                updateHUD();
                if(!isOnline && !isVsAI && game.turn()==='b') makeRandomAI(); else if(!isVsAI) isProcessing=false;
            }).start();
    }

    function makeRandomAI() {
        const m = game.moves(); if(m.length===0) return;
        const move = m[Math.floor(Math.random()*m.length)];
        game.move(move); animateMove(game.history({verbose:true}).pop());
    }

    function updateHUD() {
        const t = game.turn()==='w'?"白方":"黑方";
        document.getElementById('turn-txt').innerText = isVsAI ? (game.turn()==='w'?"你的回合":"AI 思考") : t+"回合";
    }

    function moveCam(x,y,z) { new TWEEN.Tween(camera.position).to({x,y,z}, 2000).easing(TWEEN.Easing.Cubic.Out).start(); }
    function onResize() { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); }
    function animate() { requestAnimationFrame(animate); TWEEN.update(); controls.update(); renderer.render(scene,camera); }

    init();
</script>
</body>
</html>
