<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>DTZ PDF - æ¥µè‡´ç©©å®šçš„æœ¬åœ°æ–‡ä»¶è™•ç†</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db;
            --bg-color: #f8fafc; --text-dark: #1e293b; --card-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0; background-color: var(--bg-color); color: var(--text-dark); line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }

        nav {
            background: white; padding: 1rem 8%; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 1000;
        }

        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary-red); text-decoration: none; letter-spacing: -1px; }

        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; text-align: center; }

        h1 { font-size: 2.2rem; margin-bottom: 8px; font-weight: 800; letter-spacing: -0.5px; }
        .subtitle { color: #64748b; margin-bottom: 40px; font-size: 1.05rem; }
        .highlight-text { color: var(--primary-red); }

        .upload-area {
            background: white; border: 3px dashed #cbd5e0; border-radius: 24px;
            padding: 50px 20px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
        }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary-red); background-color: #fffaf9; transform: scale(1.01); }
        .upload-icon { font-size: 50px; margin-bottom: 15px; }

        #sortable-list { margin: 30px auto; list-style: none; padding: 0; max-width: 100%; text-align: left; }
        .file-item {
            background: white; margin-bottom: 12px; padding: 16px 20px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; cursor: grab;
        }
        .file-item:active { cursor: grabbing; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        .btn-merge {
            background: var(--primary-green); color: white; padding: 18px 40px; border-radius: 50px;
            border: none; font-size: 1.2rem; font-weight: 800; cursor: pointer; width: 100%;
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.2); transition: 0.3s;
        }
        .btn-merge:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(46, 204, 113, 0.3); }
        .btn-merge:disabled { background-color: #cbd5e0; box-shadow: none; cursor: wait; }

        .features { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 80px; text-align: left; }
        .feature-card { background: white; padding: 25px; border-radius: 20px; box-shadow: var(--card-shadow); border-top: 5px solid transparent; }
        .f-red { border-top-color: var(--primary-red); }
        .f-green { border-top-color: var(--primary-green); }
        .f-blue { border-top-color: var(--primary-blue); }

        .remove-btn { border: none; background: #fee2e2; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; color: var(--primary-red); font-weight: bold; }
        
        @media (max-width: 768px) { .features { grid-template-columns: 1fr; } h1 { font-size: 1.8rem; } }
        footer { margin-top: 80px; padding: 40px; color: #94a3b8; font-size: 0.85rem; border-top: 1px solid #f1f5f9; }
    </style>
</head>
<body>

    <nav>
        <a href="#" class="logo">DTZ PDF</a>
        <div style="font-size: 0.85rem; font-weight: 600; color: var(--primary-green);">â— æœ¬åœ°åŠ å¯†æ ¸å¿ƒ</div>
    </nav>

    <div class="container">
        <h1>åˆä½µæ–‡ä»¶</h1>
        <p class="subtitle">å…è²»ã€å¿«é€Ÿä¸”<span class="highlight-text">çµ•å°ç§å¯†</span>ã€‚æª”æ¡ˆä¸æœƒä¸Šå‚³è‡³ä»»ä½•é›²ç«¯ã€‚</p>

        <div class="upload-area" id="drop-zone">
            <div class="upload-icon">ğŸ“‚</div>
            <p style="font-size: 1.1rem; font-weight: 700; margin: 0;">æ‹–æ”¾æª”æ¡ˆæˆ–é»æ“Šé¸å–</p>
            <p style="font-size: 0.85rem; color: #94a3b8; margin-top: 5px;">æ”¯æ´ PDF, JPG, PNG (æœ€å¤§ 50MB/å–®æª”)</p>
            <input type="file" id="file-input" multiple hidden accept="application/pdf,image/jpeg,image/png">
        </div>

        <ul id="sortable-list"></ul>

        <div id="action-section" style="display:none; margin-top:30px;">
            <button id="merge-btn" class="btn-merge">é–‹å§‹åˆä½µä¸¦åŒ¯å‡º</button>
            <button onclick="clearAll()" style="background:none; border:none; color:#94a3b8; margin-top:20px; cursor:pointer; font-size:0.9rem; text-decoration:underline;">å…¨éƒ¨æ¸…ç©º</button>
        </div>

        <div class="features">
            <div class="feature-card f-red"><h4>ğŸ”’ å®‰å…¨è™•ç†</h4><p>æ‚¨çš„éš±ç§æ˜¯ç¬¬ä¸€å„ªå…ˆã€‚æ‰€æœ‰é‹ç®—çš†åœ¨æ‚¨çš„è¨­å‚™ä¸Šå®Œæˆã€‚</p></div>
            <div class="feature-card f-green"><h4>ğŸ–¼ï¸ æ··åˆæ ¼å¼</h4><p>JPG/PNG åœ–ç‰‡å°‡è‡ªå‹•è½‰æ›ç‚º PDF é é¢ï¼Œå®Œç¾é©é…å°ºå¯¸ã€‚</p></div>
            <div class="feature-card f-blue"><h4>ğŸ“‘ è‡ªç”±çµ„ç¹”</h4><p>ç›´è¦ºçš„æ‹–æ”¾ä»‹é¢ï¼Œè®“æ‚¨è¼•é¬†èª¿æ•´æ–‡ä»¶çš„æœ€çµ‚é †åºã€‚</p></div>
        </div>

        <div style="text-align: left; margin-top: 60px; background: white; padding: 35px; border-radius: 24px; box-shadow: var(--card-shadow);">
            <h3 style="color: var(--primary-red);">æ“ä½œå¸¸è¦‹å•é¡Œ (FAQ)</h3>
            <p><b>Q: åœ–ç‰‡å¤ªå¯¬æœƒè¢«è£åˆ‡å—ï¼Ÿ</b><br>ä¸æœƒã€‚ç³»çµ±æœƒä¾æ“šåœ–ç‰‡æ¯”ä¾‹è‡ªå‹•èª¿æ•´ PDF é é¢å°ºå¯¸ï¼Œç¢ºä¿å®Œæ•´å‘ˆç¾ã€‚</p>
            <p><b>Q: åˆä½µå¾Œçš„æª”æ¡ˆåœ¨å“ªè£¡ï¼Ÿ</b><br>iPhone ç”¨æˆ¶æœƒç›´æ¥åœ¨æ–°åˆ†é æ‰“é–‹ï¼Œé»æ“Šåˆ†äº«æŒ‰éˆ•å³å¯å„²å­˜åˆ°ã€Œæª”æ¡ˆã€Appã€‚</p>
        </div>
    </div>

    <footer>&copy; 2026 DTZ PDF ENGINE | ä¼æ¥­ç´šæœ¬åœ°æ–‡ä»¶è™•ç†è§£æ±ºæ–¹æ¡ˆ</footer>

    <script>
        const { PDFDocument } = PDFLib;
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isMobile = isIOS || /Android/i.test(navigator.userAgent);
        
        let fileDataArray = [];
        let currentBlobUrl = null;

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const sortableList = document.getElementById('sortable-list');
        const mergeBtn = document.getElementById('merge-btn');

        // åˆå§‹åŒ–æ‹–æ”¾æ’åº
        new Sortable(sortableList, {
            animation: 200,
            ghostClass: 'sortable-ghost',
            onEnd: () => {
                const newOrder = Array.from(sortableList.children).map(li => li.dataset.id);
                fileDataArray = newOrder.map(id => fileDataArray.find(f => f.id === id));
            }
        });

        // é»æ“Šèˆ‡æ‹–æ”¾ç›£è½
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFiles(e.target.files);
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        async function handleFiles(files) {
            resetButton();
            for (const file of Array.from(files)) {
                if (file.size > 50 * 1024 * 1024) { alert(file.name + " è¶…é 50MBï¼Œè«‹å…ˆå£“ç¸®å¾Œå†åˆä½µã€‚"); continue; }
                const id = crypto.randomUUID();
                const sizeStr = (file.size / 1024 / 1024).toFixed(2) + " MB";
                fileDataArray.push({ id, file, sizeStr });
            }
            render();
        }

        function clearAll() {
            fileDataArray = [];
            if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
            render();
            resetButton();
        }

        function resetButton() {
            mergeBtn.innerText = 'é–‹å§‹åˆä½µä¸¦åŒ¯å‡º';
            mergeBtn.style.backgroundColor = 'var(--primary-green)';
            mergeBtn.disabled = false;
            mergeBtn.onclick = startMerge;
        }

        function render() {
            document.getElementById('action-section').style.display = fileDataArray.length > 0 ? 'block' : 'none';
            sortableList.innerHTML = fileDataArray.map(item => `
                <li class="file-item" data-id="${item.id}">
                    <span>â˜° &nbsp; <b>${item.file.name}</b> <small style="color:#94a3b8; margin-left:10px;">${item.sizeStr}</small></span>
                    <button class="remove-btn" onclick="event.stopPropagation(); removeFile('${item.id}')">âœ•</button>
                </li>
            `).join('');
        }

        function removeFile(id) {
            fileDataArray = fileDataArray.filter(f => f.id !== id);
            render();
            if (fileDataArray.length === 0) resetButton();
        }

        async function startMerge() {
            if (isIOS && fileDataArray.length > 15) return alert("iPhone è¨˜æ†¶é«”æœ‰é™ï¼Œå»ºè­°æ¯æ¬¡åˆä½µ 15 ä»½ä»¥å…§æª”æ¡ˆã€‚");
            
            mergeBtn.innerText = 'âš™ï¸ æ­£åœ¨è™•ç†å¹¾ä½•æ•¸æ“š...';
            mergeBtn.disabled = true;

            try {
                const mergedPdf = await PDFDocument.create();
                
                for (const item of fileDataArray) {
                    // éåŒæ­¥èª¿åº¦é»ï¼Œé‡‹æ”¾ UI ç·šç¨‹é˜²å‡çµ
                    await new Promise(r => setTimeout(r, 0));
                    const arrayBuffer = await item.file.arrayBuffer();

                    if (item.file.type === 'application/pdf') {
                        const pdf = await PDFDocument.load(arrayBuffer);
                        const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        pages.forEach(p => mergedPdf.addPage(p));
                    } else {
                        // åœ–ç‰‡åµŒå…¥é‚è¼¯ (æ™ºæ…§ç¸®æ”¾ä¿è­·æ¨¡å¼)
                        const image = item.file.type === 'image/jpeg' ? 
                            await mergedPdf.embedJpg(arrayBuffer) : await mergedPdf.embedPng(arrayBuffer);
                        
                        const maxDpiWidth = isMobile ? 1600 : 3000;
                        let sc = 1;
                        if (image.width > maxDpiWidth) sc = maxDpiWidth / image.width;
                        
                        const page = mergedPdf.addPage([image.width * sc, image.height * sc]);
                        page.drawImage(image, { x: 0, y: 0, width: image.width * sc, height: image.height * sc });
                    }
                }

                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                
                // è¨˜æ†¶é«”å›æ”¶ï¼šæ¸…ç†ä¸Šä¸€å€‹ Blob URL
                if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
                currentBlobUrl = URL.createObjectURL(blob);
                
                const dateTag = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const fileName = `Merged_${dateTag}.pdf`;

                if (isIOS) {
                    mergeBtn.innerText = 'âœ… åˆä½µå®Œæˆï¼é»æ­¤é è¦½';
                    mergeBtn.style.backgroundColor = 'var(--primary-blue)';
                    mergeBtn.disabled = false;
                    mergeBtn.onclick = () => window.open(currentBlobUrl, '_blank');
                    window.open(currentBlobUrl, '_blank');
                } else {
                    const a = document.createElement("a");
                    a.href = currentBlobUrl;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    mergeBtn.innerText = 'âœ… ä¸‹è¼‰æˆåŠŸ';
                    setTimeout(() => resetButton(), 3000);
                }
            } catch (err) {
                console.error(err);
                alert('è™•ç†å¤±æ•—ï¼šæª”æ¡ˆå¯èƒ½ææ¯€æˆ–è¨˜æ†¶é«”ä¸è¶³ã€‚');
                resetButton();
            }
        }
    </script>
</body>
</html>
