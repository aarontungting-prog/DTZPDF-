<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DTZ PDF 5.0 - æ——è‰¦çµ‚æ¥µç‰ˆ</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c;
            --primary-green: #2ecc71;
            --bg-color: #f7f9fc;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg-color); color: #2d3436; }
        nav { background: white; padding: 1rem 10%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary-red); text-decoration: none; }
        
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; text-align: center; }
        .tab-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 20px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: bold; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--primary-red); color: white; }

        .work-panel { display: none; background: white; padding: 30px; border-radius: 20px; box-shadow: var(--card-shadow); min-height: 400px; }
        .work-panel.active { display: block; animation: fadeIn 0.3s; }

        .upload-area { border: 3px dashed #cbd5e0; border-radius: 15px; padding: 50px 20px; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary-red); background: #fffaf9; }

        /* é é¢é è¦½ç¶²æ ¼ */
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 25px; }
        .page-card { border: 2px solid #eee; padding: 8px; border-radius: 12px; position: relative; cursor: grab; background: white; transition: 0.2s; }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        .page-card canvas { width: 100%; border-radius: 5px; transition: transform 0.3s ease; }
        
        /* æ—‹è½‰æ§åˆ¶ */
        .rot-0 { transform: rotate(0deg); }
        .rot-90 { transform: rotate(90deg); }
        .rot-180 { transform: rotate(180deg); }
        .rot-270 { transform: rotate(270deg); }

        .badge { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; z-index: 10; }
        .select-check { position: absolute; top: 5px; right: 5px; display: none; font-size: 20px; }
        .selected .select-check { display: block; }

        .btn-group { margin-top: 30px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .btn-action { color: white; padding: 15px 40px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s; }
        .btn-zip { background: var(--primary-blue, #3498db); }
        .btn-save { background: var(--primary-green); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<nav>
    <a href="#" class="logo">DTZ PDF 5.0</a>
    <div style="font-size: 0.8rem; color: #95a5a6;">æ——è‰¦çµ‚æ¥µç‰ˆ</div>
</nav>

<div class="container">
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('edit')">æ•´ç†èˆ‡é»é¸åˆ†å‰²</button>
        <button class="tab-btn" onclick="switchTab('toimg')">PDF è½‰åœ–ç‰‡ (ZIP)</button>
    </div>

    <div id="edit-panel" class="work-panel active">
        <div class="upload-area" onclick="document.getElementById('input-edit').click()">
            <div style="font-size: 40px;">ğŸ“„</div>
            <h3>é»æ“Šä¸Šå‚³ PDF æˆ–åœ–ç‰‡</h3>
            <p>å¯è‡ªç”±æ’åºã€æ—‹è½‰ã€æˆ–ã€Œé»é¸ã€é é¢ä¾†æå–/åˆ†å‰²</p>
            <input type="file" id="input-edit" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div id="edit-grid" class="page-grid"></div>
        <div id="edit-controls" class="btn-group" style="display:none;">
            <button class="btn-action btn-save" onclick="exportPdf(false)">åŒ¯å‡ºå…¨éƒ¨ (åˆä½µ/æ’åº)</button>
            <button class="btn-action btn-zip" onclick="exportPdf(true)">åŒ¯å‡ºæ‰€é¸é é¢ (åˆ†å‰²/æå–)</button>
        </div>
    </div>

    <div id="toimg-panel" class="work-panel">
        <div class="upload-area" onclick="document.getElementById('input-img').click()">
            <div style="font-size: 40px;">ğŸ–¼ï¸</div>
            <h3>PDF è½‰åœ–ç‰‡ä¸¦æ‰“åŒ… ZIP</h3>
            <input type="file" id="input-img" hidden accept=".pdf">
        </div>
        <div id="img-grid" class="page-grid"></div>
        <div id="img-controls" class="btn-group" style="display:none;">
            <button class="btn-action btn-zip" onclick="downloadAllImages()">ä¸€éµæ‰“åŒ… ZIP ä¸‹è¼‰</button>
        </div>
    </div>
</div>

<script>
    const { PDFDocument, degrees } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pagesData = []; // ç·¨è¼¯å€è³‡æ–™
    let fileBuffers = {};
    let imageBlobs = []; // è½‰åœ–å€è³‡æ–™

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.work-panel').forEach(p => p.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tab + '-panel').classList.add('active');
    }

    // --- ç·¨è¼¯èˆ‡åˆ†å‰²åŠŸèƒ½ ---
    document.getElementById('input-edit').onchange = async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
            // éŒ¯èª¤è™•ç†ï¼šæª¢æŸ¥æ ¼å¼
            if (!['application/pdf', 'image/jpeg', 'image/png'].includes(file.type)) {
                alert(`æ ¼å¼ä¸æ”¯æ´: ${file.name}`);
                continue;
            }
            const fId = crypto.randomUUID();
            const buffer = await file.arrayBuffer();
            fileBuffers[fId] = buffer;

            if (file.type === 'application/pdf') {
                const pdf = await pdfjsLib.getDocument({ data: buffer.slice(0) }).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const pId = crypto.randomUUID();
                    pagesData.push({ fId, pIdx: i-1, rot: 0, pId, type: 'pdf', selected: false });
                    renderThumb(buffer, i, pId, 'edit-grid');
                }
            } else {
                const pId = crypto.randomUUID();
                pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false });
                renderImgThumb(file, pId, 'edit-grid');
            }
        }
        document.getElementById('edit-controls').style.display = 'flex';
    };

    async function renderThumb(buffer, pNum, pId, gridId) {
        const pdf = await pdfjsLib.getDocument({ data: buffer.slice(0) }).promise;
        const page = await pdf.getPage(pNum);
        const viewport = page.getViewport({ scale: 0.3 });
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
        createCard(canvas, pId, gridId, `é ç¢¼ ${pNum}`);
    }

    function renderImgThumb(file, pId, gridId) {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const scale = 150 / img.width;
            canvas.width = 150; canvas.height = img.height * scale;
            canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
            createCard(canvas, pId, gridId, 'åœ–ç‰‡');
        };
    }

    function createCard(canvas, pId, gridId, label) {
        const card = document.createElement('div');
        card.className = 'page-card';
        card.id = pId;
        card.innerHTML = `
            <div class="badge">${label}</div>
            <div class="select-check">âœ…</div>
            <div class="cv-wrap"></div>
            <div style="margin-top:10px; display:flex; justify-content:center; gap:10px;">
                <button onclick="event.stopPropagation(); rotatePage('${pId}')" style="font-size:10px;">ğŸ”„ æ—‹è½‰</button>
                <button onclick="event.stopPropagation(); deletePage('${pId}')" style="font-size:10px;">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>
        `;
        card.querySelector('.cv-wrap').appendChild(canvas);
        card.onclick = () => toggleSelect(pId);
        document.getElementById(gridId).appendChild(card);
    }

    function toggleSelect(pId) {
        const p = pagesData.find(x => x.pId === pId);
        p.selected = !p.selected;
        document.getElementById(pId).classList.toggle('selected');
    }

    function rotatePage(pId) {
        const p = pagesData.find(x => x.pId === pId);
        p.rot = (p.rot + 90) % 360;
        const cv = document.getElementById(pId).querySelector('canvas');
        cv.className = `rot-${p.rot}`;
    }

    function deletePage(pId) {
        pagesData = pagesData.filter(x => x.pId !== pId);
        document.getElementById(pId).remove();
    }

    // Sortable æ’åº
    new Sortable(document.getElementById('edit-grid'), {
        animation: 150,
        onEnd: () => {
            const ids = Array.from(document.getElementById('edit-grid').children).map(c => c.id);
            pagesData = ids.map(id => pagesData.find(p => p.pId === id));
        }
    });

    // åŒ¯å‡ºåŠŸèƒ½
    async function exportPdf(onlySelected) {
        const list = onlySelected ? pagesData.filter(p => p.selected) : pagesData;
        if (list.length === 0) return alert('è«‹å…ˆé¸å–é é¢æˆ–ä¸Šå‚³æª”æ¡ˆ');

        const pdfDoc = await PDFDocument.create();
        for (const p of list) {
            await new Promise(r => setTimeout(r, 0)); // å‘¼å¸è£œä¸
            if (p.type === 'pdf') {
                const src = await PDFDocument.load(fileBuffers[p.fId]);
                const [copy] = await pdfDoc.copyPages(src, [p.pIdx]);
                // åŒæ­¥ç‰©ç†æ—‹è½‰
                copy.setRotation(degrees(p.rot + (copy.getRotation().angle || 0)));
                pdfDoc.addPage(copy);
            } else {
                const buf = await p.file.arrayBuffer();
                const img = p.file.type.includes('png') ? await pdfDoc.embedPng(buf) : await pdfDoc.embedJpg(buf);
                // åœ–ç‰‡è‡ªå‹•ç¸®æ”¾ (é™åˆ¶å¯¬åº¦ 1500px å…§ä»¥å£“ç¸®é«”ç©)
                const limit = 1500;
                const scale = img.width > limit ? limit / img.width : 1;
                const page = pdfDoc.addPage([img.width * scale, img.height * scale]);
                page.drawImage(img, { x: 0, y: 0, width: img.width * scale, height: img.height * scale, rotate: degrees(p.rot) });
            }
        }
        download(await pdfDoc.save(), 'DTZ_Expert.pdf', 'application/pdf');
    }

    // --- PDF è½‰åœ–èˆ‡ ZIP åŠŸèƒ½ ---
    document.getElementById('input-img').onchange = async (e) => {
        const file = e.target.files[0];
        const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
        const grid = document.getElementById('img-grid');
        grid.innerHTML = ''; imageBlobs = [];

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const vp = page.getViewport({ scale: 2.0 }); // é«˜æ¸…æ¸²æŸ“
            const cv = document.createElement('canvas');
            cv.width = vp.width; cv.height = vp.height;
            await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
            
            const card = document.createElement('div');
            card.className = 'page-card';
            card.innerHTML = `<div class="badge">ç¬¬ ${i} é </div>`;
            card.appendChild(cv);
            grid.appendChild(card);

            // å­˜å„² Blob ç”¨æ–¼ ZIP
            cv.toBlob(blob => imageBlobs.push({ blob, name: `Page_${i}.jpg` }), 'image/jpeg', 0.85);
        }
        document.getElementById('img-controls').style.display = 'flex';
    };

    async function downloadAllImages() {
        const zip = new JSZip();
        imageBlobs.forEach(img => zip.file(img.name, img.blob));
        const content = await zip.generateAsync({ type: 'blob' });
        download(content, 'DTZ_Images.zip', 'application/zip');
    }

    function download(data, name, type) {
        const blob = new Blob([data], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name; a.click();
    }
</script>
</body>
</html>
