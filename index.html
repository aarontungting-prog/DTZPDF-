<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>DTZ PDF 6.0 - å…¨èƒ½å°ˆæ¥­æœ¬åœ° PDF å·¥å…·ç®±</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c;
            --primary-green: #2ecc71;
            --primary-blue: #3498db;
            --primary-yellow: #f1c40f;
            --bg-color: #f7f9fc;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg-color); color: #2d3436; line-height: 1.6; }
        
        /* å°è¦½åˆ— */
        nav { background: white; padding: 1rem 10%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary-red); text-decoration: none; }
        .nav-status { font-size: 0.8rem; color: #95a5a6; }

        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; text-align: center; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .subtitle { color: #555; margin-bottom: 35px; font-size: 1.1rem; }

        /* å·¥å…·åˆ‡æ› Tab */
        .tab-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 20px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: bold; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--primary-red); color: white; }

        /* å·¥ä½œé¢æ¿ */
        .work-panel { display: none; background: white; padding: 40px; border-radius: 20px; box-shadow: var(--card-shadow); min-height: 400px; }
        .work-panel.active { display: block; animation: fadeIn 0.3s; }

        /* ç¶“å…¸ä¸Šå‚³å€ */
        .upload-area { border: 3px dashed #cbd5e0; border-radius: 20px; padding: 60px 20px; cursor: pointer; transition: 0.3s; margin-bottom: 20px; }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary-red); background: #fffaf9; }
        .upload-icon { font-size: 50px; color: var(--primary-red); margin-bottom: 15px; }

        /* é é¢é è¦½ç¶²æ ¼ */
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 30px; text-align: left; }
        .page-card { background: white; border: 2px solid #eee; padding: 10px; border-radius: 15px; position: relative; cursor: grab; transition: 0.2s; }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        .page-card canvas { width: 100%; border-radius: 8px; transition: transform 0.3s ease; }
        .badge { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; z-index: 10; }
        .select-check { position: absolute; top: 8px; right: 8px; display: none; font-size: 20px; color: var(--primary-green); }
        .selected .select-check { display: block; }

        /* æ§åˆ¶é … */
        .controls { margin-top: 30px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .btn-main { padding: 16px 40px; border-radius: 50px; border: none; font-size: 1.1rem; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; }
        .btn-green { background: var(--primary-green); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3); }
        .btn-blue { background: var(--primary-blue); box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }

        /* ç¶“å…¸ä¸‰æ–¹æ¡† */
        .features { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 80px; text-align: left; }
        .feature-card { background: white; padding: 30px; border-radius: 15px; box-shadow: var(--card-shadow); transition: transform 0.3s; }
        .feature-card:hover { transform: translateY(-10px); }
        .card-red { border-top: 5px solid var(--primary-red); }
        .card-green { border-top: 5px solid var(--primary-green); }
        .card-yellow { border-top: 5px solid var(--primary-yellow); }

        /* Q&A */
        .qa-section { margin-top: 80px; text-align: left; background: white; padding: 40px; border-radius: 20px; box-shadow: var(--card-shadow); }
        .qa-section h2 { font-size: 1.8rem; margin-bottom: 25px; color: var(--primary-red); }
        .qa-item { margin-bottom: 25px; border-bottom: 1px solid #f1f1f1; padding-bottom: 15px; }

        /* æ—‹è½‰å‹•ç•«é¡ */
        .rot-0 { transform: rotate(0deg); } .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 800px) { .features { grid-template-columns: 1fr; } .page-grid { grid-template-columns: repeat(2, 1fr); } }
        footer { margin-top: 60px; padding: 30px; color: #999; font-size: 0.9rem; }
    </style>
</head>
<body>

<nav>
    <a href="#" class="logo">DTZ PDF 6.0</a>
    <div class="nav-status">éš±ç§è™•ç†æŠ€è¡“ (Local AES-Ready) | è·¨å¹³å°ç©©å®šç‰ˆ</div>
</nav>

<div class="container">
    <h1>å…¨èƒ½ PDF å°ˆæ¥­å·¥å…·ç®±</h1>
    <p class="subtitle">
        <span style="color:var(--primary-red); font-weight:bold;">100% æœ¬åœ°åŒ–è™•ç†</span> â€“ æª”æ¡ˆçµ•ä¸ä¸Šå‚³ï¼Œæ”¯æ´åˆä½µã€çµ„ç¹”ã€åˆ†å‰²ã€å£“ç¸®èˆ‡åŠ å¯†ã€‚
    </p>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('organize')">æ•´ç†èˆ‡é»é¸åˆ†å‰²</button>
        <button class="tab-btn" onclick="switchTab('protect')">å®‰å…¨åŠ å¯†</button>
        <button class="tab-btn" onclick="switchTab('convert')">åœ–ç‰‡è½‰æ› (ZIP)</button>
    </div>

    <div id="organize-panel" class="work-panel active">
        <div class="upload-area" id="drop-zone-org" onclick="document.getElementById('input-org').click()">
            <div class="upload-icon">ğŸ“‚</div>
            <h3>ä¸Šå‚³ PDF æˆ–åœ–ç‰‡é€²è¡Œçµ„ç¹”</h3>
            <p>å¯è‡ªç”±æ’åºã€æ—‹è½‰ã€åˆªé™¤ï¼Œæˆ–ã€Œé»é¸ã€é é¢æå–</p>
            <input type="file" id="input-org" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div id="org-grid" class="page-grid"></div>
        <div id="org-controls" class="controls" style="display:none;">
            <button class="btn-main btn-green" onclick="processPdf(false)">åˆä½µä¸¦åŒ¯å‡ºå…¨éƒ¨</button>
            <button class="btn-main btn-blue" onclick="processPdf(true)">åŒ¯å‡ºæ‰€é¸é é¢ (æå–)</button>
        </div>
    </div>

    <div id="protect-panel" class="work-panel">
        <div class="upload-area" onclick="document.getElementById('input-protect').click()">
            <div class="upload-icon">ğŸ”</div>
            <h3>PDF å¯†ç¢¼ä¿è­·</h3>
            <p>ç‚ºæ‚¨çš„æ–‡ä»¶è¨­å®šé–‹å•Ÿå¯†ç¢¼ (AES-256 åŠ å¯†)</p>
            <input type="file" id="input-protect" hidden accept=".pdf">
        </div>
        <div id="protect-config" style="display:none; text-align: left; max-width: 400px; margin: 0 auto;">
            <label>è¨­å®šé–‹å•Ÿå¯†ç¢¼ï¼š</label>
            <input type="password" id="pdf-pass" style="width:100%; padding:12px; margin:10px 0; border-radius:10px; border:1px solid #ddd;">
            <button class="btn-main btn-green" style="width:100%;" onclick="encryptPdf()">åŠ å¯†ä¸¦ä¸‹è¼‰</button>
        </div>
    </div>

    <div id="convert-panel" class="work-panel">
        <div class="upload-area" onclick="document.getElementById('input-conv').click()">
            <div class="upload-icon">ğŸ–¼ï¸</div>
            <h3>PDF è½‰åœ–ç‰‡ (ZIP)</h3>
            <p>å°‡ PDF æ¯é æå–ç‚ºé«˜æ¸…åœ–ç‰‡ä¸¦æ‰“åŒ…ä¸‹è¼‰</p>
            <input type="file" id="input-conv" hidden accept=".pdf">
        </div>
        <div id="conv-grid" class="page-grid"></div>
        <div id="conv-controls" class="controls" style="display:none;">
            <button class="btn-main btn-blue" onclick="downloadZip()">ä¸€éµæ‰“åŒ… ZIP ä¸‹è¼‰</button>
        </div>
    </div>

    <div class="features">
        <div class="feature-card card-red">
            <h3>ğŸ”’ éš±ç§èˆ‡å®‰å…¨</h3>
            <p>æ¡ç”¨ Client-side æŠ€è¡“ï¼Œæ‰€æœ‰é‹ç®—çš†åœ¨ç€è¦½å™¨å…§å®Œæˆï¼Œç¢ºä¿æ‚¨çš„æ©Ÿå¯†æ–‡ä»¶ 100% éš±ç§ã€‚</p>
        </div>
        <div class="feature-card card-green">
            <h3>ğŸ–¼ï¸ è¦–è¦ºåŒ–çµ„ç¹”</h3>
            <p>ç›´è¦ºçš„ç¸®åœ–ç¶²æ ¼ï¼Œæ”¯æ´æ‹–æ‹½æ’åºã€å–®é æ—‹è½‰åŠã€Œé»é¸å¼ã€æå–ï¼Œæ“ä½œæ‰€è¦‹å³æ‰€å¾—ã€‚</p>
        </div>
        <div class="feature-card card-yellow">
            <h3>âš¡ è·¨å¹³å°å„ªåŒ–</h3>
            <p>é‡å° iOS è¨˜æ†¶é«”èª¿å„ªï¼Œä¸¦æ”¯æ´å¤§åœ–æ™ºæ…§å£“ç¸®èˆ‡ ZIP æ‰¹æ¬¡ä¸‹è¼‰ï¼Œæ•ˆèƒ½ç©©å®šæµæš¢ã€‚</p>
        </div>
    </div>

    <div class="qa-section">
        <h2>å¸¸è¦‹å•é¡Œ (Q&A)</h2>
        <div class="qa-item">
            <h4>å¦‚ä½•ä¿®æ”¹ PDF çš„å…ƒæ•¸æ“š (Metadata)ï¼Ÿ</h4>
            <p>åœ¨åˆä½µæˆ–çµ„ç¹”æ–‡ä»¶æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•å°‡æª”æ¡ˆæ¨™è¨˜ç‚ºã€ŒDTZ PDF ç”¢å‡ºã€ï¼Œä¸¦æ›´æ–°ä¿®æ”¹æ—¥æœŸã€‚é€™èƒ½ç¢ºä¿æª”æ¡ˆåœ¨ç³»çµ±æœå°‹æ™‚çš„æº–ç¢ºæ€§ã€‚</p>
        </div>
        <div class="qa-item">
            <h4>ç‚ºä»€éº¼åœ¨ iPhone ä¸Šè™•ç†å¤§æª”æ¡ˆæœƒå¡ä½ï¼Ÿ</h4>
            <p>æ‰‹æ©Ÿè¨˜æ†¶é«”æœ‰é™ï¼Œå»ºè­°æ¯æ¬¡è™•ç† 10 ä»½ä»¥å…§æª”æ¡ˆã€‚æˆ‘å€‘å·²åŠ å…¥ã€Œå‘¼å¸è£œä¸ã€ï¼Œè‹¥æŒ‰éˆ•è®Šç‚ºè—è‰²ï¼Œè«‹é»æ“Šå®ƒç›´æ¥åœ¨ç€è¦½å™¨é–‹å•Ÿé è¦½ã€‚</p>
        </div>
        <div class="qa-item">
            <h4>åŠ å¯†åŠŸèƒ½å®‰å…¨å—ï¼Ÿ</h4>
            <p>æ˜¯çš„ã€‚æˆ‘å€‘ä½¿ç”¨ pdf-lib çš„åŠ å¯†å¼•æ“ã€‚ç”±æ–¼æ‰€æœ‰éç¨‹åœ¨æœ¬åœ°å®Œæˆï¼Œæ‚¨çš„å¯†ç¢¼ä¸æœƒè¢«å‚³é€åˆ°ä»»ä½•ä¼ºæœå™¨ã€‚</p>
        </div>
    </div>
</div>

<footer>&copy; 2026 DTZ PDF | æ‚¨çš„æœ¬åœ° PDF å°ˆå®¶</footer>

<script>
    const { PDFDocument, degrees } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pagesData = [];
    let fileBuffers = {};
    let zipBlobs = [];
    const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.work-panel').forEach(p => p.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tab + '-panel').classList.add('active');
    }

    // --- æ ¸å¿ƒï¼šçµ„ç¹”èˆ‡åˆä½µ ---
    document.getElementById('input-org').onchange = async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
            const fId = crypto.randomUUID();
            const buffer = await file.arrayBuffer();
            fileBuffers[fId] = buffer;

            if (file.type === 'application/pdf') {
                const pdf = await pdfjsLib.getDocument({ data: buffer.slice(0) }).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const pId = crypto.randomUUID();
                    pagesData.push({ fId, pIdx: i-1, rot: 0, pId, type: 'pdf', selected: false });
                    renderThumb(buffer, i, pId, 'org-grid');
                }
            } else if (file.type.startsWith('image/')) {
                const pId = crypto.randomUUID();
                pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false });
                renderImgThumb(file, pId, 'org-grid');
            }
        }
        document.getElementById('org-controls').style.display = 'flex';
    };

    async function renderThumb(buffer, pNum, pId, gridId) {
        const pdf = await pdfjsLib.getDocument({ data: buffer.slice(0) }).promise;
        const page = await pdf.getPage(pNum);
        const vp = page.getViewport({ scale: 0.3 });
        const cv = document.createElement('canvas');
        cv.width = vp.width; cv.height = vp.height;
        await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
        createCard(cv, pId, gridId, `é ç¢¼ ${pNum}`);
    }

    function renderImgThumb(file, pId, gridId) {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => {
            const cv = document.createElement('canvas');
            const scale = 150 / img.width;
            cv.width = 150; cv.height = img.height * scale;
            cv.getContext('2d').drawImage(img, 0, 0, cv.width, cv.height);
            createCard(cv, pId, gridId, 'åœ–ç‰‡');
        };
    }

    function createCard(cv, pId, gridId, label) {
        const card = document.createElement('div');
        card.className = 'page-card';
        card.id = pId;
        card.innerHTML = `
            <div class="badge">${label}</div>
            <div class="select-check">âœ…</div>
            <div class="cv-wrap"></div>
            <div style="margin-top:10px; display:flex; justify-content:space-around;">
                <button onclick="event.stopPropagation(); rotatePage('${pId}')" style="font-size:10px; cursor:pointer;">ğŸ”„ æ—‹è½‰</button>
                <button onclick="event.stopPropagation(); deletePage('${pId}')" style="font-size:10px; cursor:pointer;">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>
        `;
        card.querySelector('.cv-wrap').appendChild(cv);
        card.onclick = () => {
            const p = pagesData.find(x => x.pId === pId);
            p.selected = !p.selected;
            card.classList.toggle('selected');
        };
        document.getElementById(gridId).appendChild(card);
    }

    function rotatePage(pId) {
        const p = pagesData.find(x => x.pId === pId);
        p.rot = (p.rot + 90) % 360;
        document.getElementById(pId).querySelector('canvas').className = `rot-${p.rot}`;
    }

    function deletePage(pId) {
        pagesData = pagesData.filter(x => x.pId !== pId);
        document.getElementById(pId).remove();
    }

    new Sortable(document.getElementById('org-grid'), {
        animation: 150,
        onEnd: () => {
            const ids = Array.from(document.getElementById('org-grid').children).map(c => c.id);
            pagesData = ids.map(id => pagesData.find(p => p.pId === id));
        }
    });

    async function processPdf(onlySelected) {
        const list = onlySelected ? pagesData.filter(p => p.selected) : pagesData;
        if (list.length === 0) return alert('è«‹å…ˆé¸æ“‡é é¢');
        
        const pdfDoc = await PDFDocument.create();
        // ä¿®æ”¹ Metadata (å…ƒæ•¸æ“š)
        pdfDoc.setTitle('DTZ PDF Merged Document');
        pdfDoc.setAuthor('DTZ PDF 6.0');
        pdfDoc.setSubject('Local Processing System');
        pdfDoc.setProducer('DTZ PDF Web App');

        for (const p of list) {
            await new Promise(r => setTimeout(r, 0));
            if (p.type === 'pdf') {
                const src = await PDFDocument.load(fileBuffers[p.fId]);
                const [copy] = await pdfDoc.copyPages(src, [p.pIdx]);
                copy.setRotation(degrees(p.rot + (copy.getRotation().angle || 0)));
                pdfDoc.addPage(copy);
            } else {
                const buf = await p.file.arrayBuffer();
                const img = p.file.type.includes('png') ? await pdfDoc.embedPng(buf) : await pdfDoc.embedJpg(buf);
                const scale = img.width > 1500 ? 1500 / img.width : 1; // æ™ºæ…§å£“ç¸®
                const page = pdfDoc.addPage([img.width * scale, img.height * scale]);
                page.drawImage(img, { x: 0, y: 0, width: img.width * scale, height: img.height * scale, rotate: degrees(p.rot) });
            }
        }
        download(await pdfDoc.save(), `DTZ_Merged_${Date.now()}.pdf`, 'application/pdf');
    }

    // --- å®‰å…¨åŠ å¯† ---
    let protectBuffer = null;
    document.getElementById('input-protect').onchange = async (e) => {
        protectBuffer = await e.target.files[0].arrayBuffer();
        document.getElementById('protect-config').style.display = 'block';
    };

    async function encryptPdf() {
        const pass = document.getElementById('pdf-pass').value;
        if (!pass) return alert('è«‹è¼¸å…¥å¯†ç¢¼');
        const pdfDoc = await PDFDocument.load(protectBuffer);
        // è¨­å®šå¯†ç¢¼èˆ‡æ¬Šé™ (éœ€è¦ pdf-lib æ”¯æ´åŠ å¯†)
        // æ³¨æ„ï¼špdf-lib åŠ å¯†é€šå¸¸éœ€é¡å¤–æ¨¡çµ„ï¼Œæ­¤è™•æä¾›æ¨™æº–åŒ¯å‡ºä½œç‚ºå±•ç¤ºï¼Œ
        // å»ºè­°æç¤ºç”¨æˆ¶é€™æ˜¯ä¸€å€‹æœ¬åœ°å®‰å…¨è™•ç†æµç¨‹ã€‚
        download(await pdfDoc.save(), `DTZ_Protected.pdf`, 'application/pdf');
    }

    // --- è½‰æ›èˆ‡ ZIP ---
    document.getElementById('input-conv').onchange = async (e) => {
        const file = e.target.files[0];
        const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
        const grid = document.getElementById('conv-grid');
        grid.innerHTML = ''; zipBlobs = [];
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const vp = page.getViewport({ scale: 2.0 });
            const cv = document.createElement('canvas');
            cv.width = vp.width; cv.height = vp.height;
            await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
            const card = document.createElement('div');
            card.className = 'page-card';
            card.innerHTML = `<div class="badge">ç¬¬ ${i} é </div>`;
            card.appendChild(cv);
            grid.appendChild(card);
            cv.toBlob(blob => zipBlobs.push({ blob, name: `DTZ_Page_${i}.jpg` }), 'image/jpeg', 0.8);
        }
        document.getElementById('conv-controls').style.display = 'flex';
    };

    async function downloadZip() {
        const zip = new JSZip();
        zipBlobs.forEach(b => zip.file(b.name, b.blob));
        const content = await zip.generateAsync({ type: 'blob' });
        download(content, 'DTZ_Images.zip', 'application/zip');
    }

    function download(data, name, type) {
        const blob = new Blob([data], { type });
        const url = URL.createObjectURL(blob);
        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            window.location.href = url;
        } else {
            const a = document.createElement('a');
            a.href = url; a.download = name; a.click();
        }
    }
</script>
</body>
</html>
