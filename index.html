<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>DTZ PDF PRO - å·¥æ¥­ç´šé›²ç«¯éƒ¨ç½²ç‰ˆ</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db; --primary-yellow: #f1c40f;
            --bg-color: #f0f2f5; --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg-color); color: #1e293b; overflow-x: hidden; }
        
        /* ç¾è¡“é¢¨æ ¼ï¼šé ‚éƒ¨é€²åº¦æ¢ */
        #loader-bar { position: fixed; top: 0; left: 0; width: 0%; height: 6px; background: linear-gradient(90deg, var(--primary-red), var(--primary-blue), var(--primary-green)); z-index: 2001; transition: width 0.3s ease; }
        #loader-text { position: fixed; top: 12px; right: 25px; font-size: 11px; font-weight: 900; color: var(--primary-blue); z-index: 2002; background: rgba(255,255,255,0.9); padding: 4px 14px; border-radius: 50px; display: none; }

        nav { background: white; padding: 1rem 8%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.6rem; font-weight: 800; color: var(--primary-red); text-decoration: none; }

        /* Undo/Redo å·¥å…·åˆ— */
        .history-ctrl { display: flex; gap: 8px; margin-left: 20px; }
        .btn-history { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .btn-history:disabled { opacity: 0.3; cursor: not-allowed; }

        /* å´é‚Šå°è¦½ */
        #side-toggle { position: fixed; left: 0; top: 50%; transform: translateY(-50%); background: var(--primary-red); color: white; padding: 22px 10px; border-radius: 0 15px 15px 0; cursor: pointer; z-index: 2000; writing-mode: vertical-lr; font-size: 12px; font-weight: bold; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .sidebar { position: fixed; left: 0; top: 90px; width: 250px; height: calc(100vh - 120px); background: white; padding: 20px; box-shadow: 10px 0 25px rgba(0,0,0,0.05); transition: transform 0.5s cubic-bezier(0.77, 0, 0.175, 1); z-index: 1500; overflow-y: auto; border-radius: 0 30px 30px 0; transform: translateX(-100%); }
        .sidebar.open { transform: translateX(0); }
        .side-thumb-wrap { margin-bottom: 20px; border-radius: 12px; border: 3px solid #eee; overflow: hidden; transition: 0.3s; background: #fff; cursor: pointer; }
        .side-thumb-wrap.active { border-color: var(--primary-green); transform: scale(1.02); }

        /* å·¥ä½œå€ä½ˆå±€ */
        .container { max-width: 1150px; margin: 25px auto; padding: 0 20px; text-align: center; }
        .work-panel { background: white; padding: 40px; border-radius: 30px; box-shadow: var(--card-shadow); min-height: 550px; display: none; }
        .work-panel.active { display: block; animation: slideUp 0.4s ease-out; }
        .tab-btn { padding: 12px 28px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: 800; cursor: pointer; transition: 0.3s; margin: 5px; }
        .tab-btn.active { background: var(--primary-red); color: white; box-shadow: 0 8px 15px rgba(231, 76, 60, 0.3); }

        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .page-card { background: #fff; border: 2px solid #f1f5f9; padding: 15px; border-radius: 20px; position: relative; cursor: grab; transition: 0.3s; }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        
        .cv-wrap { display: flex; align-items: center; justify-content: center; min-height: 220px; overflow: hidden; }
        canvas { max-width: 100%; max-height: 100%; border-radius: 10px; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: center center; }

        .rot-0 { transform: rotate(0deg); } .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }
        .hidden-search { display: none; }

        .btn-action { padding: 16px 45px; border-radius: 50px; border: none; font-size: 1.1rem; font-weight: 800; cursor: pointer; color: white; transition: 0.3s; margin: 10px; }
        .btn-green { background: var(--primary-green); } .btn-blue { background: var(--primary-blue); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 900px) { .sidebar { width: 100%; height: 350px; bottom: -450px; top: auto; border-radius: 30px 30px 0 0; transform: translateY(100%); left:0; } .sidebar.open { transform: translateY(-100%); } }
    </style>
</head>
<body>
    <div id="loader-bar"></div>
    <div id="loader-text"></div>
    <div id="side-toggle">ğŸ“„ é é¢å°è¦½</div>

    <aside class="sidebar">
        <h3 style="color:var(--primary-red); margin-bottom:15px;">ğŸ” æœå°‹ PDF æ–‡å­—</h3>
        <input type="text" id="search-input" placeholder="è¼¸å…¥é—œéµå­—..." onkeyup="searchPDF()" style="width:100%; padding:14px; border-radius:12px; border:1px solid #eee; margin-bottom:25px; outline:none;">
        <div id="side-grid"></div>
    </aside>

    <nav>
        <div style="display:flex; align-items:center;">
            <a href="#" class="logo">DTZ PDF <span>v23.6</span></a>
            <div class="history-ctrl">
                <button class="btn-history" id="btn-undo" onclick="undo()" disabled>â†¶ æ’¤éŠ·</button>
                <button class="btn-history" id="btn-redo" onclick="redo()" disabled>é‡åš â†·</button>
            </div>
        </div>
        <div style="font-size: 0.85rem; color: #2ecc71; font-weight: 900;">â— å®‰å…¨æœ¬åœ°ç«¯</div>
    </nav>

    <div class="container">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab(event, 'main')">æ•´ç†èˆ‡åˆ†å‰²</button>
            <button class="tab-btn" onclick="switchTab(event, 'adv')">é€²éšè£é£¾</button>
            <button class="tab-btn" onclick="switchTab(event, 'safe')">å®‰å…¨èˆ‡å±¬æ€§</button>
        </div>

        <div id="main-panel" class="work-panel active">
            <div class="upload-area" id="drop-zone" style="border:3px dashed #cbd5e0; border-radius:25px; padding:55px; cursor:pointer; background:#fff; transition:0.3s;">
                <div style="font-size:60px;">ğŸ“‚</div>
                <h3>é»æ“Šæˆ–æ‹–æ”¾ PDF / åœ–ç‰‡</h3>
                <input type="file" id="input-org" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
            </div>
            <div id="org-grid" class="page-grid"></div>
            <div id="org-ctrl" style="display:none; margin-top:40px;">
                <div style="background:#f8fafc; padding:20px; border-radius:28px; margin-bottom:25px; border:1px solid #e2e8f0;">
                    <button class="tab-btn" onclick="rotateAll90()">å…¨éƒ¨å³è½‰ 90Â°</button>
                    <button class="tab-btn" onclick="insertBlank()">åŠ å…¥ç©ºç™½é </button>
                    <button class="tab-btn" onclick="location.reload()">å…¨éƒ¨æ¸…ç©º</button>
                </div>
                <button class="btn-action btn-green" id="btn-merge" onclick="processPdf('merge')">åˆä½µ PDF</button>
                <button class="btn-action btn-blue" id="btn-split" onclick="processPdf('split')">æå–æ‰€é¸ (ZIP)</button>
            </div>
        </div>

        <div id="adv-panel" class="work-panel">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; text-align:left;">
                <div style="background:#f1f5f9; padding:25px; border-radius:25px;">
                    <h4>ğŸ›¡ï¸ å…¨å±€æµ®æ°´å°</h4>
                    <input type="text" id="wm-text" placeholder="æ–‡å­—å…§å®¹..." style="width:100%; padding:12px; border-radius:10px; border:1px solid #ddd; margin-bottom:10px;">
                    é€æ˜åº¦: <input type="range" id="wm-op" min="0.1" max="1.0" step="0.1" value="0.3">
                </div>
                <div style="background:#f1f5f9; padding:25px; border-radius:25px;">
                    <h4>ğŸ–¼ï¸ é«˜æ¸…å°å‡º</h4>
                    <button class="btn-action btn-blue" onclick="exportAsImage()">å°å‡ºé¸ä¸­é åœ–ç‰‡</button>
                </div>
            </div>
            <hr style="margin:40px 0; border:0; border-top:1px solid #eee;">
            <h3>âœ’ï¸ æ‰¹é‡é›»å­ç°½å</h3>
            <canvas id="sig-canvas" width="1200" height="600" style="background:#fff; width:400px; height:200px; border-radius:15px; border:2px solid #333;"></canvas><br>
            <button class="tab-btn" onclick="clearSig()">æ¸…é™¤</button>
            <button class="btn-action btn-blue" onclick="saveSig()">å„²å­˜ç°½å</button>
        </div>

        <div id="safe-panel" class="work-panel">
            <div style="max-width:600px; margin:0 auto; text-align:left;">
                <h3>ğŸ“ æ–‡ä»¶å±¬æ€§</h3>
                <input type="text" id="m-title" placeholder="æ–‡ä»¶æ¨™é¡Œ" style="width:100%; padding:12px; margin-bottom:15px;">
                <input type="text" id="m-author" placeholder="ä½œè€…å§“å" style="width:100%; padding:12px;">
                <hr>
                <h3>ğŸ”’ å®‰å…¨åŠ å¯†</h3>
                <input type="password" id="p-u" placeholder="é–‹å•Ÿå¯†ç¢¼" style="width:100%; padding:12px; margin-bottom:15px;">
                <label><input type="checkbox" id="can-print" checked> å…è¨±åˆ—å°</label>
                <label><input type="checkbox" id="can-copy" checked> å…è¨±è¤‡è£½</label>
            </div>
        </div>
    </div>

    <script>
        // âœ… æ‰€æœ‰ JS é‚è¼¯åš´å¯†å°è£åœ¨ä¸€å€‹å€å¡Šä¸­
        const { PDFDocument, degrees, rgb, StandardFonts } = PDFLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let pagesData = []; let fileBuffers = {}; let pdfCache = {}; let sigImage = null; let sigTargetId = null;
        let history = [], hIndex = -1;
        const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

        // --- æ ¸å¿ƒç³»çµ± ---
        function snapshot() {
            history = history.slice(0, hIndex + 1);
            history.push(JSON.stringify(pagesData));
            if (history.length > 30) { history.shift(); hIndex--; }
            hIndex++;
            updateHistoryUI();
        }

        function undo() {
            if (hIndex <= 0) return;
            hIndex--;
            pagesData = JSON.parse(history[hIndex]);
            rebuildUI();
            updateHistoryUI();
        }

        function redo() {
            if (hIndex >= history.length - 1) return;
            hIndex++;
            pagesData = JSON.parse(history[hIndex]);
            rebuildUI();
            updateHistoryUI();
        }

        function updateHistoryUI() {
            document.getElementById('btn-undo').disabled = hIndex <= 0;
            document.getElementById('btn-redo').disabled = hIndex >= history.length - 1;
        }

        function rebuildUI() {
            document.getElementById('org-grid').innerHTML = '';
            document.getElementById('side-grid').innerHTML = '';
            pagesData.forEach(p => {
                const cv = document.createElement('canvas');
                // ç‚ºäº†æ•ˆèƒ½ï¼Œé‡å»ºæ™‚ä½¿ç”¨ä½”ä½ç¬¦
                cv.width = 160; cv.height = 226;
                createCard(cv, p.pId, p.type === 'pdf' ? `P${p.pIdx+1}` : 'IMG');
                const mainCv = document.getElementById(p.pId).querySelector('canvas');
                mainCv.className = `rot-${p.rot}`;
            });
        }

        function download(data, filename, type) {
            const blob = data instanceof Blob ? data : new Blob([data], {type});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 2000);
        }

        // --- è§£æèˆ‡æ¸²æŸ“ ---
        const dropZone = document.getElementById('drop-zone');
        dropZone.onclick = () => document.getElementById('input-org').click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
        dropZone.ondragleave = () => dropZone.classList.remove('dragover');
        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); };
        document.getElementById('input-org').onchange = (e) => handleFiles(e.target.files);

        async function handleFiles(files) {
            updateProgress(10, "è§£ææª”æ¡ˆä¸­...");
            if (!document.getElementById('m-title').value && files.length > 0) document.getElementById('m-title').value = files[0].name.split('.')[0];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fId = crypto.randomUUID();
                const buf = await file.arrayBuffer();
                fileBuffers[fId] = buf;
                if (file.name.toLowerCase().endsWith('.pdf')) {
                    const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
                    for (let j = 1; j <= pdf.numPages; j++) {
                        const pId = crypto.randomUUID();
                        const page = await pdf.getPage(j);
                        const txt = (await page.getTextContent()).items.map(s => s.str).join(' ');
                        pagesData.push({ fId, pIdx: j-1, rot: 0, pId, type: 'pdf', selected: false, text: txt, fileName: file.name });
                        await renderThumb(page, pId, j);
                        if (j % 5 === 0) await new Promise(r => setTimeout(r, 0));
                    }
                } else {
                    const pId = crypto.randomUUID();
                    pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false, text:'', fileName: file.name });
                    renderImgThumb(file, pId);
                }
                updateProgress(5 + (95 * (i/files.length)), file.name);
            }
            document.getElementById('org-ctrl').style.display = 'block';
            snapshot();
            updateProgress(0);
        }

        async function renderThumb(page, pId, pNum) {
            const vp = page.getViewport({ scale: 0.35 });
            const cv = document.createElement('canvas'); cv.width = vp.width; cv.height = vp.height;
            await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
            createCard(cv, pId, `P${pNum}`);
        }

        function renderImgThumb(file, pId) {
            const url = URL.createObjectURL(file);
            const img = new Image(); img.src = url;
            img.onload = () => {
                const cv = document.createElement('canvas'); const sc = 160 / img.width;
                cv.width = 160; cv.height = img.height * sc;
                cv.getContext('2d').drawImage(img, 0, 0, cv.width, cv.height);
                createCard(cv, pId, 'IMG'); URL.revokeObjectURL(url);
            };
        }

        function createCard(cv, pId, label) {
            const card = document.createElement('div'); card.className = 'page-card'; card.id = pId;
            card.innerHTML = `<div style="position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.7);color:white;font-size:10px;padding:4px 10px;border-radius:6px;z-index:10;font-weight:bold;">${label}</div><div class="cv-wrap"></div><div style="margin-top:15px;display:flex;justify-content:center;gap:10px;"><button class="tab-btn" style="font-size:11px;padding:6px 15px;" onclick="event.stopPropagation(); rotateP('${pId}'); snapshot();">æ—‹è½‰</button><button class="tab-btn" style="font-size:11px;padding:6px 15px;" onclick="event.stopPropagation(); delP('${pId}'); snapshot();">åˆªé™¤</button></div>`;
            card.querySelector('.cv-wrap').appendChild(cv);
            card.onclick = () => {
                const p = pagesData.find(x => x.pId === pId); p.selected = !p.selected;
                card.classList.toggle('selected');
                const side = document.getElementById('side-wrap-'+pId); if(side) side.classList.toggle('active');
                sigTargetId = pId;
            };
            document.getElementById('org-grid').appendChild(card);
            const sWrap = document.createElement('div'); sWrap.className = 'side-thumb-wrap'; sWrap.id = 'side-wrap-'+pId;
            const scv = document.createElement('canvas'); scv.width = cv.width; scv.height = cv.height; scv.style.width = '100%';
            scv.getContext('2d').drawImage(cv, 0, 0);
            scv.onclick = () => document.getElementById(pId).scrollIntoView({behavior:'smooth', block:'center'});
            sWrap.appendChild(scv); document.getElementById('side-grid').appendChild(sWrap);
        }

        // --- åŠŸèƒ½æ¨¡çµ„ ---
        function rotateP(pId) {
            const p = pagesData.find(x => x.pId === pId); if(!p) return;
            p.rot = (p.rot + 90) % 360;
            const mainCv = document.getElementById(pId).querySelector('canvas');
            mainCv.className = `rot-${p.rot}`;
            const sideCv = document.querySelector('#side-wrap-' + pId + ' canvas');
            if (sideCv) sideCv.className = `rot-${p.rot}`;
        }

        function rotateAll90() { pagesData.forEach(p => rotateP(p.pId)); snapshot(); }

        function insertBlank() {
            const pId = crypto.randomUUID();
            pagesData.push({ fId: null, pIdx: 0, rot: 0, pId, type: 'blank', selected: false, fileName: 'Blank' });
            const cv = document.createElement('canvas'); cv.width = 160; cv.height = 226;
            const ctx = cv.getContext('2d'); ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, 160, 226);
            createCard(cv, pId, 'ç©ºç™½'); snapshot();
        }

        function delP(pId) { pagesData = pagesData.filter(x => x.pId !== pId); document.getElementById(pId).remove(); const s = document.getElementById('side-wrap-'+pId); if(s) s.remove(); }

        function searchPDF() {
            const q = document.getElementById('search-input').value.toLowerCase();
            pagesData.forEach(p => {
                const card = document.getElementById(p.pId);
                const side = document.getElementById('side-wrap-' + p.pId);
                const hit = p.text && p.text.toLowerCase().includes(q);
                const show = !q || hit || p.type === 'img';
                if(card) card.style.display = show ? '' : 'none';
                if(side) side.style.display = show ? '' : 'none';
            });
        }

        async function processPdf(mode) {
            updateProgress(5, "è™•ç†ä¸­...");
            const zip = mode === 'split' ? new JSZip() : null;
            try {
                const mainDoc = mode === 'merge' ? await PDFDocument.create() : null;
                let mainFont = null;
                if (mainDoc) {
                    mainFont = await mainDoc.embedFont(StandardFonts.HelveticaBold);
                    mainDoc.setTitle(document.getElementById('m-title').value || "Merged");
                }
                const list = mode === 'split' ? pagesData.filter(p => p.selected) : pagesData;
                for (let i = 0; i < list.length; i++) {
                    const p = list[i];
                    let curDoc = mode === 'merge' ? mainDoc : await PDFDocument.create();
                    const curFont = mode === 'merge' ? mainFont : await curDoc.embedFont(StandardFonts.HelveticaBold);
                    let newPage;
                    if (p.type === 'pdf') {
                        if (!pdfCache[p.fId]) pdfCache[p.fId] = await PDFDocument.load(fileBuffers[p.fId]);
                        const [copy] = await curDoc.copyPages(pdfCache[p.fId], [p.pIdx]);
                        copy.setRotation(degrees((p.rot + (copy.getRotation().angle || 0)) % 360));
                        newPage = curDoc.addPage(copy);
                    } else if (p.type === 'img') {
                        const img = await curDoc.embedPng(await p.file.arrayBuffer());
                        const isRot = p.rot === 90 || p.rot === 270;
                        newPage = curDoc.addPage(isRot ? [img.height, img.width] : [img.width, img.height]);
                        newPage.drawImage(img, { x: isRot ? (p.rot === 90 ? img.height : 0) : 0, y: isRot ? (p.rot === 270 ? img.width : 0) : 0, width: img.width, height: img.height, rotate: degrees(p.rot) });
                    } else { newPage = curDoc.addPage([595, 842]); }
                    
                    const { width: pW, height: pH } = newPage.getSize();
                    const wm = document.getElementById('wm-text').value;
                    if(wm) {
                        let fS = pW / 12; while (curFont.widthOfTextAtSize(wm, fS) > pW * 0.75 && fS > 10) fS -= 2;
                        newPage.drawText(wm, { x: pW/2 - curFont.widthOfTextAtSize(wm, fS)/2, y: pH/2.2, size: fS, font: curFont, color: rgb(0.8, 0.8, 0.8), opacity: parseFloat(document.getElementById('wm-op').value), rotate: degrees(35) });
                    }
                    if (p.selected && sigImage) {
                        const sig = await curDoc.embedPng(sigImage);
                        const sW = pW / 4.5; const sH = sW * (sig.height / sig.width);
                        newPage.drawImage(sig, { x: pW - sW - 40, y: 40, width: sW, height: sH });
                    }
                    if (mode === 'split') {
                        const b = await curDoc.save(); zip.file(`${p.fileName.split('.')[0]}_P${i+1}.pdf`, b);
                    }
                    updateProgress(10 + (85 * (i/list.length)), `ç¬¬ ${i+1} é `);
                    if (i % 5 === 0) await new Promise(r => setTimeout(r, 0));
                }
                const bytes = await (mode === 'merge' ? mainDoc.save() : zip.generateAsync({type:'blob'}));
                if (isMobile && mode === 'merge') {
                    window.open(URL.createObjectURL(new Blob([bytes], {type:'application/pdf'})));
                } else {
                    download(bytes, mode === 'merge' ? `${document.getElementById('m-title').value}.pdf` : `Splits.zip`, mode === 'merge' ? 'application/pdf' : 'application/zip');
                }
            } catch (e) { alert(e.message); }
            updateProgress(0);
        }

        async function exportAsImage() {
            const p = pagesData.find(x => x.pId === sigTargetId); if (!p) return alert("é¸å–é é¢");
            const cv = document.createElement('canvas'); const ctx = cv.getContext('2d');
            if (p.type === 'pdf') {
                const pdf = await pdfjsLib.getDocument({ data: fileBuffers[p.fId] }).promise;
                const page = await pdf.getPage(p.pIdx + 1);
                const vp = page.getViewport({ scale: 4.0, rotation: p.rot });
                cv.width = vp.width; cv.height = vp.height;
                await page.render({ canvasContext: ctx, viewport: vp }).promise;
            } else {
                const img = new Image(); const u = URL.createObjectURL(p.file); img.src = u; await new Promise(r => img.onload = r);
                if (p.rot % 180 !== 0) { cv.width = img.naturalHeight; cv.height = img.naturalWidth; } else { cv.width = img.naturalWidth; cv.height = img.naturalHeight; }
                ctx.translate(cv.width/2, cv.height/2); ctx.rotate(p.rot * Math.PI/180); ctx.drawImage(img, -img.naturalWidth/2, -img.naturalHeight/2);
                URL.revokeObjectURL(u);
            }
            cv.toBlob(b => download(b, `HD.jpg`, 'image/jpeg'), 'image/jpeg', 0.95);
        }

        const sigCanvas = document.getElementById('sig-canvas'); const sCtx = sigCanvas.getContext('2d'); let draw = false;
        function getXY(e) { const r = sigCanvas.getBoundingClientRect(); const cX = e.clientX || (e.touches && e.touches[0].clientX); const cY = e.clientY || (e.touches && e.touches[0].clientY); return { x: (cX-r.left)*(1200/r.width), y: (cY-r.top)*(600/r.height) }; }
        sigCanvas.onmousedown = sigCanvas.ontouchstart = (e) => { draw = true; const p = getXY(e); sCtx.lineWidth = 5; sCtx.beginPath(); sCtx.moveTo(p.x, p.y); e.preventDefault(); };
        sigCanvas.onmousemove = sigCanvas.ontouchmove = (e) => { if (draw) { const p = getXY(e); sCtx.lineTo(p.x, p.y); sCtx.stroke(); e.preventDefault(); } };
        window.onmouseup = window.ontouchend = () => draw = false;
        function clearSig() { sCtx.clearRect(0,0,1200,600); }
        function saveSig() { sigImage = sigCanvas.toDataURL(); alert('ç°½åå·²å„²å­˜'); }
        function switchTab(evt, tab) { document.querySelectorAll('.work-panel').forEach(p => p.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tab + '-panel').classList.add('active'); evt.currentTarget.classList.add('active'); }
        function updateProgress(v, t) { const b = document.getElementById('loader-bar'); const x = document.getElementById('loader-text'); b.style.width = v + '%'; b.style.opacity = v === 0 ? '0' : '1'; if(v>0){ x.style.display='block'; x.innerText=t; } else { x.style.display='none'; } }
        document.getElementById('side-toggle').onclick = (e) => { e.stopPropagation(); document.querySelector('.sidebar').classList.toggle('open'); };
        document.addEventListener('click', () => document.querySelector('.sidebar').classList.remove('open'));
        new Sortable(document.getElementById('org-grid'), { animation: 150, onEnd: () => {
            const order = Array.from(document.getElementById('org-grid').children).map(c => c.id);
            pagesData.sort((a,b) => order.indexOf(a.pId) - order.indexOf(b.pId));
            order.forEach(id => { const s = document.getElementById('side-wrap-'+id); if(s) document.getElementById('side-grid').appendChild(s); });
            snapshot();
        }});
    </script>
</body>
</html>
#viewer {
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#000;
}
canvas {
  background:#111;
  box-shadow:0 0 20px #000;
}

#ui-panel {
  width:260px;
  background:#05070d;
  border-left:1px solid #1e2a44;
  padding:10px;
  overflow:auto;
}
.section {
  margin-bottom:16px;
}
.section h3 {
  margin:6px 0;
  font-size:14px;
  color:#7fdcff;
}
#sig-canvas {
  border:1px solid #333;
  background:#fff;
  width:100%;
  height:120px;
  cursor:crosshair;
}
button {
  cursor:pointer;
}
</style>
</head>

<body>
<header>DTZ PDF v23.6ï½œå–®æª”å¯åŸ·è¡Œç‰ˆ</header>

<div id="app">
  <!-- å·¦å´ -->
  <div id="sidebar">
    <input id="search" placeholder="æœå°‹é ç¢¼â€¦" />
    <div id="thumbs"></div>
  </div>

  <!-- ä¸­å¤® -->
  <div id="main">
    <div id="toolbar">
      <input type="file" id="file" accept="application/pdf">
      <button onclick="prevPage()">â—€</button>
      <button onclick="nextPage()">â–¶</button>
      <span id="pageInfo">- / -</span>
      <button onclick="undo()">Undo</button>
      <button onclick="redo()">Redo</button>
      <button onclick="exportPDF()">åŒ¯å‡º PDF</button>
    </div>
    <div id="viewer">
      <canvas id="pdf-canvas"></canvas>
    </div>
  </div>

  <!-- å³å´ UI -->
  <div id="ui-panel">
    <div class="section">
      <h3>è¼¸å‡ºè¨­å®š</h3>
      <input id="m-title" placeholder="è¼¸å‡ºæª”å">
    </div>

    <div class="section">
      <h3>æµ®æ°´å°</h3>
      <input id="wm-text" placeholder="æµ®æ°´å°æ–‡å­—">
      <input id="wm-op" type="number" min="0" max="1" step="0.1" value="0.2">
      <button onclick="applyWatermark()">å¥—ç”¨</button>
    </div>

    <div class="section">
      <h3>ç°½å</h3>
      <canvas id="sig-canvas"></canvas>
      <div style="margin-top:6px;">
        <button onclick="clearSig()">æ¸…é™¤</button>
        <button onclick="applySig()">å¥—ç”¨åˆ°æ­¤é </button>
      </div>
    </div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let pdfDoc=null, pageNum=1, canvas=document.getElementById("pdf-canvas"),
ctx=canvas.getContext("2d");

let history=[], hIndex=-1;
let sigCanvas=document.getElementById("sig-canvas"),
sigCtx=sigCanvas.getContext("2d"), drawing=false;

function pushHistory(){
  history=history.slice(0,hIndex+1);
  history.push(canvas.toDataURL());
  hIndex++;
}

function undo(){
  if(hIndex>0){ hIndex--; restoreHistory(); }
}
function redo(){
  if(hIndex<history.length-1){ hIndex++; restoreHistory(); }
}
function restoreHistory(){
  let img=new Image();
  img.onload=()=>ctx.drawImage(img,0,0);
  img.src=history[hIndex];
}

document.getElementById("file").onchange=async e=>{
  const buf=await e.target.files[0].arrayBuffer();
  pdfDoc=await pdfjsLib.getDocument(buf).promise;
  renderPage(1);
  buildThumbs();
};

async function renderPage(num){
  pageNum=num;
  const page=await pdfDoc.getPage(num);
  const vp=page.getViewport({scale:1.5});
  canvas.width=vp.width; canvas.height=vp.height;
  await page.render({canvasContext:ctx,viewport:vp}).promise;
  document.getElementById("pageInfo").textContent=
    `${pageNum} / ${pdfDoc.numPages}`;
  pushHistory();
}

function prevPage(){ if(pageNum>1) renderPage(pageNum-1); }
function nextPage(){ if(pageNum<pdfDoc.numPages) renderPage(pageNum+1); }

async function buildThumbs(){
  const box=document.getElementById("thumbs");
  box.innerHTML="";
  for(let i=1;i<=pdfDoc.numPages;i++){
    const d=document.createElement("div");
    d.className="thumb";
    d.textContent="Page "+i;
    d.onclick=()=>renderPage(i);
    box.appendChild(d);
  }
}

function applyWatermark(){
  ctx.save();
  ctx.globalAlpha=parseFloat(wmOp.value);
  ctx.font="48px sans-serif";
  ctx.rotate(-0.4);
  ctx.fillText(wmText.value,50,canvas.height/2);
  ctx.restore();
  pushHistory();
}

sigCanvas.width=240; sigCanvas.height=120;
sigCanvas.onmousedown=e=>{drawing=true;sigCtx.moveTo(e.offsetX,e.offsetY);}
sigCanvas.onmousemove=e=>{
  if(!drawing) return;
  sigCtx.lineTo(e.offsetX,e.offsetY);
  sigCtx.stroke();
};
window.onmouseup=()=>drawing=false;

function clearSig(){
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
}
function applySig(){
  ctx.drawImage(sigCanvas,50,50,200,100);
  pushHistory();
}

async function exportPDF(){
  const pdf=await PDFLib.PDFDocument.create();
  const img=await pdf.embedPng(canvas.toDataURL());
  const p=pdf.addPage([canvas.width,canvas.height]);
  p.drawImage(img,{x:0,y:0,width:canvas.width,height:canvas.height});
  const bytes=await pdf.save();
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([bytes],{type:"application/pdf"}));
  a.download=(mTitle.value||"output")+".pdf";
  a.click();
}

search.oninput=()=>{
  [...thumbs.children].forEach(t=>{
    t.style.display=t.textContent.includes(search.value)?"":"none";
  });
};
</script>
</body>
</html>

