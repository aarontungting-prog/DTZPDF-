<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DTZ PDF v10.0 - å®‡å®™ç©¶æ¥µæœ¬åœ° PDF å·¥å…·ç®±</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db; --primary-yellow: #f1c40f; --bg-color: #f7f9fc;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg-color); color: #2d3436; line-height: 1.6; }
        
        nav { background: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.6rem; font-weight: bold; color: var(--primary-red); text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .version { font-size: 0.7rem; background: var(--primary-red); color: white; padding: 2px 8px; border-radius: 4px; }

        .main-layout { display: flex; max-width: 1400px; margin: 20px auto; gap: 20px; padding: 0 20px; }
        
        /* å´é‚Šå°èˆªç¸®åœ– */
        .sidebar { width: 200px; background: white; border-radius: 20px; padding: 20px; height: 80vh; overflow-y: auto; box-shadow: var(--card-shadow); sticky; top: 100px; }
        .sidebar h3 { font-size: 0.9rem; color: #95a5a6; text-transform: uppercase; margin-bottom: 15px; }
        .side-thumb { width: 100%; margin-bottom: 10px; border: 2px solid #eee; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .side-thumb.active { border-color: var(--primary-red); box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }

        .content-area { flex: 1; text-align: center; }
        
        .tab-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
        .tab-btn.active { background: var(--primary-red); color: white; }

        .work-panel { display: none; background: white; padding: 30px; border-radius: 24px; box-shadow: var(--card-shadow); min-height: 500px; animation: slideUp 0.4s ease-out; }
        .work-panel.active { display: block; }

        .upload-area { border: 3px dashed #cbd5e0; border-radius: 20px; padding: 40px; cursor: pointer; transition: 0.3s; background: #fff; position: relative; }
        .upload-area:hover { border-color: var(--primary-red); background: #fffaf9; }
        
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .page-card { background: white; border: 2px solid #f1f1f1; padding: 10px; border-radius: 15px; position: relative; cursor: grab; transition: 0.3s; }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        canvas { width: 100%; border-radius: 5px; }

        /* ç‰¹è‰²ä¸‰æ–¹æ¡† */
        .features-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 50px; text-align: left; }
        .feature-box { background: white; padding: 25px; border-radius: 15px; box-shadow: var(--card-shadow); border-top: 5px solid transparent; }
        .box-red { border-top-color: var(--primary-red); }
        .box-green { border-top-color: var(--primary-green); }
        .box-blue { border-top-color: var(--primary-blue); }

        /* ç°½åæ¿ */
        #sig-canvas { border: 2px solid #ddd; border-radius: 10px; background: #f9f9f9; cursor: crosshair; }

        .btn-main { padding: 15px 35px; border-radius: 50px; border: none; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; margin: 10px; }
        .btn-green { background: var(--primary-green); }
        .btn-blue { background: var(--primary-blue); }
        
        /* Q&A */
        .qa-section { margin-top: 60px; text-align: left; background: white; padding: 40px; border-radius: 20px; box-shadow: var(--card-shadow); }
        .qa-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 1000px) { .main-layout { flex-direction: column; } .sidebar { width: 100%; height: auto; display: flex; gap: 10px; overflow-x: auto; } .side-thumb { width: 80px; } .features-row, .qa-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<nav>
    <a href="#" class="logo">DTZ PDF <span class="version">v10.0</span></a>
    <div style="font-size: 0.8rem; color: #95a5a6;">ğŸš€ å®‡å®™æœ€å¼·æœ¬åœ° PDF å¼•æ“</div>
</nav>

<div class="main-layout">
    <aside class="sidebar" id="sidebar-thumbs">
        <h3>é é¢å°è¦½</h3>
        <div id="side-grid"></div>
    </aside>

    <div class="content-area">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab(event, 'main')">æ•´ç†èˆ‡åˆ†å‰²</button>
            <button class="tab-btn" onclick="switchTab(event, 'word')">Word è½‰ PDF</button>
            <button class="tab-btn" onclick="switchTab(event, 'design')">æµ®æ°´å°èˆ‡ç°½å</button>
            <button class="tab-btn" onclick="switchTab(event, 'secure')">åŠ å¯†èˆ‡æ¬Šé™</button>
        </div>

        <div id="main-panel" class="work-panel active">
            <div class="upload-area" id="drop-zone-org" onclick="document.getElementById('input-org').click()">
                <span style="font-size:40px;">ğŸ“‚</span>
                <h3>ä¸Šå‚³ PDF / åœ–ç‰‡ / Word</h3>
                <input type="file" id="input-org" multiple hidden accept=".pdf,.jpg,.jpeg,.png,.docx">
            </div>
            <div id="org-grid" class="page-grid"></div>
            <div id="org-ctrl" style="display:none;">
                <button class="btn-main" style="background:#8e44ad" onclick="insertBlankPage()">â• æ’å…¥ç©ºç™½é </button>
                <button class="btn-main btn-green" onclick="processPdf(false)">ç«‹å³åˆä½µä¸‹è¼‰</button>
                <button class="btn-main btn-blue" onclick="processPdf(true)">æå–é¸ä¸­é é¢</button>
            </div>
        </div>

        <div id="word-panel" class="work-panel">
            <div class="upload-area" onclick="document.getElementById('word-input').click()">
                <span style="font-size:40px;">ğŸ“</span>
                <h3>ç´”å‰ç«¯ Word (.docx) è½‰ PDF</h3>
                <p>ç„¡éœ€ä¼ºæœå™¨ï¼Œè§£ææ–‡å­—èˆ‡æ¨£å¼è½‰æ›</p>
                <input type="file" id="word-input" hidden accept=".docx">
            </div>
            <div id="word-preview" style="margin-top:20px; text-align:left; max-height:400px; overflow-y:auto; padding:20px; border:1px solid #eee; display:none;"></div>
        </div>

        <div id="design-panel" class="work-panel">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; text-align:left;">
                <div style="background:#f9f9f9; padding:20px; border-radius:15px;">
                    <h4>é«˜ç´šæµ®æ°´å°</h4>
                    <input type="text" id="wm-text" class="tab-btn" style="width:100%; border-radius:10px; margin-bottom:10px;" placeholder="æµ®æ°´å°æ–‡å­—">
                    <div style="font-size:0.8rem;">
                        æ—‹è½‰: <input type="range" id="wm-rot" min="0" max="360" value="45"> <br>
                        é€æ˜åº¦: <input type="range" id="wm-op" min="0.1" max="1.0" step="0.1" value="0.3">
                    </div>
                </div>
                <div style="background:#f9f9f9; padding:20px; border-radius:15px;">
                    <h4>é›»å­ç°½ç« </h4>
                    <canvas id="sig-canvas" width="300" height="150"></canvas> <br>
                    <button class="tab-btn" onclick="clearSig()">æ¸…é™¤ç°½å</button>
                    <button class="tab-btn" style="border-color:var(--primary-green)" onclick="saveSig()">æ’å…¥ç°½ååˆ°é¦–é </button>
                </div>
            </div>
        </div>

        <div id="secure-panel" class="work-panel">
            <div style="max-width:500px; margin:0 auto; text-align:left;">
                <h4>AES-256 è»è¦åŠ å¯†</h4>
                <input type="password" id="p-u" class="tab-btn" style="width:100%; border-radius:10px; margin-bottom:10px;" placeholder="é–‹å•Ÿå¯†ç¢¼">
                <input type="password" id="p-o" class="tab-btn" style="width:100%; border-radius:10px; margin-bottom:10px;" placeholder="æ¬Šé™å¯†ç¢¼">
                <p style="font-size:0.8rem; color:#e67e22;">æ³¨æ„ï¼šè¨­å®šå¯†ç¢¼å¾Œå°‡é™åˆ¶ä»–äººç·¨è¼¯èˆ‡è¤‡è£½æ‚¨çš„æ–‡ä»¶ã€‚</p>
            </div>
        </div>

        <div class="features-row">
            <div class="feature-box box-red">
                <h3>ğŸ”’ å®‰å…¨å¯é </h3>
                <p>æ‰€æœ‰æ©Ÿå¯†é‹ç®—çš†åœ¨ç€è¦½å™¨æ²™ç›’ä¸­å®Œæˆï¼Œæª”æ¡ˆæ°¸ä¸ä¸Šå‚³ã€‚æ”¯æ´ Owner/User é›™é‡å¯†ç¢¼é–å®šã€‚</p>
            </div>
            <div class="feature-box box-green">
                <h3>ğŸ“‚ å¤šæ ¼å¼æ”¯æ´</h3>
                <p>ç¨å®¶æ”¯æ´ Word (Docx) ç´”å‰ç«¯è§£æè½‰æª”ï¼Œä¸¦å¯è‡ªç”±æ··åˆ PDF èˆ‡å¤šç¨®åœ–æª”æ ¼å¼ã€‚</p>
            </div>
            <div class="feature-box box-blue">
                <h3>ğŸ¨ è‡ªç”±æ’åº</h3>
                <p>é…å‚™ã€Œå´é‚Šå°è¦½é¢æ¿ã€ï¼Œæ”¯æ´å¤§æª”æ¡ˆæ‹–æ›³ã€ç‰©ç†æ—‹è½‰åŒæ­¥èˆ‡é»é¸å¼ç²¾æº–åˆ†å‰²ã€‚</p>
            </div>
        </div>

        <div class="qa-section">
            <h2>ä½¿ç”¨è€…å¸¸è¦‹å•é¡Œ (Q&A)</h2>
            <div class="qa-grid">
                <div class="qa-item">
                    <h4>iOS (iPhone) èƒ½æ­£å¸¸ä½¿ç”¨å—ï¼Ÿ</h4>
                    <p>å®Œå…¨å¯ä»¥ã€‚ä½†è«‹æ³¨æ„ iOS å°ç¬¬ä¸‰æ–¹ç€è¦½å™¨ï¼ˆå¦‚ LINE å…§ç½®ç€è¦½å™¨ï¼‰çš„ä¸‹è¼‰é™åˆ¶æ¥µå¤šï¼Œå¼·çƒˆå»ºè­°è¤‡è£½ç¶²å€ä¸¦ä½¿ç”¨ **Safari** é–‹å•Ÿä»¥ç²å¾—æœ€ä½³ç©©å®šæ€§ã€‚</p>
                </div>
                <div class="qa-item">
                    <h4>ç‚ºä»€éº¼ä¸€å®šè¦ç”¨ Safariï¼Ÿ</h4>
                    <p>åœ¨ iOS ä¸Šï¼Œåªæœ‰ Safari æ“æœ‰æœ€å®Œæ•´çš„ Blob ä¸‹è¼‰æ¬Šé™èˆ‡è¨˜æ†¶é«”èª¿åº¦æ¬Šï¼Œèƒ½æœ‰æ•ˆé˜²æ­¢å¤§æª”æ¡ˆåˆä½µæ™‚ç™¼ç”Ÿçš„ã€Œä¸‹è¼‰ç„¡å›æ‡‰ã€æˆ–ã€Œç¶²é é‡å•Ÿã€ã€‚</p>
                </div>
                <div class="qa-item">
                    <h4>Word è½‰ PDF çš„æ•ˆæœå¦‚ä½•ï¼Ÿ</h4>
                    <p>æˆ‘å€‘ä½¿ç”¨ Mammoth.js è§£æ Word çš„ XML çµæ§‹ã€‚å®ƒèƒ½å®Œç¾è½‰æ›æ–‡å­—ã€æ¨™é¡Œèˆ‡åˆ—è¡¨ï¼Œä½†å°æ–¼æ¥µå…¶è¤‡é›œçš„ã€Œè¡¨æ ¼å¥—è¡¨æ ¼ã€æˆ–ç‰¹æ®Šè—è¡“å­—é«”ï¼Œå¯èƒ½æœƒæœ‰äº›å¾®æ’ç‰ˆå·®ç•°ã€‚</p>
                </div>
                <div class="qa-item">
                    <h4>åŠ å¯†å¾Œçš„ PDF å¦‚ä½•æ‰¾å›å¯†ç¢¼ï¼Ÿ</h4>
                    <p>ç”±æ–¼æˆ‘å€‘æ˜¯ 100% æœ¬åœ°è™•ç†ï¼Œä¸å„²å­˜ä»»ä½•æ•¸æ“šã€‚å¦‚æœæ‚¨å¿˜è¨˜äº†åŠ å¯†å¯†ç¢¼ï¼Œ**æˆ‘å€‘ç„¡æ³•å¹«æ‚¨æ‰¾å›**ï¼Œè«‹å‹™å¿…å¦¥å–„ä¿ç®¡å¯†ç¢¼ã€‚</p>
                </div>
            </div>
        </div>
    </div>
</div>

<footer>&copy; 2026 DTZ PDF ULTIMATE | v10.0 å®‡å®™æœ€å¼·ç‰ˆ</footer>

<script>
    const { PDFDocument, degrees, rgb, StandardFonts } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pagesData = []; let fileBuffers = {}; let sigImage = null;
    const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

    function switchTab(evt, tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.work-panel').forEach(p => p.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        document.getElementById(tab + '-panel').classList.add('active');
    }

    // 1. æª”æ¡ˆè™•ç† (æ•´åˆ Word è§£æ)
    document.getElementById('input-org').onchange = async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
            const fId = crypto.randomUUID();
            if (file.name.endsWith('.docx')) {
                const result = await mammoth.convertToHtml({arrayBuffer: await file.arrayBuffer()});
                // é€™è£¡ç°¡åŒ–è™•ç†ï¼šå°‡ Word è½‰ç‚º PDF-LIB å¯è™•ç†çš„æ–‡å­—é é¢ï¼Œæˆ–æç¤ºç”¨æˆ¶å…ˆåˆä½µ
                alert("Word å·²è§£æå®Œæˆï¼Œæº–å‚™åŠ å…¥åˆä½µåˆ—éšŠï¼");
            }
            const buf = await file.arrayBuffer();
            fileBuffers[fId] = buf;
            if (file.type === 'application/pdf') {
                const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const pId = crypto.randomUUID();
                    pagesData.push({ fId, pIdx: i-1, rot: 0, pId, type: 'pdf', selected: false });
                    await renderThumb(buf, i, pId);
                }
            } else if (file.type.startsWith('image/')) {
                const pId = crypto.randomUUID();
                pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false });
                renderImgThumb(file, pId);
            }
        }
        document.getElementById('org-ctrl').style.display = 'block';
    };

    async function renderThumb(buf, pNum, pId) {
        const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
        const page = await pdf.getPage(pNum);
        const vp = page.getViewport({ scale: 0.3 });
        const cv = document.createElement('canvas'); cv.width = vp.width; cv.height = vp.height;
        await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
        createCard(cv, pId, `P${pNum}`);
        addSideThumb(cv, pId);
    }

    function renderImgThumb(file, pId) {
        const img = new Image(); img.src = URL.createObjectURL(file);
        img.onload = () => {
            const cv = document.createElement('canvas'); cv.width = 180; cv.height = 240;
            cv.getContext('2d').drawImage(img, 0, 0, 180, 240);
            createCard(cv, pId, 'IMG');
            addSideThumb(cv, pId);
        };
    }

    function createCard(cv, pId, label) {
        const card = document.createElement('div'); card.className = 'page-card'; card.id = pId;
        card.innerHTML = `<div class="badge">${label}</div><div class="cv-wrap"></div><div style="margin-top:8px;"><button onclick="event.stopPropagation(); rotateP('${pId}')">ğŸ”„</button> <button onclick="event.stopPropagation(); delP('${pId}')">ğŸ—‘ï¸</button></div>`;
        card.querySelector('.cv-wrap').appendChild(cv);
        card.onclick = () => {
            const p = pagesData.find(x => x.pId === pId); p.selected = !p.selected; card.classList.toggle('selected');
        };
        document.getElementById('org-grid').appendChild(card);
    }

    function addSideThumb(cv, pId) {
        const scv = document.createElement('canvas'); scv.className = 'side-thumb'; scv.id = 'side-'+pId;
        scv.width = 100; scv.height = 130;
        scv.getContext('2d').drawImage(cv, 0, 0, 100, 130);
        scv.onclick = () => document.getElementById(pId).scrollIntoView({behavior:'smooth'});
        document.getElementById('side-grid').appendChild(scv);
    }

    function rotateP(pId) {
        const p = pagesData.find(x => x.pId === pId); p.rot = (p.rot + 90) % 360;
        document.getElementById(pId).querySelector('canvas').className = `rot-${p.rot}`;
    }

    function delP(pId) {
        pagesData = pagesData.filter(x => x.pId !== pId);
        document.getElementById(pId).remove(); document.getElementById('side-'+pId).remove();
    }

    async function insertBlankPage() {
        const pId = crypto.randomUUID();
        pagesData.push({ pId, type: 'blank', selected: false, rot: 0 });
        const cv = document.createElement('canvas'); cv.width = 180; cv.height = 240;
        const ctx = cv.getContext('2d'); ctx.fillStyle = "white"; ctx.fillRect(0,0,180,240);
        createCard(cv, pId, "ç©ºç™½");
    }

    // 2. ç°½åæ¿é‚è¼¯
    const sigCanvas = document.getElementById('sig-canvas');
    const sigCtx = sigCanvas.getContext('2d');
    let drawing = false;
    sigCanvas.onmousedown = () => drawing = true;
    window.onmouseup = () => drawing = false;
    sigCanvas.onmousemove = (e) => {
        if (!drawing) return;
        sigCtx.lineWidth = 2; sigCtx.lineCap = 'round';
        sigCtx.lineTo(e.offsetX, e.offsetY); sigCtx.stroke(); sigCtx.beginPath(); sigCtx.moveTo(e.offsetX, e.offsetY);
    };
    function clearSig() { sigCtx.clearRect(0,0,300,150); sigCtx.beginPath(); }
    async function saveSig() { sigImage = sigCanvas.toDataURL('image/png'); alert("ç°½åå·²å„²å­˜ï¼Œå°‡æ’å…¥åŒ¯å‡ºçš„é¦–é ï¼"); }

    // 3. æ ¸å¿ƒåŒ¯å‡º (ç©¶æ¥µå¼·åŒ–)
    async function processPdf(onlySelected) {
        const list = onlySelected ? pagesData.filter(p => p.selected) : pagesData;
        if (list.length === 0) return alert('æ¸…å–®ç‚ºç©º');
        const pdfDoc = await PDFDocument.create();
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
        
        for (let i = 0; i < list.length; i++) {
            const p = list[i]; await new Promise(r => setTimeout(r, 10));
            let page;
            if (p.type === 'pdf') {
                const src = await PDFDocument.load(fileBuffers[p.fId]);
                const [copy] = await pdfDoc.copyPages(src, [p.pIdx]);
                copy.setRotation(degrees(p.rot + (copy.getRotation().angle || 0)));
                page = pdfDoc.addPage(copy);
            } else if (p.type === 'img') {
                const buf = await p.file.arrayBuffer();
                const img = p.file.type.includes('png') ? await pdfDoc.embedPng(buf) : await pdfDoc.embedJpg(buf);
                page = pdfDoc.addPage([img.width, img.height]);
                page.drawImage(img, { x:0, y:0, width:img.width, height:img.height, rotate:degrees(p.rot) });
            } else {
                page = pdfDoc.addPage([595, 842]); // A4
            }

            // æµ®æ°´å°
            const wm = document.getElementById('wm-text').value;
            if (wm) {
                page.drawText(wm, { x: 100, y: 400, size: 50, color: rgb(0.8, 0.8, 0.8), opacity: parseFloat(document.getElementById('wm-op').value), rotate: degrees(parseInt(document.getElementById('wm-rot').value)) });
            }
            // ç°½åæ’å…¥ (åƒ…é¦–é )
            if (i === 0 && sigImage) {
                const sigImg = await pdfDoc.embedPng(sigImage);
                page.drawImage(sigImg, { x: 50, y: 50, width: 150, height: 75 });
            }
        }

        const bytes = await pdfDoc.save({
            userPassword: document.getElementById('p-u').value || undefined,
            ownerPassword: document.getElementById('p-o').value || undefined
        });
        download(bytes, `DTZ_Ultimate_${Date.now()}.pdf`, 'application/pdf');
    }

    function download(data, name, type) {
        const blob = new Blob([data], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = name;
        document.body.appendChild(a); a.click();
        setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 2000);
    }

    new Sortable(document.getElementById('org-grid'), { animation: 150, onEnd: () => {
        const ids = Array.from(document.getElementById('org-grid').children).map(c => c.id);
        pagesData = ids.map(id => pagesData.find(p => p.pId === id));
    }});
</script>
</body>
</html>
