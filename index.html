<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DTZ PDF 7.0 - å°ˆæ¥­ç´šæœ¬åœ° PDF å·¥å…·ç®±</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c;
            --primary-green: #2ecc71;
            --primary-blue: #3498db;
            --primary-yellow: #f1c40f;
            --bg-color: #f7f9fc;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg-color); color: #2d3436; overflow-x: hidden; }
        
        /* å°è¦½åˆ— */
        nav { background: white; padding: 1rem 10%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.6rem; font-weight: bold; color: var(--primary-red); text-decoration: none; letter-spacing: -1px; }
        .nav-status { font-size: 0.8rem; color: #95a5a6; border: 1px solid #eee; padding: 4px 12px; border-radius: 20px; }

        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; text-align: center; }
        h1 { font-size: 2.8rem; margin-bottom: 10px; font-weight: 800; color: #2d3436; }
        .subtitle { color: #636e72; margin-bottom: 40px; font-size: 1.1rem; line-height: 1.6; }

        /* å…¨åŸŸé€²åº¦æ¢ */
        #progress-container { display: none; width: 80%; margin: 20px auto; background: #eee; border-radius: 10px; height: 8px; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(to right, var(--primary-red), #ff7675); transition: width 0.3s; }

        /* å·¥å…· Tab */
        .tab-nav { display: flex; justify-content: center; gap: 15px; margin-bottom: 35px; flex-wrap: wrap; }
        .tab-btn { padding: 14px 28px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: bold; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--primary-red); color: white; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }

        /* å·¥ä½œé¢æ¿ */
        .work-panel { display: none; background: white; padding: 40px; border-radius: 24px; box-shadow: var(--card-shadow); min-height: 450px; }
        .work-panel.active { display: block; animation: slideUp 0.4s ease-out; }

        /* ç¶“å…¸ä¸Šå‚³å€ */
        .upload-area { border: 3px dashed #cbd5e0; border-radius: 20px; padding: 70px 20px; cursor: pointer; transition: 0.3s; margin-bottom: 25px; position: relative; }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary-red); background: #fffaf9; transform: translateY(-2px); }
        .upload-icon { font-size: 60px; margin-bottom: 15px; display: block; }

        /* é è¦½ç¶²æ ¼ */
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px; margin-top: 30px; }
        .page-card { background: white; border: 2px solid #f1f1f1; padding: 12px; border-radius: 18px; position: relative; cursor: grab; transition: 0.3s; }
        .page-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        .page-card canvas { width: 100%; border-radius: 8px; transition: transform 0.3s; background: #eee; }
        
        .badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 3px 10px; border-radius: 6px; font-size: 11px; z-index: 10; }
        .select-check { position: absolute; top: -10px; right: -10px; width: 32px; height: 32px; background: var(--primary-green); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-weight: bold; z-index: 20; }
        .selected .select-check { display: flex; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .controls { display: flex; justify-content: center; gap: 15px; margin-top: 35px; flex-wrap: wrap; }
        .btn-main { padding: 16px 45px; border-radius: 50px; border: none; font-size: 1.15rem; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; }
        .btn-main:disabled { background: #cbd5e0 !important; cursor: not-allowed; transform: none !important; }
        .btn-green { background: var(--primary-green); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3); }
        .btn-blue { background: var(--primary-blue); box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }

        /* ç¶“å…¸ä¸‰æ–¹æ¡† */
        .features { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-top: 80px; text-align: left; }
        .feature-card { background: white; padding: 35px; border-radius: 20px; box-shadow: var(--card-shadow); transition: 0.3s; border-top: 6px solid var(--primary-red); }
        .feature-card:hover { transform: translateY(-10px); }
        .card-green { border-top-color: var(--primary-green); }
        .card-yellow { border-top-color: var(--primary-yellow); }

        /* æ—‹è½‰æ§åˆ¶ */
        .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }

        /* Q&A å€å¡Š */
        .qa-section { margin-top: 80px; text-align: left; background: white; padding: 45px; border-radius: 24px; box-shadow: var(--card-shadow); }
        .qa-section h2 { font-size: 1.8rem; margin-bottom: 25px; color: var(--primary-red); }
        .qa-item { margin-bottom: 25px; border-bottom: 1px solid #f1f1f1; padding-bottom: 20px; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 850px) { .features { grid-template-columns: 1fr; } .page-grid { grid-template-columns: repeat(2, 1fr); } h1 { font-size: 2rem; } }
        footer { margin: 80px 0 40px; color: #b2bec3; font-size: 0.9rem; font-weight: 500; }
    </style>
</head>
<body>

<nav>
    <a href="#" class="logo">DTZ PDF 7.0</a>
    <div class="nav-status">ç€è¦½å™¨æœ¬åœ°é‹ç®—æ¨¡å¼ | 100% éš±ç§</div>
</nav>

<div class="container">
    <div id="progress-container"><div id="progress-bar"></div></div>

    <h1>å°ˆæ¥­ PDF æ——è‰¦å·¥å…·ç®±</h1>
    <p class="subtitle">
        é€™æ˜¯ä¸€æ¬¾çœŸæ­£å°ˆæ³¨æ–¼<span class="highlight-text">ç©©å®šæ€§èˆ‡éš±ç§</span>çš„ PDF åˆä½µèˆ‡çµ„ç¹”å·¥å…·ã€‚<br>
        æ‰€æœ‰è™•ç†çš†åœ¨æ‚¨çš„è¨­å‚™ä¸Šå®Œæˆï¼Œæª”æ¡ˆçµ•ä¸ä¸Šå‚³ï¼Œç¢ºä¿æ©Ÿå¯†å®‰å…¨ã€‚
    </p>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab(event, 'organize')">æ•´ç†ã€åˆä½µèˆ‡åˆ†å‰²</button>
        <button class="tab-btn" onclick="switchTab(event, 'convert')">PDF è½‰åœ–ç‰‡ (ZIP)</button>
        <button class="tab-btn" onclick="switchTab(event, 'meta')">è‡ªå®šç¾©æ–‡ä»¶è³‡è¨Š</button>
    </div>

    <div id="organize-panel" class="work-panel active">
        <div class="upload-area" id="drop-zone-org">
            <span class="upload-icon">ğŸ“‚</span>
            <h3 style="margin:0;">é»æ“Šæˆ–æ‹–æ”¾ PDF / åœ–ç‰‡</h3>
            <p style="color:#95a5a6; font-size:0.9rem; margin-top:10px;">æ”¯æ´å¤šæª”æ¡ˆæ’åºã€å–®é æ—‹è½‰ã€é»é¸å¼åˆ†å‰²</p>
            <input type="file" id="input-org" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div id="org-grid" class="page-grid"></div>
        <div id="org-ctrl" class="controls" style="display:none;">
            <button class="btn-main btn-green" onclick="processPdf(false)">åˆä½µåŒ¯å‡ºå…¨éƒ¨æ–‡ä»¶</button>
            <button class="btn-main btn-blue" onclick="processPdf(true)">åŒ¯å‡ºæ‰€é¸é é¢ (åˆ†å‰²)</button>
        </div>
    </div>

    <div id="convert-panel" class="work-panel">
        <div class="upload-area" id="drop-zone-conv">
            <span class="upload-icon">ğŸ–¼ï¸</span>
            <h3 style="margin:0;">ä¸Šå‚³ PDF è½‰æ›ç‚ºé«˜æ¸…åœ–æª”</h3>
            <input type="file" id="input-conv" hidden accept=".pdf">
        </div>
        <div style="margin: 20px 0; background: #f8f9fa; padding: 15px; border-radius: 15px;">
            æ ¼å¼ï¼š<select id="img-format" style="padding:5px 10px; border-radius:5px;"><option value="image/jpeg">JPEG</option><option value="image/png">PNG</option></select>
            &nbsp; å“è³ªï¼š<input type="range" id="img-quality" min="0.1" max="1.0" step="0.1" value="0.8">
        </div>
        <div id="conv-grid" class="page-grid"></div>
        <div id="conv-ctrl" class="controls" style="display:none;">
            <button class="btn-main btn-blue" onclick="downloadZip()">ä¸€éµæ‰“åŒ…æ‰€æœ‰åœ–ç‰‡ (ZIP)</button>
        </div>
    </div>

    <div id="meta-panel" class="work-panel">
        <div style="max-width: 500px; margin: 0 auto; text-align: left;">
            <h3 style="color:var(--primary-red);">è‡ªå®šç¾©æ–‡ä»¶ Metadata</h3>
            <p style="font-size: 0.9rem; color: #636e72; margin-bottom: 25px;">åœ¨æ­¤è¨­å®šçš„è³‡è¨Šå°‡åœ¨åŒ¯å‡º PDF æ™‚è‡ªå‹•å¯«å…¥æª”æ¡ˆå±¬æ€§ã€‚</p>
            <label style="font-weight:bold;">æ–‡ä»¶æ¨™é¡Œï¼š</label>
            <input type="text" id="meta-title" placeholder="é è¨­ï¼šDTZ PDF Merged" style="width:100%; padding:14px; margin:10px 0; border-radius:12px; border:1px solid #ddd;">
            <label style="font-weight:bold;">ä½œè€…åç¨±ï¼š</label>
            <input type="text" id="meta-author" placeholder="æ‚¨çš„åå­—" style="width:100%; padding:14px; margin:10px 0; border-radius:12px; border:1px solid #ddd;">
            <label style="font-weight:bold;">é—œéµå­—ï¼š</label>
            <input type="text" id="meta-keys" placeholder="ä»¥é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼šåˆç´„, 2026, å ±å‘Š" style="width:100%; padding:14px; margin:10px 0; border-radius:12px; border:1px solid #ddd;">
        </div>
    </div>

    <div class="features">
        <div class="feature-card">
            <h3 style="color:var(--primary-red);">ğŸ”’ çµ•å°å®‰å…¨</h3>
            <p>æ¡ç”¨ Web-Workers èˆ‡æœ¬åœ° Blob æŠ€è¡“ï¼Œæ•¸æ“šé‹ç®—å®Œå…¨åœ¨ç€è¦½å™¨æ²™ç›’ä¸­å®Œæˆï¼Œæ²’æœ‰ä¼ºæœå™¨ç´€éŒ„ï¼Œéš±ç§ç„¡æ†‚ã€‚</p>
        </div>
        <div class="feature-card card-green">
            <h3 style="color:var(--primary-green);">ğŸ¨ é»é¸å¼åˆ†å‰²</h3>
            <p>ä¸å†éœ€è¦èƒŒé ç¢¼ã€‚é€éé è¦½ç¸®åœ–ï¼Œç›´æ¥é»æ“Šé é¢å³å¯é¸ä¸­ï¼Œè®“ã€Œæå–ç‰¹å®šé é¢ã€åƒé¸ç…§ç‰‡ä¸€æ¨£ç°¡å–®ç›´è¦ºã€‚</p>
        </div>
        <div class="feature-card card-yellow">
            <h3 style="color:var(--primary-yellow);">âš¡ æ€§èƒ½å„ªåŒ–</h3>
            <p>å°ˆç‚ºè¡Œå‹•è£ç½®æ‰“é€ çš„ã€Œå‘¼å¸è£œä¸ã€èˆ‡ã€Œæ™ºæ…§åœ–ç‰‡ç¸®æ”¾ã€æ©Ÿåˆ¶ï¼Œå¤§å¹…é™ä½å¤§æª”æ¡ˆè™•ç†æ™‚çš„è¨˜æ†¶é«”å£“åŠ›ã€‚</p>
        </div>
    </div>

    <div class="qa-section">
        <h2>ä½¿ç”¨è€…å¸¸è¦‹å•é¡Œ (Q&A)</h2>
        <div class="qa-item">
            <h4>ã€Œç‰©ç†æ—‹è½‰æ ¡æ­£ã€æ˜¯ä»€éº¼ï¼Ÿ</h4>
            <p>è¨±å¤š PDF é é¢åŸå§‹å¸¶æœ‰æ—‹è½‰åƒæ•¸ï¼ˆä¾‹å¦‚æ©«å‘æƒææª”ï¼‰ã€‚DTZ PDF åœ¨åŒ¯å‡ºæ™‚æœƒè‡ªå‹•ç´¯åŠ æ‚¨çš„æ‰‹å‹•æ—‹è½‰èˆ‡åŸå§‹åƒæ•¸ï¼Œç¢ºä¿åœ¨ä»»ä½• PDF é–±è®€å™¨ä¸­çœ‹åˆ°çš„æ–¹å‘éƒ½ä¸€è‡´ã€‚</p>
        </div>
        <div class="qa-item">
            <h4>è™•ç†å¤§æª”æ¡ˆæœƒé–ƒé€€å—ï¼Ÿ</h4>
            <p>é‡å°å¤šé  PDFï¼Œæˆ‘å€‘æ¡ç”¨äº†åˆ†æ‰¹æ¸²æŸ“æŠ€è¡“ï¼ˆBatch Renderingï¼‰ã€‚è‹¥è™•ç†æ•¸ç™¾é æª”æ¡ˆï¼Œå»ºè­°ä½¿ç”¨é›»è…¦ç‰ˆç€è¦½å™¨ç²å¾—æœ€ä½³æ•ˆèƒ½ï¼Œæ‰‹æ©Ÿç«¯å»ºè­°ä¸€æ¬¡è™•ç† 10-20 é ã€‚</p>
        </div>
    </div>
</div>

<footer>&copy; 2026 DTZ PDF | å…¨èƒ½å°ˆæ¥­æ——è‰¦ç‰ˆ</footer>

<script>
    const { PDFDocument, degrees, PDFDate } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pagesData = [];
    let fileBuffers = {};
    let zipBlobs = [];
    const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

    function switchTab(evt, tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.work-panel').forEach(p => p.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        document.getElementById(tab + '-panel').classList.add('active');
    }

    // --- æ‹–æ”¾äº‹ä»¶åˆå§‹åŒ– ---
    function initDragArea(id, inputId) {
        const zone = document.getElementById(id);
        zone.onclick = () => document.getElementById(inputId).click();
        zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('dragover'); };
        zone.ondragleave = () => zone.classList.remove('dragover');
        zone.ondrop = (e) => { e.preventDefault(); zone.classList.remove('dragover'); handleFiles(e.dataTransfer.files, inputId); };
    }
    initDragArea('drop-zone-org', 'input-org');
    initDragArea('drop-zone-conv', 'input-conv');

    document.getElementById('input-org').onchange = (e) => handleFiles(e.target.files, 'input-org');
    document.getElementById('input-conv').onchange = (e) => handleFiles(e.target.files, 'input-conv');

    async function handleFiles(files, type) {
        if (files.length === 0) return;
        updateProgress(5);
        
        try {
            if (type === 'input-org') {
                for (const file of Array.from(files)) {
                    const fId = crypto.randomUUID();
                    const buf = await file.arrayBuffer();
                    fileBuffers[fId] = buf;
                    
                    if (file.type === 'application/pdf') {
                        const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const pId = crypto.randomUUID();
                            pagesData.push({ fId, pIdx: i-1, rot: 0, pId, type: 'pdf', selected: false });
                            await renderThumb(buf, i, pId, 'org-grid');
                            if (i % 8 === 0) await new Promise(r => setTimeout(r, 0)); // å‘¼å¸è£œä¸
                        }
                    } else if (file.type.startsWith('image/')) {
                        const pId = crypto.randomUUID();
                        pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false });
                        await renderImgThumb(file, pId, 'org-grid');
                    }
                }
                document.getElementById('org-ctrl').style.display = 'flex';
            } else {
                await processToImages(files[0]);
            }
        } catch (e) { alert('è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚'); }
        updateProgress(0);
    }

    async function renderThumb(buf, pNum, pId, gridId) {
        const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
        const page = await pdf.getPage(pNum);
        const vp = page.getViewport({ scale: isMobile ? 0.35 : 0.55 });
        const cv = document.createElement('canvas');
        cv.width = vp.width; cv.height = vp.height;
        await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
        createCard(cv, pId, gridId, `ç¬¬ ${pNum} é `);
    }

    async function renderImgThumb(file, pId, gridId) {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await new Promise(r => img.onload = r);
        const cv = document.createElement('canvas');
        const sc = 200 / img.width;
        cv.width = 200; cv.height = img.height * sc;
        cv.getContext('2d').drawImage(img, 0, 0, cv.width, cv.height);
        createCard(cv, pId, gridId, 'åœ–ç‰‡å…§å®¹');
    }

    function createCard(cv, pId, gridId, label) {
        const card = document.createElement('div');
        card.className = 'page-card'; card.id = pId;
        card.innerHTML = `
            <div class="badge">${label}</div>
            <div class="select-check">âœ“</div>
            <div class="cv-wrap"></div>
            <div style="margin-top:10px; display:flex; justify-content:center; gap:8px;">
                <button onclick="event.stopPropagation(); rotatePage('${pId}')" style="font-size:11px; padding:4px 8px; cursor:pointer;">æ—‹è½‰</button>
                <button onclick="event.stopPropagation(); deletePage('${pId}')" style="font-size:11px; padding:4px 8px; cursor:pointer;">åˆªé™¤</button>
            </div>
        `;
        card.querySelector('.cv-wrap').appendChild(cv);
        card.onclick = () => {
            const p = pagesData.find(x => x.pId === pId);
            p.selected = !p.selected; card.classList.toggle('selected');
        };
        document.getElementById(gridId).appendChild(card);
    }

    function rotatePage(pId) {
        const p = pagesData.find(x => x.pId === pId);
        p.rot = (p.rot + 90) % 360;
        document.getElementById(pId).querySelector('canvas').className = `rot-${p.rot}`;
    }

    function deletePage(pId) {
        pagesData = pagesData.filter(x => x.pId !== pId);
        document.getElementById(pId).remove();
        if (pagesData.length === 0) document.getElementById('org-ctrl').style.display = 'none';
    }

    new Sortable(document.getElementById('org-grid'), { animation: 150, onEnd: () => {
        const ids = Array.from(document.getElementById('org-grid').children).map(c => c.id);
        pagesData = ids.map(id => pagesData.find(p => p.pId === id));
    }});

    // --- æ ¸å¿ƒåŒ¯å‡ºèˆ‡å°ˆæ¥­ Metadata æ¨¡æ¿ ---
    async function processPdf(onlySelected) {
        const list = onlySelected ? pagesData.filter(p => p.selected) : pagesData;
        if (list.length === 0) return alert('æ¸…å–®ç‚ºç©ºæˆ–å°šæœªé¸å–ä»»ä½•é é¢ã€‚');
        
        toggleUI(true); updateProgress(10);
        
        try {
            const pdfDoc = await PDFDocument.create();
            const now = new Date();
            const pdfDate = PDFDate.fromDate(now);

            // å°ˆæ¥­ Metadata è‡ªå‹•åŒ–
            pdfDoc.setTitle(document.getElementById('meta-title').value || "DTZ PDF Merged Document");
            pdfDoc.setAuthor(document.getElementById('meta-author').value || "DTZ PDF Engine");
            pdfDoc.setSubject("Processed via Local Privacy Tool");
            pdfDoc.setProducer("DTZ PDF 7.0 (Local Client)");
            pdfDoc.setCreationDate(now);
            pdfDoc.setModificationDate(now);
            
            const keys = (document.getElementById('meta-keys').value || "").split(',').map(k => k.trim()).filter(k => k);
            pdfDoc.setKeywords(keys);

            for (let i = 0; i < list.length; i++) {
                const p = list[i];
                await new Promise(r => setTimeout(r, 0)); // å‘¼å¸
                
                if (p.type === 'pdf') {
                    const src = await PDFDocument.load(fileBuffers[p.fId]);
                    const [copy] = await pdfDoc.copyPages(src, [p.pIdx]);
                    // ç‰©ç†è§’åº¦æ ¡æ­£ç´¯åŠ 
                    const baseRot = copy.getRotation().angle;
                    copy.setRotation(degrees(p.rot + baseRot));
                    pdfDoc.addPage(copy);
                } else {
                    const buf = await p.file.arrayBuffer();
                    const img = p.file.type.includes('png') ? await pdfDoc.embedPng(buf) : await pdfDoc.embedJpg(buf);
                    const limit = 1500; // æ™ºæ…§å£“ç¸®é˜²æ­¢ RAM æº¢å‡º
                    const sc = img.width > limit ? limit / img.width : 1;
                    const page = pdfDoc.addPage([img.width * sc, img.height * sc]);
                    page.drawImage(img, { x:0, y:0, width:img.width * sc, height:img.height * sc, rotate:degrees(p.rot) });
                }
                updateProgress(10 + (90 * (i/list.length)));
            }
            const bytes = await pdfDoc.save();
            download(bytes, `DTZ_PDF_${now.getTime()}.pdf`, 'application/pdf');
        } catch (err) { alert('åŒ¯å‡ºå¤±æ•—ï¼Œå¯èƒ½æ˜¯æª”æ¡ˆéå¤§æˆ–æå£ã€‚'); }
        toggleUI(false); updateProgress(0);
    }

    async function processToImages(file) {
        const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
        const grid = document.getElementById('conv-grid');
        const fmt = document.getElementById('img-format').value;
        const q = parseFloat(document.getElementById('img-quality').value);
        grid.innerHTML = ''; zipBlobs = []; updateProgress(5);
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const rot = page.rotate; // ç‰©ç†æ ¡æ­£é è¦½
            const vp = page.getViewport({ scale: isMobile ? 1.3 : 2.2, rotation: rot });
            const cv = document.createElement('canvas');
            cv.width = vp.width; cv.height = vp.height;
            await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
            
            const card = document.createElement('div');
            card.className = 'page-card'; card.innerHTML = `<div class="badge">ç¬¬ ${i} é  (é«˜æ¸…)</div>`;
            card.appendChild(cv); grid.appendChild(card);
            
            // ä¿®æ­£ Blob é †åºç«¶çˆ­ Bug
            const blob = await new Promise(res => cv.toBlob(res, fmt, q));
            zipBlobs.push({ blob, name: `Page_${i}.${fmt.split('/')[1]}` });
            updateProgress((i/pdf.numPages) * 100);
        }
        document.getElementById('conv-ctrl').style.display = 'flex';
        updateProgress(0);
    }

    async function downloadZip() {
        const zip = new JSZip();
        zipBlobs.forEach(x => zip.file(x.name, x.blob));
        const content = await zip.generateAsync({type:'blob'});
        download(content, 'DTZ_Images.zip', 'application/zip');
    }

    function toggleUI(disabled) {
        document.querySelectorAll('button').forEach(b => b.disabled = disabled);
    }

    function updateProgress(val) {
        const c = document.getElementById('progress-container');
        const b = document.getElementById('progress-bar');
        c.style.display = val > 0 ? 'block' : 'none';
        b.style.width = val + '%';
    }

    function download(data, name, type) {
        const blob = new Blob([data], { type });
        const url = URL.createObjectURL(blob);
        if (isMobile && type === 'application/pdf') {
            window.location.href = url;
        } else {
            const a = document.createElement('a'); a.href = url; a.download = name; a.click();
        }
    }
</script>
</body>
</html>
