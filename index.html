<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>DTZ PDF - å°ˆæ¥­ç´šæœ¬åœ°å…¨èƒ½å·¥å…·</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c;
            --primary-green: #2ecc71;
            --primary-yellow: #f1c40f;
            --primary-blue: #3498db;
            --bg-color: #f7f9fc;
            --text-dark: #2d3436;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, system-ui, -apple-system, sans-serif;
            margin: 0; background-color: var(--bg-color); color: var(--text-dark); line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }

        nav {
            background: white; padding: 1rem 10%; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000;
        }

        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary-red); text-decoration: none; }
        .nav-status { font-size: 0.85rem; color: #95a5a6; }

        .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; text-align: center; }

        h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .subtitle { color: #555; margin-bottom: 35px; font-size: 1.1rem; }
        .highlight-text { color: var(--primary-red); font-weight: bold; }

        /* åŠŸèƒ½åˆ†é  */
        .tab-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 25px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: bold; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--primary-red); color: white; }

        .work-panel { display: none; background: white; padding: 40px; border-radius: 20px; box-shadow: var(--card-shadow); min-height: 400px; }
        .work-panel.active { display: block; animation: fadeIn 0.3s; }

        /* ä¸Šå‚³å€é¢¨æ ¼ */
        .upload-area {
            background: white; border: 3px dashed #cbd5e0; border-radius: 20px;
            padding: 60px 40px; transition: all 0.3s ease; cursor: pointer;
        }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary-red); background-color: #fffaf9; }
        .upload-icon { font-size: 60px; color: var(--primary-red); margin-bottom: 20px; }

        /* é è¦½ç¶²æ ¼ */
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 30px; }
        .page-card { 
            background: white; border: 2px solid #eee; padding: 10px; border-radius: 15px; 
            position: relative; transition: 0.2s; cursor: grab;
        }
        .page-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        .page-card canvas { width: 100%; border-radius: 8px; transition: transform 0.3s ease; }

        /* æ—‹è½‰è§’åº¦ */
        .rot-0 { transform: rotate(0deg); }
        .rot-90 { transform: rotate(90deg); }
        .rot-180 { transform: rotate(180deg); }
        .rot-270 { transform: rotate(270deg); }

        .badge { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; z-index: 10; }
        .select-check { position: absolute; top: 8px; right: 8px; display: none; font-size: 20px; }
        .selected .select-check { display: block; }

        /* æŒ‰éˆ•çµ„ */
        .btn-group { display: flex; justify-content: center; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        .btn-main { padding: 16px 40px; border-radius: 50px; border: none; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; }
        .btn-green { background: var(--primary-green); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3); }
        .btn-blue { background: var(--primary-blue); box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }

        /* ç¶“å…¸ä¸‰æ–¹æ¡† */
        .features { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 80px; text-align: left; }
        .feature-card { background: white; padding: 30px; border-radius: 15px; box-shadow: var(--card-shadow); transition: transform 0.3s; }
        .feature-card:hover { transform: translateY(-10px); }
        .card-red { border-top: 5px solid var(--primary-red); }
        .card-green { border-top: 5px solid var(--primary-green); }
        .card-yellow { border-top: 5px solid var(--primary-yellow); }

        /* Q&A å€å¡Š */
        .qa-section { margin-top: 80px; text-align: left; background: white; padding: 40px; border-radius: 20px; box-shadow: var(--card-shadow); }
        .qa-section h2 { font-size: 1.8rem; margin-bottom: 25px; color: var(--primary-red); }
        .qa-item { margin-bottom: 25px; border-bottom: 1px solid #f1f1f1; padding-bottom: 15px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 800px) { .features { grid-template-columns: 1fr; } .page-grid { grid-template-columns: repeat(2, 1fr); } }
        footer { margin-top: 60px; padding: 30px; color: #999; font-size: 0.9rem; }
    </style>
</head>
<body>

    <nav>
        <a href="#" class="logo">DTZ PDF 5.5</a>
        <div class="nav-status">ç€è¦½å™¨æœ¬åœ°è™•ç† (Local Engine) | éš±ç§ä¿è­·æ¨¡å¼</div>
    </nav>

    <div class="container">
        <h1>å…¨èƒ½ PDF å·¥å…·ç®±</h1>
        <p class="subtitle">
            <span class="highlight-text">éš±ç§ã€å®‰å…¨ã€é«˜æ•ˆ</span> â€“ æ‰€æœ‰è™•ç†çš†åœ¨æœ¬åœ°å®Œæˆï¼Œçµ•ä¸å‚³å‘é›²ç«¯ã€‚<br>
            é›†åˆä½µã€é»é¸åˆ†å‰²ã€æ—‹è½‰èˆ‡ ZIP è½‰åœ–æ–¼ä¸€èº«ã€‚
        </p>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('edit')">æ•´ç†èˆ‡é»é¸åˆ†å‰²</button>
            <button class="tab-btn" onclick="switchTab('toimg')">PDF è½‰åœ–ç‰‡ (ZIP)</button>
        </div>

        <div id="edit-panel" class="work-panel active">
            <div class="upload-area" id="drop-zone-edit" onclick="document.getElementById('input-edit').click()">
                <div class="upload-icon">ğŸ“„â•</div>
                <p style="font-size: 1.2rem; font-weight: 500;">é»æ“Šæˆ–æ‹–æ”¾ PDF / åœ–ç‰‡</p>
                <input type="file" id="input-edit" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
            </div>
            <div id="edit-grid" class="page-grid"></div>
            <div id="edit-controls" class="btn-group" style="display:none;">
                <button class="btn-main btn-green" onclick="exportPdf(false)">ç«‹å³åˆä½µæ‰€æœ‰é é¢</button>
                <button class="btn-main btn-blue" onclick="exportPdf(true)">æå–æ‰€é¸é é¢ (åˆ†å‰²)</button>
            </div>
        </div>

        <div id="toimg-panel" class="work-panel">
            <div class="upload-area" onclick="document.getElementById('input-img').click()">
                <div class="upload-icon">ğŸ–¼ï¸</div>
                <h3>é»æ“Šä¸Šå‚³ PDF è½‰æ›ç‚ºåœ–ç‰‡</h3>
                <input type="file" id="input-img" hidden accept=".pdf">
            </div>
            <div id="img-grid" class="page-grid"></div>
            <div id="img-controls" class="btn-group" style="display:none;">
                <button class="btn-main btn-blue" onclick="downloadAllImages()">ä¸€éµæ‰“åŒ… ZIP ä¸‹è¼‰</button>
            </div>
        </div>

        <div class="features">
            <div class="feature-card card-red">
                <h3>ğŸ”’ çµ•å°éš±ç§</h3>
                <p>æª”æ¡ˆä¸ç¶“éä¼ºæœå™¨ï¼Œç›´æ¥åœ¨æ‚¨çš„è£ç½®å…§å®Œæˆé‹ç®—ã€‚å³ä½¿æ˜¯æ©Ÿå¯†åˆç´„ä¹Ÿèƒ½æ”¾å¿ƒè™•ç†ã€‚</p>
            </div>
            <div class="feature-card card-green">
                <h3>ğŸ–¼ï¸ é»é¸å¼åˆ†å‰²</h3>
                <p>ä¸å†éœ€è¦è¼¸å…¥è¤‡é›œé ç¢¼ã€‚ç”¨æ»‘é¼ æˆ–æ‰‹æŒ‡ç›´æ¥é»æ“Šé è¦½åœ–ï¼Œè¼•é¬†æŒ‘é¸éœ€è¦çš„é é¢åŒ¯å‡ºã€‚</p>
            </div>
            <div class="feature-card card-yellow">
                <h3>âœ¨ è·¨å¹³å°å„ªåŒ–</h3>
                <p>é‡å° iPhone/Android çš„è¨˜æ†¶é«”é€²è¡Œæ¥µé™å„ªåŒ–ï¼Œä¸¦æ”¯æ´ ZIP æ‰¹æ¬¡æ‰“åŒ…æ‰€æœ‰åœ–ç‰‡æª”ã€‚</p>
            </div>
        </div>

        <div class="qa-section">
            <h2>ä½¿ç”¨è€…å¸¸è¦‹å•é¡Œ (Q&A)</h2>
            <div class="qa-item">
                <h4>å¦‚ä½•ä½¿ç”¨ã€Œé»é¸å¼åˆ†å‰²ã€ï¼Ÿ</h4>
                <p>ä¸Šå‚³æª”æ¡ˆå¾Œï¼Œç›´æ¥é»æ“Šé é¢é è¦½åœ–ï¼Œé¸ä¸­çš„é é¢æœƒå‡ºç¾å‹¾é¸æ¨™è¨˜ã€‚æœ€å¾Œé»æ“Šè—è‰²çš„ã€Œæå–æ‰€é¸é é¢ã€å³å¯ã€‚é€™å°æå–ç‰¹å®šå¹¾é åˆç´„éå¸¸æ–¹ä¾¿ã€‚</p>
            </div>
            <div class="qa-item">
                <h4>ç‚ºä»€éº¼åœ–ç‰‡è½‰ PDF æœƒè‡ªå‹•ç¸®æ”¾ï¼Ÿ</h4>
                <p>æ‰‹æ©Ÿè¨˜æ†¶é«”æœ‰é™ï¼Œè™•ç† 4K ä»¥ä¸Šçš„å¤§åœ–æ¥µæ˜“é–ƒé€€ã€‚DTZ PDF æœƒè‡ªå‹•åµæ¸¬ä¸¦å„ªåŒ–è§£æåº¦ï¼Œé€™ä¸åƒ…èƒ½ç¢ºä¿åˆä½µæˆåŠŸï¼Œé‚„èƒ½å¤§å¹…ç¸®å°ç”¢å‡ºçš„ PDF é«”ç©ã€‚</p>
            </div>
            <div class="qa-item">
                <h4>æª”æ¡ˆä¸‹è¼‰å¾Œåœ¨å“ªè£¡ï¼Ÿ</h4>
                <p>1. <b>iOS (Safari)ï¼š</b>è«‹æª¢æŸ¥ç¶²å€åˆ—å·¦å´çš„è—è‰²ç®­é ­ã€‚<br>
                   2. <b>Androidï¼š</b>é€šå¸¸åœ¨ã€Œä¸‹è¼‰ã€è³‡æ–™å¤¾ä¸­ã€‚å»ºè­°ä½¿ç”¨ Chrome ç€è¦½å™¨ç²å¾—æœ€ä½³ç©©å®šæ€§ã€‚</p>
            </div>
        </div>
    </div>

    <footer>&copy; 2026 DTZ PDF ENGINE | æ‚¨çš„æœ¬åœ° PDF å°ˆå®¶</footer>

    <script>
        const { PDFDocument, degrees } = PDFLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let pagesData = [];
        let fileBuffers = {};
        let imageBlobs = [];
        const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.work-panel').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-panel').classList.add('active');
        }

        // --- è™•ç†ä¸Šå‚³ (ç·¨è¼¯å€) ---
        document.getElementById('input-edit').onchange = async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                if (!['application/pdf', 'image/jpeg', 'image/png'].includes(file.type)) {
                    alert(`ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼: ${file.name}`); continue;
                }
                const fId = crypto.randomUUID();
                const buffer = await file.arrayBuffer();
                fileBuffers[fId] = buffer;

                if (file.type === 'application/pdf') {
                    const pdf = await pdfjsLib.getDocument({ data: buffer.slice(0) }).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const pId = crypto.randomUUID();
                        pagesData.push({ fId, pIdx: i-1, rot: 0, pId, type: 'pdf', selected: false });
                        renderThumb(buffer, i, pId, 'edit-grid');
                    }
                } else {
                    const pId = crypto.randomUUID();
                    pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false });
                    renderImgThumb(file, pId, 'edit-grid');
                }
            }
            document.getElementById('edit-controls').style.display = 'flex';
        };

        async function renderThumb(buffer, pNum, pId, gridId) {
            const pdf = await pdfjsLib.getDocument({ data: buffer.slice(0) }).promise;
            const page = await pdf.getPage(pNum);
            const vp = page.getViewport({ scale: 0.3 });
            const canvas = document.createElement('canvas');
            canvas.width = vp.width; canvas.height = vp.height;
            await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
            createCard(canvas, pId, gridId, `é ç¢¼ ${pNum}`);
        }

        function renderImgThumb(file, pId, gridId) {
            const img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const scale = 150 / img.width;
                canvas.width = 150; canvas.height = img.height * scale;
                canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                createCard(canvas, pId, gridId, 'åœ–ç‰‡');
            };
        }

        function createCard(canvas, pId, gridId, label) {
            const card = document.createElement('div');
            card.className = 'page-card';
            card.id = pId;
            card.innerHTML = `
                <div class="badge">${label}</div>
                <div class="select-check">âœ…</div>
                <div class="cv-wrap"></div>
                <div style="margin-top:10px; display:flex; justify-content:space-around;">
                    <button onclick="event.stopPropagation(); rotatePage('${pId}')" style="font-size:10px; cursor:pointer;">ğŸ”„ æ—‹è½‰</button>
                    <button onclick="event.stopPropagation(); deletePage('${pId}')" style="font-size:10px; cursor:pointer;">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            `;
            card.querySelector('.cv-wrap').appendChild(canvas);
            card.onclick = () => toggleSelect(pId);
            document.getElementById(gridId).appendChild(card);
        }

        function toggleSelect(pId) {
            const p = pagesData.find(x => x.pId === pId);
            p.selected = !p.selected;
            document.getElementById(pId).classList.toggle('selected');
        }

        function rotatePage(pId) {
            const p = pagesData.find(x => x.pId === pId);
            p.rot = (p.rot + 90) % 360;
            document.getElementById(pId).querySelector('canvas').className = `rot-${p.rot}`;
        }

        function deletePage(pId) {
            pagesData = pagesData.filter(x => x.pId !== pId);
            document.getElementById(pId).remove();
        }

        new Sortable(document.getElementById('edit-grid'), {
            animation: 150,
            onEnd: () => {
                const ids = Array.from(document.getElementById('edit-grid').children).map(c => c.id);
                pagesData = ids.map(id => pagesData.find(p => p.pId === id));
            }
        });

        async function exportPdf(onlySelected) {
            const list = onlySelected ? pagesData.filter(p => p.selected) : pagesData;
            if (list.length === 0) return alert('æ¸…å–®ä¸­æ²’æœ‰é é¢ï¼Œæˆ–æ‚¨å°šæœªé»é¸ä»»ä½•é é¢ã€‚');

            const btn = event.target;
            btn.disabled = true; btn.innerText = 'è™•ç†ä¸­...';

            try {
                const pdfDoc = await PDFDocument.create();
                for (const p of list) {
                    await new Promise(r => setTimeout(r, 0)); // å‘¼å¸è£œä¸
                    if (p.type === 'pdf') {
                        const src = await PDFDocument.load(fileBuffers[p.fId]);
                        const [copy] = await pdfDoc.copyPages(src, [p.pIdx]);
                        copy.setRotation(degrees(p.rot + (copy.getRotation().angle || 0)));
                        pdfDoc.addPage(copy);
                    } else {
                        const buf = await p.file.arrayBuffer();
                        const img = p.file.type.includes('png') ? await pdfDoc.embedPng(buf) : await pdfDoc.embedJpg(buf);
                        const limit = 1500;
                        const scale = img.width > limit ? limit / img.width : 1;
                        const page = pdfDoc.addPage([img.width * scale, img.height * scale]);
                        page.drawImage(img, { x: 0, y: 0, width: img.width * scale, height: img.height * scale, rotate: degrees(p.rot) });
                    }
                }
                const bytes = await pdfDoc.save();
                download(bytes, `DTZ_PDF_${Date.now()}.pdf`, 'application/pdf');
                btn.disabled = false; btn.innerText = onlySelected ? 'æå–æ‰€é¸é é¢ (åˆ†å‰²)' : 'ç«‹å³åˆä½µæ‰€æœ‰é é¢';
            } catch (e) { alert('åŒ¯å‡ºå¤±æ•—'); btn.disabled = false; }
        }

        // --- è½‰åœ–èˆ‡ ZIP ---
        document.getElementById('input-img').onchange = async (e) => {
            const file = e.target.files[0];
            const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
            const grid = document.getElementById('img-grid');
            grid.innerHTML = ''; imageBlobs = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const vp = page.getViewport({ scale: 2.0 });
                const cv = document.createElement('canvas');
                cv.width = vp.width; cv.height = vp.height;
                await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
                
                const card = document.createElement('div');
                card.className = 'page-card';
                card.innerHTML = `<div class="badge">ç¬¬ ${i} é </div>`;
                card.appendChild(cv);
                grid.appendChild(card);
                cv.toBlob(blob => imageBlobs.push({ blob, name: `DTZ_Page_${i}.jpg` }), 'image/jpeg', 0.8);
            }
            document.getElementById('img-controls').style.display = 'flex';
        };

        async function downloadAllImages() {
            const zip = new JSZip();
            imageBlobs.forEach(img => zip.file(img.name, img.blob));
            const content = await zip.generateAsync({ type: 'blob' });
            download(content, 'DTZ_Images.zip', 'application/zip');
        }

        function download(data, name, type) {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                window.location.href = url;
            } else {
                const a = document.createElement('a');
                a.href = url; a.download = name; a.click();
            }
        }
    </script>
</body>
</html>
