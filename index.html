<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>DTZ PDF v20.0 - æ——è‰¦ 2.0 å®Œçµå‚³èªªç‰ˆ</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db; --primary-yellow: #f1c40f;
            --bg-color: #f4f7fa; --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg-color); color: #2d3436; }
        
        /* ç²¾å¯†é€²åº¦æ¢èˆ‡å°èˆª */
        #loader-bar { position: fixed; top: 0; left: 0; width: 0%; height: 5px; background: linear-gradient(90deg, var(--primary-red), var(--primary-blue)); z-index: 2001; transition: width 0.3s ease; }
        nav { background: white; padding: 1rem 8%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.6rem; font-weight: 900; color: var(--primary-red); text-decoration: none; }
        .version-badge { font-size: 0.7rem; background: var(--primary-red); color: white; padding: 3px 10px; border-radius: 50px; margin-left: 8px; }

        /* å´é‚ŠæŠ½å±œå°èˆª */
        #side-toggle { position: fixed; left: 0; top: 50%; transform: translateY(-50%); background: var(--primary-red); color: white; padding: 20px 8px; border-radius: 0 12px 12px 0; cursor: pointer; z-index: 2000; writing-mode: vertical-lr; font-size: 12px; font-weight: bold; box-shadow: 3px 0 15px rgba(0,0,0,0.1); }
        .sidebar { position: fixed; left: -280px; top: 90px; width: 240px; height: calc(100vh - 130px); background: white; padding: 20px; box-shadow: 5px 0 25px rgba(0,0,0,0.1); transition: 0.5s cubic-bezier(0.77, 0, 0.175, 1); z-index: 1500; overflow-y: auto; border-radius: 0 25px 25px 0; }
        .sidebar.open { left: 0; }
        .side-thumb-wrap { margin-bottom: 18px; border-radius: 12px; border: 3px solid #eee; overflow: hidden; transition: 0.3s; position: relative; background: #fff; cursor: pointer; }
        .side-thumb-wrap.active { border-color: var(--primary-green); transform: scale(1.02); }

        /* ä¸»å®¹å™¨èˆ‡é¢æ¿ */
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; text-align: center; }
        .work-panel { background: white; padding: 40px; border-radius: 30px; box-shadow: var(--card-shadow); min-height: 550px; display: none; }
        .work-panel.active { display: block; animation: fadeIn 0.4s; }
        .tab-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 25px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: bold; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--primary-red); color: white; box-shadow: 0 8px 15px rgba(231, 76, 60, 0.2); }

        /* ä¸Šå‚³èˆ‡å¡ç‰‡è¨­è¨ˆ */
        .upload-area { border: 3px dashed #cbd5e0; border-radius: 20px; padding: 50px; cursor: pointer; background: #fff; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary-red); background: #fffaf9; }
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px; margin-top: 30px; }
        .page-card { background: #fff; border: 2px solid #eee; padding: 12px; border-radius: 18px; position: relative; cursor: grab; transition: 0.3s; }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        .cv-wrap { display: flex; align-items: center; justify-content: center; min-height: 220px; overflow: hidden; }
        canvas { max-width: 100%; max-height: 100%; border-radius: 8px; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: center center; }

        /* âœ… æ—‹è½‰æ¨£å¼ */
        .rot-0 { transform: rotate(0deg); } .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }
        .hidden-search { display: none; }

        /* âœ… ç¶“å…¸ä¸‰æ–¹æ¡†ç¾è¡“é¢¨æ ¼ */
        .feature-matrix { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-top: 80px; text-align: left; }
        .feature-card { background: white; padding: 30px; border-radius: 20px; box-shadow: var(--card-shadow); border-top: 6px solid transparent; transition: 0.3s; }
        .f-red { border-top-color: var(--primary-red); } .f-green { border-top-color: var(--primary-green); } .f-yellow { border-top-color: var(--primary-yellow); }

        /* æŒ‰éˆ•ç³»çµ± */
        .btn-action { padding: 15px 40px; border-radius: 50px; border: none; font-size: 1.1rem; font-weight: 700; cursor: pointer; color: white; transition: 0.3s; margin: 10px; }
        .btn-green { background: var(--primary-green); } .btn-blue { background: var(--primary-blue); }
        .btn-action:disabled { background: #cbd5e0 !important; cursor: wait; }

        /* Q&A å€å¡Š */
        .qa-container { text-align: left; background: white; padding: 45px; border-radius: 30px; margin-top: 80px; box-shadow: var(--card-shadow); }
        .qa-container h2 { font-size: 2rem; color: var(--primary-red); margin-bottom: 30px; border-left: 8px solid var(--primary-red); padding-left: 20px; }
        .qa-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .qa-item h4 { color: #2d3436; margin-bottom: 8px; }
        .qa-item p { color: #636e72; font-size: 0.95rem; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 900px) { .feature-matrix, .qa-grid { grid-template-columns: 1fr; } .sidebar { width: 100%; height: 320px; bottom: -450px; top: auto; left: 0; border-radius: 20px 20px 0 0; } .sidebar.open { bottom: 0; } }
        footer { margin: 80px 0 40px; color: #b2bec3; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>

<div id="loader-bar"></div>
<div id="side-toggle">ğŸ“„ é é¢å°èˆª</div>

<aside class="sidebar">
    <h3 style="color:var(--primary-red); margin-bottom:15px;">ğŸ” å¿«é€Ÿè·³è½‰</h3>
    <input type="text" id="search-input" placeholder="æœå°‹ PDF å…§å®¹..." onkeyup="searchPDF()" style="width:90%; padding:12px; border-radius:10px; border:1px solid #ddd; margin-bottom:20px; font-size:1rem; outline:none;">
    <div id="side-grid"></div>
</aside>

<nav>
    <a href="#" class="logo">DTZ PDF <span class="version-badge">v20.0</span></a>
    <div style="font-size: 0.85rem; color: #2ecc71; font-weight: bold;">â— æœ€çµ‚è–æˆ°ï¼šç´”æœ¬åœ°ç©©å®šç‰ˆ</div>
</nav>

<div class="container">
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab(event, 'main')">æ•´ç†ã€åˆ†å‰²èˆ‡æ—‹è½‰</button>
        <button class="tab-btn" onclick="switchTab(event, 'adv')">é«˜ç´šè£é£¾èˆ‡ç°½å</button>
        <button class="tab-btn" onclick="switchTab(event, 'safe')">å®‰å…¨èˆ‡å±¬æ€§</button>
    </div>

    <div id="main-panel" class="work-panel active">
        <div class="upload-area" id="drop-zone">
            <div style="font-size:55px; margin-bottom: 10px;">ğŸ“‚</div>
            <h3>é»æ“Šæˆ–ã€Œæ‹–æ”¾ã€å¤šå€‹æª”æ¡ˆé–‹å§‹</h3>
            <p style="color:#94a3b8; font-size:0.9rem;">æ”¯æ´æ··åˆ PDFã€JPGã€PNG çµ„ç¹”èˆ‡åˆ†å‰²</p>
            <input type="file" id="input-org" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div id="org-grid" class="page-grid"></div>
        <div id="org-ctrl" style="display:none; margin-top:40px;">
            <div style="background:#f8fafc; padding:20px; border-radius:25px; margin-bottom:25px; border:1px solid #e2e8f0;">
                <strong style="color:#475569;">æ•ˆç‡å·¥å…·ï¼š</strong>
                <button class="tab-btn" style="border-color:#475569; color:#475569;" onclick="rotateAll90()">å…¨éƒ¨å³è½‰ 90Â°</button>
                <button class="tab-btn" style="border-color:#8e44ad; color:#8e44ad;" onclick="insertBlank()">åŠ å…¥ç©ºç™½é </button>
                <button class="tab-btn" style="background:#94a3b8; color:#fff; border:none;" onclick="location.reload()">å…¨éƒ¨æ¸…ç©º</button>
            </div>
            <button class="btn-action btn-green" id="btn-merge" onclick="processPdf('merge')">åˆä½µç‚ºå–®ä¸€ PDF</button>
            <button class="btn-action btn-blue" id="btn-split" onclick="processPdf('split')">æ‰€é¸æå– (ZIP)</button>
        </div>
    </div>

    <div id="adv-panel" class="work-panel">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; text-align:left;">
            <div style="background:#f1f5f9; padding:25px; border-radius:20px;">
                <h4 style="color:var(--primary-red); margin-top:0;">ğŸ›¡ï¸ å…¨å±€æµ®æ°´å°</h4>
                <input type="text" id="wm-text" placeholder="å…§éƒ¨æª”æ¡ˆ, ç¦æ­¢ç¿»å°..." style="width:100%; padding:12px; border-radius:10px; border:1px solid #ddd; margin-bottom:10px;">
                <div style="font-size:0.8rem;">é€æ˜åº¦: <input type="range" id="wm-op" min="0.1" max="1.0" step="0.1" value="0.3" style="width:100%;"></div>
            </div>
            <div style="background:#f1f5f9; padding:25px; border-radius:20px;">
                <h4>ğŸ–¼ï¸ é«˜æ¸…åŸåœ–å°å‡º</h4>
                <p style="font-size:0.85rem; color:#64748b;">é¸å–å·¦æ–¹å°è¦½çš„ä¸€é å¾Œï¼Œå°‡å…¶è½‰æ›ç‚ºé«˜å“è³ª 300DPI åœ–ç‰‡ã€‚</p>
                <button class="btn-action btn-blue" style="width:100%; margin:10px 0;" onclick="exportAsImage()">ç«‹å³ä¸‹è¼‰é¸ä¸­é </button>
            </div>
        </div>
        <hr style="margin:30px 0; border:0; border-top:1px solid #e2e8f0;">
        <h3>âœ’ï¸ é«˜ç²¾ç´°é›»å­ç°½åæ¿</h3>
        <p style="font-size:0.85rem; color:#e67e22;">â— è«‹åœ¨ä¸‹æ–¹ç°½åï¼Œæ‰€æœ‰ã€Œé¸ä¸­ (ç¶ æ¡†)ã€çš„é é¢åœ¨åŒ¯å‡ºæ™‚éƒ½æœƒè‡ªå‹•è“‹ä¸Šæ­¤ç°½åã€‚</p>
        <div style="background:#2d3436; padding:15px; border-radius:25px; display:inline-block;">
            <canvas id="sig-canvas" width="1200" height="600" style="background:#fff; touch-action:none; width:400px; height:200px; border-radius:12px; cursor:crosshair;"></canvas>
        </div>
        <div style="margin-top:20px;">
            <button class="tab-btn" onclick="clearSig()">æ¸…é™¤é‡ç°½</button>
            <button class="btn-action btn-blue" onclick="saveSig()">å„²å­˜ç°½å</button>
        </div>
    </div>

    <div id="safe-panel" class="work-panel">
        <div style="max-width:600px; margin:0 auto; text-align:left;">
            <h3>ğŸ“ æª”æ¡ˆ Metadata</h3>
            <input type="text" id="m-title" class="tab-btn" style="width:100%; border-radius:10px;" placeholder="æ–‡ä»¶æ¨™é¡Œ">
            <input type="text" id="m-author" class="tab-btn" style="width:100%; border-radius:10px;" placeholder="ä½œè€…å§“å">
            <hr>
            <h3>ğŸ”’ å®‰å…¨åŠ å¯†èˆ‡æ¬Šé™</h3>
            <label>é–‹å•Ÿå¯†ç¢¼:</label><input type="password" id="p-u" class="tab-btn" style="width:100%; border-radius:10px;" placeholder="ä¸è¨­å‰‡ç•™ç™½">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; font-size:0.9rem;">
                <label><input type="checkbox" id="can-print" checked> å…è¨±åˆ—å°</label>
                <label><input type="checkbox" id="can-copy" checked> å…è¨±è¤‡è£½æ–‡å­—</label>
            </div>
        </div>
    </div>

    <div class="feature-matrix">
        <div class="feature-card f-red"><h3>ğŸ›¡ï¸ å®‰å…¨å¯é </h3><p>é‹ç®—å®Œå…¨åœ¨ç€è¦½å™¨å…§å­˜é€²è¡Œï¼Œæª”æ¡ˆä¸ç¶“ä¼ºæœå™¨ã€‚æ”¯æ´è»è¦ç´š AES åŠ å¯†èˆ‡æ¬Šé™æ§ç®¡ã€‚</p></div>
        <div class="feature-card f-green"><h3>ğŸ“ å¤šæ ¼å¼æ”¯æ´</h3><p>è™•ç† PDF èˆ‡ç…§ç‰‡æ··åˆæ’åˆ—ã€‚å…·å‚™è‡ªå‹•å­—é«”ç¸®æ”¾èˆ‡å¹¾ä½•æ ¡æ­£æŠ€è¡“ï¼Œç¢ºä¿å®Œç¾ä¸‹è¼‰ã€‚</p></div>
        <div class="feature-card f-yellow"><h3>ğŸ¨ è‡ªç”±æ’åº</h3><p>å´é‚Šå°è¦½æŠ½å±œæ”¯æ´å³æ™‚æœå°‹èˆ‡å®šä½ã€‚ç‰©ç†æ—‹è½‰ç´¯åŠ æŠ€è¡“ï¼Œç¢ºä¿åŒ¯å‡ºçµæœè§’åº¦ç²¾ç¢ºã€‚</p></div>
    </div>

    <div class="qa-container">
        <h2>ä½¿ç”¨è€…æŒ‡å—èˆ‡ Q&A</h2>
        <div class="qa-grid">
            <div class="qa-item">
                <h4>1. iOS (iPhone/iPad) ç„¡æ³•ä¸‹è¼‰ï¼Ÿ</h4>
                <p>é€™æ˜¯ iOS å®‰å…¨é™åˆ¶ã€‚**è«‹å‹™å¿…åœ¨ Safari ç€è¦½å™¨ä¸­æ“ä½œ**ã€‚è‹¥åœ¨ LINE æˆ– FB å…§å»ºè¦–çª—ä¸­ä¸‹è¼‰æ²’åæ‡‰ï¼Œè«‹é¸æ“‡ã€Œåœ¨ç€è¦½å™¨é–‹å•Ÿã€ã€‚</p>
            </div>
            <div>
                <h4>2. ã€Œå­—é«”è‡ªé©æ‡‰ã€æ˜¯ä»€éº¼ï¼Ÿ</h4>
                <p>æˆ‘å€‘å¼•é€²äº†è‡ªå‹•å¹¾ä½•è¨ˆç®—ã€‚æµ®æ°´å°æ–‡å­—è‹¥éé•·ï¼Œç³»çµ±æœƒè‡ªå‹•ç¸®å°å­—ç´šä»¥é©é…é é¢ï¼Œå¾¹åº•è§£æ±ºæº¢å‡ºå°è‡´çš„ç”Ÿæˆå¤±æ•—å•é¡Œã€‚</p>
            </div>
            <div>
                <h4>3. å¤§æª”æ¡ˆæœƒé–ƒé€€å—ï¼Ÿ</h4>
                <p>æœ¬ç‰ˆå…·å‚™ã€Œåˆ†æ®µå‘¼å¸æŠ€è¡“ã€ã€‚è™•ç†ä¸Šç™¾é æª”æ¡ˆæ™‚æœƒè‡ªå‹•é‡‹æ”¾ä¸»ç·šç¨‹å£“åŠ›ï¼Œä¸¦é¡¯ç¤ºè™•ç†é€²åº¦ã€‚å»ºè­°åˆ†æ‰¹è™•ç†æ¥µå¤§æª”æ¡ˆã€‚</p>
            </div>
            <div>
                <h4>4. ç°½åå¤§å°ç‚ºä½•çœ‹èµ·ä¾†å¾ˆåˆé©ï¼Ÿ</h4>
                <p>ç³»çµ±æœƒæ ¹æ“šé é¢å¯¬åº¦è‡ªå‹•é€²è¡Œã€Œå¹¾ä½•é‡æ¡æ¨£ã€ã€‚ç°½åå›ºå®šåœ¨é é¢å¯¬åº¦çš„ 1/4.5ï¼Œå®Œç¾é©é… A4 èˆ‡å¤§å‹åœ–ç´™ã€‚</p>
            </div>
        </div>
    </div>
</div>

<footer>&copy; 2026 DTZ PDF ULTIMATE | æ——è‰¦ç‡Ÿé‹æœ€çµ‚ç‰ˆ v20.0</footer>

<script>
    const { PDFDocument, degrees, rgb, StandardFonts } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pagesData = []; let fileBuffers = {}; let pdfCache = {}; let sigImage = null; let sigTargetId = null;
    const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

    function download(data, filename, type) {
        const blob = data instanceof Blob ? data : new Blob([data], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 2000);
    }

    // æª”æ¡ˆä¸Šå‚³
    const dropZone = document.getElementById('drop-zone');
    dropZone.onclick = () => document.getElementById('input-org').click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); };
    document.getElementById('input-org').onchange = (e) => handleFiles(e.target.files);

    async function handleFiles(files) {
        updateProgress(10);
        const titleInput = document.getElementById('m-title');
        if (!titleInput.value && files.length > 0) titleInput.value = files[0].name.split('.')[0];

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fId = crypto.randomUUID();
            const buf = await file.arrayBuffer();
            fileBuffers[fId] = buf;
            if (file.name.toLowerCase().endsWith('.pdf')) {
                const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
                for (let j = 1; j <= pdf.numPages; j++) {
                    const pId = crypto.randomUUID();
                    const page = await pdf.getPage(j);
                    const txt = (await page.getTextContent()).items.map(s => s.str).join(' ');
                    pagesData.push({ fId, pIdx: j-1, rot: 0, pId, type: 'pdf', selected: false, text: txt, fileName: file.name });
                    await renderThumb(page, pId, j);
                    if (j % 5 === 0) await new Promise(r => setTimeout(r, 0));
                }
            } else {
                const pId = crypto.randomUUID();
                pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false, text:'', fileName: file.name });
                renderImgThumb(file, pId);
            }
        }
        document.getElementById('org-ctrl').style.display = 'block';
        if(pagesData.length > 5) document.getElementById('side-toggle').style.display = 'block';
        updateProgress(0);
    }

    async function renderThumb(page, pId, pNum) {
        const vp = page.getViewport({ scale: 0.3 });
        const cv = document.createElement('canvas'); cv.width = vp.width; cv.height = vp.height;
        await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
        createCard(cv, pId, `P${pNum}`);
    }

    function renderImgThumb(file, pId) {
        const url = URL.createObjectURL(file);
        const img = new Image(); img.src = url;
        img.onload = () => {
            const cv = document.createElement('canvas'); 
            const maxW = 150; const sc = maxW / img.width;
            cv.width = maxW; cv.height = img.height * sc;
            cv.getContext('2d').drawImage(img, 0, 0, cv.width, cv.height);
            createCard(cv, pId, 'åœ–'); URL.revokeObjectURL(url);
        };
    }

    function createCard(cv, pId, label) {
        const card = document.createElement('div'); card.className = 'page-card'; card.id = pId;
        card.innerHTML = `<div style="position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.6);color:white;font-size:10px;padding:2px 6px;border-radius:4px;z-index:10;">${label}</div><div class="cv-wrap"></div><div style="margin-top:8px;display:flex;justify-content:center;gap:5px;"><button class="tab-btn" style="font-size:10px;padding:5px 10px;" onclick="event.stopPropagation(); rotateP('${pId}')">æ—‹è½‰</button><button class="tab-btn" style="font-size:10px;padding:5px 10px;" onclick="event.stopPropagation(); delP('${pId}')">åˆªé™¤</button></div>`;
        card.querySelector('.cv-wrap').appendChild(cv);
        card.onclick = () => toggleSelect(pId);
        document.getElementById('org-grid').appendChild(card);
        const sideWrap = document.createElement('div'); sideWrap.className = 'side-thumb-wrap'; sideWrap.id = 'side-wrap-'+pId;
        const scv = document.createElement('canvas'); scv.id = 'side-'+pId; scv.width = cv.width; scv.height = cv.height; scv.style.width = '100%'; scv.getContext('2d').drawImage(cv, 0, 0);
        scv.onclick = () => document.getElementById(pId).scrollIntoView({behavior:'smooth'});
        sideWrap.appendChild(scv); document.getElementById('side-grid').appendChild(sideWrap);
    }

    function toggleSelect(pId) {
        const p = pagesData.find(x => x.pId === pId); p.selected = !p.selected;
        document.getElementById(pId).classList.toggle('selected');
        document.getElementById('side-wrap-'+pId).classList.toggle('active');
        sigTargetId = pId;
    }

    // --- ğŸ’ ç©¶æ¥µç©©å®šçš„è™•ç†å¼•æ“ ---
    async function processPdf(mode) {
        updateProgress(10);
        const zip = mode === 'split' ? new JSZip() : null;
        try {
            const mainDoc = mode === 'merge' ? await PDFDocument.create() : null;
            let mainFont = null;
            if (mainDoc) {
                mainFont = await mainDoc.embedFont(StandardFonts.HelveticaBold);
                mainDoc.setTitle(document.getElementById('m-title').value || "DTZ Merged");
            }

            const list = mode === 'split' ? pagesData.filter(p => p.selected) : pagesData;
            if(!list.length) return alert('æ¸…å–®ç‚ºç©º');

            for (let i = 0; i < list.length; i++) {
                const p = list[i];
                let curDoc = mode === 'merge' ? mainDoc : await PDFDocument.create();
                const curFont = mode === 'merge' ? mainFont : await curDoc.embedFont(StandardFonts.HelveticaBold);
                if (mode === 'split') curDoc.setTitle(`Split_P${i+1}`);

                let newPage;
                if (p.type === 'pdf') {
                    if (!pdfCache[p.fId]) pdfCache[p.fId] = await PDFDocument.load(fileBuffers[p.fId]);
                    const [copy] = await curDoc.copyPages(pdfCache[p.fId], [p.pIdx]);
                    copy.setRotation(degrees((p.rot + (copy.getRotation().angle || 0)) % 360));
                    newPage = curDoc.addPage(copy);
                } else if (p.type === 'img') {
                    const img = await curDoc.embedPng(await p.file.arrayBuffer());
                    newPage = curDoc.addPage([img.width, img.height]);
                    newPage.drawImage(img, { x:0, y:0, width:img.width, height:img.height, rotate:degrees(p.rot) });
                } else {
                    newPage = curDoc.addPage([595, 842]);
                }

                // âœ… å¹¾ä½•æ ¡æ­£æµ®æ°´å°
                const wm = document.getElementById('wm-text').value;
                if(wm) {
                    const { width, height } = newPage.getSize();
                    const maxWidth = width * 0.7;
                    let fontSize = width / 12;
                    while (curFont.widthOfTextAtSize(wm, fontSize) > maxWidth && fontSize > 10) fontSize -= 2;
                    const textWidth = curFont.widthOfTextAtSize(wm, fontSize);
                    newPage.drawText(wm, { x: width/2 - textWidth/2, y: height/2, size: fontSize, font: curFont, color: rgb(0.85, 0.85, 0.85), opacity: parseFloat(document.getElementById('wm-op').value), rotate: degrees(35) });
                }

                // âœ… æ‰¹é‡ç°½åæ’å…¥
                if (p.selected && sigImage) {
                    const sig = await curDoc.embedPng(sigImage);
                    const { width: pageW } = newPage.getSize();
                    const sW = pageW / 4.5; const sH = sW * (sig.height / sig.width);
                    newPage.drawImage(sig, { x: pageW - sW - 40, y: 40, width: sW, height: sH });
                }

                if (mode === 'split') zip.file(`Page_${i+1}.pdf`, await curDoc.save());
                updateProgress(10 + (85 * (i/list.length)));
                if (i % 8 === 0) await new Promise(r => setTimeout(r, 0));
            }

            const saveOpts = { userPassword: document.getElementById('p-u').value || undefined, permissions: { printing: !!document.getElementById('can-print').checked, copying: !!document.getElementById('can-copy').checked } };
            if (mode === 'merge') {
                const bytes = await mainDoc.save(saveOpts);
                if (isMobile) { window.open(URL.createObjectURL(new Blob([bytes], {type:'application/pdf'}))); }
                else { download(bytes, `${document.getElementById('m-title').value}.pdf`, 'application/pdf'); }
            } else {
                download(await zip.generateAsync({type:'blob', compression: "DEFLATE"}), `DTZ_Splits.zip`, 'application/zip');
            }
        } catch (e) { alert("è™•ç†å¤±æ•—"); }
        updateProgress(0);
    }

    async function exportAsImage() {
        const p = pagesData.find(x => x.pId === sigTargetId);
        if(!p) return alert("è«‹å…ˆé¸å–ä¸€é é é¢");
        updateProgress(50);
        const cv = document.createElement('canvas'); const ctx = cv.getContext('2d');
        if (p.type === 'pdf') {
            const pdf = await pdfjsLib.getDocument({ data: fileBuffers[p.fId] }).promise;
            const page = await pdf.getPage(p.pIdx + 1);
            const vp = page.getViewport({ scale: 4.5, rotation: p.rot });
            cv.width = vp.width; cv.height = vp.height;
            await page.render({ canvasContext: ctx, viewport: vp }).promise;
        } else {
            const img = new Image(); img.src = URL.createObjectURL(p.file);
            await new Promise(r => img.onload = r);
            if (p.rot % 180 !== 0) { cv.width = img.naturalHeight; cv.height = img.naturalWidth; } 
            else { cv.width = img.naturalWidth; cv.height = img.naturalHeight; }
            ctx.translate(cv.width/2, cv.height/2); ctx.rotate(p.rot * Math.PI / 180);
            ctx.drawImage(img, -img.naturalWidth/2, -img.naturalHeight/2);
        }
        cv.toBlob(b => { download(b, `DTZ_HD_Export.jpg`, 'image/jpeg'); updateProgress(0); }, 'image/jpeg', 0.98);
    }

    function rotateAll90() { pagesData.forEach(p => rotateP(p.pId)); }
    function rotateP(pId) {
        const p = pagesData.find(x => x.pId === pId); p.rot = (p.rot + 90) % 360;
        ['canvas', 'side-'+pId].forEach(elId => {
            const el = document.getElementById(elId); if(!el) return;
            const cv = el.tagName === 'CANVAS' ? el : el.querySelector('canvas');
            cv.classList.remove('rot-0','rot-90','rot-180','rot-270'); cv.classList.add(`rot-${p.rot}`);
        });
    }

    function delP(pId) { pagesData = pagesData.filter(x => x.pId !== pId); document.getElementById(pId).remove(); document.getElementById('side-wrap-'+pId).remove(); }
    function insertBlank() { 
        const pId = crypto.randomUUID(); 
        pagesData.push({ pId, type:'blank', rot:0, selected:false, text:'', fileName:'blank.pdf' }); 
        const cv = document.createElement('canvas'); cv.width=150; cv.height=210; 
        const ctx = cv.getContext('2d'); ctx.fillStyle="white"; ctx.fillRect(0,0,150,210); 
        createCard(cv, pId, 'ç©ºç™½é '); 
    }

    function searchPDF() {
        const q = document.getElementById('search-input').value.toLowerCase();
        pagesData.forEach(p => {
            const el = document.getElementById(p.pId); const side = document.getElementById('side-wrap-'+p.pId);
            const match = p.type === 'img' || p.text.toLowerCase().includes(q);
            el.classList.toggle('hidden-search', !match); side.style.display = match ? 'block' : 'none';
        });
    }
    const sigCanvas = document.getElementById('sig-canvas'); const sCtx = sigCanvas.getContext('2d'); let drawing = false;
    function getXY(e) { const rect = sigCanvas.getBoundingClientRect(); return { x: ((e.clientX || (e.touches && e.touches[0].clientX)) - rect.left) * (1200/rect.width), y: ((e.clientY || (e.touches && e.touches[0].clientY)) - rect.top) * (600/rect.height) }; }
    sigCanvas.onmousedown = sigCanvas.ontouchstart = (e) => { drawing = true; const p = getXY(e); sCtx.lineWidth = 5; sCtx.lineCap = 'round'; sCtx.beginPath(); sCtx.moveTo(p.x, p.y); e.preventDefault(); };
    sigCanvas.onmousemove = sigCanvas.ontouchmove = (e) => { if(!drawing) return; const p = getXY(e); sCtx.lineTo(p.x, p.y); sCtx.stroke(); };
    window.onmouseup = window.ontouchend = () => drawing = false;
    function clearSig() { sCtx.clearRect(0,0,1200,600); }
    function saveSig() { sigImage = sigCanvas.toDataURL(); alert('ç°½åå·²å„²å­˜ã€‚'); }
    function switchTab(evt, tab) { document.querySelectorAll('.work-panel').forEach(p => p.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tab + '-panel').classList.add('active'); evt.currentTarget.classList.add('active'); }
    function updateProgress(v) { document.getElementById('loader-bar').style.width = v + '%'; }
    document.getElementById('side-toggle').onclick = (e) => { e.stopPropagation(); document.querySelector('.sidebar').classList.toggle('open'); };
    document.addEventListener('click', () => document.querySelector('.sidebar').classList.remove('open'));
    new Sortable(document.getElementById('org-grid'), { animation: 150, onEnd: () => {
        const order = Array.from(document.getElementById('org-grid').children).map(c => c.id);
        pagesData.sort((a,b) => order.indexOf(a.pId) - order.indexOf(b.pId));
        order.forEach(id => document.getElementById('side-grid').appendChild(document.getElementById('side-wrap-'+id)));
    }});
</script>
</body>
</html>
