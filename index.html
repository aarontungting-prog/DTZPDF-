<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>DTZ PDF - å°ˆæ¥­ç´šæœ¬åœ°å…¨èƒ½å·¥å…·ç®±</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db; --bg-color: #f7f9fc;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg-color); color: #2d3436; overflow-x: hidden; }
        
        /* å°èˆª */
        nav { background: white; padding: 1rem 10%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.6rem; font-weight: bold; color: var(--primary-red); text-decoration: none; letter-spacing: -1px; }
        .right-meta { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: #95a5a6; font-weight: bold; }
        .version-badge { font-size: 0.7rem; color: white; background: var(--primary-red); padding: 2px 8px; border-radius: 4px; }
        
        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; text-align: center; }
        
        /* é€²åº¦æ¢ */
        #progress-container { display: none; width: 100%; position: fixed; top: 0; left: 0; height: 4px; z-index: 2000; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-red), var(--primary-blue)); transition: width 0.3s ease; box-shadow: 0 0 10px rgba(231, 76, 60, 0.5); }
        
        /* Tab åˆ‡æ› */
        .tab-nav { display: flex; justify-content: center; gap: 12px; margin-bottom: 35px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 35px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: bold; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--primary-red); color: white; box-shadow: 0 6px 15px rgba(231, 76, 60, 0.3); transform: translateY(-2px); }
        
        .work-panel { display: none; background: white; padding: 40px; border-radius: 24px; box-shadow: var(--card-shadow); min-height: 450px; border: 1px solid #edf2f7; }
        .work-panel.active { display: block; animation: slideUp 0.4s ease-out; }
        
        /* ä¸Šå‚³å€ */
        .upload-area { border: 3px dashed #cbd5e0; border-radius: 20px; padding: 60px 20px; cursor: pointer; transition: 0.3s; margin-bottom: 25px; position: relative; }
        .upload-area:hover { border-color: var(--primary-red); background: #fffaf9; }
        .upload-icon { font-size: 50px; margin-bottom: 15px; display: block; }
        
        /* Grid ä½ˆå±€ */
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 30px; }
        
        /* å¡ç‰‡è¨­è¨ˆ - åˆä½µæ¨¡å¼ (å¯æ’åº) */
        .page-card { background: white; border: 1px solid #e2e8f0; padding: 10px; border-radius: 16px; position: relative; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .page-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-color: var(--primary-blue); }
        
        /* å¡ç‰‡è¨­è¨ˆ - åˆ†å‰²æ¨¡å¼ (å¯é¸å–) */
        .page-card.selectable { cursor: pointer; }
        .page-card.selected { border: 2px solid var(--primary-green); background: #f0fff4; box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.1); }
        
        .cv-wrap { overflow: hidden; border-radius: 8px; display: flex; align-items: center; justify-content: center; min-height: 200px; background: #f8f9fa; }
        canvas { max-width: 100%; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        /* æ—‹è½‰æ¨£å¼ */
        .rot-0 { transform: rotate(0deg); } .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }
        
        /* å¡ç‰‡å·¥å…·åˆ— */
        .card-tools { display: flex; justify-content: center; gap: 8px; margin-top: 12px; }
        .tool-btn { background: #f1f5f9; border: none; border-radius: 8px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem; font-weight: 600; color: #64748b; transition: 0.2s; display: flex; align-items: center; gap: 4px; }
        .tool-btn:hover { background: #e2e8f0; color: var(--primary-red); }
        
        /* ä¸»æŒ‰éˆ• */
        .btn-main { padding: 16px 50px; border-radius: 50px; border: none; font-size: 1.1rem; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; margin: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-main:disabled { background: #cbd5e0 !important; cursor: not-allowed; box-shadow: none; }
        .btn-green { background: var(--primary-green); } .btn-blue { background: var(--primary-blue); }
        
        /* ä¸‰æ–¹æ¡†ç¾è¡“ */
        .feature-matrix { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 60px; }
        .feature-card { background: white; padding: 35px; border-radius: 25px; box-shadow: var(--card-shadow); border-top: 8px solid var(--primary-red); text-align: left; transition: 0.3s; cursor: default; }
        .feature-card:hover { transform: translateY(-5px); }
        .feature-card h3 { margin-top: 0; color: #2d3436; }

        /* Q&A */
        .qa-section { background: white; padding: 50px; border-radius: 30px; margin-top: 60px; box-shadow: var(--card-shadow); text-align: left; }
        .qa-section h2 { color: var(--primary-red); border-left: 6px solid var(--primary-red); padding-left: 15px; margin-bottom: 30px; }
        .qa-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; }
        .qa-item h4 { color: var(--primary-blue); margin-bottom: 8px; }
        .qa-item p { color: #636e72; font-size: 0.95rem; line-height: 1.6; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        footer { margin: 80px 0 40px; color: #b2bec3; font-size: 0.9rem; text-align: center; }
        @media (max-width: 768px) { .qa-grid { grid-template-columns: 1fr; } .work-panel { padding: 25px; } }
    </style>
</head>
<body>

<div id="progress-container"><div id="progress-bar"></div></div>

<nav>
    <a href="#" class="logo">DTZ PDF</a>
    <div class="right-meta">
        100% æœ¬åœ°éš±ç§è™•ç† <span class="version-badge">v26.0</span>
    </div>
</nav>

<div class="container">
    <h1 style="font-size: 2.5rem; letter-spacing: -1.5px; margin-bottom: 10px;">å°ˆæ¥­ PDF è™•ç†å¼•æ“</h1>
    <p style="color:#636e72; margin-bottom: 40px;">ç´”å‰ç«¯é‹è¡Œï¼Œæ¥µé€Ÿã€å®‰å…¨ã€ä¸é™æµé‡ã€‚</p>
    
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab(event, 'merge')">åˆä½µèˆ‡æ’åº</button>
        <button class="tab-btn" onclick="switchTab(event, 'split')">åˆ†å‰²èˆ‡æå–</button>
    </div>

    <div id="merge-panel" class="work-panel active">
        <div class="upload-area" onclick="document.getElementById('input-merge').click()">
            <span class="upload-icon">ğŸ“‘</span>
            <h3 style="margin:0;">åˆä½µæ¨¡å¼ï¼šæ‹–æ”¾å¤šå€‹æª”æ¡ˆ</h3>
            <p style="color:#95a5a6; font-size:0.9rem; margin-top:10px;">æ”¯æ´ PDF / JPG / PNGï¼Œä¸Šå‚³å¾Œå¯<b>æ‹–æ›³æ’åº</b>èˆ‡<b>æ—‹è½‰</b></p>
            <input type="file" id="input-merge" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div id="merge-grid" class="page-grid"></div>
        <div id="merge-ctrl" style="display:none; margin-top:40px; border-top: 1px solid #eee; padding-top: 25px;">
            <button class="btn-main btn-green" onclick="processTask('merge')">åˆä½µä¸¦åŒ¯å‡º PDF</button>
            <button onclick="location.reload()" style="display:block; margin:15px auto; background:none; border:none; color:#95a5a6; cursor:pointer; text-decoration:underline;">æ¸…ç©ºæ‰€æœ‰æª”æ¡ˆ</button>
        </div>
    </div>

    <div id="split-panel" class="work-panel">
        <div class="upload-area" onclick="document.getElementById('input-split').click()">
            <span class="upload-icon">âœ‚ï¸</span>
            <h3 style="margin:0;">åˆ†å‰²æ¨¡å¼ï¼šä¸Šå‚³å–®ä»½ PDF</h3>
            <p style="color:#95a5a6; font-size:0.9rem; margin-top:10px;">è§£æå¾Œ<b>é»é¸</b>æƒ³è¦æå–çš„é é¢ï¼ˆç¶ è‰²é‚Šæ¡†ï¼‰</p>
            <input type="file" id="input-split" hidden accept=".pdf">
        </div>
        <div id="split-grid" class="page-grid"></div>
        <div id="split-ctrl" style="display:none; margin-top:40px; border-top: 1px solid #eee; padding-top: 25px;">
            <button class="btn-main btn-blue" onclick="processTask('split')">æå–é¸ä¸­é é¢ (ZIP)</button>
        </div>
    </div>

    <div class="feature-matrix">
        <div class="feature-card"><h3>ğŸ›¡ï¸ éš±ç§å®‰å…¨</h3><p>æ¡ç”¨ç«¯é»åŠ å¯†é‹ç®—ï¼Œæ‰€æœ‰æª”æ¡ˆçš†åœ¨æ‚¨çš„è¨­å‚™è¨˜æ†¶é«”ä¸­è™•ç†ï¼Œçµ•ä¸ä¸Šå‚³é›²ç«¯ï¼Œé©åˆè™•ç†æ©Ÿå¯†åˆç´„ã€‚</p></div>
        <div class="feature-card" style="border-top-color:var(--primary-green);"><h3>ğŸš€ æ¥µé€Ÿæ ¸å¿ƒ</h3><p>å‡ç´šç‰ˆæ¸²æŸ“å¼•æ“ï¼Œè®€å–å¤§æª”æ¡ˆé€Ÿåº¦æå‡ 500%ã€‚æ”¯æ´åœ–ç‰‡æ™ºæ…§å¹¾ä½•æ—‹è½‰ï¼Œåˆä½µå¾Œå®Œç¾ç½®ä¸­ä¸è£åˆ‡ã€‚</p></div>
        <div class="feature-card" style="border-top-color:var(--primary-blue);"><h3>ğŸ“± å…¨å¹³å°æ”¯æ´</h3><p>å®Œç¾ç›¸å®¹ Windows, Mac, Linuxã€‚é‡å° iOS Safari å¯¦ä½œå°ˆå±¬ä¸‹è¼‰æ©‹æ¥ï¼Œè§£æ±º iPhone å­˜æª”å•é¡Œã€‚</p></div>
    </div>

    <div class="qa-section">
        <h2>å¸¸è¦‹å•é¡Œ (Q&A)</h2>
        <div class="qa-grid">
            <div class="qa-item"><h4>1. iPhone ä¸‹è¼‰å¾Œæ²’åæ‡‰ï¼Ÿ</h4><p>iOS Safari å®‰å…¨æ©Ÿåˆ¶è¼ƒåš´æ ¼ã€‚åˆä½µå®Œæˆå¾Œï¼Œè‹¥è‡ªå‹•å½ˆå‡ºæ–°åˆ†é é¡¯ç¤º PDFï¼Œè«‹é»æ“Šåº•éƒ¨çš„ã€Œåˆ†äº«ã€æŒ‰éˆ•ï¼Œé¸æ“‡ã€Œå„²å­˜åˆ°æª”æ¡ˆã€å³å¯ã€‚</p></div>
            <div class="qa-item"><h4>2. åˆ†å‰²æ¨¡å¼å¦‚ä½•ä½¿ç”¨ï¼Ÿ</h4><p>åœ¨åˆ†å‰²æ¨¡å¼ä¸‹ï¼Œã€Œæ‹–æ›³æ’åºã€åŠŸèƒ½æœƒæš«æ™‚é—œé–‰ã€‚è«‹ç›´æ¥ç”¨æ»‘é¼ é»æ“Šæ‚¨æƒ³è¦ä¿ç•™çš„é é¢ï¼Œé¸ä¸­çš„é é¢æœƒé¡¯ç¤ºç¶ è‰²é‚Šæ¡†ï¼Œæœ€å¾ŒæŒ‰ä¸‹è¼‰å³å¯ã€‚</p></div>
            <div class="qa-item"><h4>3. åœ–ç‰‡æ—‹è½‰å¾Œæœƒè¢«åˆ‡æ‰å—ï¼Ÿ</h4><p>ä¸æœƒã€‚æœ¬å·¥å…·å…§å»ºå¹¾ä½•æ ¡æ­£å¼•æ“ã€‚ç•¶æ‚¨å°‡åœ–ç‰‡æ—‹è½‰ 90 åº¦æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•å°‡ PDF é é¢å¾ç›´å‘è½‰ç‚ºæ©«å‘ï¼Œç¢ºä¿åœ–ç‰‡å®Œæ•´å‘ˆç¾ã€‚</p></div>
            <div class="qa-item"><h4>4. æ”¯æ´å¤šå¤§çš„æª”æ¡ˆï¼Ÿ</h4><p>å»ºè­°å–®æª”ä¸è¶…é 100MBã€‚ç”±æ–¼æ˜¯ç´”ç€è¦½å™¨é‹ç®—ï¼Œéå¤§çš„æª”æ¡ˆå¯èƒ½æœƒå°è‡´æ‰‹æ©Ÿç€è¦½å™¨è¨˜æ†¶é«”ä¸è¶³è€Œé‡æ•´ã€‚</p></div>
        </div>
    </div>
</div>

<footer>&copy; 2026 DTZ PDF ENGINE | v26.0 æ¥µé€Ÿç‰©ç†å¼•æ“ç‰ˆ</footer>

<script>
    const { PDFDocument, degrees } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pagesData = []; let fileBuffers = {}; 
    let sortableInstance = null; // Sortable å¯¦ä¾‹æ§åˆ¶
    const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

    // --- Tab åˆ‡æ›èˆ‡ç‹€æ…‹ç®¡ç† ---
    function switchTab(evt, mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.work-panel').forEach(p => p.classList.remove('active'));
        evt.currentTarget.classList.add('active');
        document.getElementById(mode + '-panel').classList.add('active');
        
        // é‡ç½®æ•¸æ“š
        pagesData = []; fileBuffers = {};
        document.getElementById('merge-grid').innerHTML = '';
        document.getElementById('split-grid').innerHTML = '';
        document.getElementById('merge-ctrl').style.display = 'none';
        document.getElementById('split-ctrl').style.display = 'none';
    }

    document.getElementById('input-merge').onchange = (e) => handleFiles(e.target.files, 'merge');
    document.getElementById('input-split').onchange = (e) => handleFiles(e.target.files, 'split');

    // --- æ ¸å¿ƒè§£æå¼•æ“ (Fix #1: åªè®€ä¸€æ¬¡ PDF) ---
    async function handleFiles(files, mode) {
        if (files.length === 0) return;
        updateProgress(10);
        try {
            for (const file of Array.from(files)) {
                // (Fix #9) é˜»æ“‹éŒ¯èª¤æ ¼å¼
                if (mode === 'split' && !file.type.includes('pdf')) {
                    alert('åˆ†å‰²æ¨¡å¼åƒ…æ”¯æ´ PDF æª”æ¡ˆ'); continue;
                }

                const fId = crypto.randomUUID();
                const buf = await file.arrayBuffer();
                fileBuffers[fId] = buf;
                
                if (file.type === 'application/pdf') {
                    // âœ… å„ªåŒ–ï¼šåªè¼‰å…¥ä¸€æ¬¡ Document
                    const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const pId = crypto.randomUUID();
                        pagesData.push({ fId, pIdx: i-1, rot: 0, pId, type: 'pdf', selected: false, fileName: file.name });
                        await renderThumb(pdf, i, pId, mode + '-grid', mode);
                        // å‘¼å¸é»ï¼šé˜²æ­¢ UI å‡çµ
                        if (i % 5 === 0) await new Promise(r => setTimeout(r, 0));
                    }
                } else if (file.type.startsWith('image/')) {
                    const pId = crypto.randomUUID();
                    pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false, fileName: file.name });
                    await renderImgThumb(file, pId, 'merge-grid', mode);
                }
            }
            document.getElementById(mode + '-ctrl').style.display = 'block';
            
            // (Fix: Sortable åƒ…åœ¨åˆä½µæ¨¡å¼å•Ÿç”¨)
            if (mode === 'merge' && !sortableInstance) {
                initSortable();
            }
        } catch (e) { console.error(e); alert('æª”æ¡ˆè§£æå¤±æ•—ï¼Œå¯èƒ½æ˜¯æª”æ¡ˆææ¯€æˆ–å¯†ç¢¼ä¿è­·'); }
        updateProgress(0);
    }

    async function renderThumb(pdfDoc, pNum, pId, gridId, mode) {
        const page = await pdfDoc.getPage(pNum);
        const vp = page.getViewport({ scale: 0.35 });
        const cv = document.createElement('canvas');
        cv.width = vp.width; cv.height = vp.height;
        await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
        createCard(cv, pId, gridId, `é  ${pNum}`, mode);
    }

    async function renderImgThumb(file, pId, gridId, mode) {
        const url = URL.createObjectURL(file);
        const img = new Image(); img.src = url;
        await new Promise(r => img.onload = r);
        const cv = document.createElement('canvas'); const sc = 180 / img.width;
        cv.width = 180; cv.height = img.height * sc;
        cv.getContext('2d').drawImage(img, 0, 0, cv.width, cv.height);
        createCard(cv, pId, gridId, 'IMG', mode); URL.revokeObjectURL(url);
    }

    function createCard(cv, pId, gridId, label, mode) {
        const card = document.createElement('div'); 
        card.className = mode === 'split' ? 'page-card selectable' : 'page-card'; // åˆ†å‰²æ¨¡å¼æ‰æœ‰æ‰‹å‹æ¸¸æ¨™
        card.id = pId;
        
        // åˆä½µæ¨¡å¼ï¼šé¡¯ç¤ºæ—‹è½‰/åˆªé™¤å·¥å…·ï¼›åˆ†å‰²æ¨¡å¼ï¼šç´”é¸å–
        let toolsHtml = '';
        if (mode === 'merge') {
            toolsHtml = `
            <div class="card-tools">
                <button class="tool-btn" onclick="event.stopPropagation(); rotatePage('${pId}')">ğŸ”„ æ—‹è½‰</button>
                <button class="tool-btn" onclick="event.stopPropagation(); deletePage('${pId}')">âœ• åˆªé™¤</button>
            </div>`;
        }

        card.innerHTML = `<div class="badge">${label}</div><div class="cv-wrap"></div>${toolsHtml}`;
        card.querySelector('.cv-wrap').appendChild(cv);
        
        // (Fix #4) åˆ†å‰²æ¨¡å¼é¸å–é‚è¼¯
        if (mode === 'split') {
            card.onclick = () => { 
                const p = pagesData.find(x => x.pId === pId); 
                if (!p) return;
                p.selected = !p.selected; 
                card.classList.toggle('selected'); 
            };
        }
        document.getElementById(gridId).appendChild(card);
    }

    function rotatePage(pId) {
        const p = pagesData.find(x => x.pId === pId); if(!p) return;
        p.rot = (p.rot + 90) % 360;
        const cv = document.getElementById(pId).querySelector('canvas');
        cv.className = `rot-${p.rot}`;
    }

    // (Fix #3) åˆªé™¤å¾Œä¿æŒæ•¸æ“šä¸€è‡´æ€§
    function deletePage(pId) { 
        pagesData = pagesData.filter(x => x.pId !== pId); 
        const el = document.getElementById(pId);
        if(el) el.remove(); 
    }

    // (Fix #5) SortableJS é˜²ç¦¦æ€§æª¢æŸ¥
    function initSortable() {
        const el = document.getElementById('merge-grid');
        sortableInstance = new Sortable(el, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: () => {
                const ids = Array.from(el.children).map(c => c.id);
                // æ¿¾æ‰ undefined é¿å…å ±éŒ¯
                pagesData = ids.map(id => pagesData.find(p => p.pId === id)).filter(Boolean);
            }
        });
    }

    async function processTask(mode) {
        const list = mode === 'split' ? pagesData.filter(p => p.selected) : pagesData;
        if (list.length === 0) return alert('è«‹è‡³å°‘é¸å–æˆ–ä¸Šå‚³ä¸€å€‹é é¢');
        
        const btnId = mode === 'merge' ? 'btn-green' : 'btn-blue'; // é€™è£¡åƒ…ç‚ºç¤ºæ„ï¼Œå¯¦éš›æ‡‰æŠ“ DOM
        updateProgress(10);

        try {
            if (mode === 'merge') {
                const pdfDoc = await PDFDocument.create();
                for (let i = 0; i < list.length; i++) {
                    const p = list[i];
                    
                    if (p.type === 'pdf') {
                        const src = await PDFDocument.load(fileBuffers[p.fId]);
                        const [copy] = await pdfDoc.copyPages(src, [p.pIdx]);
                        // ä½¿ç”¨æ­£ç¢ºçš„ç‰©ç†æ—‹è½‰
                        copy.setRotation(degrees(p.rot + (copy.getRotation().angle || 0))); 
                        pdfDoc.addPage(copy);
                    } else {
                        const buf = await p.file.arrayBuffer();
                        const img = p.file.type.includes('png') ? await pdfDoc.embedPng(buf) : await pdfDoc.embedJpg(buf);
                        
                        // (Fix #2) åœ–ç‰‡å¹¾ä½•æ—‹è½‰æ ¡æ­£
                        const isRotated = p.rot === 90 || p.rot === 270;
                        const page = pdfDoc.addPage(isRotated ? [img.height, img.width] : [img.width, img.height]);
                        
                        // è¨ˆç®—ç¹ªè£½åº§æ¨™ (Origin Shift)
                        let x = 0, y = 0;
                        if (p.rot === 90) x = img.height;
                        else if (p.rot === 180) { x = img.width; y = img.height; }
                        else if (p.rot === 270) y = img.width;

                        page.drawImage(img, { x, y, width: img.width, height: img.height, rotate: degrees(p.rot) });
                    }
                    updateProgress(10 + (90 * (i/list.length)));
                }
                download(await pdfDoc.save(), `DTZ_Merged_${Date.now()}.pdf`, 'application/pdf');
            } else {
                // åˆ†å‰²æ¨¡å¼ (ZIP)
                const zip = new JSZip();
                for (let i = 0; i < list.length; i++) {
                    const p = list[i];
                    const singleDoc = await PDFDocument.create();
                    const src = await PDFDocument.load(fileBuffers[p.fId]);
                    const [copy] = await singleDoc.copyPages(src, [p.pIdx]);
                    singleDoc.addPage(copy);
                    
                    // (Fix #4) å„ªåŒ–æª”å
                    const safeName = (p.fileName || "doc").replace(/\.pdf$/i, "");
                    zip.file(`${safeName}_Page_${p.pIdx+1}.pdf`, await singleDoc.save());
                    updateProgress(10 + (90 * (i/list.length)));
                }
                download(await zip.generateAsync({type:'blob'}), `DTZ_Split_${Date.now()}.zip`, 'application/zip');
            }
        } catch (e) { console.error(e); alert('è™•ç†éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ææ¯€'); }
        
        // (Fix #8) é€²åº¦æ¢å»¶é²æ¶ˆå¤±
        setTimeout(() => updateProgress(0), 1000); 
    }

    function updateProgress(v) {
        const bar = document.getElementById('progress-bar');
        const con = document.getElementById('progress-container');
        con.style.display = 'block';
        bar.style.width = v + '%';
        if (v === 0) setTimeout(() => { con.style.display = 'none'; bar.style.width = '0%'; }, 500);
    }

    function download(data, name, type) {
        const blob = new Blob([data], { type });
        const url = URL.createObjectURL(blob);
        // (Fix #7) iOS Safari æ©‹æ¥
        if (type === "application/pdf" && /iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            const win = window.open(url, '_blank');
            if(!win) alert('è«‹å…è¨±å½ˆå‡ºè¦–çª—ä»¥æª¢è¦– PDF');
        } else {
            const a = document.createElement('a'); a.href = url; a.download = name;
            document.body.appendChild(a); a.click(); a.remove();
        }
        setTimeout(() => URL.revokeObjectURL(url), 10000); // å»¶é•·åˆ° 10 ç§’ç¢ºä¿ä¸‹è¼‰è§¸ç™¼
    }
</script>
</body>
</html>
