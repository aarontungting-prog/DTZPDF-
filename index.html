<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DTZ PDF v19.5 - çµ‚æ¥µå“è¶Šæ——è‰¦ç‰ˆ</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db; --bg-color: #f8fafc;
            --card-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg-color); color: #1e293b; overflow-x: hidden; }
        
        #loader-bar { position: fixed; top: 0; left: 0; width: 0%; height: 5px; background: linear-gradient(90deg, var(--primary-green), var(--primary-blue)); z-index: 2001; transition: width 0.3s ease; }
        nav { background: white; padding: 1rem 8%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.6rem; font-weight: 800; color: var(--primary-red); text-decoration: none; }

        .container { max-width: 1100px; margin: 20px auto; padding: 0 20px; text-align: center; }
        .work-panel { background: white; padding: 35px; border-radius: 28px; box-shadow: var(--card-shadow); min-height: 520px; display: none; opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
        .work-panel.active { display: block; opacity: 1; transform: translateY(0); }

        .upload-area { border: 3px dashed #cbd5e0; border-radius: 24px; padding: 50px; cursor: pointer; background: #fff; transition: 0.3s; position: relative; }
        .upload-area:hover { border-color: var(--primary-red); background: #fffaf9; box-shadow: inset 0 0 20px rgba(231, 76, 60, 0.05); }

        /* âœ… ä¿®æ­£ 1.2: Side-grid æ¯”ä¾‹è‡ªé©æ‡‰èˆ‡æ»¾å‹•å„ªåŒ– */
        .sidebar { position: fixed; left: -270px; top: 80px; width: 240px; height: calc(100vh - 120px); background: white; padding: 20px; box-shadow: 5px 0 25px rgba(0,0,0,0.1); transition: 0.4s; z-index: 1500; overflow-y: auto; border-radius: 0 24px 24px 0; scroll-snap-type: y proximity; }
        .sidebar.open { left: 0; }
        .side-thumb-wrap { margin-bottom: 20px; border-radius: 12px; border: 3px solid #eee; overflow: hidden; transition: 0.3s; position: relative; scroll-snap-align: start; background: #f1f5f9; }
        .side-thumb-wrap.active { border-color: var(--primary-green); transform: scale(1.03); }

        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px; margin-top: 30px; }
        .page-card { background: #fff; border: 2px solid #eee; padding: 12px; border-radius: 18px; position: relative; cursor: grab; transition: 0.3s; }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        /* âœ… ä¿®æ­£ 1.2: ç¸®åœ–æ¯”ä¾‹ä¿æŒä¸è®Šå½¢ */
        .cv-wrap { display: flex; align-items: center; justify-content: center; min-height: 200px; overflow: hidden; }
        canvas { max-width: 100%; max-height: 100%; border-radius: 6px; transition: transform 0.4s ease; transform-origin: center center; }

        /* âœ… ä¿®æ­£ 1.1: Metadata/Safe çª„è¢å¹•é«˜åº¦ä¸€è‡´æ€§ */
        .safe-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; text-align: left; align-items: stretch; }
        .safe-card { background: #f8fafc; padding: 28px; border-radius: 20px; border: 1px solid #e2e8f0; min-height: 240px; display: flex; flex-direction: column; }
        .meta-input { width: 100%; padding: 12px; margin: 8px 0 15px 0; border-radius: 12px; border: 1px solid #cbd5e0; box-sizing: border-box; }

        .btn-action { padding: 14px 35px; border-radius: 50px; border: none; font-size: 1rem; font-weight: 700; cursor: pointer; color: white; transition: 0.3s; margin: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .btn-green { background: var(--primary-green); } .btn-blue { background: var(--primary-blue); }
        .btn-action:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        
        .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }
        .hidden-search { display: none; }
        
        @media (max-width: 900px) { .sidebar { width: 100%; height: 320px; bottom: -450px; top: auto; left: 0; border-radius: 24px 24px 0 0; } .sidebar.open { bottom: 0; } }
    </style>
</head>
<body>

<div id="loader-bar"></div>
<div id="side-toggle" style="position:fixed; left:0; top:50%; transform:translateY(-50%); background:var(--primary-red); color:white; padding:18px 8px; border-radius:0 12px 12px 0; cursor:pointer; z-index:2000; writing-mode:vertical-lr; font-size:12px; font-weight:bold; box-shadow: 3px 0 15px rgba(0,0,0,0.1);">ğŸ“„ å¿«é€Ÿå°èˆª</div>

<aside class="sidebar">
    <h3 style="color:var(--primary-red); font-size:1.1rem; margin-bottom:20px;">ğŸ” é é¢éæ¿¾</h3>
    <input type="text" id="search-input" placeholder="æœå°‹ PDF æ–‡å­—..." onkeyup="searchPDF()" style="width:95%; padding:12px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px; outline:none;">
    <div id="side-grid"></div>
</aside>

<nav>
    <a href="#" class="logo">DTZ PDF <span style="font-size:0.75rem; background:var(--primary-red); color:white; padding:3px 10px; border-radius:50px; margin-left:8px; letter-spacing: 0;">v19.5</span></a>
    <div style="font-size: 0.85rem; color: #64748b; font-weight: bold;">â— å“è¶Šç‡Ÿé‹æœ€çµ‚é«”</div>
</nav>

<div class="container">
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab(event, 'main')">æ•´ç†èˆ‡åˆ†å‰²</button>
        <button class="tab-btn" onclick="switchTab(event, 'adv')">é«˜ç´šè£é£¾</button>
        <button class="tab-btn" onclick="switchTab(event, 'safe')">å®‰å…¨èˆ‡å±¬æ€§</button>
    </div>

    <div id="main-panel" class="work-panel active">
        <div class="upload-area" id="drop-zone">
            <div style="font-size:55px;">ğŸ“‚</div>
            <h3 style="margin:10px 0;">é»æ“Šæˆ–æ‹–æ”¾æª”æ¡ˆä¸Šå‚³</h3>
            <div id="upload-status" style="color:var(--primary-blue); font-weight:600; font-size:0.9rem;">æº–å‚™å°±ç·’ï¼Œæ”¯æ´è¶…å¤§å‹ PDF åˆ†æ®µè™•ç†</div>
            <input type="file" id="input-org" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div id="org-grid" class="page-grid"></div>
        <div id="org-ctrl" style="display:none; margin-top:35px;">
            <div style="background:#f1f5f9; padding:20px; border-radius:24px; margin-bottom:25px; display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap;">
                <strong>å¿«é€Ÿæ“ä½œï¼š</strong>
                <button class="tab-btn" style="border-color:#475569; color:#475569;" onclick="rotateAll90()">å…¨éƒ¨å³è½‰ 90Â°</button>
                <button class="tab-btn" style="border-color:#7c3aed; color:#7c3aed;" onclick="location.reload()">å…¨éƒ¨æ¸…ç©º</button>
            </div>
            <button class="btn-action btn-green" onclick="processPdf('merge')">åˆä½µå–®ä»½ PDF</button>
            <button class="btn-action btn-blue" onclick="processPdf('split')">æ‰€é¸æå– (ZIP)</button>
        </div>
    </div>

    <div id="adv-panel" class="work-panel">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px; text-align:left;">
            <div class="safe-card">
                <h4>ğŸ›¡ï¸ ä¸­å¿ƒå®šä½æµ®æ°´å°</h4>
                <input type="text" id="wm-text" placeholder="å…§éƒ¨æ©Ÿå¯†, åƒ…ä¾›åƒè€ƒ..." class="meta-input">
                <div style="font-size:0.8rem; font-weight:600; color:#475569;">é€æ˜åº¦è¨­å®š:</div>
                <input type="range" id="wm-op" min="0.1" max="1.0" step="0.1" value="0.3" style="width:100%; margin:10px 0;">
                <div style="font-size:0.75rem; color:#94a3b8;">â€» è‡ªå‹•å¹¾ä½•æ ¡æ­£ï¼šæ–‡å­—å°‡ä¾æ“šé é¢å¯¬åº¦è‡ªå‹•ç¸®æ”¾ä¸¦ç²¾æº–å±…ä¸­ã€‚</div>
            </div>
            <div class="safe-card">
                <h4>ğŸ–¼ï¸ é«˜è§£æåœ–ç‰‡å°å‡º</h4>
                <p style="font-size:0.85rem; color:#64748b;">é¸å–å·¦æ–¹å°èˆªæˆ–ä¸»ç•«é¢é é¢å¾Œï¼Œå°‡å…¶è½‰æ›ç‚ºé«˜å“è³ª 300DPI åœ–ç‰‡ã€‚</p>
                <button class="btn-action btn-blue" style="width:100%; margin-top:auto;" onclick="exportAsImage()">åŒ¯å‡ºé¸ä¸­é ç‚ºåœ–ç‰‡</button>
            </div>
        </div>
        <hr style="margin:35px 0; border:0; border-top:2px solid #f1f5f9;">
        <h3 style="margin-bottom:15px;">âœ’ï¸ æ‰¹é‡é›»å­ç°½åæ¿</h3>
        <p style="font-size:0.85rem; color:#f59e0b; font-weight:bold;">â— æ‰¹é‡ç°½åå·²å•Ÿå‹•ï¼šé¸å–çš„ã€Œæ‰€æœ‰é é¢ (ç¶ æ¡†)ã€éƒ½å°‡è¢«æ’å…¥æ­¤ç°½åã€‚</p>
        <canvas id="sig-canvas" width="1200" height="600" style="border:3px solid #1e293b; background:#fff; touch-action:none; width:400px; height:200px; border-radius:16px; cursor:crosshair;"></canvas><br>
        <button class="tab-btn" onclick="clearSig()">æ¸…é™¤é‡ç°½</button>
        <button class="btn-action btn-blue" onclick="saveSig()">å„²å­˜ä¸¦æ’å…¥é¸ä¸­é é¢</button>
    </div>

    <div id="safe-panel" class="work-panel">
        <div class="safe-grid">
            <div class="safe-card">
                <h3>ğŸ“ æª”æ¡ˆ Metadata è¨­å®š</h3>
                <label>æ–‡ä»¶æ¨™é¡Œ (Title)</label><input type="text" id="m-title" class="meta-input" placeholder="è‡ªå‹•æŠ“å–ç¬¬ä¸€å€‹æª”å">
                <label>ä½œè€…å§“å (Author)</label><input type="text" id="m-author" class="meta-input" placeholder="æ‚¨çš„åå­—">
            </div>
            <div class="safe-card">
                <h3>ğŸ”’ é–‹å•Ÿå¯†ç¢¼èˆ‡æ¬Šé™æ§ç®¡</h3>
                <label>é–‹å•Ÿå¯†ç¢¼ (User Password)</label><input type="password" id="p-u" class="meta-input" placeholder="è‹¥ç„¡éœ€æ±‚è«‹ç•™ç™½">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; font-size:0.9rem; font-weight:bold;">
                    <label><input type="checkbox" id="can-print" checked> å…è¨±åˆ—å°</label>
                    <label><input type="checkbox" id="can-copy" checked> å…è¨±è¤‡è£½æ–‡å­—</label>
                </div>
                <div style="font-size:0.75rem; color:var(--primary-red); margin-top:auto; line-height:1.4;">â€» è²æ˜ï¼šå®‰å…¨æ€§è¨­å®šåš´è¬¹åº¦ä¾ä¸åŒ PDF é–±è®€å™¨å°æ¬Šé™è¦ç¯„ä¹‹æ”¯æ´è€Œå®šã€‚</div>
            </div>
        </div>
    </div>
</div>

<footer>&copy; 2026 DTZ PDF ENGINE | v19.5 ç‡Ÿé‹é«”æœ€çµ‚å®Œæˆç‰ˆ</footer>

<script>
    const { PDFDocument, degrees, rgb, StandardFonts } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pagesData = []; let fileBuffers = {}; let pdfCache = {}; let sigImage = null; let sigTargetId = null;

    function download(data, filename, type) {
        const blob = data instanceof Blob ? data : new Blob([data], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 2000);
    }

    const dropZone = document.getElementById('drop-zone');
    dropZone.onclick = () => document.getElementById('input-org').click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if(e.dataTransfer.files.length) handleFiles(e.dataTransfer.files); };
    document.getElementById('input-org').onchange = (e) => handleFiles(e.target.files);

    async function handleFiles(files) {
        updateProgress(5);
        const status = document.getElementById('upload-status');
        const titleInput = document.getElementById('m-title');
        if (!titleInput.value && files.length > 0) titleInput.value = files[0].name.split('.')[0];

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            status.innerText = `æ­£åœ¨è®€å– (${i+1}/${files.length}): ${file.name}`;
            const fId = crypto.randomUUID();
            const buf = await file.arrayBuffer();
            fileBuffers[fId] = buf;
            
            if (file.name.toLowerCase().endsWith('.pdf')) {
                const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
                for (let j = 1; j <= pdf.numPages; j++) {
                    const pId = crypto.randomUUID();
                    const page = await pdf.getPage(j);
                    const txt = (await page.getTextContent()).items.map(s => s.str).join(' ');
                    pagesData.push({ fId, pIdx: j-1, rot: 0, pId, type: 'pdf', selected: false, text: txt, fileName: file.name });
                    await renderThumb(page, pId, j);
                    if (j % 5 === 0) await new Promise(r => setTimeout(r, 0));
                }
            } else {
                const pId = crypto.randomUUID();
                pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false, text:'', fileName: file.name });
                renderImgThumb(file, pId);
            }
            updateProgress(5 + (95 * (i/files.length)));
        }
        document.getElementById('org-ctrl').style.display = 'block';
        status.innerText = `è®€å–å®Œæˆï¼Œå…± ${pagesData.length} é å¯æ“ä½œ`;
        updateProgress(0);
    }

    async function renderThumb(page, pId, pNum) {
        const vp = page.getViewport({ scale: 0.3 });
        const cv = document.createElement('canvas');
        cv.width = vp.width; cv.height = vp.height;
        await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
        createCard(cv, pId, `P${pNum}`);
    }

    function renderImgThumb(file, pId) {
        const url = URL.createObjectURL(file);
        const img = new Image(); img.src = url;
        img.onload = () => {
            const cv = document.createElement('canvas'); 
            // âœ… ä¿®æ­£ 1.2: ä¿æŒåœ–ç‰‡åŸå§‹æ¯”ä¾‹ç¸®ç•¥åœ–
            const maxW = 150; const sc = maxW / img.width;
            cv.width = maxW; cv.height = img.height * sc;
            cv.getContext('2d').drawImage(img, 0, 0, cv.width, cv.height);
            createCard(cv, pId, 'IMG'); URL.revokeObjectURL(url);
        };
    }

    function createCard(cv, pId, label) {
        const card = document.createElement('div'); card.className = 'page-card'; card.id = pId;
        card.innerHTML = `<div style="position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.6);color:white;font-size:10px;padding:2px 6px;border-radius:4px;z-index:10;">${label}</div><div class="cv-wrap"></div><div style="margin-top:10px;display:flex;justify-content:center;gap:6px;"><button class="tab-btn" style="font-size:10px;padding:5px 12px;" onclick="event.stopPropagation(); rotateP('${pId}')">æ—‹è½‰</button><button class="tab-btn" style="font-size:10px;padding:5px 12px;" onclick="event.stopPropagation(); delP('${pId}')">åˆªé™¤</button></div>`;
        card.querySelector('.cv-wrap').appendChild(cv);
        card.onclick = () => toggleSelect(pId);
        document.getElementById('org-grid').appendChild(card);
        
        const sideWrap = document.createElement('div'); sideWrap.className = 'side-thumb-wrap'; sideWrap.id = 'side-wrap-'+pId;
        const scv = document.createElement('canvas'); scv.id = 'side-'+pId; scv.width = cv.width; scv.height = cv.height; scv.style.width = '100%'; scv.getContext('2d').drawImage(cv, 0, 0);
        scv.onclick = () => document.getElementById(pId).scrollIntoView({behavior:'smooth'});
        sideWrap.appendChild(scv); document.getElementById('side-grid').appendChild(sideWrap);
    }

    function toggleSelect(pId) {
        const p = pagesData.find(x => x.pId === pId); p.selected = !p.selected;
        document.getElementById(pId).classList.toggle('selected');
        document.getElementById('side-wrap-'+pId).classList.toggle('active');
        sigTargetId = pId;
    }

    // --- âœ… ä¿®æ­£ 1.3 & 2.1: å¹¾ä½•ä¸­å¿ƒæµ®æ°´å°èˆ‡æ‰¹é‡ç°½å ---
    async function processPdf(mode) {
        updateProgress(5);
        const zip = mode === 'split' ? new JSZip() : null;
        try {
            const mainDoc = mode === 'merge' ? await PDFDocument.create() : null;
            let mainFont = null;
            if (mainDoc) {
                mainFont = await mainDoc.embedFont(StandardFonts.HelveticaBold);
                mainDoc.setTitle(document.getElementById('m-title').value || "DTZ_Merged");
                mainDoc.setAuthor(document.getElementById('m-author').value || "DTZ_USER");
            }

            const list = mode === 'split' ? pagesData.filter(p => p.selected) : pagesData;
            if(!list.length) return alert('å°šæœªé¸å–ä»»ä½•é é¢');

            const saveOpts = { userPassword: document.getElementById('p-u').value || undefined, permissions: { printing: !!document.getElementById('can-print').checked, copying: !!document.getElementById('can-copy').checked } };

            for (let i = 0; i < list.length; i++) {
                const p = list[i];
                let curDoc = mode === 'merge' ? mainDoc : await PDFDocument.create();
                const curFont = mode === 'merge' ? mainFont : await curDoc.embedFont(StandardFonts.HelveticaBold);
                if (mode === 'split') {
                    curDoc.setTitle(document.getElementById('m-title').value || p.fileName.split('.')[0]);
                    curDoc.setAuthor(document.getElementById('m-author').value || "DTZ_USER");
                }

                let newPage;
                if (p.type === 'pdf') {
                    if (!pdfCache[p.fId]) pdfCache[p.fId] = await PDFDocument.load(fileBuffers[p.fId]);
                    const [copy] = await curDoc.copyPages(pdfCache[p.fId], [p.pIdx]);
                    copy.setRotation(degrees((p.rot + (copy.getRotation().angle || 0)) % 360));
                    newPage = curDoc.addPage(copy);
                } else {
                    const img = await curDoc.embedPng(await p.file.arrayBuffer());
                    newPage = curDoc.addPage([img.width, img.height]);
                    newPage.drawImage(img, { x:0, y:0, width:img.width, height:img.height, rotate:degrees(p.rot) });
                }

                const { width, height } = newPage.getSize();
                const wm = document.getElementById('wm-text').value;
                if(wm) {
                    try { // âœ… ä¿®æ­£ 1.3: æ–‡å­—ç½®ä¸­å®šä½
                        const fontSize = width / 12;
                        const textWidth = wm.length * (fontSize * 0.6); // ç²—ä¼°å¯¬åº¦
                        newPage.drawText(wm, { x: width/2 - textWidth/2, y: height/2.2, size: fontSize, font: curFont, color: rgb(0.88, 0.88, 0.88), opacity: parseFloat(document.getElementById('wm-op').value), rotate: degrees(35) });
                    } catch(e){}
                }

                // âœ… ä¿®æ­£ 2.1: å¦‚æœæœ‰ç°½åä¸”è©²é è¢«é¸ä¸­ï¼Œæ’å…¥ç°½å
                if (p.selected && sigImage) {
                    try {
                        const sig = await curDoc.embedPng(sigImage);
                        const sW = width / 4.5; const sH = sW / 2;
                        newPage.drawImage(sig, { x: width - sW - 40, y: 40, width: sW, height: sH });
                    } catch(e){}
                }

                if (mode === 'split') zip.file(`ID${i+1}_${p.fileName.split('.')[0]}_P${p.pIdx+1}.pdf`, await curDoc.save(saveOpts));
                updateProgress(5 + (90 * (i/list.length)));
                if (i % 8 === 0) await new Promise(r => setTimeout(r, 0));
            }

            if (mode === 'merge') {
                download(await mainDoc.save(saveOpts), `${document.getElementById('m-title').value}.pdf`, 'application/pdf');
            } else {
                download(await zip.generateAsync({type:'blob', compression: "DEFLATE"}), `DTZ_Splits_${Date.now()}.zip`, 'application/zip');
            }
        } catch (e) { alert("è™•ç†ç™¼ç”Ÿç•°å¸¸"); }
        updateProgress(0);
    }

    // âœ… ä¿®æ­£ 2.2: é«˜æ¸…å°å‡ºæ—‹è½‰ä¸­å¿ƒæ ¡æ­£
    async function exportAsImage() {
        const p = pagesData.find(x => x.pId === sigTargetId);
        if(!p) return alert("è«‹å…ˆé¸å–ä¸€é é é¢");
        updateProgress(50);
        const cv = document.createElement('canvas'); const ctx = cv.getContext('2d');
        if (p.type === 'pdf') {
            const pdf = await pdfjsLib.getDocument({ data: fileBuffers[p.fId] }).promise;
            const page = await pdf.getPage(p.pIdx + 1);
            const vp = page.getViewport({ scale: 4.5, rotation: p.rot }); // âœ… æ¥µè‡´æ¡æ¨£
            cv.width = vp.width; cv.height = vp.height;
            await page.render({ canvasContext: ctx, viewport: vp }).promise;
        } else {
            const img = new Image(); img.src = URL.createObjectURL(p.file);
            await new Promise(r => img.onload = r);
            if (p.rot % 180 !== 0) { cv.width = img.naturalHeight; cv.height = img.naturalWidth; } 
            else { cv.width = img.naturalWidth; cv.height = img.naturalHeight; }
            ctx.translate(cv.width/2, cv.height/2); ctx.rotate(p.rot * Math.PI / 180);
            ctx.drawImage(img, -img.naturalWidth/2, -img.naturalHeight/2);
        }
        cv.toBlob(b => { download(b, `DTZ_300DPI_${p.fileName.split('.')[0]}.jpg`, 'image/jpeg'); updateProgress(0); }, 'image/jpeg', 0.98);
    }

    function rotateAll90() { pagesData.forEach(p => rotateP(p.pId)); }
    function rotateP(pId) {
        const p = pagesData.find(x => x.pId === pId); p.rot = (p.rot + 90) % 360;
        ['canvas', 'side-'+pId].forEach(elId => {
            const el = document.getElementById(elId); if(!el) return;
            const cv = el.tagName === 'CANVAS' ? el : el.querySelector('canvas');
            cv.classList.remove('rot-0','rot-90','rot-180','rot-270'); cv.classList.add(`rot-${p.rot}`);
        });
    }

    function delP(pId) { pagesData = pagesData.filter(x => x.pId !== pId); document.getElementById(pId).remove(); document.getElementById('side-wrap-'+pId).remove(); }
    function searchPDF() {
        const q = document.getElementById('search-input').value.toLowerCase();
        pagesData.forEach(p => {
            const el = document.getElementById(p.pId); const side = document.getElementById('side-wrap-'+p.pId);
            const match = p.type === 'img' || p.text.toLowerCase().includes(q);
            el.classList.toggle('hidden-search', !match); side.style.display = match ? 'block' : 'none';
        });
    }
    const sigCanvas = document.getElementById('sig-canvas'); const sCtx = sigCanvas.getContext('2d'); let drawing = false;
    function getXY(e) { const rect = sigCanvas.getBoundingClientRect(); return { x: ((e.clientX || (e.touches && e.touches[0].clientX)) - rect.left) * (1200/rect.width), y: ((e.clientY || (e.touches && e.touches[0].clientY)) - rect.top) * (600/rect.height) }; }
    sigCanvas.onmousedown = sigCanvas.ontouchstart = (e) => { drawing = true; const p = getXY(e); sCtx.lineWidth = 5; sCtx.lineCap = 'round'; sCtx.beginPath(); sCtx.moveTo(p.x, p.y); e.preventDefault(); };
    sigCanvas.onmousemove = sigCanvas.ontouchmove = (e) => { if(!drawing) return; const p = getXY(e); sCtx.lineTo(p.x, p.y); sCtx.stroke(); };
    window.onmouseup = window.ontouchend = () => drawing = false;
    function clearSig() { sCtx.clearRect(0,0,1200,600); }
    function saveSig() { sigImage = sigCanvas.toDataURL(); alert('ç°½åå·²å„²å­˜ã€‚ç¾åœ¨é¸å–çš„æ‰€æœ‰é é¢(ç¶ æ¡†)éƒ½å°‡è¢«ç°½åã€‚'); }

    function switchTab(evt, tab) { document.querySelectorAll('.work-panel').forEach(p => p.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tab + '-panel').classList.add('active'); evt.currentTarget.classList.add('active'); }
    function updateProgress(v) { const bar = document.getElementById('loader-bar'); bar.style.width = v + '%'; bar.style.opacity = v === 0 ? '0' : '1'; }
    document.getElementById('side-toggle').onclick = (e) => { e.stopPropagation(); document.querySelector('.sidebar').classList.toggle('open'); };
    document.addEventListener('click', () => document.querySelector('.sidebar').classList.remove('open'));
    new Sortable(document.getElementById('org-grid'), { animation: 150, onEnd: () => {
        const order = Array.from(document.getElementById('org-grid').children).map(c => c.id);
        pagesData.sort((a,b) => order.indexOf(a.pId) - order.indexOf(b.pId));
        order.forEach(id => document.getElementById('side-grid').appendChild(document.getElementById('side-wrap-'+id)));
    }});
</script>
</body>
</html>
