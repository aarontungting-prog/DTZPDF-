<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>DTZ PDF v16.0 - æ°¸æ†å¢ƒåœ° 2.0 æ——è‰¦ç‰ˆ</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db; --primary-yellow: #f1c40f;
            --bg-color: #f0f3f7; --card-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg-color); color: #2d3436; line-height: 1.6; }
        
        /* å…¨åŸŸè¼‰å…¥æ¢ */
        #loader-bar { position: fixed; top: 0; left: 0; width: 0%; height: 5px; background: linear-gradient(90deg, var(--primary-red), var(--primary-blue)); z-index: 2001; transition: width 0.3s; box-shadow: 0 0 10px rgba(0,0,0,0.2); }

        /* é ‚éƒ¨å°èˆª */
        nav { background: white; padding: 1rem 8%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.8rem; font-weight: 900; color: var(--primary-red); text-decoration: none; letter-spacing: -1.5px; }
        .version-badge { font-size: 0.7rem; background: var(--primary-red); color: white; padding: 3px 10px; border-radius: 50px; margin-left: 8px; vertical-align: middle; }

        /* å´é‚ŠæŠ½å±œå°èˆª */
        #side-toggle { position: fixed; left: 0; top: 50%; transform: translateY(-50%); background: var(--primary-red); color: white; padding: 20px 8px; border-radius: 0 15px 15px 0; cursor: pointer; z-index: 2000; font-size: 14px; writing-mode: vertical-lr; box-shadow: 5px 0 15px rgba(0,0,0,0.1); transition: 0.3s ease; }
        #side-toggle:hover { padding-left: 12px; }
        .sidebar { position: fixed; left: -280px; top: 100px; width: 240px; height: calc(100vh - 150px); background: var(--card-bg); backdrop-filter: blur(10px); padding: 25px; box-shadow: 10px 0 40px rgba(0,0,0,0.1); transition: 0.5s cubic-bezier(0.77, 0, 0.175, 1); z-index: 1500; overflow-y: auto; border-radius: 0 30px 30px 0; }
        .sidebar.open { left: 0; }
        .sidebar canvas { transition: transform 0.4s; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; transform-origin: center center; }

        /* å®¹å™¨èˆ‡å·¥ä½œé¢æ¿ */
        .container { max-width: 1200px; margin: 40px auto; padding: 0 25px; text-align: center; }
        .work-panel { background: var(--card-bg); padding: 45px; border-radius: 35px; box-shadow: var(--card-shadow); min-height: 550px; display: none; border: 1px solid rgba(255,255,255,0.5); }
        .work-panel.active { display: block; animation: slideUp 0.5s ease-out; }

        /* æ¨™ç±¤å°èˆª */
        .tab-nav { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; flex-wrap: wrap; }
        .tab-btn { padding: 14px 30px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .tab-btn.active { background: var(--primary-red); color: white; box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3); }

        /* ä¸Šå‚³èˆ‡å¡ç‰‡ */
        .upload-area { border: 3px dashed #cbd5e0; border-radius: 30px; padding: 60px; cursor: pointer; background: white; transition: 0.3s; }
        .upload-area.dragover { border-color: var(--primary-red); background: #fffaf9; transform: scale(1.02); }
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; margin-top: 40px; }
        .page-card { background: #fff; border: 2px solid #f1f1f1; padding: 15px; border-radius: 20px; position: relative; cursor: grab; transition: 0.3s; }
        .page-card:hover { transform: translateY(-8px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        .page-card canvas { width: 100%; border-radius: 12px; transition: transform 0.4s; transform-origin: center center; }
        .hidden-search { display: none; }

        /* æ ¸å¿ƒèƒ½åŠ›çŸ©é™£ (åŸä¸‰å€‹æ ¼å­) */
        .feature-matrix { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-top: 100px; text-align: left; }
        .feature-card { background: white; padding: 40px; border-radius: 28px; box-shadow: var(--card-shadow); border-top: 8px solid transparent; transition: 0.4s; }
        .feature-card:hover { transform: translateY(-15px); }
        .f-red { border-top-color: var(--primary-red); } .f-green { border-top-color: var(--primary-green); } .f-blue { border-top-color: var(--primary-blue); }
        .feature-card h3 { font-size: 1.5rem; margin-bottom: 15px; }

        /* æŒ‰éˆ•ç³»çµ± */
        .btn-action { padding: 16px 45px; border-radius: 50px; border: none; font-size: 1.1rem; font-weight: 800; cursor: pointer; color: white; transition: 0.3s; margin: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-green { background: var(--primary-green); box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3); }
        .btn-blue { background: var(--primary-blue); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3); }

        /* Q&A å¤§å…¨å€å¡Š */
        .qa-container { text-align: left; background: white; padding: 60px; border-radius: 35px; margin-top: 100px; box-shadow: var(--card-shadow); }
        .qa-container h2 { font-size: 2.2rem; color: var(--primary-red); margin-bottom: 40px; border-left: 10px solid var(--primary-red); padding-left: 25px; }
        .qa-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 40px; }
        .qa-item h4 { font-size: 1.25rem; color: #2d3436; margin-bottom: 12px; }
        .qa-item p { color: #636e72; font-size: 1.05rem; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 950px) { .feature-matrix, .qa-grid { grid-template-columns: 1fr; } .sidebar { width: 100%; height: 350px; bottom: -450px; top: auto; border-radius: 30px 30px 0 0; } .sidebar.open { bottom: 0; } }
        footer { margin: 100px 0 50px; color: #b2bec3; font-size: 1rem; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div id="loader-bar"></div>
<div id="side-toggle">ğŸ“„ å¿«é€Ÿé é¢å°èˆª</div>

<aside class="sidebar">
    <h3 style="color:var(--primary-red); margin-bottom: 20px;">ğŸ” æœå°‹èˆ‡å®šä½</h3>
    <input type="text" id="search-input" placeholder="æœå°‹ PDF å…§å®¹..." onkeyup="searchPDF()" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-bottom:25px; font-size:1rem;">
    <div id="side-grid"></div>
</aside>

<nav>
    <a href="#" class="logo">DTZ PDF <span class="version-badge">v16.0 æ°¸æ†å¢ƒåœ°</span></a>
    <div style="font-size: 0.9rem; font-weight: bold; color: #2ecc71;">â— æ ¸å¿ƒåŠ å¯†å¼•æ“é‹ä½œä¸­</div>
</nav>

<div class="container">
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab(event, 'main')">æ•´ç†ã€åˆ†å‰²èˆ‡æå–</button>
        <button class="tab-btn" onclick="switchTab(event, 'adv')">é«˜ç´šè£é£¾å·¥å…·</button>
        <button class="tab-btn" onclick="switchTab(event, 'safe')">å®‰å…¨èˆ‡å±¬æ€§è¨­å®š</button>
    </div>

    <div id="main-panel" class="work-panel active">
        <div class="upload-area" id="drop-zone">
            <div style="font-size:60px; margin-bottom: 20px;">ğŸ“‚</div>
            <h3 style="font-size: 1.5rem;">é»æ“Šæˆ–æ‹–æ”¾æª”æ¡ˆé–‹å§‹è™•ç†</h3>
            <p style="color:#95a5a6;">æ”¯æ´ PDF, JPG, PNG æ··åˆçµ„ç¹”èˆ‡åˆ†å‰²</p>
            <input type="file" id="input-org" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div id="org-grid" class="page-grid"></div>
        <div id="org-ctrl" style="display:none; margin-top:45px;">
            <div style="background:rgba(0,0,0,0.03); padding:20px; border-radius:20px; margin-bottom:25px;">
                <strong style="margin-right:15px;">å¿«é€Ÿæ‰¹æ¬¡ï¼š</strong>
                <button class="tab-btn" style="border-color:#34495e; color:#34495e;" onclick="batchRotate()">å…¨éƒ¨å³è½‰ 90Â°</button>
                <button class="tab-btn" style="border-color:#8e44ad; color:#8e44ad;" onclick="insertBlank()">æ’å…¥ A4 ç©ºç™½é </button>
            </div>
            <button class="tab-btn" style="background:#95a5a6; color:#fff; border:none;" onclick="location.reload()">å…¨éƒ¨æ¸…ç©º</button>
            <button class="btn-action btn-green" onclick="processPdf('merge')">åˆä½µç‚ºå–®ä¸€ PDF</button>
            <button class="btn-action btn-blue" onclick="processPdf('split')">æå–æ‰€é¸é é¢ (ZIP)</button>
        </div>
    </div>

    <div id="adv-panel" class="work-panel">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; text-align:left;">
            <div style="background:#f8f9fa; padding:30px; border-radius:25px;">
                <h4 style="color:var(--primary-red);">ğŸ›¡ï¸ å•†æ¥­æµ®æ°´å°</h4>
                <input type="text" id="wm-text" placeholder="è¼¸å…¥æ–‡å­—å…§å®¹" style="width:100%; padding:14px; border-radius:12px; border:1px solid #ddd; margin-bottom:15px;">
                <div style="font-size:0.9rem;">é€æ˜åº¦: <input type="range" id="wm-op" min="0.1" max="1.0" step="0.1" value="0.3" style="width:100%;"></div>
            </div>
            <div style="background:#f8f9fa; padding:30px; border-radius:25px;">
                <h4 style="color:var(--primary-blue);">ğŸ–¼ï¸ é é¢å¦å­˜åœ–ç‰‡</h4>
                <p style="font-size:0.9rem; color:#666;">é»é¸æ•´ç†é¢æ¿ä¸­çš„æŸä¸€é é¢å¾Œï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•å°‡å…¶å­˜ç‚ºé«˜å“è³ª JPGã€‚</p>
                <button class="btn-action btn-blue" style="width:100%; margin:0;" onclick="exportAsImage()">ç«‹å³åŒ¯å‡ºé¸ä¸­é </button>
            </div>
        </div>
        <hr style="margin:40px 0; border:0; border-top:2px solid #eee;">
        <h3 style="margin-bottom: 25px;">âœ’ï¸ å·¥æ¥­ç´šæ‰‹å¯«ç°½åæ¿ (2x é«˜è§£æ)</h3>
        <div style="background:#f1f1f1; padding:25px; border-radius:30px; display:inline-block;">
            <canvas id="sig-canvas" width="800" height="400" style="border:3px solid #2d3436; background:#fff; touch-action:none; width:400px; height:200px; border-radius:15px; cursor:crosshair;"></canvas>
        </div>
        <div style="margin-top:25px;">
            <button class="tab-btn" onclick="clearSig()">æ¸…é™¤é‡ç°½</button>
            <button class="btn-action btn-blue" onclick="saveSig()">å„²å­˜ç°½åä¸¦æ¨™è¨˜é é¢</button>
        </div>
    </div>

    <div id="safe-panel" class="work-panel">
        <div style="max-width:700px; margin:0 auto; text-align:left; display:grid; grid-template-columns: 1fr 1fr; gap:40px;">
            <div>
                <h3 style="color:var(--primary-red);">ğŸ“ Metadata å¯«å…¥</h3>
                <label>æ–‡ä»¶æ¨™é¡Œ</label><input type="text" id="m-title" class="tab-btn" style="width:100%; border-radius:10px;" placeholder="DTZ Merged Doc">
                <label>ä½œè€…åç¨±</label><input type="text" id="m-author" class="tab-btn" style="width:100%; border-radius:10px;" placeholder="DTZ PDF User">
                <label>æ–‡ä»¶ä¸»é¡Œ</label><input type="text" id="m-subject" class="tab-btn" style="width:100%; border-radius:10px;" placeholder="æœ¬åœ°é‹ç®—æˆæœ">
            </div>
            <div style="border-left: 2px solid #eee; padding-left: 40px;">
                <h3 style="color:var(--primary-green);">ğŸ”’ åŠ å¯†æ¬Šé™è¨­å®š</h3>
                <label>é–‹å•Ÿå¯†ç¢¼ (User)</label><input type="password" id="p-u" class="tab-btn" style="width:100%; border-radius:10px;" placeholder="è‹¥ä¸è¨­è«‹ç•™ç™½">
                <label>ç®¡ç†å¯†ç¢¼ (Owner)</label><input type="password" id="p-o" class="tab-btn" style="width:100%; border-radius:10px;" placeholder="è‹¥éœ€é™åˆ¶æ¬Šé™è«‹å¡«å¯«">
                <div style="margin-top:20px; font-size:0.9rem;">
                    <label><input type="checkbox" id="can-print" checked> å…è¨±åˆ—å°</label><br>
                    <label><input type="checkbox" id="can-copy" checked> å…è¨±å…§å®¹è¤‡è£½</label>
                </div>
            </div>
        </div>
    </div>

    <div class="feature-matrix">
        <div class="feature-card f-red"><h3>ğŸ›¡ï¸ å®‰å…¨å¯é </h3><p>æ‰€æœ‰é‹ç®—å‡åœ¨ç€è¦½å™¨å…§å­˜é€²è¡Œï¼Œæª”æ¡ˆä¸ç¶“ä¼ºæœå™¨ã€‚æ”¯æ´è»è¦ç´š AES-256 åŠ å¯†èˆ‡æ¬Šé™æ§ç®¡ã€‚</p></div>
        <div class="feature-card f-green"><h3>ğŸ“ å¤šæ ¼å¼æ”¯æ´</h3><p>å®Œç¾è™•ç† PDFã€PNGã€JPEG åŠç©ºç™½é æ··åˆæ’åˆ—ã€‚å…§å»ºã€Œåˆ†æ®µå‘¼å¸ã€æŠ€è¡“é˜²æ­¢å¤§æª”å´©æ½°ã€‚</p></div>
        <div class="feature-card f-blue"><h3>ğŸ¨ è‡ªç”±æ’åº</h3><p>ç¨å®¶å´é‚Šå°è¦½é¢æ¿æ”¯æ´å³æ™‚æœå°‹èˆ‡å®šä½ã€‚ç‰©ç†æ—‹è½‰ç´¯åŠ ç¢ºä¿åŒ¯å‡ºçµæœèˆ‡é è¦½ 100% åŒæ­¥ã€‚</p></div>
    </div>

    <div class="qa-container">
        <h2>å¸¸è¦‹å•é¡Œèˆ‡ä½¿ç”¨è€…æŒ‡å— (Q&A)</h2>
        <div class="qa-grid">
            <div class="qa-item">
                <h4>1. iOS (iPhone/iPad) é»æ“Šä¸‹è¼‰æ²’åæ‡‰ï¼Ÿ</h4>
                <p>é€™æ˜¯ iOS ç¬¬ä¸‰æ–¹ç€è¦½å™¨ (å¦‚ LINE) çš„é™åˆ¶ã€‚**å¼·çƒˆå»ºè­°ä½¿ç”¨ Safari**ã€‚å¦‚æœä»åœ¨ Safari å¤±æ•—ï¼Œè«‹ç¢ºä¿æœªé–‹å•Ÿã€Œé˜»æ“‹å½ˆå‡ºè¦–çª—ã€ï¼Œä¸¦æª¢æŸ¥è£ç½®å„²å­˜ç©ºé–“ã€‚</p>
            </div>
            <div class="qa-item">
                <h4>2. ã€Œç‰©ç†æ—‹è½‰ã€èˆ‡ã€Œé è¦½æ—‹è½‰ã€æœ‰ä½•ä¸åŒï¼Ÿ</h4>
                <p>DTZ PDF 16.0 è®€å– PDF å…§éƒ¨åº§æ¨™ç³»çŸ©é™£ã€‚ç•¶æ‚¨åœ¨ UI æ—‹è½‰æ™‚ï¼Œæˆ‘å€‘æœƒç‰©ç†é‡å¯« PDF é é¢å±¬æ€§ï¼Œç¢ºä¿åœ¨ Adobe Reader æˆ–å°è¡¨æ©Ÿè¼¸å‡ºæ™‚è§’åº¦çµ•å°æ­£ç¢ºã€‚</p>
            </div>
            <div class="qa-item">
                <h4>3. åˆä½µå¤šå¼µé«˜æ¸…ç…§ç‰‡æœƒå°è‡´ç•¶æ©Ÿå—ï¼Ÿ</h4>
                <p>æˆ‘å€‘é‡å°å¤§æª”æ¡ˆå¯¦ä½œäº†ã€Œè¨˜æ†¶é«”å›æ”¶ (GC)ã€æ©Ÿåˆ¶ã€‚åˆä½µç…§ç‰‡æ™‚æœƒè‡ªå‹• revoke æš«å­˜ ObjectURLã€‚è‹¥ä»é–ƒé€€ï¼Œå»ºè­°å°‡ç…§ç‰‡è§£æåº¦å…ˆåœ¨æ‰‹æ©Ÿç¸®å°å¾Œå†ä¸Šå‚³ã€‚</p>
            </div>
            <div class="qa-item">
                <h4>4. æœå°‹åŠŸèƒ½æœƒæœå°‹åœ–ç‰‡è£¡çš„æ–‡å­—å—ï¼Ÿ</h4>
                <p>ç›®å‰æœå°‹åŠŸèƒ½æ”¯æ´ã€ŒPDF æ–‡å­—å±¤ã€ã€‚å°æ–¼ç´”åœ–ç‰‡ PDFï¼Œå»ºè­°ä½¿ç”¨æœ¬å·¥å…·è½‰æ›ç‚ºåœ–ç‰‡å¾Œå¦è¡Œä¿å­˜ã€‚æœå°‹æ™‚åœ–ç‰‡é æœƒè‡ªå‹•ä¿ç•™ï¼Œé¿å…èª¤è—é‡è¦é é¢ã€‚</p>
            </div>
        </div>
    </div>
</div>

<footer>&copy; 2026 DTZ PDF ULTIMATE | æ——è‰¦å…¨èƒ½æœ¬åœ°å·¥ä½œç«™ v16.0</footer>

<script>
    const { PDFDocument, degrees, rgb, StandardFonts } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pagesData = []; let fileBuffers = {}; let pdfCache = {};
    let sigImage = null; let sigTargetId = null;

    // --- ğŸ† æ ¸å¿ƒä¸‹è¼‰å™¨ (ç©©å®š DOM æ’å…¥æ¨¡å¼) ---
    function download(data, filename, type) {
        const blob = data instanceof Blob ? data : new Blob([data], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 2000);
    }

    // --- æ‹–æ”¾ä¸Šå‚³ ---
    const dropZone = document.getElementById('drop-zone');
    dropZone.onclick = () => document.getElementById('input-org').click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if(e.dataTransfer.files.length) handleFiles(e.dataTransfer.files); };
    document.getElementById('input-org').onchange = (e) => handleFiles(e.target.files);

    async function handleFiles(files) {
        updateProgress(10);
        for (const file of Array.from(files)) {
            const fId = crypto.randomUUID();
            const buf = await file.arrayBuffer();
            fileBuffers[fId] = buf;
            const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
            if (isPdf) {
                const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const pId = crypto.randomUUID();
                    const page = await pdf.getPage(i);
                    const txt = (await page.getTextContent()).items.map(s => s.str).join(' ');
                    pagesData.push({ fId, pIdx: i-1, rot: 0, pId, type: 'pdf', selected: false, text: txt, canvas: null });
                    await renderThumb(page, pId, i);
                    if (i % 10 === 0) await new Promise(r => setTimeout(r, 0));
                }
            } else {
                const pId = crypto.randomUUID();
                pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false, text:'', canvas: null });
                renderImgThumb(file, pId);
            }
        }
        document.getElementById('org-ctrl').style.display = 'block';
        if(pagesData.length > 5) document.getElementById('side-toggle').style.display = 'block';
        updateProgress(0);
    }

    async function renderThumb(page, pId, pNum) {
        const vp = page.getViewport({ scale: 0.3 });
        const cv = document.createElement('canvas'); cv.width = vp.width; cv.height = vp.height;
        await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
        // âœ… ä¿®æ­£ 1: æŠŠ Canvas å­˜å…¥æ•¸æ“šï¼Œç¢ºä¿åŒ¯å‡ºåœ–ç‰‡ä¸å¤±æ•ˆ
        pagesData.find(p => p.pId === pId).canvas = cv;
        createCard(cv, pId, `P${pNum}`);
    }

    function renderImgThumb(file, pId) {
        const url = URL.createObjectURL(file);
        const img = new Image(); img.src = url;
        img.onload = () => {
            const cv = document.createElement('canvas'); cv.width = 180; cv.height = 240;
            cv.getContext('2d').drawImage(img, 0, 0, 180, 240);
            pagesData.find(p => p.pId === pId).canvas = cv;
            createCard(cv, pId, 'åœ–æª”');
            URL.revokeObjectURL(url);
        };
    }

    function createCard(cv, pId, label) {
        const card = document.createElement('div'); card.className = 'page-card'; card.id = pId;
        card.innerHTML = `<div style="position:absolute;top:5px;left:5px;background:rgba(0,0,0,0.6);color:white;font-size:10px;padding:2px 5px;border-radius:4px;">${label}</div><div class="cv-wrap"></div><div style="margin-top:10px;display:flex;justify-content:center;gap:5px;"><button class="tab-btn" style="font-size:10px;padding:5px 10px;" onclick="event.stopPropagation(); rotateP('${pId}')">æ—‹è½‰</button><button class="tab-btn" style="font-size:10px;padding:5px 10px;" onclick="event.stopPropagation(); delP('${pId}')">åˆªé™¤</button></div>`;
        card.querySelector('.cv-wrap').appendChild(cv);
        card.onclick = () => {
            const p = pagesData.find(x => x.pId === pId); p.selected = !p.selected; card.classList.toggle('selected');
            sigTargetId = pId; document.querySelectorAll('.page-card').forEach(c => c.style.boxShadow = 'none'); card.style.boxShadow = '0 0 15px var(--primary-blue)';
        };
        document.getElementById('org-grid').appendChild(card);
        // Sidebar åŒæ­¥
        const sWrap = document.createElement('div'); sWrap.className = 'side-thumb-wrap'; sWrap.id = 'side-'+pId;
        const scv = document.createElement('canvas'); scv.width = cv.width; scv.height = cv.height;
        scv.style.width = '100%'; scv.getContext('2d').drawImage(cv, 0, 0);
        scv.onclick = () => document.getElementById(pId).scrollIntoView({behavior:'smooth'});
        sWrap.appendChild(scv); document.getElementById('side-grid').appendChild(sWrap);
    }

    // --- âœ… ä¿®æ­£ 2: O(n) æ‰¹æ¬¡æ—‹è½‰æ•ˆç‡å„ªåŒ– ---
    function batchRotate() {
        pagesData.forEach(p => {
            p.rot = (p.rot + 90) % 360;
            document.getElementById(p.pId).querySelector('canvas').className = `rot-${p.rot}`;
            const sideEl = document.getElementById('side-'+p.pId);
            if(sideEl) sideEl.querySelector('canvas').className = `rot-${p.rot}`;
        });
    }

    // --- âœ… ä¿®æ­£ 5: æœå°‹ Display None é‡æ’ä½ˆå±€ ---
    function searchPDF() {
        const q = document.getElementById('search-input').value.toLowerCase();
        pagesData.forEach(p => {
            const el = document.getElementById(p.pId);
            const side = document.getElementById('side-'+p.pId);
            if(p.type === 'img' || p.text.toLowerCase().includes(q)) {
                el.classList.remove('hidden-search'); side.style.display = 'block';
            } else {
                el.classList.add('hidden-search'); side.style.display = 'none';
            }
        });
    }

    // --- ğŸ† æ ¸å¿ƒè™•ç†å¼•æ“ (ä¿®æ­£ Metadata èˆ‡ åµŒå…¥å­—å‹) ---
    async function processPdf(mode) {
        updateProgress(10);
        const zip = mode === 'split' ? new JSZip() : null;
        try {
            const mainDoc = mode === 'merge' ? await PDFDocument.create() : null;
            const list = mode === 'split' ? pagesData.filter(p => p.selected) : pagesData;
            if(!list.length) return alert('å°šæœªé¸å–é é¢');

            for (let i = 0; i < list.length; i++) {
                const p = list[i];
                let curDoc = mode === 'merge' ? mainDoc : await PDFDocument.create();
                
                // âœ… ä¿®æ­£ 3: åµŒå…¥æ¨™æº–å­—å‹é¿å… PDF æ¯€æ
                const font = await curDoc.embedFont(StandardFonts.HelveticaBold);
                curDoc.setTitle(document.getElementById('m-title').value || "DTZ PDF Merged");
                curDoc.setAuthor(document.getElementById('m-author').value || "DTZ User");

                if (p.type === 'pdf') {
                    if (!pdfCache[p.fId]) pdfCache[p.fId] = await PDFDocument.load(fileBuffers[p.fId]);
                    const [copy] = await curDoc.copyPages(pdfCache[p.fId], [p.pIdx]);
                    copy.setRotation(degrees(p.rot + (copy.getRotation().angle || 0)));
                    curDoc.addPage(copy);
                } else if (p.type === 'img') {
                    const img = await curDoc.embedPng(await p.file.arrayBuffer());
                    const page = curDoc.addPage([img.width, img.height]);
                    page.drawImage(img, { x:0, y:0, width:img.width, height:img.height, rotate:degrees(p.rot) });
                } else {
                    curDoc.addPage([595, 842]);
                }

                // æµ®æ°´å°èˆ‡ç°½å
                const page = curDoc.getPage(curDoc.getPageCount()-1);
                const wm = document.getElementById('wm-text').value;
                if(wm) page.drawText(wm, { x: 50, y: 150, size: 50, font, color: rgb(0.8,0.8,0.8), opacity: parseFloat(document.getElementById('wm-op').value), rotate: degrees(45) });
                
                if (p.pId === sigTargetId && sigImage) {
                    const sig = await curDoc.embedPng(sigImage);
                    page.drawImage(sig, { x: 50, y: 50, width: 120, height: 60 });
                }

                if (mode === 'split') zip.file(`Split_P${i+1}.pdf`, await curDoc.save({
                    userPassword: document.getElementById('p-u').value || undefined,
                    ownerPassword: document.getElementById('p-o').value || undefined,
                    permissions: { printing: document.getElementById('can-print').checked ? 'highResolution' : 'none', copying: document.getElementById('can-copy').checked }
                }));
                updateProgress(10 + (80 * (i/list.length)));
                await new Promise(r => setTimeout(r, 0));
            }

            if (mode === 'merge') {
                const bytes = await mainDoc.save({
                    userPassword: document.getElementById('p-u').value || undefined,
                    ownerPassword: document.getElementById('p-o').value || undefined,
                    permissions: { printing: document.getElementById('can-print').checked ? 'highResolution' : 'none', copying: document.getElementById('can-copy').checked }
                });
                download(bytes, `DTZ_v16_${Date.now()}.pdf`, 'application/pdf');
            } else {
                download(await zip.generateAsync({type:'blob'}), `DTZ_Split.zip`, 'application/zip');
            }
        } catch (e) { alert("è™•ç†ç•°å¸¸ï¼Œè«‹å˜—è©¦æ¸›å°‘åˆä½µé æ•¸ã€‚"); }
        updateProgress(0);
    }

    // âœ… ä¿®æ­£ 1: å–®é å¦å­˜åœ–ç‰‡å¯¦ä½œ
    function exportAsImage() {
        const p = pagesData.find(x => x.pId === sigTargetId);
        if(!p || !p.canvas) return alert("è«‹å…ˆé»é¸ä¸‹æ–¹æ•´ç†é¢æ¿ä¸­çš„æŸä¸€é é¢å¡ç‰‡ã€‚");
        p.canvas.toBlob(b => download(b, `DTZ_Capture_${Date.now()}.jpg`, 'image/jpeg'), 'image/jpeg', 0.95);
    }

    function insertBlank() {
        const pId = crypto.randomUUID();
        pagesData.push({ pId, type: 'blank', rot: 0, selected: false, text: '', canvas: null });
        const cv = document.createElement('canvas'); cv.width=180; cv.height=240;
        const ctx = cv.getContext('2d'); ctx.fillStyle="white"; ctx.fillRect(0,0,180,240);
        pagesData.find(p => p.pId === pId).canvas = cv; createCard(cv, pId, 'ç©ºç™½');
    }

    function rotateP(pId) {
        const p = pagesData.find(x => x.pId === pId); p.rot = (p.rot + 90) % 360;
        document.getElementById(pId).querySelector('canvas').className = `rot-${p.rot}`;
        const side = document.getElementById('side-'+pId); if(side) side.querySelector('canvas').className = `rot-${p.rot}`;
    }

    function delP(pId) { pagesData = pagesData.filter(x => x.pId !== pId); document.getElementById(pId).remove(); const side = document.getElementById('side-'+pId); if(side) side.remove(); }

    const sigCanvas = document.getElementById('sig-canvas'); const sCtx = sigCanvas.getContext('2d'); let drawing = false;
    function getXY(e) { const rect = sigCanvas.getBoundingClientRect(); const scX = sigCanvas.width / rect.width; const scY = sigCanvas.height / rect.height; return { x: ((e.clientX || e.touches[0].clientX) - rect.left) * scX, y: ((e.clientY || e.touches[0].clientY) - rect.top) * scY }; }
    sigCanvas.onmousedown = sigCanvas.ontouchstart = (e) => { drawing = true; const p = getXY(e); sCtx.beginPath(); sCtx.moveTo(p.x, p.y); e.preventDefault(); };
    sigCanvas.onmousemove = sigCanvas.ontouchmove = (e) => { if(!drawing) return; const p = getXY(e); sCtx.lineTo(p.x, p.y); sCtx.stroke(); };
    window.onmouseup = window.ontouchend = () => drawing = false;
    function clearSig() { sCtx.clearRect(0,0,800,400); }
    function saveSig() { sigImage = sigCanvas.toDataURL(); alert('ç°½åå·²æˆåŠŸå„²å­˜'); }

    function switchTab(evt, tab) { document.querySelectorAll('.work-panel').forEach(p => p.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tab + '-panel').classList.add('active'); evt.currentTarget.classList.add('active'); }
    function updateProgress(v) { document.getElementById('loader-bar').style.width = v + '%'; }
    document.getElementById('side-toggle').onclick = (e) => { e.stopPropagation(); document.querySelector('.sidebar').classList.toggle('open'); };
    document.addEventListener('click', () => document.querySelector('.sidebar').classList.remove('open'));
    document.querySelector('.sidebar').onclick = (e) => e.stopPropagation();

    new Sortable(document.getElementById('org-grid'), { animation: 150, onEnd: () => {
        const order = Array.from(document.getElementById('org-grid').children).map(c => c.id);
        pagesData.sort((a,b) => order.indexOf(a.pId) - order.indexOf(b.pId));
        order.forEach(id => { const s = document.getElementById('side-'+id); if(s) document.getElementById('side-grid').appendChild(s); });
    }});
</script>
</body>
</html>
