<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>DTZ PDF v23.6</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<style>
body {
  margin: 0;
  background: #0b0f1a;
  color: #eaf2ff;
  font-family: "Segoe UI","Microsoft JhengHei",sans-serif;
  overflow: hidden;
}
header {
  padding: 10px;
  background: linear-gradient(90deg,#0ff,#09f);
  color:#000;
  font-weight:700;
}
#app {
  display:flex;
  height: calc(100vh - 48px);
}
#sidebar {
  width: 220px;
  background:#05070d;
  border-right:1px solid #1e2a44;
  display:flex;
  flex-direction:column;
}
#sidebar input {
  margin:8px;
  padding:6px;
}
#thumbs {
  flex:1;
  overflow:auto;
}
.thumb {
  padding:6px;
  border-bottom:1px solid #111;
  cursor:pointer;
}
.thumb:hover { background:#111; }

#main {
  flex:1;
  display:flex;
  flex-direction:column;
}
#toolbar {
  display:flex;
  gap:6px;
  padding:8px;
  background:#0e1424;
  align-items:center;
}
#toolbar input, #toolbar button {
  padding:6px;
}
#viewer {
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#000;
}
canvas {
  background:#111;
  box-shadow:0 0 20px #000;
}

#ui-panel {
  width:260px;
  background:#05070d;
  border-left:1px solid #1e2a44;
  padding:10px;
  overflow:auto;
}
.section {
  margin-bottom:16px;
}
.section h3 {
  margin:6px 0;
  font-size:14px;
  color:#7fdcff;
}
#sig-canvas {
  border:1px solid #333;
  background:#fff;
  width:100%;
  height:120px;
  cursor:crosshair;
}
button {
  cursor:pointer;
}
</style>
</head>

<body>
<header>DTZ PDF v23.6｜單檔可執行版</header>

<div id="app">
  <!-- 左側 -->
  <div id="sidebar">
    <input id="search" placeholder="搜尋頁碼…" />
    <div id="thumbs"></div>
  </div>

  <!-- 中央 -->
  <div id="main">
    <div id="toolbar">
      <input type="file" id="file" accept="application/pdf">
      <button onclick="prevPage()">◀</button>
      <button onclick="nextPage()">▶</button>
      <span id="pageInfo">- / -</span>
      <button onclick="undo()">Undo</button>
      <button onclick="redo()">Redo</button>
      <button onclick="exportPDF()">匯出 PDF</button>
    </div>
    <div id="viewer">
      <canvas id="pdf-canvas"></canvas>
    </div>
  </div>

  <!-- 右側 UI -->
  <div id="ui-panel">
    <div class="section">
      <h3>輸出設定</h3>
      <input id="m-title" placeholder="輸出檔名">
    </div>

    <div class="section">
      <h3>浮水印</h3>
      <input id="wm-text" placeholder="浮水印文字">
      <input id="wm-op" type="number" min="0" max="1" step="0.1" value="0.2">
      <button onclick="applyWatermark()">套用</button>
    </div>

    <div class="section">
      <h3>簽名</h3>
      <canvas id="sig-canvas"></canvas>
      <div style="margin-top:6px;">
        <button onclick="clearSig()">清除</button>
        <button onclick="applySig()">套用到此頁</button>
      </div>
    </div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let pdfDoc=null, pageNum=1, canvas=document.getElementById("pdf-canvas"),
ctx=canvas.getContext("2d");

let history=[], hIndex=-1;
let sigCanvas=document.getElementById("sig-canvas"),
sigCtx=sigCanvas.getContext("2d"), drawing=false;

function pushHistory(){
  history=history.slice(0,hIndex+1);
  history.push(canvas.toDataURL());
  hIndex++;
}

function undo(){
  if(hIndex>0){ hIndex--; restoreHistory(); }
}
function redo(){
  if(hIndex<history.length-1){ hIndex++; restoreHistory(); }
}
function restoreHistory(){
  let img=new Image();
  img.onload=()=>ctx.drawImage(img,0,0);
  img.src=history[hIndex];
}

document.getElementById("file").onchange=async e=>{
  const buf=await e.target.files[0].arrayBuffer();
  pdfDoc=await pdfjsLib.getDocument(buf).promise;
  renderPage(1);
  buildThumbs();
};

async function renderPage(num){
  pageNum=num;
  const page=await pdfDoc.getPage(num);
  const vp=page.getViewport({scale:1.5});
  canvas.width=vp.width; canvas.height=vp.height;
  await page.render({canvasContext:ctx,viewport:vp}).promise;
  document.getElementById("pageInfo").textContent=
    `${pageNum} / ${pdfDoc.numPages}`;
  pushHistory();
}

function prevPage(){ if(pageNum>1) renderPage(pageNum-1); }
function nextPage(){ if(pageNum<pdfDoc.numPages) renderPage(pageNum+1); }

async function buildThumbs(){
  const box=document.getElementById("thumbs");
  box.innerHTML="";
  for(let i=1;i<=pdfDoc.numPages;i++){
    const d=document.createElement("div");
    d.className="thumb";
    d.textContent="Page "+i;
    d.onclick=()=>renderPage(i);
    box.appendChild(d);
  }
}

function applyWatermark(){
  ctx.save();
  ctx.globalAlpha=parseFloat(wmOp.value);
  ctx.font="48px sans-serif";
  ctx.rotate(-0.4);
  ctx.fillText(wmText.value,50,canvas.height/2);
  ctx.restore();
  pushHistory();
}

sigCanvas.width=240; sigCanvas.height=120;
sigCanvas.onmousedown=e=>{drawing=true;sigCtx.moveTo(e.offsetX,e.offsetY);}
sigCanvas.onmousemove=e=>{
  if(!drawing) return;
  sigCtx.lineTo(e.offsetX,e.offsetY);
  sigCtx.stroke();
};
window.onmouseup=()=>drawing=false;

function clearSig(){
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
}
function applySig(){
  ctx.drawImage(sigCanvas,50,50,200,100);
  pushHistory();
}

async function exportPDF(){
  const pdf=await PDFLib.PDFDocument.create();
  const img=await pdf.embedPng(canvas.toDataURL());
  const p=pdf.addPage([canvas.width,canvas.height]);
  p.drawImage(img,{x:0,y:0,width:canvas.width,height:canvas.height});
  const bytes=await pdf.save();
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([bytes],{type:"application/pdf"}));
  a.download=(mTitle.value||"output")+".pdf";
  a.click();
}

search.oninput=()=>{
  [...thumbs.children].forEach(t=>{
    t.style.display=t.textContent.includes(search.value)?"":"none";
  });
};
</script>
</body>
</html>
