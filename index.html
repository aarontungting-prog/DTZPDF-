<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DTZ PDF v12.0 - å°ˆæ¥­æœ¬åœ°å·¥ä½œç«™</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db; --bg-color: #f7f9fc;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg-color); color: #2d3436; }
        
        /* å°è¦½åˆ—èˆ‡è¼‰å…¥æ¢ */
        nav { background: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        #loader-bar { position: fixed; top: 0; left: 0; width: 0%; height: 4px; background: var(--primary-green); z-index: 2001; transition: width 0.3s; }

        /* æŠ½å±œç³»çµ± */
        #side-toggle {
            position: fixed; left: 0; top: 50%; transform: translateY(-50%);
            background: var(--primary-red); color: white; padding: 15px 8px;
            border-radius: 0 10px 10px 0; cursor: pointer; z-index: 2000;
            font-size: 13px; writing-mode: vertical-lr; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar {
            position: fixed; left: -260px; top: 80px; width: 220px; height: calc(100vh - 120px);
            background: white; padding: 20px; box-shadow: 5px 0 30px rgba(0,0,0,0.1); 
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1500; overflow-y: auto;
        }
        .sidebar.open { left: 0; }

        /* ä¸»å·¥ä½œå€ */
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; text-align: center; }
        .upload-area { 
            border: 3px dashed #cbd5e0; border-radius: 20px; padding: 40px; cursor: pointer; 
            background: #fff; transition: 0.3s; position: relative; 
        }
        .upload-area.dragover { border-color: var(--primary-red); background: #fffaf9; }
        
        /* é é¢å¡ç‰‡ */
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .page-card { 
            background: #fff; border: 2px solid #eee; padding: 10px; border-radius: 15px; 
            position: relative; transition: 0.3s; cursor: grab;
        }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        .page-card canvas { width: 100%; border-radius: 5px; transition: transform 0.4s; }
        
        /* æ—‹è½‰å‹•ç•«åŒæ­¥ */
        .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }

        /* ç°½åæŒ‡å®šæ¨™è¨˜ */
        .sig-target::after { content: "âœï¸ ç°½åé "; position: absolute; bottom: 10px; right: 10px; background: var(--primary-blue); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        /* æŒ‰éˆ•èˆ‡ Q&A */
        .tab-btn { padding: 10px 20px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: bold; cursor: pointer; margin: 5px; }
        .tab-btn.active { background: var(--primary-red); color: white; }
        .qa-box { text-align: left; background: #fff; padding: 30px; border-radius: 20px; margin-top: 50px; box-shadow: var(--card-shadow); }

        @media (max-width: 900px) {
            #side-toggle { top: auto; bottom: 20px; left: 50%; transform: translateX(-50%); writing-mode: horizontal-tb; border-radius: 50px; }
            .sidebar { left: 0; right: 0; bottom: -400px; top: auto; width: 100%; height: 300px; border-radius: 20px 20px 0 0; }
            .sidebar.open { bottom: 0; }
        }
    </style>
</head>
<body>

<div id="loader-bar"></div>
<div id="side-toggle">ğŸ“„ é é¢å°è¦½</div>

<aside class="sidebar">
    <h3>ğŸ” é é¢æœå°‹</h3>
    <input type="text" id="search-input" placeholder="è¼¸å…¥é—œéµå­—..." onkeyup="searchPDF()">
    <div id="side-grid"></div>
</aside>

<nav>
    <a href="#" class="logo">DTZ PDF <span>v12.0</span></a>
    <div style="font-size: 0.8rem; color: #2ecc71;">â— æœ¬åœ°å¼•æ“å·²å°±ç·’</div>
</nav>

<div class="container">
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab(event, 'main')">æ•´ç†èˆ‡åˆ†å‰²</button>
        <button class="tab-btn" onclick="switchTab(event, 'sign')">é›»å­ç°½å</button>
        <button class="tab-btn" onclick="switchTab(event, 'safe')">å®‰å…¨èˆ‡å±¬æ€§</button>
    </div>

    <div id="main-panel" class="work-panel">
        <div class="upload-area" id="drop-zone">
            <div style="font-size:40px;">ğŸ“‚</div>
            <h3>é»æ“Šæˆ–ã€Œæ‹–æ”¾ã€æª”æ¡ˆä¸Šå‚³</h3>
            <p>æ”¯æ´ PDF èˆ‡ åœ–ç‰‡</p>
            <input type="file" id="input-org" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div id="org-grid" class="page-grid" style="margin-top:20px;"></div>
        <div id="org-ctrl" style="display:none; margin-top:20px;">
            <button class="tab-btn" style="background:#95a5a6; color:#fff; border:none;" onclick="resetAll()">æ¸…ç©ºé‡ç½®</button>
            <button class="tab-btn" style="background:var(--primary-green); color:#fff; border:none; padding:15px 40px;" onclick="processPdf(false)">ç«‹å³åˆä½µä¸‹è¼‰</button>
        </div>
    </div>

    <div id="sign-panel" class="work-panel" style="display:none;">
        <h3>âœ’ï¸ é›»å­æ‰‹å¯«ç°½ç« </h3>
        <p>è«‹é»é¸ã€Œæ•´ç†ã€åˆ†é ä¸­çš„æŸä¸€é ä½œç‚ºç°½åç›®æ¨™ï¼ˆé è¨­ç¬¬ä¸€é ï¼‰</p>
        <canvas id="sig-canvas" width="400" height="200" style="border:2px solid #333; background:#fff; touch-action:none;"></canvas>
        <div style="margin-top:10px;">
            <button class="tab-btn" onclick="clearSig()">æ¸…é™¤é‡ç°½</button>
            <button class="tab-btn" style="background:var(--primary-blue); color:#fff; border:none;" onclick="saveSig()">å„²å­˜ç°½å</button>
        </div>
    </div>

    <div id="safe-panel" class="work-panel" style="display:none;">
        <div style="max-width:500px; margin:0 auto; text-align:left;">
            <h3>ğŸ“ æª”æ¡ˆå±¬æ€§ (Metadata)</h3>
            <input type="text" id="meta-title" class="tab-btn" style="width:100%; border-radius:8px;" placeholder="æ–‡ä»¶æ¨™é¡Œ">
            <input type="text" id="meta-author" class="tab-btn" style="width:100%; border-radius:8px;" placeholder="ä½œè€…åç¨±">
            <hr>
            <h3>ğŸ”’ é–‹å•Ÿå¯†ç¢¼</h3>
            <input type="password" id="p-u" class="tab-btn" style="width:100%; border-radius:8px;" placeholder="è¨­å®šå¯†ç¢¼ (é¸å¡«)">
        </div>
    </div>

    <div class="qa-box">
        <h4>Q&A æŒ‡å—</h4>
        <p>â— <b>æ‹–æ”¾ä¸Šå‚³ï¼š</b>ç¾åœ¨æ‚¨å¯ä»¥ç›´æ¥å¾è³‡æ–™å¤¾æ‹–æ›³å¤šå€‹æª”æ¡ˆåˆ°ç°è‰²æ¡†ä¸­ã€‚</p>
        <p>â— <b>æœå°‹åŠŸèƒ½ï¼š</b>å´é‚Šæ¬„æœå°‹æœƒå³æ™‚ç¯©é¸åŒ…å«è©²æ–‡å­—çš„é é¢ã€‚</p>
        <p>â— <b>æ•ˆèƒ½å„ªåŒ–ï¼š</b>æœ¬ç‰ˆæ¡ç”¨ã€Œå–®æ¬¡è§£æã€æŠ€è¡“ï¼Œè™•ç† 50 é ä»¥ä¸Š PDF ä¸å†å¡é “ã€‚</p>
    </div>
</div>

<footer>&copy; 2026 DTZ PDF PRO | v12.0</footer>

<script>
    const { PDFDocument, degrees } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pagesData = []; let fileBuffers = {}; let sigImage = null; let sigTargetId = null;
    const sidebar = document.querySelector('.sidebar');
    const sideGrid = document.getElementById('side-grid');
    const orgGrid = document.getElementById('org-grid');

    // --- âœ… ä¿®æ­£ 1: çœŸæ­£å¯¦ä½œæ‹–æ”¾ä¸Šå‚³ ---
    const dropZone = document.getElementById('drop-zone');
    dropZone.onclick = () => document.getElementById('input-org').click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => {
        e.preventDefault(); dropZone.classList.remove('dragover');
        if(e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
    };
    document.getElementById('input-org').onchange = (e) => handleFiles(e.target.files);

    async function handleFiles(files) {
        updateProgress(10);
        for (const file of Array.from(files)) {
            const fId = crypto.randomUUID();
            const buf = await file.arrayBuffer();
            fileBuffers[fId] = buf;
            
            if (file.type === 'application/pdf') {
                // âœ… ä¿®æ­£ 4: æ¯å€‹æª”æ¡ˆåª load ä¸€æ¬¡ PDFDocï¼Œæå‡æ•ˆèƒ½
                const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const pId = crypto.randomUUID();
                    const page = await pdf.getPage(i);
                    const txtObj = await page.getTextContent();
                    const text = txtObj.items.map(s => s.str).join(' ');
                    pagesData.push({ fId, pIdx: i-1, rot: 0, pId, type: 'pdf', selected: false, text });
                    await renderThumb(page, pId, i);
                }
            } else {
                const pId = crypto.randomUUID();
                pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false, text:'' });
                renderImgThumb(file, pId);
            }
        }
        document.getElementById('org-ctrl').style.display = 'block';
        updateProgress(0);
    }

    // --- âœ… ä¿®æ­£ 1 & 5: ç¹ªè£½ç¸®åœ–ä¸¦é‡‹æ”¾è¨˜æ†¶é«” ---
    async function renderThumb(page, pId, pNum) {
        const vp = page.getViewport({ scale: 0.3 });
        const cv = document.createElement('canvas');
        cv.width = vp.width; cv.height = vp.height;
        await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
        createCard(cv, pId, `P${pNum}`);
    }

    function renderImgThumb(file, pId) {
        const url = URL.createObjectURL(file);
        const img = new Image(); img.src = url;
        img.onload = () => {
            const cv = document.createElement('canvas'); cv.width = 150; cv.height = 200;
            cv.getContext('2d').drawImage(img, 0, 0, 150, 200);
            createCard(cv, pId, 'åœ–æª”');
            // âœ… ä¿®æ­£ 5: é‡‹æ”¾ ObjectURL
            URL.revokeObjectURL(url);
        };
    }

    function createCard(cv, pId, label) {
        const card = document.createElement('div'); card.className = 'page-card'; card.id = pId;
        card.innerHTML = `
            <div class="badge" style="position:absolute;top:5px;left:5px;background:rgba(0,0,0,0.6);color:white;font-size:10px;padding:2px 5px;border-radius:4px;">${label}</div>
            <div class="cv-wrap"></div>
            <div style="margin-top:8px; display:flex; justify-content:center; gap:5px;">
                <button class="tab-btn" style="font-size:10px;padding:5px 10px;" onclick="event.stopPropagation(); rotateP('${pId}')">æ—‹è½‰</button>
                <button class="tab-btn" style="font-size:10px;padding:5px 10px;" onclick="event.stopPropagation(); delP('${pId}')">åˆªé™¤</button>
            </div>
        `;
        card.querySelector('.cv-wrap').appendChild(cv);
        card.onclick = () => {
            const p = pagesData.find(x => x.pId === pId); p.selected = !p.selected; card.classList.toggle('selected');
            sigTargetId = pId; // è¨­ç‚ºç°½åç›®æ¨™
            document.querySelectorAll('.page-card').forEach(c => c.classList.remove('sig-target'));
            card.classList.add('sig-target');
        };
        orgGrid.appendChild(card);
        
        // --- âœ… ä¿®æ­£ 1 & 9: Sidebar ç¸®åœ–åŒæ­¥èˆ‡å°ºå¯¸ä¿®æ­£ ---
        const scv = document.createElement('canvas'); scv.id = 'side-'+pId;
        scv.width = cv.width; scv.height = cv.height; // è¨­å®šå°ºå¯¸é¿å…ç©ºç™½
        scv.style.width = '100%'; scv.style.marginBottom = '10px'; scv.style.borderRadius = '5px';
        scv.getContext('2d').drawImage(cv, 0, 0);
        scv.onclick = () => document.getElementById(pId).scrollIntoView({behavior:'smooth'});
        sideGrid.appendChild(scv);
    }

    // --- âœ… ä¿®æ­£ 3: çœŸæ­£å•Ÿç”¨ SortableJS ä¸¦åŒæ­¥ sidebar ---
    new Sortable(orgGrid, { 
        animation: 150, 
        onEnd: (evt) => {
            const order = Array.from(orgGrid.children).map(c => c.id);
            pagesData.sort((a,b) => order.indexOf(a.pId) - order.indexOf(b.pId));
            // åŒæ­¥ sidebar é †åº
            order.forEach(id => sideGrid.appendChild(document.getElementById('side-'+id)));
        }
    });

    // --- âœ… ä¿®æ­£ 2: åˆªé™¤åŒæ­¥ sidebar ---
    function delP(pId) {
        pagesData = pagesData.filter(x => x.pId !== pId);
        document.getElementById(pId).remove();
        const sideItem = document.getElementById('side-'+pId);
        if(sideItem) sideItem.remove();
    }

    function rotateP(pId) {
        const p = pagesData.find(x => x.pId === pId); p.rot = (p.rot + 90) % 360;
        const cv = document.getElementById(pId).querySelector('canvas');
        cv.className = `rot-${p.rot}`;
        // âœ… ä¿®æ­£ 9: Sidebar ç¸®åœ–åŒæ­¥æ—‹è½‰
        document.getElementById('side-'+pId).className = `rot-${p.rot}`;
    }

    // --- âœ… ä¿®æ­£ 6: å¯¦ä½œæœå°‹å®šä½ ---
    function searchPDF() {
        const q = document.getElementById('search-input').value.toLowerCase();
        pagesData.forEach(p => {
            const el = document.getElementById(p.pId);
            const sideEl = document.getElementById('side-'+p.pId);
            if(p.text.toLowerCase().includes(q)) {
                el.style.display = 'block'; sideEl.style.display = 'block';
            } else {
                el.style.display = 'none'; sideEl.style.display = 'none';
            }
        });
    }

    // --- âœ… ä¿®æ­£ 3: ç°½ååº§æ¨™å°æº–ä¿®æ­£ ---
    const sigCanvas = document.getElementById('sig-canvas');
    const sCtx = sigCanvas.getContext('2d');
    let drawing = false;
    sigCanvas.onmousedown = sigCanvas.ontouchstart = (e) => {
        drawing = true;
        const rect = sigCanvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        sCtx.beginPath(); sCtx.moveTo(x, y);
        e.preventDefault();
    };
    sigCanvas.onmousemove = sigCanvas.ontouchmove = (e) => {
        if(!drawing) return;
        const rect = sigCanvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        sCtx.lineTo(x, y); sCtx.stroke();
    };
    window.onmouseup = window.ontouchend = () => drawing = false;
    function clearSig() { sCtx.clearRect(0,0,400,200); }
    function saveSig() { sigImage = sigCanvas.toDataURL(); alert('ç°½åå·²å„²å­˜ï¼Œå°‡æ’å…¥é¸ä¸­é é¢'); }

    // --- âœ… ä¿®æ­£ 11 & 7: é€²åº¦æç¤ºèˆ‡ Metadata ---
    async function processPdf() {
        updateProgress(20);
        const pdfDoc = await PDFDocument.create();
        // âœ… ä¿®æ­£ 7: å¥—ç”¨ Metadata
        pdfDoc.setTitle(document.getElementById('meta-title').value || "DTZ Merged");
        pdfDoc.setAuthor(document.getElementById('meta-author').value || "DTZ PDF Engine");

        for (let i = 0; i < pagesData.length; i++) {
            const p = pagesData[i];
            let page;
            if (p.type === 'pdf') {
                const src = await PDFDocument.load(fileBuffers[p.fId]);
                const [copy] = await pdfDoc.copyPages(src, [p.pIdx]);
                copy.setRotation(degrees(p.rot + (copy.getRotation().angle || 0)));
                page = pdfDoc.addPage(copy);
            } else {
                const img = await pdfDoc.embedPng(await p.file.arrayBuffer());
                page = pdfDoc.addPage([img.width, img.height]);
                page.drawImage(img, { x:0, y:0, width:img.width, height:img.height, rotate:degrees(p.rot) });
            }
            // âœ… ä¿®æ­£ 8: æ’å…¥ç°½ååˆ°æŒ‡å®šé 
            if (p.pId === sigTargetId && sigImage) {
                const sig = await pdfDoc.embedPng(sigImage);
                page.drawImage(sig, { x: 50, y: 50, width: 150, height: 75 });
            }
            updateProgress(20 + (70 * (i/pagesData.length)));
        }
        const bytes = await pdfDoc.save({ userPassword: document.getElementById('p-u').value || undefined });
        const blob = new Blob([bytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `DTZ_v12_${Date.now()}.pdf`;
        document.body.appendChild(a); a.click();
        updateProgress(0);
    }

    function switchTab(evt, tab) {
        document.querySelectorAll('.work-panel').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tab + '-panel').style.display = 'block';
        evt.currentTarget.classList.add('active');
    }
    function updateProgress(v) { document.getElementById('loader-bar').style.width = v + '%'; }
    function resetAll() { location.reload(); }
    document.getElementById('side-toggle').onclick = () => sidebar.classList.toggle('open');
</script>
</body>
</html>
