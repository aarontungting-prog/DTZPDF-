<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DTZ PDF - å°ˆæ¥­ç´šæ–‡ä»¶è™•ç†ä¸­æ¨</title>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --primary: #e74c3c; --accent: #3498db; --success: #2ecc71; 
            --bg: #f4f7f6; /* âœ… å›æ­¸åæ·±ç™½è‰² (å†·ç°) */
            --surface: #ffffff; /* âœ… äº®ç™½è‰² */
            --text-main: #2c3e50; --text-sub: #7f8c8d; --border: #e0e0e0;
            --shadow-card: 0 15px 35px rgba(0,0,0,0.08);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text-main); line-height: 1.6; }

        /* --- å°èˆªåˆ— --- */
        nav { background: var(--surface); padding: 1.2rem 8%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.6rem; font-weight: 900; color: var(--primary); text-decoration: none; letter-spacing: -0.5px; }
        
        /* ç‰ˆæœ¬æŒ‰éˆ• */
        .version-btn { 
            background: linear-gradient(135deg, var(--primary), #c0392b); color: white; 
            font-size: 0.8rem; padding: 8px 20px; border-radius: 50px; font-weight: 700; 
            cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
            display: flex; align-items: center; gap: 6px;
        }
        .version-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4); }

        .container { max-width: 1000px; margin: 50px auto; padding: 0 24px; text-align: center; }
        
        .header h1 { font-size: 2.8rem; margin: 0 0 10px 0; color: #2c3e50; letter-spacing: -1px; }
        .header p { color: var(--text-sub); font-size: 1.1rem; }

        /* --- ç¶“å…¸ç´…è‰² Tab --- */
        .tab-group { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .tab-btn { 
            padding: 12px 45px; border-radius: 50px; border: 2px solid var(--primary); background: transparent; 
            color: var(--primary); font-weight: 800; cursor: pointer; transition: 0.3s; font-size: 1rem;
        }
        .tab-btn:hover { background: #fff5f5; transform: translateY(-2px); }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 10px 25px rgba(231, 76, 60, 0.25); transform: translateY(-2px); }

        /* --- âœ… æ›´æ–°ï¼šäº®ç™½æ‡¸æµ®é¢æ¿ (Panel) --- */
        .work-area { display: none; animation: fadeUp 0.5s cubic-bezier(0.165, 0.84, 0.44, 1); }
        .work-area.active { display: block; }

        .panel-box {
            background: var(--surface); border-radius: 24px; padding: 50px;
            box-shadow: var(--shadow-card); border: 1px solid rgba(255,255,255,0.5);
            margin-bottom: 40px; position: relative;
        }

        /* âœ… æ›´æ–°ï¼šæ¥µç´°æé‚Šä¸Šå‚³å€ */
        .drop-zone { 
            border: 2px dashed #d1d8dd; /* ç´°ç·»æé‚Š */
            border-radius: 16px; padding: 80px 20px; text-align: center; 
            cursor: pointer; transition: 0.3s; background: #fafbfc;
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--primary); background: #fffbfb; transform: scale(1.005); }
        .drop-zone h3 { font-size: 1.5rem; color: #555; margin: 15px 0 5px; font-weight: 700; }
        
        /* Grid ç³»çµ± */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; text-align: left; }
        
        /* å¡ç‰‡è¨­è¨ˆ */
        .card { 
            background: white; border: 1px solid #eee; padding: 12px; border-radius: 16px; position: relative; 
            transition: 0.3s; cursor: grab; box-shadow: 0 5px 15px rgba(0,0,0,0.03);
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); border-color: var(--accent); }
        .card.selected { border: 2px solid var(--success); background: #f0fff4; box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.1); }
        
        .cv-wrap { height: 230px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 10px; overflow: hidden; margin-bottom: 12px; }
        canvas { max-width: 100%; max-height: 100%; transition: transform 0.3s; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .tools { display: flex; gap: 8px; justify-content: center; }
        .tool-btn { 
            flex: 1; padding: 8px; border: 1px solid #eee; background: white; color: #666; border-radius: 8px; 
            cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.2s;
        }
        .tool-btn:hover { background: #f1f2f6; color: var(--text-main); }
        .tool-btn.danger:hover { background: #fff5f5; color: var(--primary); border-color: #ffdcdc; }

        .btn-main { padding: 18px 70px; border-radius: 50px; border: none; background: var(--primary); color: white; font-size: 1.2rem; font-weight: 800; cursor: pointer; transition: 0.3s; margin-top: 30px; box-shadow: 0 10px 25px rgba(231, 76, 60, 0.25); }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(231, 76, 60, 0.35); }
        .btn-main:disabled { background: #cbd5e0; cursor: wait; transform: none; box-shadow: none; }
        .btn-text { background: none; border: none; color: #999; text-decoration: underline; cursor: pointer; margin-top: 20px; display: block; width: 100%; font-size: 0.9rem; }

        /* âœ… ä¸‰æ–¹æ ¼èˆ‡ Q&A çµ±ä¸€æ ¼ç·š */
        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-top: 60px; }
        
        .anim-card {
            background: var(--surface); padding: 35px 30px; border-radius: 20px; box-shadow: var(--shadow-card);
            border-top: 6px solid transparent; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: left; height: 100%; position: relative; overflow: hidden;
        }
        .anim-card:hover { transform: translateY(-12px); box-shadow: 0 25px 50px rgba(0,0,0,0.1); }
        
        /* é¡è‰²å®šç¾© */
        .anim-card.red { border-top-color: var(--primary); }
        .anim-card.green { border-top-color: var(--success); }
        .anim-card.blue { border-top-color: var(--accent); }
        .anim-card.qa { border-top-color: #636e72; background: #fff; } /* Q&A å°ˆå±¬è‰² */

        .anim-card h3 { margin-top: 0; color: #2c3e50; font-size: 1.25rem; font-weight: 800; margin-bottom: 15px; }
        .anim-card h4 { margin-top: 0; color: var(--accent); font-size: 1.15rem; font-weight: 800; margin-bottom: 15px; }
        .anim-card p { color: var(--text-sub); font-size: 0.95rem; margin: 0; line-height: 1.7; }

        .section-title { grid-column: 1 / -1; text-align: center; font-size: 2rem; margin-top: 80px; margin-bottom: 10px; color: #2c3e50; font-weight: 800; }

        /* âœ… å²è©©ç´šç‰ˆæœ¬æ­·å² Modal */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(44, 62, 80, 0.85); z-index: 2000; 
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }
        .modal-content { 
            background: white; width: 90%; max-width: 700px; max-height: 85vh; border-radius: 30px; 
            padding: 0; overflow: hidden; box-shadow: 0 50px 100px rgba(0,0,0,0.3); animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column;
        }
        .modal-header { background: #f8f9fa; padding: 25px 40px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; color: #2c3e50; }
        .close-modal { cursor: pointer; font-size: 2rem; color: #999; transition: 0.2s; line-height: 1; }
        .close-modal:hover { color: var(--primary); }
        
        .timeline-container { padding: 40px; overflow-y: auto; }
        .timeline-item { 
            display: flex; margin-bottom: 30px; opacity: 0; transform: translateY(20px); 
            animation: slideInUp 0.5s forwards; 
        }
        .timeline-marker { 
            flex: 0 0 50px; display: flex; flex-direction: column; align-items: center; margin-right: 20px; 
        }
        .dot { width: 16px; height: 16px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.2); }
        .line { flex: 1; width: 2px; background: #eee; margin-top: 5px; }
        
        .timeline-content { flex: 1; text-align: left; }
        .ver-tag { display: inline-block; background: var(--primary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; margin-bottom: 8px; }
        .ver-date { color: #999; font-size: 0.8rem; margin-left: 10px; }
        .ver-title { font-size: 1.1rem; font-weight: 700; color: #2c3e50; margin-bottom: 5px; }
        .ver-desc { color: #666; font-size: 0.95rem; line-height: 1.6; }

        /* å…ƒä»¶ */
        #progress-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 999; display: none; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.2s; }
        .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideInUp { to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 900px) { .info-grid, .grid { grid-template-columns: 1fr; } .panel-box { padding: 30px; } }
        footer { margin: 100px 0 40px; color: #b2bec3; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>

<div id="progress-wrap"><div id="progress-bar"></div></div>

<div id="history-modal" class="modal-overlay" onclick="if(event.target === this) App.ui.toggleHistory(false)">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸš€ é–‹ç™¼é€²åŒ–æ—¥èªŒ</h2>
            <span class="close-modal" onclick="App.ui.toggleHistory(false)">Ã—</span>
        </div>
        <div class="timeline-container" id="timeline-root">
            </div>
    </div>
</div>

<nav>
    <a href="#" class="logo">DTZ PDF</a>
    <div class="version-btn" onclick="App.ui.toggleHistory(true)">
        <span>âœ¨ v31.0 Ultimate</span>
    </div>
</nav>

<div class="container">
    <div class="header">
        <h1>å°ˆæ¥­ PDF è™•ç†ä¸­æ¨</h1>
        <p>ç«¯é»é‹ç®— â€¢ æ¥µè‡´éš±ç§ â€¢ å¹¾ä½•æ ¡æ­£</p>
    </div>

    <div class="tab-group">
        <button class="tab-btn active" onclick="App.ui.switchTab('merge')">åˆä½µèˆ‡æ’åº</button>
        <button class="tab-btn" onclick="App.ui.switchTab('split')">åˆ†å‰²èˆ‡æå–</button>
    </div>

    <div id="area-merge" class="work-area active">
        <div class="panel-box">
            <div class="drop-zone" id="drop-merge">
                <div style="font-size:3.5rem; margin-bottom:15px; opacity:0.8;">ğŸ“‚</div>
                <h3>é»æ“Š æˆ– æ‹–æ”¾æª”æ¡ˆè‡³æ­¤</h3>
                <p style="color:#999; margin-top:10px;">æ”¯æ´ PDF / JPG / PNG (å¯è‡ªç”±æ‹–æ›³æ’åº)</p>
                <input type="file" id="input-merge" multiple accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            </div>
            <div id="grid-merge" class="grid"></div>
            <div id="ctrl-merge" style="display:none; text-align:center;">
                <button class="btn-main" onclick="App.core.process('merge')">åˆä½µä¸¦ä¸‹è¼‰ PDF</button>
                <button class="btn-text" onclick="App.state.reset()">æ¸…ç©ºæ‰€æœ‰æª”æ¡ˆ</button>
            </div>
        </div>
    </div>

    <div id="area-split" class="work-area">
        <div class="panel-box">
            <div class="drop-zone" id="drop-split">
                <div style="font-size:3.5rem; margin-bottom:15px; opacity:0.8;">âœ‚ï¸</div>
                <h3>é»æ“Š æˆ– æ‹–æ”¾å–®ä»½ PDF</h3>
                <p style="color:#999; margin-top:10px;">è§£æå¾Œå¯æ’åºã€æ—‹è½‰ã€é¸å–æå–</p>
                <input type="file" id="input-split" accept=".pdf" style="display:none;">
            </div>
            <div id="grid-split" class="grid"></div>
            <div id="ctrl-split" style="display:none; text-align:center;">
                <button class="btn-main" style="background:var(--accent);" onclick="App.core.process('split')">æå–é¸ä¸­é é¢ (ZIP)</button>
                <button class="btn-text" onclick="App.state.reset()">æ¸…ç©ºæ‰€æœ‰æª”æ¡ˆ</button>
            </div>
        </div>
    </div>

    <div class="info-grid">
        <div class="anim-card red">
            <h3>ğŸ›¡ï¸ ç«¯é»åŠ å¯†é‹ç®—</h3>
            <p>æ”¾æ£„é›²ç«¯ä¸Šå‚³ï¼Œæ“æŠ±çµ•å°éš±ç§ã€‚æ‰€æœ‰æª”æ¡ˆè™•ç†çš†åœ¨æ‚¨çš„ç€è¦½å™¨è¨˜æ†¶é«”ä¸­å®Œæˆï¼Œé©åˆè™•ç†æ©Ÿå¯†æ–‡ä»¶ã€‚</p>
        </div>
        <div class="anim-card green">
            <h3>ğŸš€ å¹¾ä½•ç‰©ç†å¼•æ“</h3>
            <p>å…§å»ºåæ¨™è½‰æ›ç³»çµ±ã€‚ç•¶æ‚¨æ—‹è½‰åœ–ç‰‡æ™‚ï¼ŒPDF é é¢æœƒè‡ªå‹•é©æ‡‰å¯¬é«˜ï¼Œç¢ºä¿å…§å®¹å®Œç¾ç½®ä¸­ä¸è£åˆ‡ã€‚</p>
        </div>
        <div class="anim-card blue">
            <h3>âš¡ åˆ†æ®µå‘¼å¸æ¸²æŸ“</h3>
            <p>é‡å°å¤§æª”æ¡ˆå„ªåŒ–çš„éåŒæ­¥è™•ç†æŠ€è¡“ï¼Œå³ä½¿è¼‰å…¥æ•¸ç™¾é çš„åˆç´„ï¼Œä¹Ÿèƒ½ä¿æŒä»‹é¢æµæš¢ã€‚</p>
        </div>
    </div>

    <h2 class="section-title">å¸¸è¦‹å•é¡ŒæŒ‡å—</h2>
    <div class="info-grid">
        <div class="anim-card qa">
            <h4>ğŸ“± iOS ç„¡æ³•ä¸‹è¼‰ï¼Ÿ</h4>
            <p>iPhone Safari å®‰å…¨æ€§è¼ƒé«˜ã€‚åˆä½µå®Œæˆå¾Œè‹¥è·³å‡ºæ–°åˆ†é ï¼Œè«‹é»æ“Šåº•éƒ¨çš„ã€Œåˆ†äº«ã€åœ–ç¤ºï¼Œä¸¦é¸æ“‡ã€Œå„²å­˜åˆ°æª”æ¡ˆã€å³å¯ã€‚</p>
        </div>
        <div class="anim-card qa">
            <h4>âœ‚ï¸ åˆ†å‰²æ¨¡å¼å…¨è§£é–</h4>
            <p>v31.0 ç‰ˆæœ¬è³¦äºˆåˆ†å‰²æ¨¡å¼æœ€é«˜æ¬Šé™ã€‚æ‚¨ç¾åœ¨å¯ä»¥å°å–®ä¸€é é¢é€²è¡Œ<b>æ—‹è½‰</b>ã€<b>åˆªé™¤</b>ï¼Œç”šè‡³<b>æ‹–æ›³æ’åº</b>ã€‚æå–å¾Œçš„ ZIP æœƒé‡æ–°ç·¨è™Ÿã€‚</p>
        </div>
        <div class="anim-card qa">
            <h4>ğŸ–¼ï¸ åœ–ç‰‡è¨˜æ†¶é«”ä¿è­·</h4>
            <p>æˆ‘å€‘æœƒè‡ªå‹•åµæ¸¬è£ç½®æ•ˆèƒ½ï¼Œå° 4K ä»¥ä¸Šåœ–ç‰‡é€²è¡Œæ™ºæ…§ç¸®æ”¾ï¼Œé˜²æ­¢æ‰‹æ©Ÿç€è¦½å™¨å› è¨˜æ†¶é«”ä¸è¶³è€Œå´©æ½°ã€‚</p>
        </div>
    </div>
</div>

<footer>&copy; 2026 DTZ PDF ENGINE | Ultimate Aesthetic Edition</footer>

<script>
const App = {
    state: { mode: 'merge', pages: [], buffers: {}, sortable: null },
    
    // âœ… å²è©©ç´šé–‹ç™¼æ—¥èªŒ (é©šè‰·ç‰ˆ)
    history: [
        { ver: "v31.0 Ultimate", date: "2026/01/24", desc: "âœ¨ è¦–è¦ºç¾å­¸é‡è£½ï¼šå°å…¥å†·ç°ç™½æ¥µç°¡é¢¨æ ¼èˆ‡æ‡¸æµ®é¢æ¿è¨­è¨ˆã€‚<br>âœ¨ Q&A ä½ˆå±€å„ªåŒ–ï¼šæ¡ç”¨ 3 æ¬„å¼ç¶²æ ¼å°é½Šï¼Œè¦–è¦ºæ›´å”èª¿ã€‚<br>âœ¨ æ–°å¢ã€Œæ™‚å…‰è¿´å»Šã€ï¼šå‹•æ…‹ç‰ˆæœ¬æ­·å²å±•ç¤ºã€‚" },
        { ver: "v30.0 Milestone", date: "2026/01/24", desc: "ğŸš€ åŠŸèƒ½å®Œå…¨é«”ï¼šä¿®å¾©å…¨æ¨¡å¼æ—‹è½‰æ¬Šé™ï¼Œåˆä½µèˆ‡åˆ†å‰²æ¨¡å¼çš†æ”¯æ´å®Œæ•´ç·¨è¼¯å·¥å…·ã€‚<br>ğŸš€ å›æ­¸ç¶“å…¸ï¼šé‡å•Ÿæé‚Šé¢¨æ ¼ä¸Šå‚³å€ï¼Œæå‡æ“ä½œç›´è¦ºã€‚" },
        { ver: "v28.0 SaaS Core", date: "2026/01/24", desc: "âš¡ æ¶æ§‹é‡æ§‹ï¼šå¼•å…¥ Namespace æ¨¡çµ„åŒ–è¨­è¨ˆã€‚<br>âš¡ éœé»˜æ›´æ–°ï¼šå„ªåŒ– UXï¼Œç§»é™¤å¹²æ“¾æ€§ Toast é€šçŸ¥ã€‚<br>âš¡ é›™æ¨¡å¼æ’åºï¼šSortableJS å…¨é¢æ”¯æ´åˆ†å‰²æ¨¡å¼ã€‚" },
        { ver: "v26.0 Physics", date: "2026/01/23", desc: "ğŸ“ å¹¾ä½•ç‰©ç†å¼•æ“ï¼šå¯¦ä½œåœ–ç‰‡æ—‹è½‰çš„åº§æ¨™çŸ©é™£æ ¡æ­£ (Origin Shift)ï¼Œå¾¹åº•è§£æ±ºæ—‹è½‰å¾Œåœ–ç‰‡è£åˆ‡å•é¡Œã€‚<br>ğŸš€ æ•ˆèƒ½ç¿»å€ï¼šPDF.js è§£æé‚è¼¯å„ªåŒ– (Single Pass)ã€‚" },
        { ver: "v24.0 Stability", date: "2026/01/23", desc: "ğŸ›¡ï¸ iOS æ©‹æ¥å™¨ï¼šè§£æ±º Safari Blob ä¸‹è¼‰å¤±æ•—å•é¡Œï¼Œæ”¹ç”¨ Window.open æ–¹æ¡ˆã€‚<br>ğŸ›¡ï¸ è¨˜æ†¶é«”é˜²è­·ï¼šé‡å°å¤§åœ–é€²è¡Œ DPI æ™ºæ…§é™å™ªã€‚" },
        { ver: "v10.0 - v1.0", date: "2026/01", desc: "ğŸŒ± èµ·æºï¼šå¾ç°¡å–®çš„ PDF åˆä½µåŸå‹ï¼Œç¶“æ­·ç¸®åœ–æ¸²æŸ“éŒ¯èª¤ã€æ’åºå¤±æ•ˆç­‰æŒ‘æˆ°ï¼Œä¸€æ­¥æ­¥é€²åŒ–è‡³ä»Šã€‚" }
    ],

    ui: {
        switchTab(mode) {
            App.state.mode = mode; App.state.pages = []; App.state.buffers = {};
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.work-area').forEach(p => p.classList.remove('active'));
            const targetBtn = event ? event.target : document.querySelector(`button[onclick*="'${mode}'"]`);
            if(targetBtn) targetBtn.classList.add('active');
            document.getElementById(`area-${mode}`).classList.add('active');
            
            document.getElementById('grid-merge').innerHTML = '';
            document.getElementById('grid-split').innerHTML = '';
            document.getElementById('ctrl-merge').style.display = 'none';
            document.getElementById('ctrl-split').style.display = 'none';
        },
        showProgress(p) {
            const bar = document.getElementById('progress-bar');
            const wrap = document.getElementById('progress-wrap');
            wrap.style.display = 'block'; bar.style.width = p + '%';
            if (p >= 100) setTimeout(() => { wrap.style.display = 'none'; bar.style.width = '0%'; }, 500);
        },
        createCard(pageObj, canvas, label) {
            const div = document.createElement('div');
            div.className = 'card'; div.id = pageObj.id;
            const tools = `
                <div class="tools" style="margin-top:10px;">
                    <button class="tool-btn" onclick="event.stopPropagation(); App.core.rotate('${pageObj.id}')">â†º</button>
                    <button class="tool-btn danger" onclick="event.stopPropagation(); App.core.remove('${pageObj.id}')">âœ•</button>
                </div>`;
            div.innerHTML = `<div class="cv-wrap"></div><div style="font-size:0.8rem; text-align:center; color:#666;">${label}</div>${tools}`;
            div.querySelector('.cv-wrap').appendChild(canvas);
            
            if (App.state.mode === 'split') {
                div.onclick = (e) => {
                    if(e.target.tagName === 'BUTTON') return;
                    const p = App.state.pages.find(x => x.id === pageObj.id);
                    if (p) { p.selected = !p.selected; div.classList.toggle('selected'); }
                };
            }
            document.getElementById(`grid-${App.state.mode}`).appendChild(div);
        },
        toggleHistory(show) {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('timeline-root');
            if(show) {
                list.innerHTML = App.history.map((h, i) => `
                    <div class="timeline-item" style="animation-delay: ${i * 0.1}s">
                        <div class="timeline-marker">
                            <div class="dot"></div>
                            ${i < App.history.length - 1 ? '<div class="line"></div>' : ''}
                        </div>
                        <div class="timeline-content">
                            <span class="ver-tag">${h.ver}</span>
                            <span class="ver-date">${h.date}</span>
                            <p class="ver-desc">${h.desc}</p>
                        </div>
                    </div>
                `).join('');
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }
    },
    core: {
        async init() {
            const { pdfjsLib } = window;
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
            ['merge', 'split'].forEach(m => {
                const drop = document.getElementById(`drop-${m}`);
                const input = document.getElementById(`input-${m}`);
                drop.onclick = () => input.click();
                input.onchange = (e) => this.handleFiles(e.target.files);
                drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
                drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
                drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('dragover'); this.handleFiles(e.dataTransfer.files); });
            });
        },
        async handleFiles(files) {
            if (files.length === 0) return;
            App.ui.showProgress(10);
            try {
                for (const file of Array.from(files)) {
                    if (App.state.mode === 'split' && !file.type.includes('pdf')) { alert("åˆ†å‰²æ¨¡å¼åƒ…æ”¯æ´ PDF"); continue; }
                    const fileId = crypto.randomUUID();
                    const buffer = await file.arrayBuffer();
                    App.state.buffers[fileId] = buffer;
                    if (file.type === 'application/pdf') {
                        const pdfDoc = await pdfjsLib.getDocument({ data: buffer.slice(0) }).promise;
                        for (let i = 1; i <= pdfDoc.numPages; i++) {
                            const pId = crypto.randomUUID();
                            App.state.pages.push({ id: pId, fileId, pIdx: i-1, rot: 0, selected: false, type: 'pdf', name: file.name });
                            await this.renderPage(pdfDoc, i, pId);
                            if (i % 5 === 0) await new Promise(r => setTimeout(r, 0));
                        }
                    } else if (file.type.startsWith('image/') && App.state.mode === 'merge') {
                        const pId = crypto.randomUUID();
                        App.state.pages.push({ id: pId, fileId, pIdx: 0, rot: 0, selected: false, type: 'img', name: file.name });
                        await this.renderImage(file, pId);
                    }
                }
                document.getElementById(`ctrl-${App.state.mode}`).style.display = 'block';
                this.initSortable();
            } catch (e) { console.error(e); alert("è§£æå¤±æ•—"); }
            App.ui.showProgress(100);
        },
        async renderPage(pdfDoc, num, id) {
            const page = await pdfDoc.getPage(num);
            const vp = page.getViewport({ scale: 0.3 });
            const cv = document.createElement('canvas');
            cv.width = vp.width; cv.height = vp.height;
            await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
            App.ui.createCard(App.state.pages.find(p => p.id === id), cv, `P${num}`);
        },
        async renderImage(file, id) {
            const img = new Image(); img.src = URL.createObjectURL(file);
            await new Promise(r => img.onload = r);
            const maxW = 300; const sc = maxW / img.width;
            const cv = document.createElement('canvas');
            cv.width = maxW; cv.height = img.height * sc;
            cv.getContext('2d').drawImage(img, 0, 0, cv.width, cv.height);
            App.ui.createCard(App.state.pages.find(p => p.id === id), cv, 'IMG');
            URL.revokeObjectURL(img.src);
        },
        rotate(id) {
            const p = App.state.pages.find(x => x.id === id);
            if (p) { p.rot = (p.rot + 90) % 360; const cv = document.querySelector(`#${id} canvas`); if(cv) cv.className = `rot-${p.rot}`; }
        },
        remove(id) {
            App.state.pages = App.state.pages.filter(x => x.id !== id);
            document.getElementById(id).remove();
            if (App.state.pages.length === 0) document.getElementById(`ctrl-${App.state.mode}`).style.display = 'none';
        },
        initSortable() {
            const el = document.getElementById(`grid-${App.state.mode}`);
            if (App.state.sortable) App.state.sortable.destroy();
            App.state.sortable = new Sortable(el, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: () => {
                    const ids = Array.from(el.children).map(c => c.id);
                    App.state.pages = ids.map(id => App.state.pages.find(p => p.id === id)).filter(Boolean);
                }
            });
        },
        async process(mode) {
            const targets = mode === 'split' ? App.state.pages.filter(p => p.selected) : App.state.pages;
            if (targets.length === 0) return alert(mode === 'split' ? "è«‹å…ˆé»é¸é é¢" : "ç„¡æª”æ¡ˆå¯è™•ç†");
            App.ui.showProgress(20);
            const { PDFDocument, degrees } = PDFLib;
            try {
                if (mode === 'merge') {
                    const doc = await PDFDocument.create();
                    for (const p of targets) { await this.addToDoc(doc, p); }
                    this.download(await doc.save(), `Merged_${Date.now()}.pdf`, 'application/pdf');
                } else {
                    const zip = new JSZip();
                    let count = 0;
                    for (const p of targets) {
                        const doc = await PDFDocument.create();
                        await this.addToDoc(doc, p);
                        const safeName = (p.name || "doc").replace(/\.pdf$/i, "");
                        zip.file(`${String(++count).padStart(2,'0')}_${safeName}.pdf`, await doc.save());
                    }
                    this.download(await zip.generateAsync({type:'blob'}), `Split_${Date.now()}.zip`, 'application/zip');
                }
            } catch (e) { console.error(e); alert("è™•ç†å¤±æ•—"); }
            App.ui.showProgress(100);
        },
        async addToDoc(targetDoc, p) {
            const { PDFDocument, degrees } = PDFLib;
            const buffer = App.state.buffers[p.fileId];
            if (p.type === 'pdf') {
                const src = await PDFDocument.load(buffer);
                const [page] = await targetDoc.copyPages(src, [p.pIdx]);
                page.setRotation(degrees(p.rot + (page.getRotation().angle || 0)));
                targetDoc.addPage(page);
            } else {
                const img = p.name.toLowerCase().endsWith('png') ? await targetDoc.embedPng(buffer) : await targetDoc.embedJpg(buffer);
                const isRotated = p.rot === 90 || p.rot === 270;
                const dims = isRotated ? { w: img.height, h: img.width } : { w: img.width, h: img.height };
                const page = targetDoc.addPage([dims.w, dims.h]);
                let x = 0, y = 0;
                if (p.rot === 90) x = img.height;
                else if (p.rot === 180) { x = img.width; y = img.height; }
                else if (p.rot === 270) y = img.width;
                page.drawImage(img, { x, y, width: img.width, height: img.height, rotate: degrees(p.rot) });
            }
        },
        download(data, name, type) {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) { window.open(url, '_blank'); } 
            else {
                const a = document.createElement('a'); a.href = url; a.download = name;
                document.body.appendChild(a); a.click(); a.remove();
            }
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        }
    }
};
App.core.init();
</script>
</body>
</html>
