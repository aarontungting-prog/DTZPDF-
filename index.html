<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DTZ PDF v24.0 - å…¨å¹³å°æ¥µè‡´ç©©å®šç‰ˆ</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db;
            --bg-color: #f8fafc; --card-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg-color); color: #1e293b; line-height: 1.6; }
        
        /* é ‚éƒ¨é€²åº¦æ¢ */
        #loader-bar { position: fixed; top: 0; left: 0; width: 0%; height: 5px; background: linear-gradient(90deg, var(--primary-red), var(--primary-blue)); z-index: 2001; transition: width 0.3s ease; }
        
        nav { background: white; padding: 1rem 8%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary-red); text-decoration: none; }

        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; text-align: center; }
        .work-panel { background: white; padding: 40px; border-radius: 24px; box-shadow: var(--card-shadow); min-height: 400px; border: 1px solid #f1f5f9; }

        /* ä¸Šå‚³å€å¡Š */
        .upload-area { border: 3px dashed #cbd5e0; border-radius: 20px; padding: 60px 20px; cursor: pointer; transition: 0.3s; background: #fff; }
        .upload-area:hover { border-color: var(--primary-red); background: #fffaf9; }
        
        /* é é¢å¡ç‰‡ */
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 30px; }
        .page-card { background: #fff; border: 2px solid #f1f5f9; padding: 12px; border-radius: 16px; position: relative; cursor: grab; transition: 0.2s; }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        .cv-wrap { min-height: 180px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        canvas { max-width: 100%; max-height: 100%; border-radius: 4px; }

        /* æŒ‰éˆ•é¢¨æ ¼ */
        .btn-action { padding: 14px 35px; border-radius: 50px; border: none; font-size: 1rem; font-weight: 700; cursor: pointer; color: white; transition: 0.3s; margin: 10px; }
        .btn-green { background: var(--primary-green); } .btn-blue { background: var(--primary-blue); }
        .btn-action:disabled { background: #cbd5e0; cursor: wait; }

        /* ç¾è¡“ä¸‰æ–¹æ¡† */
        .feature-matrix { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 60px; text-align: left; }
        .feature-card { background: white; padding: 25px; border-radius: 18px; box-shadow: var(--card-shadow); border-top: 5px solid transparent; }
        .f-red { border-top-color: var(--primary-red); } .f-green { border-top-color: var(--primary-green); } .f-blue { border-top-color: var(--primary-blue); }

        /* Q&A */
        .qa-container { text-align: left; background: white; padding: 40px; border-radius: 24px; margin-top: 60px; box-shadow: var(--card-shadow); }
        .qa-container h2 { color: var(--primary-red); border-left: 6px solid var(--primary-red); padding-left: 15px; margin-bottom: 25px; }
        .qa-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }

        @media (max-width: 768px) { .feature-matrix, .qa-grid { grid-template-columns: 1fr; } }
        footer { margin: 60px 0; color: #94a3b8; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>
    <div id="loader-bar"></div>
    <nav><a href="#" class="logo">DTZ PDF Lite <span>v24.0</span></a></nav>

    <div class="container">
        <div class="work-panel">
            <div class="upload-area" id="drop-zone" onclick="document.getElementById('file-input').click()">
                <div style="font-size:50px;">ğŸ“‚</div>
                <h3>é»æ“Šæˆ–æ‹–æ”¾ PDF / åœ–ç‰‡</h3>
                <p id="status-text" style="color:#94a3b8;">æ”¯æ´æ··åˆæ ¼å¼ï¼Œç©©å®šè™•ç†ä¸é–ƒé€€</p>
                <input type="file" id="file-input" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
            </div>
            
            <div id="org-grid" class="page-grid"></div>
            
            <div id="controls" style="display:none; margin-top:40px; border-top:1px solid #f1f5f9; padding-top:30px;">
                <button class="btn-action btn-green" id="btn-merge" onclick="processPdf('merge')">åˆä½µç‚ºå–®ä»½ PDF</button>
                <button class="btn-action btn-blue" id="btn-split" onclick="processPdf('split')">åˆ†æ‹†é¸ä¸­é  (ZIP)</button>
                <p style="font-size:0.8rem; color:#94a3b8; margin-top:15px;">æç¤ºï¼šé»æ“Šé é¢å¯é¸å–ï¼ˆç¶ æ¡†ï¼‰ï¼Œæ‹–æ›³å¯æ’åºã€‚</p>
            </div>
        </div>

        <div class="feature-matrix">
            <div class="feature-card f-red"><h4>ğŸ”’ å®‰å…¨éš±ç§</h4><p>100% ç€è¦½å™¨æœ¬åœ°é‹ç®—ï¼Œä¸ç¶“éä»»ä½•ä¼ºæœå™¨ï¼Œç¢ºä¿å•†æ¥­æ©Ÿå¯†çµ•å°å®‰å…¨ã€‚</p></div>
            <div class="feature-card f-green"><h4>ğŸ“± è·¨ç«¯ç›¸å®¹</h4><p>é‡å° iOS Safari ä¸‹è¼‰é€²è¡Œç‰¹åˆ¥å„ªåŒ–ï¼Œç›¸å®¹ Windowsã€Macã€å®‰å“èˆ‡ Linuxã€‚</p></div>
            <div class="feature-card f-blue"><h4>âš¡ é«˜æ•ˆç©©å®š</h4><p>åˆ†æ®µè¼‰å…¥èˆ‡å‘¼å¸æ¸²æŸ“æŠ€è¡“ï¼Œé¿å…è™•ç†å¤§æª”æ¡ˆæ™‚ç¶²é å´©æ½°æˆ–å¡æ­»ã€‚</p></div>
        </div>

        <div class="qa-container">
            <h2>å¸¸è¦‹å•é¡ŒæŒ‡å—</h2>
            <div class="qa-grid">
                <div><h4>1. iPhone ä¸‹è¼‰å¾Œæ‰¾ä¸åˆ°æª”æ¡ˆï¼Ÿ</h4><p>ä¸‹è¼‰å¾Œçš„æª”æ¡ˆé€šå¸¸å„²å­˜åœ¨ç³»çµ±å…§å»ºçš„ã€Œæª”æ¡ˆã€App å…§çš„ã€Œä¸‹è¼‰é …ç›®ã€è³‡æ–™å¤¾ä¸­ã€‚</p></div>
                <div><h4>2. ä¸€æ¬¡èƒ½è™•ç†å¹¾é ï¼Ÿ</h4><p>å»ºè­°ä¸€æ¬¡è™•ç†ä¸è¶…é 100 é ä»¥ç²å¾—æœ€ä½³ç©©å®šæ€§ã€‚è‹¥æª”æ¡ˆéå¤§ï¼Œè«‹åˆ†æ‰¹è™•ç†ã€‚</p></div>
            </div>
        </div>
    </div>

    <footer>&copy; 2026 DTZ PDF PRO | æ ¸å¿ƒç©©å®šç‰ˆ</footer>

    <script>
        const { PDFDocument } = PDFLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let pagesData = []; 
        let fileBuffers = {};
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

        // --- æ ¸å¿ƒè§£æåŠŸèƒ½ ---
        const dropZone = document.getElementById('drop-zone');
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = "#e74c3c"; };
        dropZone.ondragleave = () => { dropZone.style.borderColor = "#cbd5e0"; };
        dropZone.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
        document.getElementById('file-input').onchange = (e) => handleFiles(e.target.files);

        async function handleFiles(files) {
            updateProgress(10);
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fId = crypto.randomUUID();
                const buf = await file.arrayBuffer();
                fileBuffers[fId] = buf;
                
                if (file.name.toLowerCase().endsWith('.pdf')) {
                    const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
                    for (let j = 1; j <= pdf.numPages; j++) {
                        const pId = crypto.randomUUID();
                        const page = await pdf.getPage(j);
                        pagesData.push({ fId, pIdx: j-1, pId, selected: false, fileName: file.name });
                        await renderThumb(page, pId);
                        if (j % 10 === 0) await new Promise(r => setTimeout(r, 0)); // å‘¼å¸
                    }
                } else {
                    const pId = crypto.randomUUID();
                    pagesData.push({ fId, pIdx: 0, pId, selected: false, fileName: file.name, isImg: true, file });
                    renderImgThumb(file, pId);
                }
            }
            document.getElementById('controls').style.display = 'block';
            updateProgress(0);
        }

        async function renderThumb(page, pId) {
            const vp = page.getViewport({ scale: 0.3 });
            const cv = document.createElement('canvas');
            cv.width = vp.width; cv.height = vp.height;
            await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
            createCard(cv, pId);
        }

        function renderImgThumb(file, pId) {
            const url = URL.createObjectURL(file);
            const img = new Image(); img.src = url;
            img.onload = () => {
                const cv = document.createElement('canvas');
                const sc = 150 / img.width;
                cv.width = 150; cv.height = img.height * sc;
                cv.getContext('2d').drawImage(img, 0, 0, cv.width, cv.height);
                createCard(cv, pId); URL.revokeObjectURL(url);
            };
        }

        function createCard(cv, pId) {
            const card = document.createElement('div');
            card.className = 'page-card'; card.id = pId;
            card.innerHTML = `<div class="cv-wrap"></div><button onclick="event.stopPropagation(); delP('${pId}')" style="margin-top:10px; cursor:pointer; font-size:10px;">ç§»é™¤</button>`;
            card.querySelector('.cv-wrap').appendChild(cv);
            card.onclick = () => {
                const p = pagesData.find(x => x.pId === pId);
                p.selected = !p.selected;
                card.classList.toggle('selected');
            };
            document.getElementById('org-grid').appendChild(card);
        }

        function delP(pId) {
            pagesData = pagesData.filter(x => x.pId !== pId);
            document.getElementById(pId).remove();
        }

        // --- æ ¸å¿ƒç”Ÿæˆèˆ‡ä¸‹è¼‰ ---
        async function processPdf(mode) {
            updateProgress(20);
            const zip = mode === 'split' ? new JSZip() : null;
            try {
                const mainDoc = mode === 'merge' ? await PDFDocument.create() : null;
                const list = mode === 'split' ? pagesData.filter(p => p.selected) : pagesData;
                
                if (list.length === 0) return alert("å°šæœªé¸å–é é¢ï¼");

                for (let i = 0; i < list.length; i++) {
                    const p = list[i];
                    let curDoc = mode === 'merge' ? mainDoc : await PDFDocument.create();
                    
                    if (p.isImg) {
                        const img = await curDoc.embedPng(await p.file.arrayBuffer());
                        const page = curDoc.addPage([img.width, img.height]);
                        page.drawImage(img, { x:0, y:0, width:img.width, height:img.height });
                    } else {
                        const srcDoc = await PDFDocument.load(fileBuffers[p.fId]);
                        const [copy] = await curDoc.copyPages(srcDoc, [p.pIdx]);
                        curDoc.addPage(copy);
                    }

                    if (mode === 'split') {
                        zip.file(`Page_${i+1}.pdf`, await curDoc.save());
                    }
                    updateProgress(20 + (80 * (i/list.length)));
                }

                if (mode === 'merge') {
                    const bytes = await mainDoc.save();
                    triggerDownload(bytes, "Merged_by_DTZ.pdf", "application/pdf");
                } else {
                    const blob = await zip.generateAsync({type:"blob"});
                    triggerDownload(blob, "Splits_by_DTZ.zip", "application/zip");
                }
            } catch (e) { alert("ç™¼ç”ŸéŒ¯èª¤: " + e.message); }
            updateProgress(0);
        }

        function triggerDownload(data, name, type) {
            const blob = data instanceof Blob ? data : new Blob([data], {type});
            const url = URL.createObjectURL(blob);
            if (isIOS && type === "application/pdf") {
                window.open(url, '_blank'); // iOS ç©©å®šæ©‹æ¥
            } else {
                const a = document.createElement('a'); a.href = url; a.download = name;
                document.body.appendChild(a); a.click(); a.remove();
            }
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        }

        function updateProgress(v) { document.getElementById('loader-bar').style.width = v + '%'; }

        // åˆå§‹åŒ–æ‹–æ”¾æ’åº
        new Sortable(document.getElementById('org-grid'), {
            animation: 150,
            onEnd: () => {
                const ids = Array.from(document.getElementById('org-grid').children).map(el => el.id);
                pagesData.sort((a,b) => ids.indexOf(a.pId) - ids.indexOf(b.pId));
            }
        });
    </script>
</body>
</html>
