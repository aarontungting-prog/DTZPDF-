<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>éœ“è™¹è¥¿æ´‹æ£‹ï¼šDTZ æœ€çµ‚å®Œå…¨ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/objects/Sky.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/BufferGeometryUtils.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js",
            "firebase/database": "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"
        }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; touch-action: none; color: white; }
        
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .hud { position: absolute; pointer-events: auto; }
        
        /* --- ç™»å…¥è¦–çª— (ä¿æŒä¸è®Š) --- */
        #auth-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; display: flex;
            justify-content: center; align-items: center; pointer-events: auto;
            backdrop-filter: blur(10px); overflow-y: auto;
        }
        .auth-box {
            background: rgba(20, 20, 30, 0.95); border: 1px solid #00e5ff;
            padding: 30px 25px; border-radius: 15px; width: 90%; max-width: 320px; 
            text-align: center; box-shadow: 0 0 40px rgba(0, 229, 255, 0.2);
        }
        .auth-box h2 { color: #00e5ff; margin-top: 0; letter-spacing: 2px; font-size: 24px; margin-bottom: 10px; }
        .auth-input {
            width: 100%; padding: 12px; margin: 8px 0;
            background: #111; border: 1px solid #444; color: #fff;
            border-radius: 6px; box-sizing: border-box; font-size: 16px; 
            -webkit-appearance: none;
        }
        .auth-input:focus { border-color: #00e5ff; outline: none; }
        #nickname-container { display: none; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .forgot-link {
            display: block; text-align: center; font-size: 12px; color: #aaa;
            margin: 15px 0; cursor: pointer; text-decoration: none; padding: 10px;
        }
        .auth-btn {
            width: 100%; padding: 12px; margin-top: 5px;
            background: #00e5ff; color: #000; border: none; font-weight: bold;
            cursor: pointer; border-radius: 6px; transition: 0.3s; font-size: 16px;
        }
        .guest-btn {
            width: 100%; padding: 10px; margin-top: 5px;
            background: transparent; color: #aaa; border: 1px solid #444; 
            font-weight: bold; cursor: pointer; border-radius: 6px; transition: 0.3s; font-size: 14px;
        }

        /* --- éŠæˆ²ä»‹é¢å„ªåŒ– --- */
        
        /* 1. ç‹€æ…‹åˆ— (åŸæœ¬åœ¨å³å´ï¼Œç¾åœ¨æ”¹æˆé ‚éƒ¨å°è† å›Š) */
        #status-panel { 
            top: 20px; right: 20px;
            text-align: right; 
            background: linear-gradient(to left, rgba(0, 255, 255, 0.1), rgba(0,0,0,0)); 
            padding: 15px; border-right: 3px solid #00e5ff; 
            transition: all 0.3s ease;
        }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; color: #00e5ff; margin-bottom: 5px; text-transform: uppercase; }
        #turn-txt { font-size: 1.5rem; font-weight: 900; color: #fff; }

        /* 2. é¸å–®é¢æ¿ (é›»è…¦ç‰ˆé å·¦) */
        #menu-panel { 
            top: 20px; left: 20px; 
            background: rgba(0,0,0,0.8); padding: 20px; 
            border-radius: 8px; border: 1px solid #333; width: 240px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        /* æ–°å¢: é¸å–®åˆ‡æ›æŒ‰éˆ• (é è¨­éš±è—ï¼Œæ‰‹æ©Ÿç‰ˆé¡¯ç¤º) */
        #menu-toggle-btn {
            display: none; position: absolute; top: 15px; left: 15px;
            width: 40px; height: 40px; background: rgba(0,0,0,0.6);
            border: 1px solid #444; border-radius: 8px;
            color: #fff; font-size: 20px; cursor: pointer; z-index: 200;
            pointer-events: auto; justify-content: center; align-items: center;
        }

        /* æ–°æ‰‹æ•™å­¸æŒ‰éˆ• */
        #tutorial-btn {
            position: absolute; bottom: 20px; right: 20px;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(0,0,0,0.7); border: 2px solid #ffaa00;
            color: #ffaa00; font-weight: bold; font-size: 20px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.3s; pointer-events: auto; z-index: 110;
        }

        #tutorial-content {
            position: absolute; bottom: 70px; right: 20px; width: 280px;
            background: rgba(0, 0, 0, 0.95); border: 1px solid #ffaa00;
            border-radius: 8px; padding: 15px; display: none;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.2); z-index: 110;
            max-height: 60vh; overflow-y: auto; 
        }
        #tutorial-content h3 { color: #ffaa00; margin: 0 0 10px 0; border-bottom: 1px solid #555; padding-bottom: 5px; font-size: 16px; }
        #tutorial-content ul { padding-left: 20px; margin: 0; font-size: 13px; color: #ccc; line-height: 1.5; }
        .key-highlight { color: #00e5ff; font-weight: bold; }

        .user-card { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #444; }
        .rank-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; font-weight: bold; }
        .rank-bronze { background: #cd7f32; color: #000; }
        .rank-silver { background: #c0c0c0; color: #000; }
        .rank-gold { background: #ffd700; color: #000; }
        .rank-diamond { background: #b9f2ff; color: #000; box-shadow: 0 0 5px #b9f2ff; }
        .rank-master { background: #ff0055; color: #fff; box-shadow: 0 0 10px #ff0055; }

        button.game-btn { 
            background: #00e5ff; color: #000; border: none; 
            padding: 10px; margin-top: 8px; width: 100%;
            font-weight: bold; cursor: pointer; transition: 0.3s; border-radius: 4px;
        }
        button.join-btn { background: #ff0055; color: #fff; }

        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; color: #ffaa00; font-size: 18px; font-weight: bold; z-index: 1500; text-shadow: 0 0 10px #ffaa00; transition: opacity 0.5s; }
        #footer-watermark { position: absolute; bottom: 10px; width: 100%; text-align: center; color: rgba(255,255,255,0.3); font-size: 12px; pointer-events: none; }
        
        /* =========================================
           â­â­ MOBILE OPTIMIZATION (æ‰‹æ©Ÿç‰ˆå°ˆç”¨ CSS) â­â­
           ========================================= */
        @media (max-width: 600px) {
            /* 1. é¡¯ç¤ºå·¦ä¸Šè§’æ¼¢å ¡é¸å–®æŒ‰éˆ• */
            #menu-toggle-btn { display: flex; }

            /* 2. éš±è—ä¸»é¸å–®ï¼Œæ”¹æˆå½ˆå‡ºå¼ */
            #menu-panel { 
                position: fixed; top: 50%; left: 50%; 
                transform: translate(-50%, -50%) scale(0.9); 
                opacity: 0; pointer-events: none;
                width: 80%; max-width: 300px;
                background: rgba(10, 10, 15, 0.95);
                border: 1px solid #00e5ff;
                box-shadow: 0 0 30px rgba(0,0,0,0.8);
                z-index: 1000;
            }
            /* ç•¶é¸å–®é–‹å•Ÿæ™‚çš„æ¨£å¼ (é€é JS åŠ  class) */
            #menu-panel.active {
                opacity: 1; pointer-events: auto;
                transform: translate(-50%, -50%) scale(1);
            }

            /* 3. ç‹€æ…‹åˆ—æ”¹æˆé ‚éƒ¨æ¥µç°¡æ¨¡å¼ (Pill Style) */
            #status-panel { 
                top: 15px; bottom: auto; right: auto; left: 50%; 
                transform: translateX(-50%);
                width: auto; padding: 5px 20px;
                background: rgba(0, 0, 0, 0.6);
                border: 1px solid rgba(0, 229, 255, 0.3);
                border-radius: 30px;
                border-right: 1px solid rgba(0, 229, 255, 0.3); /* ç§»é™¤åŸæœ¬çš„å³é‚Šæ¡† */
                text-align: center;
                white-space: nowrap;
            }
            #status-panel h1 { display: none; } /* æ‰‹æ©Ÿç‰ˆä¸é¡¯ç¤ºå¤§æ¨™é¡Œ */
            #turn-txt { font-size: 16px; margin: 0; line-height: 1.2; }
            #opponent-info { font-size: 10px; margin-top: 0; }

            /* 4. æ•™å­¸è¦–çª—èˆ‡æŒ‰éˆ•èª¿æ•´ */
            #tutorial-btn { bottom: 20px; right: 20px; width: 35px; height: 35px; font-size: 16px; }
            #tutorial-content { bottom: 60px; right: 10px; left: 10px; width: auto; max-height: 50vh; }
            
            /* 5. ç™»å…¥æ¡† */
            .auth-box { width: 85%; padding: 25px 20px; }
            
            /* 6. é®ç½©å±¤ (ç•¶é¸å–®é–‹å•Ÿæ™‚èƒŒæ™¯è®Šæš—) */
            #menu-backdrop {
                display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 900; pointer-events: auto;
            }
            #menu-backdrop.active { display: block; }
        }
    </style>
</head>
<body>

<div id="loading">æ­£åœ¨é€£ç·šä¼ºæœå™¨...</div>

<div id="menu-toggle-btn" onclick="toggleMenu()">â˜°</div>
<div id="menu-backdrop" onclick="toggleMenu()"></div>

<div id="auth-modal">
    <div class="auth-box">
        <h2>DTZ CHESS</h2>
        <div id="auth-error" style="color:#ff0055; font-size:12px; margin-bottom:10px;"></div>
        
        <div id="email-login-form">
            <input type="email" id="email" class="auth-input" placeholder="é›»å­ä¿¡ç®± (Email)">
            <input type="password" id="password" class="auth-input" placeholder="å¯†ç¢¼ (Password)">
            
            <div id="nickname-container">
                <input type="text" id="nickname" class="auth-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„éŠæˆ²æš±ç¨±" style="border-color:#00ff00;">
            </div>

            <button id="auth-action-btn" class="auth-btn">é–‹å§‹éŠç© (Start)</button>
            <div class="forgot-link" id="forgot-pw">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</div>
        </div>

        <button id="guest-btn" class="guest-btn">è¨ªå®¢è©¦ç© (Guest Login)</button>
    </div>
</div>

<div id="ui" style="display:none;">
    
    <div id="menu-panel" class="hud">
        <div style="text-align:right; margin-bottom:5px; display:none;" id="menu-close-x">
            <span style="cursor:pointer; color:#aaa; font-size:20px;" onclick="toggleMenu()">âœ•</span>
        </div>

        <div class="user-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="user-name" style="font-weight:bold; font-size:16px; color:#fff;">Player</span>
                <span id="user-rank" class="rank-badge rank-bronze">éŠ…ç‰Œ</span>
            </div>
            <div style="font-size:12px; color:#aaa; margin-top:5px;">
                æˆ°åŠ›ç©åˆ† (ELO): <span id="user-elo" style="color:#00e5ff; font-weight:bold;">0</span>
            </div>
        </div>

        <div style="color:#aaa; font-weight:bold; margin-bottom:5px; font-size:12px; letter-spacing: 1px;">å°æˆ°å¤§å»³</div>
        <div id="room-display" style="font-size:12px; color:#0f0; margin-bottom:10px;">ç‹€æ…‹ï¼šç­‰å¾…æ“ä½œ</div>
        
        <button id="btn-create" class="game-btn">å‰µå»ºæˆ¿é–“ (åŸ·ç™½)</button>
        <button id="btn-join" class="game-btn join-btn">åŠ å…¥æˆ¿é–“ (åŸ·é»‘)</button>
        <button id="btn-logout" class="game-btn" style="background:#333; color:#aaa; margin-top:15px;">ç™»å‡º</button>
    </div>

    <div id="tutorial-btn" onclick="toggleTutorial()">?</div>
    <div id="tutorial-content" class="hud">
        <h3>æ–°æ‰‹æŒ‡å—</h3>
        <h4>ğŸ® åŸºç¤æ“ä½œ</h4>
        <ul>
            <li><span class="key-highlight">ç§»å‹•:</span> é»é¸æ£‹å­ -> é»é¸ç›®æ¨™</li>
            <li><span class="key-highlight">è¦–è§’:</span> å–®æŒ‡æ»‘å‹•ç©ºç™½è™•</li>
            <li><span class="key-highlight">ç¸®æ”¾:</span> é›™æŒ‡ç¸®æ”¾</li>
        </ul>
        <div style="text-align:center; margin-top:10px; color:#888; font-size:12px;">(é»æ“Š ? é—œé–‰)</div>
    </div>

    <div id="status-panel" class="hud">
        <h1>NEON CHESS</h1>
        <div id="turn-txt">ç­‰å¾…å°æˆ°</div>
        <div id="opponent-info" style="font-size: 12px; color: #aaa; margin-top:5px;">å°æ‰‹: ---</div>
    </div>
    
    <div id="footer-watermark">Made by DTZ with Gemini Pro</div>
</div>

<script type="module">
    import { initializeApp } from "firebase/app";
    import { getDatabase, ref, set, get, update, onValue, child } from "firebase/database";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut, sendPasswordResetEmail } from "firebase/auth";

    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    // æ‰‹æ©Ÿç‰ˆè‡ªå‹•é¡¯ç¤ºé¸å–®é—œé–‰å‰å‰
    if(isMobile) {
        document.getElementById('menu-close-x').style.display = 'block';
    }

    const CONFIG = {
        grassCount: isMobile ? 20000 : 80000,
        treeCount: isMobile ? 300 : 850,
        shadowSize: isMobile ? 1024 : 2048,
        pixelRatio: isMobile ? Math.min(window.devicePixelRatio, 2) : window.devicePixelRatio
    };

    const firebaseConfig = {
        apiKey: "AIzaSyCxPppnUG864v3E2j1OzykzFmhLpsEJCSE",
        authDomain: "chess-1885a.firebaseapp.com",
        databaseURL: "https://chess-1885a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "chess-1885a",
        storageBucket: "chess-1885a.firebasestorage.app",
        messagingSenderId: "824383572856",
        appId: "1:824383572856:web:7c663d6bf0f970f6acd68d",
        measurementId: "G-0EMJ4W2KLS"
    };

    let app, db, auth;
    try {
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        auth = getAuth(app);
    } catch(e) { console.error("Firebase Config Error:", e); }

    let currentUser = null;
    let gameId = null;
    let playerColor = 'w';
    let isOnline = false;
    let isRegistering = false; 

    let scene, camera, renderer, controls, raycaster, mouse, clock;
    let game = new Chess();
    let tilesMap = {}, piecesMap = {};
    let selectedSquare = null, isProcessing = false;
    let grassMat, cloudParticles = [];
    const BOARD_HEIGHT = 15;

    // --- UI åˆ‡æ›é‚è¼¯ ---
    window.toggleTutorial = function() {
        const p = document.getElementById('tutorial-content');
        p.style.display = p.style.display === 'none' ? 'block' : 'none';
    }

    window.toggleMenu = function() {
        // åªæœ‰æ‰‹æ©Ÿç‰ˆéœ€è¦é€™å€‹åŠŸèƒ½
        if (!document.getElementById('ui').style.display === 'none') return;
        
        const menu = document.getElementById('menu-panel');
        const backdrop = document.getElementById('menu-backdrop');
        
        // åˆ‡æ› active class
        if (menu.classList.contains('active')) {
            menu.classList.remove('active');
            backdrop.classList.remove('active');
        } else {
            menu.classList.add('active');
            backdrop.classList.add('active');
        }
    }

    const authModal = document.getElementById('auth-modal');
    const authActionBtn = document.getElementById('auth-action-btn');
    const forgotPwLink = document.getElementById('forgot-pw');
    const guestBtn = document.getElementById('guest-btn');
    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('password');
    const nicknameInput = document.getElementById('nickname');
    const nicknameContainer = document.getElementById('nickname-container');
    const errorMsg = document.getElementById('auth-error');
    const loadingScreen = document.getElementById('loading');

    onAuthStateChanged(auth, (user) => {
        loadingScreen.style.display = 'none';
        if (user) {
            currentUser = user;
            authModal.style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            checkAndCreateUserProfile(user);
        } else {
            currentUser = null;
            authModal.style.display = 'flex';
            document.getElementById('ui').style.display = 'none';
            resetAuthForm();
        }
    });

    function resetAuthForm() {
        isRegistering = false;
        nicknameContainer.style.display = 'none';
        authActionBtn.innerText = "é–‹å§‹éŠç© (Start)";
        errorMsg.innerText = "";
    }

    function checkAndCreateUserProfile(user) {
        const userRef = ref(db, 'users/' + user.uid);
        get(userRef).then((snapshot) => {
            if (!snapshot.exists()) {
                const inputName = nicknameInput.value.trim();
                const name = inputName || (user.isAnonymous ? `è¨ªå®¢_${user.uid.substring(0,4)}` : user.email.split('@')[0]);
                
                set(userRef, {
                    name: name,
                    email: user.email || "guest",
                    elo: 0,
                    wins: 0,
                    losses: 0
                }).then(loadUserProfile);
            } else {
                loadUserProfile();
            }
        });
    }

    function loadUserProfile() {
        if (!currentUser) return;
        onValue(ref(db, 'users/' + currentUser.uid), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                document.getElementById('user-name').innerText = data.name;
                document.getElementById('user-elo').innerText = data.elo;
                updateRankBadge(data.elo);
            }
        });
    }

    function updateRankBadge(elo) {
        const badge = document.getElementById('user-rank');
        badge.className = 'rank-badge';
        if (elo < 200) { badge.innerText = "æ–°æ‰‹ NOVICE"; badge.classList.add('rank-bronze'); }
        else if (elo < 500) { badge.innerText = "éŠ…ç‰Œ BRONZE"; badge.classList.add('rank-bronze'); }
        else if (elo < 1000) { badge.innerText = "éŠ€ç‰Œ SILVER"; badge.classList.add('rank-silver'); }
        else if (elo < 1500) { badge.innerText = "é‡‘ç‰Œ GOLD"; badge.classList.add('rank-gold'); }
        else if (elo < 2000) { badge.innerText = "é‘½çŸ³ DIAMOND"; badge.classList.add('rank-diamond'); }
        else { badge.innerText = "éœ“è™¹å®—å¸«"; badge.classList.add('rank-master'); }
    }

    authActionBtn.addEventListener('click', async () => {
        const email = emailInput.value.trim();
        const password = passInput.value.trim();
        
        if(!email || !password) { errorMsg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
        if(!email.includes('@')) { errorMsg.innerText = "Email æ ¼å¼ä¸æ­£ç¢º"; return; }

        if (isRegistering) {
            const nickname = nicknameInput.value.trim();
            if(!nickname) { errorMsg.innerText = "è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±"; return; }
            errorMsg.innerText = "è¨»å†Šä¸­...";
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                handleAuthError(error);
            }
            return;
        }

        errorMsg.innerText = "ç™»å…¥ä¸­...";
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                isRegistering = true;
                nicknameContainer.style.display = 'block'; 
                authActionBtn.innerText = "ç¢ºèªè¨»å†Š"; 
                errorMsg.innerText = "åˆæ¬¡è¦‹é¢ï¼è«‹è¼¸å…¥æš±ç¨±ä¾†å®Œæˆè¨»å†Šã€‚";
                errorMsg.style.color = "#00ff00"; 
            } else {
                handleAuthError(error);
            }
        }
    });

    function handleAuthError(error) {
        errorMsg.style.color = "#ff0055";
        let msg = error.message;
        if(msg.includes("weak-password")) msg = "å¯†ç¢¼å¤ªå¼±";
        if(msg.includes("email-already-in-use")) msg = "æ­¤ä¿¡ç®±å·²è¢«è¨»å†Š";
        if(msg.includes("wrong-password") || msg.includes("invalid-credential")) msg = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
        errorMsg.innerText = msg;
    }

    forgotPwLink.addEventListener('click', async () => {
        const email = emailInput.value.trim();
        if(!email || !email.includes('@')) {
            errorMsg.innerText = "è«‹å…ˆè¼¸å…¥ Email";
            return;
        }
        try {
            await sendPasswordResetEmail(auth, email);
            alert(`å¯†ç¢¼é‡è¨­ä¿¡å·²ç™¼é€è‡³ ${email}`);
        } catch (error) {
            errorMsg.innerText = "ç™¼é€å¤±æ•—ï¼š" + error.message;
        }
    });

    guestBtn.addEventListener('click', async () => {
        errorMsg.innerText = "è¨ªå®¢ç™»å…¥ä¸­...";
        try {
            await signInAnonymously(auth);
        } catch (error) {
            errorMsg.innerText = "è¨ªå®¢ç™»å…¥å¤±æ•—";
        }
    });

    document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

    // ä¿®æ”¹: å‰µå»ºæˆ–åŠ å…¥æˆ¿é–“å¾Œï¼Œåœ¨æ‰‹æ©Ÿç‰ˆè‡ªå‹•é—œé–‰é¸å–®
    function closeMenuIfMobile() {
        if(isMobile) {
            document.getElementById('menu-panel').classList.remove('active');
            document.getElementById('menu-backdrop').classList.remove('active');
        }
    }

    window.createGameRoom = function() {
        gameId = Math.floor(1000 + Math.random() * 9000).toString();
        get(ref(db, 'users/' + currentUser.uid)).then(snap => {
            const userData = snap.val();
            set(ref(db, 'games/' + gameId), {
                fen: game.fen(),
                turn: 'w',
                white: { uid: currentUser.uid, elo: userData.elo, name: userData.name },
                black: null,
                status: 'waiting'
            }).then(() => {
                playerColor = 'w'; isOnline = true;
                document.getElementById('room-display').innerText = `æˆ¿é–“è™Ÿï¼š${gameId} (ç­‰å¾…åŠ å…¥)`;
                document.getElementById('room-display').style.color = "#00ff00";
                document.getElementById('opponent-info').innerText = "ç­‰å¾…å°æ‰‹...";
                
                new TWEEN.Tween(camera.position).to({x: 0, y: 60, z: 100}, 2000).easing(TWEEN.Easing.Cubic.Out).start();
                controls.target.set(0, BOARD_HEIGHT, 0);

                closeMenuIfMobile(); // è‡ªå‹•é—œé–‰é¸å–®

                onValue(ref(db, 'games/' + gameId), (snapshot) => {
                    const data = snapshot.val();
                    if (!data) return;
                    if (data.status === 'playing' && !data.winner && document.getElementById('turn-txt').innerText.includes("ç­‰å¾…")) {
                        if (data.black) {
                            document.getElementById('opponent-info').innerText = `VS: ${data.black.name}`;
                            document.getElementById('room-display').innerText = `æˆ¿é–“è™Ÿï¼š${gameId} (å°æˆ°ä¸­)`;
                            alert(`å°æ‰‹ ${data.black.name} å·²åŠ å…¥ï¼`);
                            updateStatusHUD();
                        }
                    }
                    if (data.fen !== game.fen()) {
                        game.load(data.fen);
                        syncPieces();
                        updateStatusHUD();
                    }
                    if (data.winner) handleGameOver(data.winner);
                });
                alert(`æˆ¿é–“å·²å»ºç«‹ï¼è™Ÿç¢¼ï¼š${gameId}`);
            });
        });
    }

    window.joinGameRoom = function() {
        const id = prompt('è«‹è¼¸å…¥æˆ¿é–“è™Ÿç¢¼:');
        if(!id) return;
        gameId = id;
        get(ref(db, 'games/' + gameId)).then((snapshot) => {
            if (snapshot.exists()) {
                const gameData = snapshot.val();
                if(gameData.status !== 'waiting') { alert("æˆ¿é–“å·²æ»¿æˆ–éŠæˆ²å·²çµæŸ"); return; }

                get(ref(db, 'users/' + currentUser.uid)).then(snap => {
                    const userData = snap.val();
                    update(ref(db, 'games/' + gameId), {
                        black: { uid: currentUser.uid, elo: userData.elo, name: userData.name },
                        status: 'playing'
                    });

                    playerColor = 'b'; isOnline = true;
                    document.getElementById('room-display').innerText = `æˆ¿é–“è™Ÿï¼š${gameId} (å°æˆ°ä¸­)`;
                    document.getElementById('opponent-info').innerText = `VS: ${gameData.white.name}`;
                    
                    new TWEEN.Tween(camera.position).to({x: 0, y: 60, z: -100}, 2000).easing(TWEEN.Easing.Cubic.Out).start();
                    controls.target.set(0, BOARD_HEIGHT, 0);

                    closeMenuIfMobile(); // è‡ªå‹•é—œé–‰é¸å–®

                    game.load(gameData.fen);
                    syncPieces();
                    updateStatusHUD();

                    onValue(ref(db, 'games/' + gameId), (snapshot) => {
                        const data = snapshot.val();
                        if(data.fen !== game.fen()) {
                            game.load(data.fen);
                            syncPieces();
                            updateStatusHUD();
                        }
                        if (data.winner) handleGameOver(data.winner);
                    });
                });
            } else { alert("æˆ¿é–“ä¸å­˜åœ¨"); }
        });
    }

    function sendMove(move) {
        if (!isOnline) return;
        const nextFen = game.fen();
        let updateData = { fen: nextFen, turn: game.turn(), lastMove: move };
        if (game.in_checkmate()) {
            const winnerColor = game.turn() === 'w' ? 'b' : 'w'; 
            updateData.winner = winnerColor;
            updateData.status = 'finished';
            calculateELO(winnerColor);
        }
        update(ref(db, 'games/' + gameId), updateData);
    }

    function calculateELO(winnerColor) {
        get(ref(db, 'games/' + gameId)).then(snap => {
            const data = snap.val();
            if(data.calculated) return; 
            if(playerColor === 'w') {
                const K = 32; 
                let wElo = data.white.elo;
                let bElo = data.black.elo;
                const expectW = 1 / (1 + Math.pow(10, (bElo - wElo) / 400));
                const expectB = 1 / (1 + Math.pow(10, (wElo - bElo) / 400));
                let wScore = winnerColor === 'w' ? 1 : 0;
                let bScore = winnerColor === 'b' ? 1 : 0;
                const newWElo = Math.round(wElo + K * (wScore - expectW));
                const newBElo = Math.round(bElo + K * (bScore - expectB));
                update(ref(db, 'users/' + data.white.uid), { elo: newWElo });
                update(ref(db, 'users/' + data.black.uid), { elo: newBElo });
                update(ref(db, 'games/' + gameId), { calculated: true });
            }
        });
    }

    function handleGameOver(winnerColor) {
        isProcessing = true; 
        let msg = "";
        if (winnerColor === playerColor) msg = "å‹åˆ©ï¼";
        else msg = "æˆ°æ•—...";
        alert(msg);
        document.getElementById('turn-txt').innerText = winnerColor === 'w' ? "ç™½æ–¹å‹åˆ©" : "é»‘æ–¹å‹åˆ©";
        document.getElementById('turn-txt').style.color = "#ffff00";
    }

    document.getElementById('btn-create').addEventListener('click', window.createGameRoom);
    document.getElementById('btn-join').addEventListener('click', window.joinGameRoom);

    function getTerrainHeight(x, z) {
        const dist = Math.sqrt(x*x + z*z);
        if (dist < 400) return -12 + Math.sin(x*0.004)*Math.cos(z*0.004)*2.0;
        const blend = smoothstep(400, 700, dist);
        let h = blend * 140; 
        h += Math.sin(x * 0.015) * Math.cos(z * 0.015) * 25;
        h += Math.sin(x * 0.03 + z * 0.02) * 10;
        return h - 12;
    }
    function smoothstep(min, max, value) {
        var x = Math.max(0, Math.min(1, (value - min) / (max - min)));
        return x * x * (3 - 2 * x);
    }

    function init() {
        clock = new THREE.Clock();
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0xff9966, 0.0008);
        scene.background = new THREE.Color(0x331111);

        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 6000);
        camera.position.set(0, 60, 100); 

        renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setPixelRatio(CONFIG.pixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.1; 
        document.body.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.maxPolarAngle = Math.PI / 2.05;
        controls.minDistance = 10; controls.maxDistance = 450;
        controls.target.set(0, BOARD_HEIGHT, 0);

        setupSunsetLighting();
        
        setTimeout(() => {
            createProceduralTerrain(); 
            createVegetation(); 
            createHighAltitudeClouds(); 
            createFloatingBoard();
            syncPieces();
        }, 100);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        
        window.addEventListener('touchstart', onTouchStart, {passive: false});
        window.addEventListener('click', onMouseClick);
        window.addEventListener('resize', onResize);

        animate();
    }

    function setupSunsetLighting(){const ambient=new THREE.AmbientLight(0xffccaa,0.75);scene.add(ambient);const sunLight=new THREE.DirectionalLight(0xff8800,3.2);sunLight.position.set(-300,100,-300);sunLight.castShadow=true;sunLight.shadow.mapSize.set(CONFIG.shadowSize,CONFIG.shadowSize);const d=700;sunLight.shadow.camera.left=-d;sunLight.shadow.camera.right=d;sunLight.shadow.camera.top=d;sunLight.shadow.camera.bottom=-d;scene.add(sunLight);const sky=new THREE.Sky();sky.scale.setScalar(450000);scene.add(sky);const uniforms=sky.material.uniforms;uniforms['turbidity'].value=10;uniforms['rayleigh'].value=3;uniforms['mieCoefficient'].value=0.005;uniforms['mieDirectionalG'].value=0.8;uniforms['sunPosition'].value.copy(sunLight.position);const sunGeo=new THREE.SphereGeometry(80,32,32);const sunMat=new THREE.MeshBasicMaterial({color:0xff5500,fog:false});const sunSphere=new THREE.Mesh(sunGeo,sunMat);sunSphere.position.copy(sunLight.position).normalize().multiplyScalar(3000);scene.add(sunSphere);}
    function createProceduralTerrain(){const geo=new THREE.PlaneGeometry(3500,3500,isMobile?100:180,isMobile?100:180);geo.rotateX(-Math.PI/2);const pos=geo.attributes.position;const colors=[];const c1=new THREE.Color(0x226622);const c2=new THREE.Color(0x665544);for(let i=0;i<pos.count;i++){const h=getTerrainHeight(pos.getX(i),pos.getZ(i));pos.setY(i,h);const b=smoothstep(-12,8,h);const c=c1.clone().lerp(c2,b);colors.push(c.r,c.g,c.b);}geo.setAttribute('color',new THREE.Float32BufferAttribute(colors,3));geo.computeVertexNormals();const mat=new THREE.MeshStandardMaterial({vertexColors:true,roughness:0.9,metalness:0.1,flatShading:true});const mesh=new THREE.Mesh(geo,mat);mesh.receiveShadow=true;scene.add(mesh);}
    function createVegetation(){const grp=new THREE.Group();const lMat=new THREE.MeshStandardMaterial({color:0x1a3d1a,roughness:0.9,flatShading:true});const tMat=new THREE.MeshStandardMaterial({color:0x3d2817,roughness:1.0});const lGeo=new THREE.DodecahedronGeometry(4,0);const tGeo=new THREE.CylinderGeometry(0.7,1.0,6,6);tGeo.translate(0,3,0);for(let i=0;i<CONFIG.treeCount;i++){const a=Math.random()*Math.PI*2;const r=70+Math.random()*380;const x=Math.cos(a)*r;const z=Math.sin(a)*r;const h=getTerrainHeight(x,z);const tr=new THREE.Group();const t=new THREE.Mesh(tGeo,tMat);t.castShadow=true;tr.add(t);for(let j=0;j<3;j++){const l=new THREE.Mesh(lGeo,lMat);l.position.set((Math.random()-0.5)*5,5.5+Math.random()*3.5,(Math.random()-0.5)*5);l.scale.setScalar(0.8+Math.random()*0.4);l.castShadow=true;tr.add(l);}tr.position.set(x,h,z);tr.scale.setScalar(0.9+Math.random()*0.6);grp.add(tr);}scene.add(grp);const bGeo=new THREE.PlaneGeometry(0.3,1.5);bGeo.translate(0,0.75,0);grassMat=new THREE.MeshStandardMaterial({color:0x226622,side:THREE.DoubleSide});grassMat.onBeforeCompile=s=>{s.uniforms.time={value:0};s.vertexShader=`uniform float time;\n`+s.vertexShader;s.vertexShader=s.vertexShader.replace(`#include <begin_vertex>`,`vec3 transformed=vec3(position);float w=sin(time*1.5+position.x*0.5)*0.2*position.y;transformed.x+=w;#include <begin_vertex>`);grassMat.userData.shader=s;};const iG=new THREE.InstancedMesh(bGeo,grassMat,CONFIG.grassCount);const d=new THREE.Object3D();let c=0;for(let i=0;i<100000;i++){if(c>=CONFIG.grassCount)break;const r=Math.random()*420;const a=Math.random()*Math.PI*2;const x=Math.cos(a)*r;const z=Math.sin(a)*r;const h=getTerrainHeight(x,z);if(h<-8){d.position.set(x,h,z);d.rotation.y=Math.random()*Math.PI;d.scale.setScalar(0.7+Math.random()*0.6);d.updateMatrix();iG.setMatrixAt(c++,d.matrix);}}iG.receiveShadow=true;scene.add(iG);}
    function createHighAltitudeClouds(){const cv=document.createElement('canvas');cv.width=128;cv.height=128;const cx=cv.getContext('2d'),g=cx.createRadialGradient(64,64,0,64,64,64);g.addColorStop(0,'rgba(255,180,120,0.5)');g.addColorStop(1,'rgba(0,0,0,0)');cx.fillStyle=g;cx.fillRect(0,0,128,128);const mat=new THREE.SpriteMaterial({map:new THREE.CanvasTexture(cv),transparent:true,blending:THREE.AdditiveBlending,depthWrite:false});const gp=new THREE.Group();const cc=isMobile?25:45;for(let i=0;i<cc;i++){const cl=new THREE.Group();for(let j=0;j<15;j++){const p=new THREE.Sprite(mat);p.position.set((Math.random()-0.5)*50,(Math.random()-0.5)*20,(Math.random()-0.5)*50);p.scale.setScalar(40+Math.random()*40);cl.add(p);}cl.position.set((Math.random()-0.5)*3200,250+Math.random()*150,(Math.random()-0.5)*3200);gp.add(cl);cloudParticles.push(cl);}scene.add(gp);}
    function createFloatingBoard(){const g=new THREE.TorusGeometry(8,0.3,16,32);const m=new THREE.MeshBasicMaterial({color:0xffaa00});const r=new THREE.Mesh(g,m);r.rotation.x=Math.PI/2;r.position.y=BOARD_HEIGHT-3;scene.add(r);const b=new THREE.Mesh(new THREE.BoxGeometry(9,0.5,9),new THREE.MeshStandardMaterial({color:0x221111,roughness:0.5}));b.position.y=BOARD_HEIGHT-0.25;b.receiveShadow=true;scene.add(b);for(let r=0;r<8;r++)for(let c=0;c<8;c++){const n=String.fromCharCode(97+c)+(r+1),w=(r+c)%2!==0;const t=new THREE.Mesh(new THREE.BoxGeometry(1,0.2,1),new THREE.MeshStandardMaterial({color:w?0xffddbb:0x443333,roughness:0.2,metalness:0.3}));t.position.set(c-3.5,BOARD_HEIGHT,3.5-r);t.userData={square:n,isTile:true};t.receiveShadow=true;t.castShadow=true;scene.add(t);tilesMap[n]=t;}}
    function createSolidPiece(t,c){const g=new THREE.Group(),mat=c==='w'?new THREE.MeshStandardMaterial({color:0xeeeeff,roughness:0.2,metalness:0.5}):new THREE.MeshStandardMaterial({color:0x222222,roughness:0.3,metalness:0.8}),glow=c==='w'?new THREE.MeshStandardMaterial({color:0x00e5ff,emissive:0x00e5ff,emissiveIntensity:2}):new THREE.MeshStandardMaterial({color:0xff0055,emissive:0xff0055,emissiveIntensity:2});const b=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.45,0.2,32),mat);b.position.y=0.1;b.castShadow=true;g.add(b);if(t==='p'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.35,0.6,16),mat);by.position.y=0.5;by.castShadow=true;const h=new THREE.Mesh(new THREE.SphereGeometry(0.25,32,32),mat);h.position.y=0.95;h.castShadow=true;g.add(by,h);}else if(t==='r'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.35,0.8,32),mat);by.position.y=0.6;by.castShadow=true;const tp=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.3,32),mat);tp.position.y=1.1;tp.castShadow=true;const rg=new THREE.Mesh(new THREE.TorusGeometry(0.2,0.05,16,32),glow);rg.position.y=1.25;rg.rotation.x=Math.PI/2;g.add(by,tp,rg);}else if(t==='b'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.35,1.0,16),mat);by.position.y=0.7;by.castShadow=true;const h=new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.25,0.5,16),mat);h.position.y=1.4;h.castShadow=true;const tp=new THREE.Mesh(new THREE.SphereGeometry(0.08),glow);tp.position.y=1.7;g.add(by,h,tp);}else if(t==='n'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.35,0.6,16),mat);by.position.y=0.5;by.castShadow=true;const h=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.6,0.2),mat);h.position.set(0,1.0,0.1);h.rotation.x=-Math.PI/6;h.castShadow=true;const m=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.5,0.05),glow);m.position.set(0,1.1,-0.15);m.rotation.x=-Math.PI/6;g.add(by,h,m);if(c==='b')g.rotation.y=Math.PI;}else if(t==='q'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.4,1.4,32),mat);by.position.y=0.9;by.castShadow=true;const t=new THREE.Mesh(new THREE.SphereGeometry(0.15),glow);t.position.y=1.7;g.add(by,t);}else if(t==='k'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.45,1.6,32),mat);by.position.y=1.0;by.castShadow=true;const c=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.4,0.1),glow);c.position.y=1.95;g.add(by,c);}return g;}
    function syncPieces(){for(let sq in piecesMap)scene.remove(piecesMap[sq]);piecesMap={};const b=game.board();for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=b[r][c];if(p){const sq=String.fromCharCode(97+c)+(8-r),s=createSolidPiece(p.type,p.color);s.position.set(c-3.5, BOARD_HEIGHT, r-3.5);scene.add(s);piecesMap[sq]=s;}}}
    
    function onTouchStart(e){
        // é»æ“Š UI å…ƒç´  (åŒ…å«é¸å–®é–‹é—œ) ä¸è§¸ç™¼ 3D
        if (e.target.closest('.auth-box') || e.target.closest('.hud') || e.target.id === 'menu-toggle-btn' || e.target.id === 'menu-backdrop' || e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') {
            return;
        }

        if(e.touches.length > 1) return;
        e.preventDefault(); 
        mouse.x=(e.touches[0].clientX/window.innerWidth)*2-1;
        mouse.y=-(e.touches[0].clientY/window.innerHeight)*2+1;
        chk();
    }

    function onMouseClick(e){
        if(isProcessing)return;
        if (e.target.closest('.auth-box') || e.target.closest('.hud') || e.target.id === 'menu-toggle-btn') return;

        mouse.x=(e.clientX/window.innerWidth)*2-1;
        mouse.y=-(e.clientY/window.innerHeight)*2+1;
        chk();
    }

    function chk(){raycaster.setFromCamera(mouse,camera);const i=raycaster.intersectObjects(Object.values(tilesMap));if(i.length>0)hdl(i[0].object.userData.square);}
    function hdl(sq){
        if(isOnline&&game.turn()!==playerColor)return;
        const p=game.get(sq);
        if(!selectedSquare){if(p&&p.color===game.turn())if(!isOnline||(isOnline&&p.color===playerColor))sel(sq);}
        else{if(p&&p.color===game.turn()){sel(sq);return;}const m=game.move({from:selectedSquare,to:sq,promotion:'q'});if(m){am(m);if(isOnline)sendMove(m);}else{clr();selectedSquare=null;}}
    }
    function sel(sq){clr();selectedSquare=sq;tilesMap[sq].material.emissive.setHex(0xffff00);tilesMap[sq].material.emissiveIntensity=0.8;game.moves({square:sq,verbose:true}).forEach(m=>{tilesMap[m.to].material.emissive.setHex(m.captured?0xff3300:0x00aaff);tilesMap[m.to].material.emissiveIntensity=0.5;});}
    function clr(){for(let s in tilesMap){tilesMap[s].material.emissive.setHex(0x000000);tilesMap[s].material.emissiveIntensity=0;}}
    function am(m){isProcessing=true;clr();const s=piecesMap[m.from],e=tilesMap[m.to].position.clone();if(m.captured&&piecesMap[m.to])scene.remove(piecesMap[m.to]);new TWEEN.Tween(s.position).to(e,500).easing(TWEEN.Easing.Quadratic.Out).onComplete(()=>{syncPieces();updateStatusHUD();if(!isOnline&&game.turn()==='b')setTimeout(makeRandomAI,500);else isProcessing=false;}).start();}
    function makeRandomAI(){const ms=game.moves();if(ms.length===0)return;game.move(ms[Math.floor(Math.random()*ms.length)]);syncPieces();updateStatusHUD();isProcessing=false;}
    function updateStatusHUD(){
        const t=document.getElementById('turn-txt'), turn=game.turn();
        if(isOnline){t.innerText=turn==='w'?"ç™½æ–¹å›åˆ":"é»‘æ–¹å›åˆ";t.style.color=turn==='w'?"#00e5ff":"#ff0055";}
        else{t.innerText=turn==='w'?"è—æ–¹å›åˆ":"é›»è…¦å›åˆ";t.style.color=turn==='w'?"#00e5ff":"#ff0055";}
    }
    function onResize(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);}
    function animate(){requestAnimationFrame(animate);const t=clock.getElapsedTime();TWEEN.update();controls.update();if(grassMat&&grassMat.userData.shader)grassMat.userData.shader.uniforms.time.value=t;cloudParticles.forEach(c=>{c.rotation.y+=0.0003;});renderer.render(scene,camera);}
    
    init();
</script>
</body>
</html>
