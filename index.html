<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>DTZ PDF - å°ˆæ¥­ç´šæ–‡ä»¶è™•ç†ä¸­æ¨</title>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --primary: #e74c3c; --accent: #3498db; --success: #2ecc71; 
            --bg: #fdfdfd; --text-main: #2d3436; --text-sub: #636e72; --border: #dcdcdc;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text-main); line-height: 1.6; }

        /* å°èˆª */
        nav { background: white; padding: 1.2rem 8%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .logo { font-size: 1.6rem; font-weight: 800; color: var(--primary); text-decoration: none; letter-spacing: -0.5px; }
        
        /* âœ… ç‰ˆæœ¬è™ŸæŒ‰éˆ• (å¯é»æ“Š) */
        .version-btn { 
            background: var(--primary); color: white; font-size: 0.8rem; padding: 6px 16px; border-radius: 50px; font-weight: 600; cursor: pointer; transition: 0.3s;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
        }
        .version-btn:hover { transform: scale(1.05); background: #c0392b; }

        .container { max-width: 960px; margin: 50px auto; padding: 0 24px; text-align: center; }
        
        .header { margin-bottom: 40px; }
        .header h1 { font-size: 2.5rem; margin: 0 0 10px 0; color: #1a1a1a; }
        .header p { color: var(--text-sub); }

        /* Tab æŒ‰éˆ• (ç´…è‰²ç¶“å…¸æ¬¾) */
        .tab-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
        .tab-btn { 
            padding: 12px 40px; border-radius: 50px; border: 2px solid var(--primary); background: transparent; 
            color: var(--primary); font-weight: 800; cursor: pointer; transition: 0.3s; font-size: 1rem;
        }
        .tab-btn:hover { background: #fff5f5; transform: translateY(-2px); }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3); transform: translateY(-2px); }

        /* âœ… å¾©å¤æ¨£å¼ä¸Šå‚³å€ (ç„¡ Panel èƒŒæ™¯) */
        .work-area { display: none; animation: fadeUp 0.5s ease; }
        .work-area.active { display: block; }

        .drop-zone { 
            border: 4px dashed #ccc; border-radius: 20px; padding: 80px 20px; text-align: center; 
            cursor: pointer; transition: 0.3s; background: transparent; margin-bottom: 30px;
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--primary); background: rgba(231, 76, 60, 0.03); transform: scale(1.01); }
        .drop-zone h3 { font-size: 1.5rem; color: #555; margin: 10px 0; }
        
        /* Grid èˆ‡ å¡ç‰‡ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px; text-align: left; }
        .card { 
            background: white; border: 1px solid #eee; padding: 10px; border-radius: 12px; position: relative; 
            transition: 0.2s; cursor: grab; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: var(--accent); }
        .card.selected { border: 2px solid var(--success); background: #f0fff4; }
        
        .cv-wrap { height: 220px; display: flex; align-items: center; justify-content: center; background: #f9f9f9; border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
        canvas { max-width: 100%; max-height: 100%; transition: transform 0.3s; }
        
        /* å·¥å…·åˆ— */
        .tools { display: flex; gap: 5px; justify-content: center; }
        .tool-btn { 
            flex: 1; padding: 6px; border: 1px solid #eee; background: white; color: #555; border-radius: 6px; 
            cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: 0.2s; z-index: 10;
        }
        .tool-btn:hover { background: #f0f0f0; color: black; }
        .tool-btn.danger { color: var(--primary); }
        .tool-btn.danger:hover { background: var(--primary); color: white; }

        .btn-main { padding: 16px 60px; border-radius: 50px; border: none; background: var(--primary); color: white; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.3s; margin-top: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .btn-main:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4); }
        .btn-main:disabled { background: #ccc; cursor: wait; transform: none; }
        .btn-text { background: none; border: none; color: #999; text-decoration: underline; cursor: pointer; margin-top: 15px; display: block; width: 100%; }

        /* ä¸‰æ–¹æ¡† */
        .feature-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-top: 80px; }
        .anim-card {
            background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border-top: 5px solid transparent; transition: all 0.3s; cursor: default; text-align: left;
        }
        .anim-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .anim-card.red { border-top-color: var(--primary); }
        .anim-card.green { border-top-color: var(--success); }
        .anim-card.blue { border-top-color: var(--accent); }
        .anim-card h3 { margin-top: 0; color: #333; font-size: 1.2rem; }
        .anim-card p { color: #666; font-size: 0.9rem; margin: 0; }

        /* âœ… Q&A æ•´åˆå€å¡Š */
        .qa-box { max-width: 800px; margin: 80px auto; text-align: left; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .qa-box h2 { text-align: center; color: var(--primary); margin-bottom: 30px; font-weight: 800; }
        .qa-group { margin-bottom: 25px; border-bottom: 1px solid #f0f0f0; padding-bottom: 20px; }
        .qa-group:last-child { border-bottom: none; }
        .qa-group h4 { margin: 0 0 10px 0; color: var(--accent); font-size: 1.1rem; }
        .qa-group p { margin: 0; color: #555; font-size: 0.95rem; }

        /* âœ… ç‰ˆæœ¬æ­·å² Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-width: 600px; max-height: 80vh; border-radius: 20px; padding: 30px; overflow-y: auto; text-align: left; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popIn 0.3s; }
        .history-item { margin-bottom: 20px; padding-left: 15px; border-left: 3px solid #eee; }
        .history-ver { font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        .history-date { color: #999; font-size: 0.8rem; margin-bottom: 5px; }
        .history-desc { color: #555; font-size: 0.9rem; margin: 0; }
        .close-modal { float: right; cursor: pointer; font-size: 1.5rem; line-height: 1; color: #999; }

        /* å…ƒä»¶ */
        #progress-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 999; display: none; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.2s; }
        .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @media (max-width: 768px) { .feature-grid { grid-template-columns: 1fr; } }
        footer { margin: 100px 0 40px; color: #ccc; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>

<div id="progress-wrap"><div id="progress-bar"></div></div>

<div id="history-modal" class="modal-overlay" onclick="if(event.target === this) App.ui.toggleHistory(false)">
    <div class="modal-content">
        <span class="close-modal" onclick="App.ui.toggleHistory(false)">Ã—</span>
        <h2 style="margin-top:0; color:var(--text-main);">é–‹ç™¼æ—¥èªŒ (Changelog)</h2>
        <div id="history-list"></div>
    </div>
</div>

<nav>
    <a href="#" class="logo">DTZ PDF</a>
    <div class="version-btn" onclick="App.ui.toggleHistory(true)">v30.0 Anniversary</div>
</nav>

<div class="container">
    <div class="header">
        <h1>å°ˆæ¥­ PDF è™•ç†ä¸­æ¨</h1>
        <p>ç«¯é»é‹ç®— â€¢ æ¥µè‡´éš±ç§ â€¢ å¹¾ä½•æ ¡æ­£</p>
    </div>

    <div class="tab-group">
        <button class="tab-btn active" onclick="App.ui.switchTab('merge')">åˆä½µèˆ‡æ’åº</button>
        <button class="tab-btn" onclick="App.ui.switchTab('split')">åˆ†å‰²èˆ‡æå–</button>
    </div>

    <div id="area-merge" class="work-area active">
        <div class="drop-zone" id="drop-merge">
            <div style="font-size:3rem; margin-bottom:15px; opacity:0.6;">ğŸ“‚</div>
            <h3>é»æ“Š æˆ– æ‹–æ”¾æª”æ¡ˆè‡³æ­¤</h3>
            <p style="color:#999; margin-top:10px;">æ”¯æ´ PDF / JPG / PNG (å¯è‡ªç”±æ‹–æ›³æ’åº)</p>
            <input type="file" id="input-merge" multiple accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
        </div>
        <div id="grid-merge" class="grid"></div>
        <div id="ctrl-merge" style="display:none;">
            <button class="btn-main" onclick="App.core.process('merge')">åˆä½µä¸¦ä¸‹è¼‰ PDF</button>
            <button class="btn-text" onclick="App.state.reset()">æ¸…ç©ºæ‰€æœ‰æª”æ¡ˆ</button>
        </div>
    </div>

    <div id="area-split" class="work-area">
        <div class="drop-zone" id="drop-split">
            <div style="font-size:3rem; margin-bottom:15px; opacity:0.6;">âœ‚ï¸</div>
            <h3>é»æ“Š æˆ– æ‹–æ”¾å–®ä»½ PDF</h3>
            <p style="color:#999; margin-top:10px;">è§£æå¾Œå¯æ’åºã€æ—‹è½‰ã€é¸å–æå–</p>
            <input type="file" id="input-split" accept=".pdf" style="display:none;">
        </div>
        <div id="grid-split" class="grid"></div>
        <div id="ctrl-split" style="display:none;">
            <button class="btn-main" style="background:var(--accent);" onclick="App.core.process('split')">æå–é¸ä¸­é é¢ (ZIP)</button>
            <button class="btn-text" onclick="App.state.reset()">æ¸…ç©ºæ‰€æœ‰æª”æ¡ˆ</button>
        </div>
    </div>

    <div class="feature-grid">
        <div class="anim-card red">
            <h3>ğŸ›¡ï¸ ç«¯é»åŠ å¯†é‹ç®—</h3>
            <p>æ”¾æ£„é›²ç«¯ä¸Šå‚³ï¼Œæ“æŠ±çµ•å°éš±ç§ã€‚æ‰€æœ‰æª”æ¡ˆè™•ç†çš†åœ¨æ‚¨çš„ç€è¦½å™¨è¨˜æ†¶é«”ä¸­å®Œæˆã€‚</p>
        </div>
        <div class="anim-card green">
            <h3>ğŸš€ å¹¾ä½•ç‰©ç†å¼•æ“</h3>
            <p>å…§å»ºåæ¨™è½‰æ›ç³»çµ±ã€‚ç•¶æ‚¨æ—‹è½‰åœ–ç‰‡æ™‚ï¼ŒPDF é é¢æœƒè‡ªå‹•é©æ‡‰å¯¬é«˜ï¼Œç¢ºä¿å…§å®¹ä¸è£åˆ‡ã€‚</p>
        </div>
        <div class="anim-card blue">
            <h3>âš¡ åˆ†æ®µå‘¼å¸æ¸²æŸ“</h3>
            <p>é‡å°å¤§æª”æ¡ˆå„ªåŒ–çš„éåŒæ­¥è™•ç†æŠ€è¡“ï¼Œå³ä½¿è¼‰å…¥æ•¸ç™¾é çš„åˆç´„ï¼Œä¹Ÿèƒ½ä¿æŒä»‹é¢æµæš¢ã€‚</p>
        </div>
    </div>

    <div class="qa-box">
        <h2>å¸¸è¦‹å•é¡ŒæŒ‡å—</h2>
        <div class="qa-group">
            <h4>ğŸ“± iOS ç„¡æ³•ä¸‹è¼‰æª”æ¡ˆï¼Ÿ</h4>
            <p>iPhone Safari å®‰å…¨æ€§è¼ƒé«˜ã€‚åˆä½µå®Œæˆå¾Œè‹¥è·³å‡ºæ–°åˆ†é ï¼Œè«‹é»æ“Šåº•éƒ¨çš„ã€Œåˆ†äº«ã€åœ–ç¤ºï¼Œä¸¦é¸æ“‡ã€Œå„²å­˜åˆ°æª”æ¡ˆã€å³å¯ã€‚</p>
        </div>
        <div class="qa-group">
            <h4>âœ‚ï¸ åˆ†å‰²æ¨¡å¼èƒ½åšä»€éº¼ï¼Ÿ</h4>
            <p>v30.0 ç‰ˆæœ¬å·²å…¨æ¬Šé™è§£é–ã€‚æ‚¨å¯ä»¥å°å–®ä¸€é é¢é€²è¡Œ<b>æ—‹è½‰</b>ã€<b>åˆªé™¤</b>ï¼Œç”šè‡³<b>æ‹–æ›³æ’åº</b>ã€‚æå–å¾Œçš„ ZIP æœƒä¾ç…§æ–°é †åºç·¨è™Ÿã€‚</p>
        </div>
        <div class="qa-group">
            <h4>ğŸ–¼ï¸ åœ–ç‰‡æœƒè¢«å£“ç¸®å—ï¼Ÿ</h4>
            <p>æˆ‘å€‘æœƒè‡ªå‹•å„ªåŒ–åœ–ç‰‡å°ºå¯¸ä»¥é˜²æ­¢è¨˜æ†¶é«”æº¢å‡ºï¼Œä½†ä»æœƒä¿æŒ 300DPI çš„åˆ—å°ç´šæ¸…æ™°åº¦ï¼Œè«‹æ”¾å¿ƒä½¿ç”¨ã€‚</p>
        </div>
    </div>
</div>

<footer>&copy; 2026 DTZ PDF ENGINE | Anniversary Edition</footer>

<script>
const App = {
    state: { mode: 'merge', pages: [], buffers: {}, sortable: null },
    
    // é–‹ç™¼æ­·å²æ•¸æ“š
    history: [
        { ver: "v30.0 Anniversary", date: "2026/01/24", desc: "å›æ­¸ç¶“å…¸ UI è¨­è¨ˆï¼›æ•´åˆ Q&A å€å¡Šï¼›æ–°å¢ç‰ˆæœ¬æ­·å²æ™‚å…‰æ©Ÿï¼›ä¿®å¾©å…¨æ¨¡å¼æ—‹è½‰æ¬Šé™ã€‚" },
        { ver: "v29.5 Final Perfect", date: "2026/01/24", desc: "å„ªåŒ–ç´…è‰²æŒ‰éˆ•ç¾è¡“é¢¨æ ¼ï¼›ç§»é™¤åˆ‡æ›æ™‚çš„å¹²æ“¾æç¤ºï¼›è¦–è¦ºå¾®èª¿ã€‚" },
        { ver: "v28.5 Full Edit", date: "2026/01/24", desc: "è§£é–åˆ†å‰²æ¨¡å¼æ¬Šé™ï¼šæ”¯æ´æ‹–æ›³æ’åºã€å–®é åˆªé™¤ã€æ—‹è½‰ï¼›ZIP æª”åä¾åºç·¨è™Ÿã€‚" },
        { ver: "v28.0 SaaS Foundation", date: "2026/01/24", desc: "åº•å±¤æ¶æ§‹é‡æ§‹ (Namespace)ï¼›å¼•å…¥ Toast é€šçŸ¥ç³»çµ±ï¼›è¨˜æ†¶é«”ä¸»å‹•å›æ”¶æ©Ÿåˆ¶ã€‚" },
        { ver: "v27.0 Complete", date: "2026/01/24", desc: "å¯¦ä½œå…¨å±€æ‹–æ”¾ (Drag & Drop)ï¼›SortableJS å°å…¥ï¼›è¨˜æ†¶é«”ä¿è­· (Image Downscaling)ã€‚" },
        { ver: "v26.0 Physics Engine", date: "2026/01/24", desc: "å¹¾ä½•ç‰©ç†æ—‹è½‰æ ¡æ­£ (å¯¬é«˜äº’æ›)ï¼›PDF.js æ•ˆèƒ½å„ªåŒ– (Single Pass)ã€‚" },
        { ver: "v24.0 Stable Core", date: "2026/01/23", desc: "é‡å° iOS Safari ä¸‹è¼‰æ©‹æ¥å„ªåŒ–ï¼›ç§»é™¤ä¸ç©©å®šåŠŸèƒ½å›æ­¸æ ¸å¿ƒã€‚" },
        { ver: "v1.0 - v20.0", date: "2026/01", desc: "å°ˆæ¡ˆå•Ÿå‹•ï¼›ç¸®åœ–æ¸²æŸ“ï¼›åŸºç¤åˆä½µåŠŸèƒ½å¯¦ä½œï¼›Undo ç³»çµ±å˜—è©¦ã€‚" }
    ],

    ui: {
        switchTab(mode) {
            App.state.mode = mode; App.state.pages = []; App.state.buffers = {};
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.work-area').forEach(p => p.classList.remove('active'));
            const targetBtn = event ? event.target : document.querySelector(`button[onclick*="'${mode}'"]`);
            if(targetBtn) targetBtn.classList.add('active');
            document.getElementById(`area-${mode}`).classList.add('active');
            
            document.getElementById('grid-merge').innerHTML = '';
            document.getElementById('grid-split').innerHTML = '';
            document.getElementById('ctrl-merge').style.display = 'none';
            document.getElementById('ctrl-split').style.display = 'none';
        },
        showProgress(p) {
            const bar = document.getElementById('progress-bar');
            const wrap = document.getElementById('progress-wrap');
            wrap.style.display = 'block'; bar.style.width = p + '%';
            if (p >= 100) setTimeout(() => { wrap.style.display = 'none'; bar.style.width = '0%'; }, 500);
        },
        createCard(pageObj, canvas, label) {
            const div = document.createElement('div');
            div.className = 'card'; div.id = pageObj.id;
            // âœ… ç¢ºä¿æ‰€æœ‰æ¨¡å¼éƒ½æœ‰å®Œæ•´å·¥å…·åˆ—
            const tools = `
                <div class="tools" style="margin-top:10px;">
                    <button class="tool-btn" onclick="event.stopPropagation(); App.core.rotate('${pageObj.id}')">â†º</button>
                    <button class="tool-btn danger" onclick="event.stopPropagation(); App.core.remove('${pageObj.id}')">âœ•</button>
                </div>`;
            div.innerHTML = `<div class="cv-wrap"></div><div style="font-size:0.8rem; text-align:center; color:#666;">${label}</div>${tools}`;
            div.querySelector('.cv-wrap').appendChild(canvas);
            
            if (App.state.mode === 'split') {
                div.onclick = (e) => {
                    // é˜²æ­¢æŒ‰éˆ•å†’æ³¡è§¸ç™¼é¸å–
                    if(e.target.tagName === 'BUTTON') return;
                    const p = App.state.pages.find(x => x.id === pageObj.id);
                    if (p) { p.selected = !p.selected; div.classList.toggle('selected'); }
                };
            }
            document.getElementById(`grid-${App.state.mode}`).appendChild(div);
        },
        toggleHistory(show) {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            if(show) {
                list.innerHTML = App.history.map(h => `
                    <div class="history-item">
                        <div class="history-ver">${h.ver} <span style="font-weight:400; color:#999; font-size:0.8rem;">${h.date}</span></div>
                        <p class="history-desc">${h.desc}</p>
                    </div>
                `).join('');
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }
    },
    core: {
        async init() {
            const { pdfjsLib } = window;
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
            ['merge', 'split'].forEach(m => {
                const drop = document.getElementById(`drop-${m}`);
                const input = document.getElementById(`input-${m}`);
                drop.onclick = () => input.click();
                input.onchange = (e) => this.handleFiles(e.target.files);
                drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
                drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
                drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('dragover'); this.handleFiles(e.dataTransfer.files); });
            });
        },
        async handleFiles(files) {
            if (files.length === 0) return;
            App.ui.showProgress(10);
            try {
                for (const file of Array.from(files)) {
                    if (App.state.mode === 'split' && !file.type.includes('pdf')) { alert("åˆ†å‰²æ¨¡å¼åƒ…æ”¯æ´ PDF"); continue; }
                    const fileId = crypto.randomUUID();
                    const buffer = await file.arrayBuffer();
                    App.state.buffers[fileId] = buffer;
                    if (file.type === 'application/pdf') {
                        const pdfDoc = await pdfjsLib.getDocument({ data: buffer.slice(0) }).promise;
                        for (let i = 1; i <= pdfDoc.numPages; i++) {
                            const pId = crypto.randomUUID();
                            App.state.pages.push({ id: pId, fileId, pIdx: i-1, rot: 0, selected: false, type: 'pdf', name: file.name });
                            await this.renderPage(pdfDoc, i, pId);
                            if (i % 5 === 0) await new Promise(r => setTimeout(r, 0));
                        }
                    } else if (file.type.startsWith('image/') && App.state.mode === 'merge') {
                        const pId = crypto.randomUUID();
                        App.state.pages.push({ id: pId, fileId, pIdx: 0, rot: 0, selected: false, type: 'img', name: file.name });
                        await this.renderImage(file, pId);
                    }
                }
                document.getElementById(`ctrl-${App.state.mode}`).style.display = 'block';
                this.initSortable();
            } catch (e) { console.error(e); alert("è§£æå¤±æ•—"); }
            App.ui.showProgress(100);
        },
        async renderPage(pdfDoc, num, id) {
            const page = await pdfDoc.getPage(num);
            const vp = page.getViewport({ scale: 0.3 });
            const cv = document.createElement('canvas');
            cv.width = vp.width; cv.height = vp.height;
            await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
            App.ui.createCard(App.state.pages.find(p => p.id === id), cv, `P${num}`);
        },
        async renderImage(file, id) {
            const img = new Image(); img.src = URL.createObjectURL(file);
            await new Promise(r => img.onload = r);
            const maxW = 300; const sc = maxW / img.width;
            const cv = document.createElement('canvas');
            cv.width = maxW; cv.height = img.height * sc;
            cv.getContext('2d').drawImage(img, 0, 0, cv.width, cv.height);
            App.ui.createCard(App.state.pages.find(p => p.id === id), cv, 'IMG');
            URL.revokeObjectURL(img.src);
        },
        rotate(id) {
            const p = App.state.pages.find(x => x.id === id);
            if (p) { p.rot = (p.rot + 90) % 360; const cv = document.querySelector(`#${id} canvas`); if(cv) cv.className = `rot-${p.rot}`; }
        },
        remove(id) {
            App.state.pages = App.state.pages.filter(x => x.id !== id);
            document.getElementById(id).remove();
            // å¦‚æœæ¸…ç©ºäº†ï¼Œéš±è—æŒ‰éˆ•
            if (App.state.pages.length === 0) document.getElementById(`ctrl-${App.state.mode}`).style.display = 'none';
        },
        initSortable() {
            const el = document.getElementById(`grid-${App.state.mode}`);
            if (App.state.sortable) App.state.sortable.destroy();
            App.state.sortable = new Sortable(el, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: () => {
                    const ids = Array.from(el.children).map(c => c.id);
                    App.state.pages = ids.map(id => App.state.pages.find(p => p.id === id)).filter(Boolean);
                }
            });
        },
        async process(mode) {
            const targets = mode === 'split' ? App.state.pages.filter(p => p.selected) : App.state.pages;
            if (targets.length === 0) return alert(mode === 'split' ? "è«‹å…ˆé»é¸é é¢" : "ç„¡æª”æ¡ˆå¯è™•ç†");
            App.ui.showProgress(20);
            const { PDFDocument, degrees } = PDFLib;
            try {
                if (mode === 'merge') {
                    const doc = await PDFDocument.create();
                    for (const p of targets) { await this.addToDoc(doc, p); }
                    this.download(await doc.save(), `Merged_${Date.now()}.pdf`, 'application/pdf');
                } else {
                    const zip = new JSZip();
                    let count = 0;
                    for (const p of targets) {
                        const doc = await PDFDocument.create();
                        await this.addToDoc(doc, p);
                        const safeName = (p.name || "doc").replace(/\.pdf$/i, "");
                        zip.file(`${String(++count).padStart(2,'0')}_${safeName}.pdf`, await doc.save());
                    }
                    this.download(await zip.generateAsync({type:'blob'}), `Split_${Date.now()}.zip`, 'application/zip');
                }
            } catch (e) { console.error(e); alert("è™•ç†å¤±æ•—"); }
            App.ui.showProgress(100);
        },
        async addToDoc(targetDoc, p) {
            const { PDFDocument, degrees } = PDFLib;
            const buffer = App.state.buffers[p.fileId];
            if (p.type === 'pdf') {
                const src = await PDFDocument.load(buffer);
                const [page] = await targetDoc.copyPages(src, [p.pIdx]);
                page.setRotation(degrees(p.rot + (page.getRotation().angle || 0)));
                targetDoc.addPage(page);
            } else {
                const img = p.name.toLowerCase().endsWith('png') ? await targetDoc.embedPng(buffer) : await targetDoc.embedJpg(buffer);
                const isRotated = p.rot === 90 || p.rot === 270;
                const dims = isRotated ? { w: img.height, h: img.width } : { w: img.width, h: img.height };
                const page = targetDoc.addPage([dims.w, dims.h]);
                let x = 0, y = 0;
                if (p.rot === 90) x = img.height;
                else if (p.rot === 180) { x = img.width; y = img.height; }
                else if (p.rot === 270) y = img.width;
                page.drawImage(img, { x, y, width: img.width, height: img.height, rotate: degrees(p.rot) });
            }
        },
        download(data, name, type) {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) { window.open(url, '_blank'); } 
            else {
                const a = document.createElement('a'); a.href = url; a.download = name;
                document.body.appendChild(a); a.click(); a.remove();
            }
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        }
    }
};
App.core.init();
</script>
</body>
</html>
