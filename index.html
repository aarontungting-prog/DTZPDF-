<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>DTZ PDF v18.0 - çµ‚æ¥µç§©åºç©©å¥ç‰ˆ</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db; --bg-color: #f4f7f6;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg-color); color: #2d3436; }
        nav { background: white; padding: 1rem 8%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.6rem; font-weight: bold; color: var(--primary-red); text-decoration: none; }
        
        /* âœ… ä¿®æ­£ 1: é€²åº¦æ¢å‹•ç•«å„ªåŒ– */
        #loader-bar { position: fixed; top: 0; left: 0; width: 0%; height: 5px; background: var(--primary-green); z-index: 2001; transition: width 0.3s ease, opacity 0.3s ease; }

        /* âœ… ä¿®æ­£ 2: æ—‹è½‰å‹•ç•«èˆ‡ Origin ä¿®æ­£ */
        .rot-90  { transform: rotate(90deg); }
        .rot-180 { transform: rotate(180deg); }
        .rot-270 { transform: rotate(270deg); }
        .rot-0   { transform: rotate(0deg); }
        canvas { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: center center; }

        #side-toggle { position: fixed; left: 0; top: 50%; transform: translateY(-50%); background: var(--primary-red); color: white; padding: 15px 8px; border-radius: 0 10px 10px 0; cursor: pointer; z-index: 2000; writing-mode: vertical-lr; font-size: 12px; }
        .sidebar { position: fixed; left: -260px; top: 80px; width: 220px; height: calc(100vh - 120px); background: white; padding: 20px; box-shadow: 5px 0 20px rgba(0,0,0,0.1); transition: 0.4s; z-index: 1500; overflow-y: auto; border-radius: 0 20px 20px 0; }
        .sidebar.open { left: 0; }
        
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; text-align: center; }
        .work-panel { background: white; padding: 40px; border-radius: 24px; box-shadow: var(--card-shadow); min-height: 500px; display: none; }
        .work-panel.active { display: block; animation: fadeIn 0.4s; }
        .tab-btn { padding: 10px 22px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: bold; cursor: pointer; margin: 5px; transition: 0.2s; }
        .tab-btn.active { background: var(--primary-red); color: white; }
        
        .upload-area { border: 3px dashed #cbd5e0; border-radius: 20px; padding: 50px; cursor: pointer; background: #fff; transition: 0.3s; }
        .upload-area.dragover { border-color: var(--primary-red); background: #fffaf9; }
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 30px; }
        .page-card { background: #fff; border: 2px solid #eee; padding: 10px; border-radius: 15px; position: relative; cursor: grab; }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
        .hidden-search { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        footer { margin: 80px 0 40px; color: #b2bec3; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>

<div id="loader-bar"></div>
<div id="side-toggle">ğŸ“„ é é¢å°èˆª</div>

<aside class="sidebar">
    <h3 style="color:var(--primary-red)">ğŸ” æœå°‹ç¯©é¸</h3>
    <input type="text" id="search-input" placeholder="é—œéµå­—..." onkeyup="searchPDF()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px;">
    <div id="side-grid"></div>
</aside>

<nav>
    <a href="#" class="logo">DTZ PDF <span style="font-size:0.7rem; background:var(--primary-red); color:white; padding:2px 8px; border-radius:4px;">v18.0</span></a>
    <div style="font-size: 0.85rem; color: #2ecc71; font-weight: bold;">â— çµ‚æ¥µç§©åºç©©å¥ç‰ˆ</div>
</nav>

<div class="container">
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab(event, 'main')">æ•´ç†èˆ‡åˆ†å‰²</button>
        <button class="tab-btn" onclick="switchTab(event, 'adv')">é«˜ç´šå·¥å…·</button>
        <button class="tab-btn" onclick="switchTab(event, 'safe')">å±¬æ€§èˆ‡å®‰å…¨</button>
    </div>

    <div id="main-panel" class="work-panel active">
        <div class="upload-area" id="drop-zone">
            <div style="font-size:50px;">ğŸ“‚</div>
            <h3>é»æ“Šæˆ–ã€Œæ‹–æ”¾ã€ä¸Šå‚³</h3>
            <input type="file" id="input-org" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
        </div>
        <div id="org-grid" class="page-grid"></div>
        <div id="org-ctrl" style="display:none; margin-top:30px;">
            <button class="tab-btn" style="background:#f39c12; color:#fff; border:none;" onclick="rotateAll90()">å…¨éƒ¨å³è½‰ 90Â°</button>
            <button class="tab-btn" style="background:#95a5a6; color:#fff; border:none;" onclick="location.reload()">å…¨éƒ¨æ¸…ç©º</button>
            <button class="tab-btn" style="background:var(--primary-green); color:#fff; border:none; padding:12px 35px;" onclick="processPdf('merge')">åˆä½µå–®ä»½ PDF</button>
            <button class="tab-btn" style="background:var(--primary-blue); color:#fff; border:none; padding:12px 35px;" onclick="processPdf('split')">æå–æ‰€é¸ (ZIP)</button>
        </div>
    </div>

    <div id="adv-panel" class="work-panel">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; text-align:left;">
            <div style="background:#f8f9fa; padding:20px; border-radius:15px;">
                <h4>ğŸ›¡ï¸ å…¨å±€æµ®æ°´å°</h4>
                <input type="text" id="wm-text" placeholder="æµ®æ°´å°å…§å®¹" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;">
                <div style="font-size:0.8rem;">é€æ˜åº¦: <input type="range" id="wm-op" min="0.1" max="1.0" step="0.1" value="0.3"></div>
            </div>
            <div style="background:#f8f9fa; padding:20px; border-radius:15px;">
                <h4>ğŸ–¼ï¸ é«˜æ¸…å°å‡º</h4>
                <p style="font-size:0.8rem;">é¸å–é é¢å¾Œï¼Œå°‡å…¶ä»¥é«˜å“è³ªé‡æ–°æ¸²æŸ“ç‚ºåœ–ç‰‡ã€‚</p>
                <button class="tab-btn" style="background:var(--primary-blue); color:#fff; width:100%; margin:0;" onclick="exportAsImage()">åŒ¯å‡ºé¸ä¸­é ç‚ºåœ–ç‰‡</button>
            </div>
        </div>
        <hr style="margin:30px 0; border:0; border-top:1px solid #eee;">
        <h3>âœ’ï¸ æ‰‹å¯«ç°½åæ¿</h3>
        <canvas id="sig-canvas" width="800" height="400" style="border:2px solid #333; background:#fff; touch-action:none; width:400px; height:200px; border-radius:10px;"></canvas><br>
        <button class="tab-btn" onclick="clearSig()">æ¸…é™¤</button>
        <button class="tab-btn" style="background:var(--primary-blue); color:#fff; border:none;" onclick="saveSig()">å„²å­˜ç°½å</button>
    </div>

    <div id="safe-panel" class="work-panel">
        <div style="max-width:500px; margin:0 auto; text-align:left;">
            <h3>ğŸ“ æª”æ¡ˆå±¬æ€§</h3>
            <input type="text" id="m-title" class="tab-btn" style="width:100%; border-radius:8px;" placeholder="æ–‡ä»¶æ¨™é¡Œ">
            <input type="text" id="m-author" class="tab-btn" style="width:100%; border-radius:8px;" placeholder="ä½œè€…å§“å">
            <hr>
            <h3>ğŸ”’ å®‰å…¨æ¬Šé™</h3>
            <label>é–‹å•Ÿå¯†ç¢¼:</label><input type="password" id="p-u" class="tab-btn" style="width:100%; border-radius:8px;" placeholder="ä¸è¨­å‰‡ç•™ç™½">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; font-size:0.85rem;">
                <label><input type="checkbox" id="can-print" checked> å…è¨±åˆ—å°</label>
                <label><input type="checkbox" id="can-copy" checked> å…è¨±è¤‡è£½</label>
            </div>
        </div>
    </div>
</div>

<footer>&copy; 2026 DTZ PDF ULTIMATE | å°ˆæ¥­ç©©å¥å·¥ä½œç«™</footer>

<script>
    const { PDFDocument, degrees, rgb, StandardFonts } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pagesData = []; let fileBuffers = {}; let pdfCache = {}; let sigImage = null; let sigTargetId = null;

    function download(data, filename, type) {
        const blob = data instanceof Blob ? data : new Blob([data], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 2000);
    }

    const dropZone = document.getElementById('drop-zone');
    dropZone.onclick = () => document.getElementById('input-org').click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if(e.dataTransfer.files.length) handleFiles(e.dataTransfer.files); };
    document.getElementById('input-org').onchange = (e) => handleFiles(e.target.files);

    async function handleFiles(files) {
        updateProgress(10);
        for (const file of Array.from(files)) {
            const fId = crypto.randomUUID();
            const buf = await file.arrayBuffer();
            fileBuffers[fId] = buf;
            if (file.name.toLowerCase().endsWith('.pdf')) {
                const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const pId = crypto.randomUUID();
                    const page = await pdf.getPage(i);
                    const txt = (await page.getTextContent()).items.map(s => s.str).join(' ');
                    pagesData.push({ fId, pIdx: i-1, rot: 0, pId, type: 'pdf', selected: false, text: txt });
                    await renderThumb(page, pId, i);
                }
            } else {
                const pId = crypto.randomUUID();
                pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false, text:'' });
                renderImgThumb(file, pId);
            }
        }
        document.getElementById('org-ctrl').style.display = 'block';
        updateProgress(0);
    }

    async function renderThumb(page, pId, pNum) {
        const vp = page.getViewport({ scale: 0.3 });
        const cv = document.createElement('canvas');
        cv.width = vp.width; cv.height = vp.height;
        await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
        createCard(cv, pId, `P${pNum}`);
    }

    function renderImgThumb(file, pId) {
        const url = URL.createObjectURL(file);
        const img = new Image(); img.src = url;
        img.onload = () => {
            const cv = document.createElement('canvas'); cv.width = 150; cv.height = 200;
            cv.getContext('2d').drawImage(img, 0, 0, 150, 200);
            createCard(cv, pId, 'åœ–');
            URL.revokeObjectURL(url);
        };
    }

    function createCard(cv, pId, label) {
        const card = document.createElement('div'); card.className = 'page-card'; card.id = pId;
        card.innerHTML = `<div style="position:absolute;top:5px;left:5px;background:rgba(0,0,0,0.6);color:white;font-size:10px;padding:2px 5px;border-radius:4px;">${label}</div><div class="cv-wrap"></div><div style="margin-top:8px;display:flex;justify-content:center;gap:5px;"><button class="tab-btn" style="font-size:10px;padding:5px 10px;" onclick="event.stopPropagation(); rotateP('${pId}')">æ—‹è½‰</button><button class="tab-btn" style="font-size:10px;padding:5px 10px;" onclick="event.stopPropagation(); delP('${pId}')">åˆªé™¤</button></div>`;
        card.querySelector('.cv-wrap').appendChild(cv);
        card.onclick = () => {
            const p = pagesData.find(x => x.pId === pId); p.selected = !p.selected; card.classList.toggle('selected');
            sigTargetId = pId;
        };
        document.getElementById('org-grid').appendChild(card);
        const scv = document.createElement('canvas'); scv.id = 'side-'+pId; scv.width = cv.width; scv.height = cv.height; scv.style.width = '100%'; scv.style.marginBottom = '10px'; scv.getContext('2d').drawImage(cv, 0, 0);
        scv.onclick = () => document.getElementById(pId).scrollIntoView({behavior:'smooth'});
        document.getElementById('side-grid').appendChild(scv);
    }

    // --- âœ… ä¿®æ­£ 1 & 3: åˆä½µé‚è¼¯èˆ‡ Split æ¨¡å¼å¼·åŒ– ---
    async function processPdf(mode) {
        updateProgress(10);
        const zip = mode === 'split' ? new JSZip() : null;
        try {
            const mainDoc = mode === 'merge' ? await PDFDocument.create() : null;
            let mainFont = null;
            if (mainDoc) {
                mainFont = await mainDoc.embedFont(StandardFonts.HelveticaBold);
                mainDoc.setTitle(document.getElementById('m-title').value || "DTZ Merged");
                mainDoc.setAuthor(document.getElementById('m-author').value || "DTZ PRO");
            }

            const list = mode === 'split' ? pagesData.filter(p => p.selected) : pagesData;
            if(!list.length) return alert('æ¸…å–®ç‚ºç©º');

            for (let i = 0; i < list.length; i++) {
                const p = list[i];
                let curDoc = mode === 'merge' ? mainDoc : await PDFDocument.create();
                const curFont = mode === 'merge' ? mainFont : await curDoc.embedFont(StandardFonts.HelveticaBold);
                
                if (mode === 'split') {
                    curDoc.setTitle(document.getElementById('m-title').value || `Page ${i+1}`);
                    curDoc.setAuthor(document.getElementById('m-author').value || "DTZ PRO");
                }

                let newPage;
                if (p.type === 'pdf') {
                    if (!pdfCache[p.fId]) pdfCache[p.fId] = await PDFDocument.load(fileBuffers[p.fId]);
                    const [copy] = await curDoc.copyPages(pdfCache[p.fId], [p.pIdx]);
                    // âœ… ä¿®æ­£: ä½¿ç”¨ % 360 ç¢ºä¿è§’åº¦æ­£ç¢º
                    copy.setRotation(degrees((p.rot + (copy.getRotation().angle || 0)) % 360));
                    newPage = curDoc.addPage(copy);
                } else {
                    const img = await curDoc.embedPng(await p.file.arrayBuffer());
                    newPage = curDoc.addPage([img.width, img.height]);
                    newPage.drawImage(img, { x:0, y:0, width:img.width, height:img.height, rotate:degrees(p.rot) });
                }

                // å¥—ç”¨æµ®æ°´å° (å°é¸ä¸­æˆ–å…¨éƒ¨)
                const wm = document.getElementById('wm-text').value;
                if(wm) {
                    newPage.drawText(wm, { x: 50, y: 150, size: 50, font: curFont, color: rgb(0.8, 0.8, 0.8), opacity: parseFloat(document.getElementById('wm-op').value), rotate: degrees(45) });
                }

                if (p.pId === sigTargetId && sigImage) {
                    const sig = await curDoc.embedPng(sigImage);
                    newPage.drawImage(sig, { x: 50, y: 50, width: 120, height: 60 });
                }

                if (mode === 'split') zip.file(`DTZ_Page_${i+1}.pdf`, await curDoc.save());
                updateProgress(10 + (80 * (i/list.length)));
            }

            const saveOpts = { userPassword: document.getElementById('p-u').value || undefined, permissions: { printing: document.getElementById('can-print').checked ? 'highResolution' : 'none', copying: document.getElementById('can-copy').checked } };
            if (mode === 'merge') {
                download(await mainDoc.save(saveOpts), `DTZ_Merged_${Date.now()}.pdf`, 'application/pdf');
            } else {
                download(await zip.generateAsync({type:'blob', compression: "DEFLATE"}), `DTZ_Split_${Date.now()}.zip`, 'application/zip');
            }
        } catch (e) { console.error(e); alert("è™•ç†å¤±æ•—"); }
        updateProgress(0);
    }

    // --- âœ… ä¿®æ­£ 2: åœ–ç‰‡åŒ¯å‡ºå¸¶æ—‹è½‰èˆ‡é«˜å“è³ª ---
    async function exportAsImage() {
        const p = pagesData.find(x => x.pId === sigTargetId);
        if(!p) return alert("è«‹å…ˆé¸å–ä¸€é é é¢");
        updateProgress(50);
        
        const cv = document.createElement('canvas');
        const ctx = cv.getContext('2d');
        
        if (p.type === 'pdf') {
            const pdf = await pdfjsLib.getDocument({ data: fileBuffers[p.fId] }).promise;
            const page = await pdf.getPage(p.pIdx + 1);
            const vp = page.getViewport({ scale: 2.0, rotation: p.rot }); // âœ… PDF.js å…§å»ºæ—‹è½‰æ¸²æŸ“
            cv.width = vp.width; cv.height = vp.height;
            await page.render({ canvasContext: ctx, viewport: vp }).promise;
        } else {
            const img = new Image(); img.src = URL.createObjectURL(p.file);
            await new Promise(r => img.onload = r);
            
            // âœ… ä¿®æ­£: åœ–ç‰‡æ‰‹å‹•åº§æ¨™è®Šæ›æ—‹è½‰
            if (p.rot === 90 || p.rot === 270) { cv.width = img.naturalHeight; cv.height = img.naturalWidth; } 
            else { cv.width = img.naturalWidth; cv.height = img.naturalHeight; }
            
            ctx.translate(cv.width/2, cv.height/2);
            ctx.rotate(p.rot * Math.PI / 180);
            ctx.drawImage(img, -img.naturalWidth/2, -img.naturalHeight/2);
        }
        cv.toBlob(b => { download(b, `DTZ_HD_${Date.now()}.jpg`, 'image/jpeg'); updateProgress(0); }, 'image/jpeg', 0.95);
    }

    // --- âœ… ä¿®æ­£ 4: ä¸€éµæ—‹è½‰æ‰€æœ‰é é¢ ---
    function rotateAll90() {
        pagesData.forEach(p => rotateP(p.pId));
    }

    function rotateP(pId) {
        const p = pagesData.find(x => x.pId === pId); p.rot = (p.rot + 90) % 360;
        
        const updateClasses = (elId) => {
            const el = document.getElementById(elId);
            if(!el) return;
            const cv = el.tagName === 'CANVAS' ? el : el.querySelector('canvas');
            cv.classList.remove('rot-0','rot-90','rot-180','rot-270');
            cv.classList.add(`rot-${p.rot}`);
        };
        updateClasses(p.pId);
        updateClasses('side-'+pId);
    }

    function delP(pId) {
        pagesData = pagesData.filter(x => x.pId !== pId);
        document.getElementById(pId).remove();
        document.getElementById('side-'+pId).remove();
    }

    function searchPDF() {
        const q = document.getElementById('search-input').value.toLowerCase();
        pagesData.forEach(p => {
            const el = document.getElementById(p.pId);
            const side = document.getElementById('side-'+p.pId);
            if(p.type === 'img' || p.text.toLowerCase().includes(q)) { el.classList.remove('hidden-search'); side.style.display = 'block'; }
            else { el.classList.add('hidden-search'); side.style.display = 'none'; }
        });
    }

    const sigCanvas = document.getElementById('sig-canvas'); const sCtx = sigCanvas.getContext('2d'); let drawing = false;
    function getXY(e) { const rect = sigCanvas.getBoundingClientRect(); return { x: ((e.clientX || (e.touches && e.touches[0].clientX)) - rect.left) * (800/rect.width), y: ((e.clientY || (e.touches && e.touches[0].clientY)) - rect.top) * (400/rect.height) }; }
    sigCanvas.onmousedown = sigCanvas.ontouchstart = (e) => { drawing = true; const p = getXY(e); sCtx.beginPath(); sCtx.moveTo(p.x, p.y); e.preventDefault(); };
    sigCanvas.onmousemove = sigCanvas.ontouchmove = (e) => { if(!drawing) return; const p = getXY(e); sCtx.lineTo(p.x, p.y); sCtx.stroke(); };
    window.onmouseup = window.ontouchend = () => drawing = false;
    function clearSig() { sCtx.clearRect(0,0,800,400); }
    function saveSig() { sigImage = sigCanvas.toDataURL(); alert('ç°½åå·²å„²å­˜'); }

    function switchTab(evt, tab) {
        document.querySelectorAll('.work-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tab + '-panel').classList.add('active');
        evt.currentTarget.classList.add('active');
    }
    function updateProgress(v) { 
        const bar = document.getElementById('loader-bar');
        bar.style.width = v + '%'; 
        bar.style.opacity = v === 0 ? '0' : '1';
    }
    document.getElementById('side-toggle').onclick = (e) => { e.stopPropagation(); document.querySelector('.sidebar').classList.toggle('open'); };
    document.addEventListener('click', () => document.querySelector('.sidebar').classList.remove('open'));
    new Sortable(document.getElementById('org-grid'), { animation: 150, onEnd: () => {
        const order = Array.from(document.getElementById('org-grid').children).map(c => c.id);
        pagesData.sort((a,b) => order.indexOf(a.pId) - order.indexOf(b.pId));
        order.forEach(id => document.getElementById('side-grid').appendChild(document.getElementById('side-'+id)));
    }});
</script>
</body>
</html>
