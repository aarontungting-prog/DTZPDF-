<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>DTZ PDF - å°ˆæ¥­ç´š PDF è™•ç†å·¥å…·</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db;
            --bg-color: #f8fafc; --text-dark: #1e293b; --card-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0; background-color: var(--bg-color); color: var(--text-dark); line-height: 1.6;
        }

        /* å°èˆªèˆ‡æ¨™ç±¤åˆ‡æ› */
        nav {
            background: white; padding: 1rem 8%; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary-red); text-decoration: none; letter-spacing: -1px; }
        .engine-badge { font-size: 0.8rem; font-weight: 600; color: #64748b; background: #f1f5f9; padding: 5px 12px; border-radius: 50px; }

        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; text-align: center; }
        
        .tab-wrapper {
            display: inline-flex; background: #e2e8f0; padding: 5px; border-radius: 50px; margin-bottom: 30px;
        }
        .tab-btn {
            padding: 10px 30px; border-radius: 50px; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; background: transparent; color: #64748b;
        }
        .tab-btn.active { background: white; color: var(--primary-red); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* å·¥ä½œé¢æ¿ */
        .panel { display: none; background: white; padding: 40px; border-radius: 24px; box-shadow: var(--card-shadow); border: 1px solid #f1f5f9; min-height: 450px; }
        .panel.active { display: block; animation: fadeIn 0.4s; }

        /* ä¸Šå‚³èˆ‡å¡ç‰‡ */
        .upload-area {
            border: 3px dashed #cbd5e0; border-radius: 20px; padding: 50px 20px; cursor: pointer; transition: 0.3s;
        }
        .upload-area:hover { border-color: var(--primary-red); background-color: #fffaf9; }
        
        .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 30px; }
        .page-card { 
            background: #fff; border: 2px solid #f1f5f9; padding: 10px; border-radius: 12px; position: relative; cursor: pointer; transition: 0.2s; 
        }
        .page-card.selected { border-color: var(--primary-green); background: #f0fff4; transform: scale(1.02); }
        .page-card:hover { border-color: var(--primary-blue); }
        .page-label { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        
        canvas { max-width: 100%; border-radius: 4px; }

        /* æŒ‰éˆ•ç³»çµ± */
        .btn-action { 
            padding: 15px 45px; border-radius: 50px; border: none; font-size: 1.1rem; font-weight: 700; cursor: pointer; color: white; transition: 0.3s; margin: 15px 5px; width: 100%; max-width: 400px;
        }
        .btn-green { background: var(--primary-green); box-shadow: 0 6px 15px rgba(46, 204, 113, 0.2); }
        .btn-blue { background: var(--primary-blue); box-shadow: 0 6px 15px rgba(52, 152, 219, 0.2); }
        .btn-action:disabled { background: #cbd5e0; cursor: wait; box-shadow: none; }

        /* ç¾è¡“ä¸‰æ–¹æ¡†èˆ‡ QA */
        .features { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 60px; text-align: left; }
        .feature-card { background: white; padding: 25px; border-radius: 18px; box-shadow: var(--card-shadow); border-top: 5px solid transparent; }
        .f-red { border-top-color: var(--primary-red); } .f-green { border-top-color: var(--primary-green); } .f-blue { border-top-color: var(--primary-blue); }
        .qa-section { text-align: left; background: white; padding: 40px; border-radius: 24px; margin-top: 60px; box-shadow: var(--card-shadow); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { .features { grid-template-columns: 1fr; } .tab-btn { padding: 10px 15px; font-size: 0.9rem; } }
        footer { margin: 60px 0; color: #94a3b8; font-size: 0.85rem; text-align: center; }
    </style>
</head>
<body>

    <nav>
        <a href="#" class="logo">DTZ PDF</a>
        <div class="engine-badge">ç«¯é»é‹ç®—å¼•æ“ (Edge Computing Engine) | v25.0</div>
    </nav>

    <div class="container">
        <div class="tab-wrapper">
            <button class="tab-btn active" onclick="switchTab('merge')">åˆä½µæ–‡ä»¶</button>
            <button class="tab-btn" onclick="switchTab('split')">åˆ‡å‰²é é¢</button>
        </div>

        <div id="panel-merge" class="panel active">
            <div class="upload-area" onclick="document.getElementById('input-merge').click()">
                <div style="font-size:50px;">ğŸ“‘</div>
                <h3>åˆä½µ PDF èˆ‡åœ–ç‰‡</h3>
                <p style="color:#94a3b8;">å°‡æª”æ¡ˆæ‹–æ”¾åˆ°æ­¤è™•ï¼Œæ”¯æ´è‡ªç”±æ’åº</p>
                <input type="file" id="input-merge" multiple hidden accept=".pdf,.jpg,.jpeg,.png">
            </div>
            <div id="merge-list" class="page-grid"></div>
            <div id="merge-ctrl" style="display:none; margin-top:30px;">
                <button class="btn-action btn-green" id="btn-run-merge" onclick="doMerge()">é–‹å§‹åˆä½µä¸¦ä¸‹è¼‰</button>
            </div>
        </div>

        <div id="panel-split" class="panel">
            <div class="upload-area" onclick="document.getElementById('input-split').click()">
                <div style="font-size:50px;">âœ‚ï¸</div>
                <h3>åˆ‡å‰² PDF é é¢</h3>
                <p style="color:#94a3b8;">ä¸Šå‚³å–®ä»½ PDFï¼Œé»é¸æ¬²æå–çš„é é¢</p>
                <input type="file" id="input-split" hidden accept=".pdf">
            </div>
            <div id="split-grid" class="page-grid"></div>
            <div id="split-ctrl" style="display:none; margin-top:30px;">
                <button class="btn-action btn-blue" id="btn-run-split" onclick="doSplit()">æå–é¸ä¸­é é¢ (ZIP)</button>
                <p style="font-size:0.8rem; color:#94a3b8;">æç¤ºï¼šé»æ“Šåˆ†é ä½¿å…¶å‘ˆç¾ç¶ æ¡†å³å¯æå–</p>
            </div>
        </div>

        <div class="features">
            <div class="feature-card f-red"><h4>ğŸ”’ é›¶ä¼ºæœå™¨</h4><p>æ‰€æœ‰æ–‡ä»¶çš†åœ¨æ‚¨çš„ç€è¦½å™¨å…§è™•ç†ï¼Œè³‡æ–™çµ•ä¸é›¢é–‹æ‚¨çš„è¨­å‚™ã€‚</p></div>
            <div class="feature-card f-green"><h4>âš¡ åˆ†æ®µæ¸²æŸ“</h4><p>æ¡ç”¨ Chunked Rendering æŠ€è¡“ï¼Œè™•ç†å¤§é‡é é¢ä¾ç„¶ä¿æŒç³»çµ±æµæš¢ã€‚</p></div>
            <div class="feature-card f-blue"><h4>ğŸ“± iOS å„ªåŒ–</h4><p>é‡å° Safari ç’°å¢ƒå¯¦ä½œ Blob æ©‹æ¥ï¼Œç¢ºä¿ iPhone ä½¿ç”¨è€…èƒ½é †åˆ©å­˜æª”ã€‚</p></div>
        </div>

        <div class="qa-section">
            <h2 style="color:var(--primary-red); margin-bottom:20px;">æ“ä½œæŒ‡å—</h2>
            <div class="qa-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                <div><h4>å¦‚ä½•é‡æ–°æ’åºï¼Ÿ</h4><p>åœ¨ã€Œåˆä½µæ–‡ä»¶ã€æ¨¡å¼ä¸‹ï¼Œä¸Šå‚³å¾Œå¯ç›´æ¥æŒ‰ä½æª”æ¡ˆå¡ç‰‡é€²è¡Œæ‹–æ›³æ’åºã€‚</p></div>
                <div><h4>å¦‚ä½•é¸å–åˆ‡å‰²é é¢ï¼Ÿ</h4><p>åœ¨ã€Œåˆ‡å‰²é é¢ã€æ¨¡å¼ä¸­ï¼ŒPDF è¼‰å…¥å¾Œé»æ“Šé è¦½åœ–ï¼Œç¶ æ¡†æ¨™ç¤ºçš„é é¢å°‡è¢«æå–ã€‚</p></div>
            </div>
        </div>
    </div>

    <footer>&copy; 2026 DTZ PDF ENGINE | ä¼æ¥­ç´šæœ¬åœ°æ–‡ä»¶è™•ç†è§£æ±ºæ–¹æ¡ˆ</footer>

    <script>
        const { PDFDocument } = PDFLib;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        let mergeFiles = [];
        let splitPages = [];
        let currentFileBuffer = null;

        // --- Tab åˆ‡æ› ---
        function switchTab(mode) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`panel-${mode}`).classList.add('active');
        }

        // --- åˆä½µé‚è¼¯ ---
        document.getElementById('input-merge').onchange = e => handleMergeFiles(e.target.files);
        async function handleMergeFiles(files) {
            for (const file of Array.from(files)) {
                const id = crypto.randomUUID();
                const buf = await file.arrayBuffer();
                const item = { id, file, buf };
                mergeFiles.push(item);
                
                const card = document.createElement('div');
                card.className = 'page-card';
                card.id = id;
                card.innerHTML = `<div><b>${file.name}</b></div><button onclick="removeMerge('${id}')" style="margin-top:10px; cursor:pointer;">ç§»é™¤</button>`;
                document.getElementById('merge-list').appendChild(card);
            }
            document.getElementById('merge-ctrl').style.display = mergeFiles.length > 0 ? 'block' : 'none';
        }

        function removeMerge(id) {
            mergeFiles = mergeFiles.filter(f => f.id !== id);
            document.getElementById(id).remove();
            if(mergeFiles.length === 0) document.getElementById('merge-ctrl').style.display = 'none';
        }

        async function doMerge() {
            const btn = document.getElementById('btn-run-merge');
            btn.disabled = true; btn.innerText = "æ­£åœ¨åˆä½µ...";
            try {
                const mergedPdf = await PDFDocument.create();
                for (const item of mergeFiles) {
                    if (item.file.type === 'application/pdf') {
                        const pdf = await PDFDocument.load(item.buf);
                        const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        pages.forEach(p => mergedPdf.addPage(p));
                    } else {
                        const img = item.file.type.includes('png') ? await mergedPdf.embedPng(item.buf) : await mergedPdf.embedJpg(item.buf);
                        const page = mergedPdf.addPage([img.width, img.height]);
                        page.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
                    }
                }
                const bytes = await mergedPdf.save();
                triggerDownload(bytes, "Merged_Document.pdf", "application/pdf");
            } catch (e) { alert("åˆä½µå¤±æ•—"); }
            btn.disabled = false; btn.innerText = "é–‹å§‹åˆä½µä¸¦ä¸‹è¼‰";
        }

        // --- åˆ‡å‰²é‚è¼¯ ---
        document.getElementById('input-split').onchange = e => handleSplitFile(e.target.files[0]);
        async function handleSplitFile(file) {
            if(!file) return;
            const grid = document.getElementById('split-grid');
            grid.innerHTML = "æ­£åœ¨è§£æé é¢...";
            splitPages = [];
            currentFileBuffer = await file.arrayBuffer();
            
            const pdf = await pdfjsLib.getDocument({ data: currentFileBuffer }).promise;
            grid.innerHTML = "";
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const vp = page.getViewport({ scale: 0.3 });
                const cv = document.createElement('canvas');
                cv.width = vp.width; cv.height = vp.height;
                await page.render({ canvasContext: cv.getContext('2d'), viewport: vp }).promise;
                
                const card = document.createElement('div');
                card.className = 'page-card';
                card.innerHTML = `<div class="page-label">P${i}</div>`;
                card.appendChild(cv);
                card.onclick = () => {
                    card.classList.toggle('selected');
                    const idx = i - 1;
                    if(splitPages.includes(idx)) splitPages = splitPages.filter(v => v !== idx);
                    else splitPages.push(idx);
                };
                grid.appendChild(card);
                if(i % 10 === 0) await new Promise(r => setTimeout(r, 0)); // å‘¼å¸é»
            }
            document.getElementById('split-ctrl').style.display = 'block';
        }

        async function doSplit() {
            if(splitPages.length === 0) return alert("è«‹å…ˆé»é¸æ¬²æå–çš„é é¢");
            const btn = document.getElementById('btn-run-split');
            btn.disabled = true;
            
            const zip = new JSZip();
            const srcDoc = await PDFDocument.load(currentFileBuffer);
            
            for (let i = 0; i < splitPages.length; i++) {
                const newPdf = await PDFDocument.create();
                const [page] = await newPdf.copyPages(srcDoc, [splitPages[i]]);
                newPdf.addPage(page);
                const bytes = await newPdf.save();
                zip.file(`Extract_Page_${splitPages[i]+1}.pdf`, bytes);
            }
            
            const content = await zip.generateAsync({type:"blob"});
            triggerDownload(content, "Extracted_Pages.zip", "application/zip");
            btn.disabled = false;
        }

        // --- å…±ç”¨ä¸‹è¼‰å™¨ ---
        function triggerDownload(data, name, type) {
            const blob = data instanceof Blob ? data : new Blob([data], {type});
            const url = URL.createObjectURL(blob);
            if (isIOS && type === "application/pdf") {
                window.open(url, '_blank');
            } else {
                const a = document.createElement('a'); a.href = url; a.download = name;
                document.body.appendChild(a); a.click(); a.remove();
            }
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        }

        // åˆå§‹åŒ–æ‹–æ›³æ’åº (åƒ…é™åˆä½µåˆ—è¡¨)
        new Sortable(document.getElementById('merge-list'), {
            animation: 150,
            onEnd: () => {
                const ids = Array.from(document.getElementById('merge-list').children).map(el => el.id);
                mergeFiles.sort((a,b) => ids.indexOf(a.id) - ids.indexOf(b.id));
            }
        });
    </script>
</body>
</html>
