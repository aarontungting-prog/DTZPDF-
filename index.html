<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>霓虹西洋棋：史詩完整版</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/objects/Sky.js"></script>
    
    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js",
            "firebase/database": "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"
        }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Microsoft JhengHei', sans-serif; color: white; user-select: none; }
        
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .hud { pointer-events: auto; }

        /* 捲軸美化 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #00e5ff; }

        /* 彈窗 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000; display: none;
            justify-content: center; align-items: center; pointer-events: auto;
            backdrop-filter: blur(10px);
        }
        .auth-box {
            background: rgba(20, 20, 30, 0.95); border: 1px solid #00e5ff;
            padding: 25px; border-radius: 15px; width: 320px; text-align: center;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.25); max-height: 90vh; overflow-y: auto;
        }
        .auth-box h2 { color: #00e5ff; margin-top: 0; margin-bottom: 10px; }
        .auth-input { width: 100%; padding: 10px; margin: 5px 0; background: #111; border: 1px solid #444; color: #fff; border-radius: 5px; box-sizing: border-box; }
        
        /* 按鈕 */
        .btn-base { width: 100%; padding: 10px; margin-top: 5px; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; transition: 0.2s; font-size: 14px; }
        .auth-btn { background: #00e5ff; color: #000; }
        .guest-btn { background: transparent; color: #aaa; border: 1px solid #444; }
        .game-btn { background: #00e5ff; color: #000; }
        .join-btn { background: #ff0055; color: #fff; }
        .ai-btn { background: #9d00ff; color: #fff; }
        .logout-btn { background: #333; color: #aaa; border: 1px solid #444; font-size: 12px; }

        /* 左側介面 */
        #left-container { position: absolute; top: 20px; left: 20px; width: 240px; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
        .hud-box { background: rgba(0,0,0,0.85); border: 1px solid #333; border-radius: 10px; padding: 12px; pointer-events: auto; backdrop-filter: blur(5px); }
        .hud-title { color: #aaa; font-size: 11px; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #444; padding-bottom: 4px; }

        /* 頭像 */
        .avatar-container { width: 70px; height: 70px; margin: 5px auto 10px auto; border-radius: 50%; position: relative; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .avatar-img { width: 100%; height: 100%; border-radius: 50%; background: #333; object-fit: cover; }
        .avatar-hint { position: absolute; bottom: -15px; width: 100%; text-align: center; font-size: 10px; color: #00e5ff; opacity: 0.7; }

        /* 頭像框 */
        .frame-basic-1 { border: 3px solid #555; }
        .frame-basic-2 { border: 3px solid #888; }
        .frame-basic-3 { border: 3px solid #fff; }
        .frame-basic-4 { border: 3px dashed #00e5ff; }
        .frame-basic-5 { border: 3px double #ff0055; }
        .frame-bronze { border: 4px solid #cd7f32; box-shadow: 0 0 10px #cd7f32; }
        .frame-silver { border: 4px solid #c0c0c0; box-shadow: 0 0 15px #c0c0c0; }
        .frame-gold { border: 4px solid #ffd700; box-shadow: 0 0 20px #ffd700; }
        .frame-diamond { border: 4px solid #b9f2ff; box-shadow: 0 0 20px #b9f2ff; animation: pulse-b 2s infinite; }
        .frame-master { border: 4px solid #ff0055; box-shadow: 0 0 25px #ff0055; animation: pulse-r 1.5s infinite; }
        @keyframes pulse-b { 50% { box-shadow: 0 0 35px #00e5ff; } }
        @keyframes pulse-r { 50% { box-shadow: 0 0 40px #ff0000; } }

        /* 設定網格 */
        .frames-grid, .skin-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 10px 0; }
        .option-item { width: 100%; aspect-ratio: 1; border-radius: 8px; cursor: pointer; position: relative; background: #222; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px solid #444; }
        .option-item.locked { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
        .option-item.selected { border: 2px solid #00e5ff; box-shadow: 0 0 8px #00e5ff; }

        /* AI 氣泡 */
        #ai-chat-bubble { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 300px; background: rgba(0, 0, 0, 0.9); border: 1px solid #9d00ff; border-radius: 20px; padding: 10px 20px; color: #fff; font-size: 14px; text-align: center; display: none; z-index: 2000; pointer-events: none; }
        .ai-name { color: #9d00ff; font-weight: bold; margin-bottom: 4px; display: block; font-size: 12px; }

        #status-panel { top: 20px; right: 20px; text-align: right; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; border: 1px solid #333; }
        
        .ai-card { background: #222; padding: 10px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; }
        .ai-card:hover { background: #333; border: 1px solid #00e5ff; }

        #tutorial-btn { position: absolute; bottom: 30px; right: 30px; width: 40px; height: 40px; border-radius: 50%; background: #333; border: 2px solid #ffaa00; color: #ffaa00; display: flex; justify-content: center; align-items: center; cursor: pointer; font-weight: bold; z-index: 2500; pointer-events: auto; }
        #tutorial-content { position: absolute; bottom: 80px; right: 30px; width: 280px; background: rgba(0,0,0,0.95); border: 1px solid #ffaa00; padding: 15px; display: none; border-radius: 10px; z-index: 2500; pointer-events: auto; }

        #loading { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; display:flex; justify-content:center; align-items:center; color:#ffaa00; font-size:18px; z-index:4000; }
        #footer-watermark { position: absolute; bottom: 10px; width: 100%; text-align: center; color: rgba(255,255,255,0.3); font-size: 12px; pointer-events: none; }
        
        @media (max-width: 600px) {
            #left-container { top: 10px; left: 10px; width: calc(100% - 20px); }
            #status-panel { top: auto; bottom: 80px; right: 20px; }
            #tutorial-btn { bottom: 20px; right: 20px; }
            #tutorial-content { bottom: 70px; right: 20px; }
        }
    </style>
</head>
<body>

<div id="loading">初始化 3D 引擎與 Firebase...</div>

<div id="auth-modal" class="modal-overlay" style="display: flex;">
    <div class="auth-box">
        <h2>DTZ CHESS</h2>
        <div id="auth-error" style="color:#ff0055; font-size:12px; margin-bottom:10px;"></div>
        <input type="email" id="email" class="auth-input" placeholder="Email">
        <input type="password" id="password" class="auth-input" placeholder="密碼">
        <div id="nickname-container" style="display:none; margin-top:5px;">
            <input type="text" id="nickname" class="auth-input" placeholder="設定暱稱" style="border-color:#00ff00;">
        </div>
        <button id="auth-action-btn" class="btn-base auth-btn">登入 / 註冊</button>
        <div id="forgot-pw" style="margin-top:10px; font-size:12px; color:#aaa; cursor:pointer; text-decoration:underline;">忘記密碼？</div>
        <button id="guest-btn" class="btn-base guest-btn">訪客試玩</button>
    </div>
</div>

<div id="ai-modal" class="modal-overlay">
    <div class="auth-box">
        <h2>選擇對手</h2>
        <div id="ai-list-container" style="max-height:300px; overflow-y:auto; text-align:left;"></div>
        <button onclick="document.getElementById('ai-modal').style.display='none'" class="btn-base guest-btn">取消</button>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="auth-box" style="width: 340px;">
        <h2>設定</h2>
        <div style="text-align:left; margin-bottom:10px;">
            <label style="font-size:12px; color:#aaa;">暱稱:</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="setting-name" class="auth-input" style="margin:0;">
                <button onclick="saveName()" class="btn-base auth-btn" style="width:60px; margin:0;">儲存</button>
            </div>
        </div>
        
        <input type="file" id="file-input" accept="image/*" style="display:none;">

        <div style="text-align:left; margin-bottom:5px;">
            <label style="font-size:12px; color:#aaa;">頭像框 (排位解鎖):</label>
            <div class="frames-grid" id="frames-grid"></div>
        </div>

        <div style="text-align:left;">
            <label style="font-size:12px; color:#aaa;">棋子造型 (排位解鎖):</label>
            <div class="skin-grid" id="skins-grid"></div>
        </div>
        
        <button onclick="document.getElementById('settings-modal').style.display='none'" class="btn-base guest-btn" style="margin-top:15px;">關閉</button>
    </div>
</div>

<div id="ui" style="display:none;">
    <div id="left-container">
        
        <div class="hud-box">
            <button onclick="openSettings()" style="position:absolute; top:10px; right:10px; background:none; border:none; color:#aaa; cursor:pointer;">⚙️</button>
            <div class="avatar-container" onclick="document.getElementById('file-input').click()">
                <div id="user-frame" class="frame-basic-1" style="width:100%; height:100%; border-radius:50%; position:absolute; pointer-events:none;"></div>
                <img src="" class="avatar-img" id="user-avatar-img">
                <div class="avatar-hint">點擊換圖</div>
            </div>
            <div style="text-align:center;">
                <div id="user-name" style="font-weight:bold;">Player</div>
                <div style="font-size:12px; color:#aaa;">
                    <span id="user-rank" style="color:#cd7f32;">銅牌</span> | ELO: <span id="user-elo">0</span>
                </div>
            </div>
            <button id="btn-logout" class="btn-base logout-btn">登出</button>
        </div>

        <div class="hud-box">
            <div class="hud-title">連線對戰 (PVP)</div>
            <div id="room-display" style="font-size:12px; color:#0f0; margin-bottom:5px;">狀態: 閒置</div>
            <div style="display:flex; gap:5px;">
                <button id="btn-create" class="btn-base game-btn" style="margin:0;">創建</button>
                <button id="btn-join" class="btn-base join-btn" style="margin:0;">加入</button>
            </div>
        </div>

        <div class="hud-box">
            <div class="hud-title">挑戰電腦 (PVE)</div>
            <button id="btn-ai" class="btn-base ai-btn" style="margin:0;">選擇 AI 對手</button>
        </div>
    </div>

    <div id="ai-chat-bubble">
        <span class="ai-name" id="ai-name-label">GEMINI</span>
        <span id="ai-message">...</span>
    </div>

    <div id="status-panel" class="hud">
        <h1 style="margin:0; font-size:1.2rem; color:#00e5ff;">NEON CHESS</h1>
        <div id="turn-txt" style="font-size:1.5rem; font-weight:bold;">等待中</div>
        <div id="opponent-info" style="font-size:12px; color:#aaa;">對手: ---</div>
    </div>

    <div id="tutorial-btn">?</div>
    <div id="tutorial-content">
        <h3 style="color:#ffaa00; margin-top:0;">排位與獎勵</h3>
        <ul style="padding-left:20px; font-size:12px; color:#ccc;">
            <li>新手 (0): 基礎造型</li>
            <li>銅牌 (500): 銅框 + 青銅棋</li>
            <li>銀牌 (1000): 銀框 + 科技棋</li>
            <li>金牌 (1500): 金框 + 奢華棋</li>
            <li>鑽石 (2000): 呼吸框 + 水晶棋</li>
            <li>宗師 (2500): 烈焰框 + 宇宙棋</li>
        </ul>
    </div>

    <div id="footer-watermark">Made by DTZ with Gemini Pro</div>
</div>

<script type="module">
    import { initializeApp } from "firebase/app";
    import { getDatabase, ref, set, get, update, onValue } from "firebase/database";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut, sendPasswordResetEmail } from "firebase/auth";

    // --- Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyCxPppnUG864v3E2j1OzykzFmhLpsEJCSE",
        authDomain: "chess-1885a.firebaseapp.com",
        databaseURL: "https://chess-1885a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "chess-1885a",
        storageBucket: "chess-1885a.firebasestorage.app",
        messagingSenderId: "824383572856",
        appId: "1:824383572856:web:7c663d6bf0f970f6acd68d",
        measurementId: "G-0EMJ4W2KLS"
    };
    const GEMINI_API_KEY = "AIzaSyBEueRZXZUidaSKfyl8dKoCJF4ha1Y1TcY";

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- State ---
    let currentUser=null, userElo=0, userSkin='skin_classic', gameId=null, playerColor='w', isOnline=false, isVsAI=false, isRegistering=false, currentAiPersona=null;
    let scene, camera, renderer, controls, raycaster, mouse={x:0,y:0}, clock, game=new Chess();
    let tilesMap={}, piecesMap={}, selectedSquare=null, isProcessing=false, grassMat, cloudParticles=[];
    const BOARD_HEIGHT=15;

    // --- Data Definitions ---
    const AI_PERSONAS = [
        { name:'波波 (Bob)', rank:'新手', elo:400, color:'#aaa', desc:'經常送頭', prompt:'You are Bob, novice player. Make mistakes. Speak cute.' },
        { name:'愛麗絲 (Alice)', rank:'銅牌', elo:800, color:'#cd7f32', desc:'性格溫和', prompt:'You are Alice, beginner. Polite and encouraging.' },
        { name:'毒蛇 (Viper)', rank:'銀牌', elo:1200, color:'#c0c0c0', desc:'喜歡嘲諷', prompt:'You are Viper, toxic player. Trash talk aggressively.' },
        { name:'策士 (Strategos)', rank:'金牌', elo:1600, color:'#ffd700', desc:'冷靜分析', prompt:'You are Strategos. Speak logically. No emotion.' },
        { name:'諾娃 (Nova)', rank:'鑽石', elo:2000, color:'#00e5ff', desc:'天才少女', prompt:'You are Nova, flashy genius. Confident and playful.' },
        { name:'奧米加 (Omega)', rank:'宗師', elo:2800, color:'#ff0055', desc:'神諭', prompt:'You are Omega, god-like AI. Speak in cryptic riddles.' }
    ];
    const FRAMES = [
        {id:'frame-basic-1', req:0}, {id:'frame-basic-2', req:0}, {id:'frame-basic-3', req:0}, {id:'frame-basic-4', req:0}, {id:'frame-basic-5', req:0},
        {id:'frame-bronze', req:500}, {id:'frame-silver', req:1000}, {id:'frame-gold', req:1500}, {id:'frame-diamond', req:2000}, {id:'frame-master', req:2500}
    ];
    const SKINS = [
        {id:'skin_classic', name:'經典', req:0}, {id:'skin_bronze', name:'青銅', req:500},
        {id:'skin_silver', name:'白銀', req:1000}, {id:'skin_gold', name:'黃金', req:1500},
        {id:'skin_crystal', name:'水晶', req:2000}, {id:'skin_glitch', name:'故障', req:2500}, {id:'skin_cosmic', name:'宇宙', req:2800}
    ];

    // --- UI Events ---
    document.getElementById('tutorial-btn').onclick = (e) => { e.stopPropagation(); const el=document.getElementById('tutorial-content'); el.style.display=el.style.display==='none'?'block':'none'; };

    window.openSettings = function() {
        document.getElementById('settings-modal').style.display='flex';
        document.getElementById('setting-name').value = document.getElementById('user-name').innerText;
        
        const fGrid = document.getElementById('frames-grid'); fGrid.innerHTML='';
        const currFrame = document.getElementById('user-frame').className;
        FRAMES.forEach(f => {
            const d = document.createElement('div'); d.className = `option-item ${f.id}`;
            if(userElo < f.req) d.classList.add('locked');
            else { d.onclick=()=>setFrame(f.id); if(f.id===currFrame) d.classList.add('selected'); }
            fGrid.appendChild(d);
        });

        const sGrid = document.getElementById('skins-grid'); sGrid.innerHTML='';
        SKINS.forEach(s => {
            const d = document.createElement('div'); d.className = 'option-item';
            d.innerHTML = `<div style="font-size:20px;">♟️</div><div style="font-size:10px;margin-top:2px;">${s.name}</div>`;
            if(userElo < s.req) d.classList.add('locked');
            else { d.onclick=()=>setSkin(s.id); if(s.id===userSkin) d.classList.add('selected'); }
            sGrid.appendChild(d);
        });
    };

    function setFrame(id) { update(ref(db,'users/'+currentUser.uid), {selectedFrame:id}); document.getElementById('settings-modal').style.display='none'; }
    function setSkin(id) { 
        update(ref(db,'users/'+currentUser.uid), {selectedSkin:id}); 
        userSkin=id; 
        if(!isOnline) syncPieces(); 
        document.getElementById('settings-modal').style.display='none'; 
    }
    window.saveName = function() {
        const n = document.getElementById('setting-name').value.trim();
        if(n) update(ref(db,'users/'+currentUser.uid), {name:n});
    };

    document.getElementById('file-input').onchange = function(e) {
        const f = e.target.files[0];
        if(!f) return;
        if(f.size > 1024*1024) return alert("圖片需小於 1MB");
        const r = new FileReader();
        r.onload = (ev) => update(ref(db,'users/'+currentUser.uid), {avatarUrl:ev.target.result});
        r.readAsDataURL(f);
    };

    // --- Auth Logic ---
    onAuthStateChanged(auth, (user) => {
        document.getElementById('loading').style.display='none';
        if(user) {
            currentUser = user;
            document.getElementById('auth-modal').style.display='none';
            document.getElementById('ui').style.display='block';
            checkUser(user);
        } else {
            currentUser = null;
            document.getElementById('auth-modal').style.display='flex';
            document.getElementById('ui').style.display='none';
            resetAuth();
        }
    });

    function resetAuth() { isRegistering=false; document.getElementById('nickname-container').style.display='none'; document.getElementById('auth-action-btn').innerText="登入 / 註冊"; document.getElementById('auth-error').innerText=""; }
    function checkUser(u) {
        const r = ref(db,'users/'+u.uid);
        get(r).then(s => {
            if(!s.exists()) {
                const nick = document.getElementById('nickname').value.trim() || (u.isAnonymous?`Guest`:u.email.split('@')[0]);
                set(r, {name:nick, email:u.email||"guest", elo:0, selectedFrame:'frame-basic-1', selectedSkin:'skin_classic'}).then(loadUser);
            } else loadUser();
        });
    }
    function loadUser() {
        onValue(ref(db,'users/'+currentUser.uid), (s) => {
            const d = s.val(); if(!d) return;
            userElo = d.elo; userSkin = d.selectedSkin || 'skin_classic';
            document.getElementById('user-name').innerText = d.name;
            document.getElementById('user-elo').innerText = d.elo;
            document.getElementById('user-rank').innerText = getRankName(d.elo);
            document.getElementById('user-frame').className = d.selectedFrame || 'frame-basic-1';
            document.getElementById('user-avatar-img').src = d.avatarUrl || `https://api.dicebear.com/7.x/bottts/svg?seed=${d.name}`;
            if(!isOnline) syncPieces();
        });
    }
    function getRankName(elo) {
        if(elo<500)return "新手"; if(elo<1000)return "銅牌"; if(elo<1500)return "銀牌";
        if(elo<2000)return "金牌"; if(elo<2500)return "鑽石"; return "宗師";
    }

    document.getElementById('auth-action-btn').onclick = async () => {
        const e = document.getElementById('email').value.trim(), p = document.getElementById('password').value.trim();
        if(!e || !p) return document.getElementById('auth-error').innerText = "請輸入帳密";
        if(isRegistering) {
            if(!document.getElementById('nickname').value.trim()) return;
            try { await createUserWithEmailAndPassword(auth, e, p); } catch(err) { document.getElementById('auth-error').innerText = err.message; }
            return;
        }
        try { await signInWithEmailAndPassword(auth, e, p); } catch(err) {
            if(err.code.includes('user-not-found') || err.code.includes('invalid-credential')) {
                isRegistering=true; document.getElementById('nickname-container').style.display='block';
                document.getElementById('auth-action-btn').innerText="確認註冊"; document.getElementById('auth-error').innerText="初次見面，請輸入暱稱";
            } else document.getElementById('auth-error').innerText = err.message;
        }
    };
    document.getElementById('guest-btn').onclick = async () => { try{await signInAnonymously(auth);}catch(e){} };
    document.getElementById('btn-logout').onclick = () => signOut(auth);

    // --- PVP Logic ---
    document.getElementById('btn-create').onclick = () => {
        isVsAI=false; gameId = Math.floor(1000+Math.random()*9000).toString();
        get(ref(db,'users/'+currentUser.uid)).then(s=>{
            const u=s.val();
            set(ref(db,'games/'+gameId), {
                fen:game.fen(), turn:'w', status:'waiting',
                white:{uid:currentUser.uid, name:u.name, elo:u.elo, skin:u.selectedSkin||'skin_classic'}
            }).then(()=>{
                playerColor='w'; isOnline=true;
                document.getElementById('room-display').innerText = `房號: ${gameId} (等待)`;
                moveCam(0,60,100); listenGame(); alert(`房號: ${gameId}`);
            });
        });
    };
    document.getElementById('btn-join').onclick = () => {
        const id = prompt("輸入房號"); if(!id) return;
        gameId = id; isVsAI=false;
        get(ref(db,'games/'+id)).then(s=>{
            if(!s.exists() || s.val().status!=='waiting') return alert("無法加入");
            get(ref(db,'users/'+currentUser.uid)).then(us=>{
                const u=us.val();
                update(ref(db,'games/'+id), {
                    status:'playing', black:{uid:currentUser.uid, name:u.name, elo:u.elo, skin:u.selectedSkin||'skin_classic'}
                });
                playerColor='b'; isOnline=true;
                document.getElementById('room-display').innerText = `房號: ${id} (對戰)`;
                moveCam(0,60,-100); listenGame();
            });
        });
    };

    function listenGame() {
        onValue(ref(db,'games/'+gameId), (s) => {
            const d = s.val(); if(!d) return;
            if(d.status==='playing' && !d.winner && document.getElementById('turn-txt').innerText.includes("等待")) {
                const opp = playerColor==='w'?d.black:d.white;
                if(opp) { document.getElementById('opponent-info').innerText = `VS: ${opp.name}`; syncPieces(d); }
            }
            if(d.fen !== game.fen()) { game.load(d.fen); syncPieces(d); updateHUD(); }
            if(d.winner) { isProcessing=true; alert(d.winner===playerColor?"勝利！":"戰敗..."); }
        });
    }

    function sendMove(m) {
        if(!isOnline) return;
        let up = {fen:game.fen(), turn:game.turn(), lastMove:m};
        if(game.in_checkmate()) { up.winner = game.turn()==='w'?'b':'w'; up.status='finished'; calcElo(up.winner); }
        update(ref(db,'games/'+gameId), up);
    }

    function calcElo(win) {
        get(ref(db,'games/'+gameId)).then(s=>{
            const d=s.val(); if(d.calculated) return;
            if(playerColor==='w') {
                const K=32, wE=d.white.elo, bE=d.black.elo;
                const eW=1/(1+Math.pow(10,(bE-wE)/400)), eB=1/(1+Math.pow(10,(wE-bE)/400));
                update(ref(db,'users/'+d.white.uid), {elo:Math.round(wE+K*((win==='w'?1:0)-eW))});
                update(ref(db,'users/'+d.black.uid), {elo:Math.round(bE+K*((win==='b'?1:0)-eB))});
                update(ref(db,'games/'+gameId), {calculated:true});
            }
        });
    }

    // --- AI Logic ---
    document.getElementById('btn-ai').onclick = () => {
        const list = document.getElementById('ai-list-container'); list.innerHTML='';
        AI_PERSONAS.forEach((ai,i) => {
            const d=document.createElement('div'); d.className='ai-card';
            d.innerHTML=`<div><span style="color:${ai.color};font-weight:bold;">${ai.name}</span><span style="display:block;font-size:10px;color:#888;">${ai.desc}</span></div><span style="font-size:12px;color:${ai.color};">${ai.rank}</span>`;
            d.onclick=()=>startAI(i); list.appendChild(d);
        });
        document.getElementById('ai-modal').style.display='flex';
    };

    function startAI(idx) {
        document.getElementById('ai-modal').style.display='none';
        currentAiPersona = AI_PERSONAS[idx];
        isVsAI=true; isOnline=false; gameId="vs-ai"; playerColor='w';
        game.reset(); syncPieces(); moveCam(0,60,100);
        document.getElementById('opponent-info').innerText = `VS: ${currentAiPersona.name}`;
        updateHUD(); aiSpeak("我是 "+currentAiPersona.name+"，準備好了嗎？");
    }

    function aiSpeak(msg) {
        const b = document.getElementById('ai-chat-bubble');
        document.getElementById('ai-message').innerText = msg;
        document.getElementById('ai-name-label').innerText = currentAiPersona.name.split(' ')[0];
        document.getElementById('ai-name-label').style.color = currentAiPersona.color;
        b.style.display='block'; setTimeout(()=>b.style.display='none', 6000);
    }

    async function makeAiMove() {
        if(game.game_over()) return;
        isProcessing=true; document.getElementById('turn-txt').innerText="思考中...";
        const fen=game.fen(), moves=game.moves({verbose:true}).map(m=>m.san).join(',');
        const prompt=`${currentAiPersona.prompt} Black. FEN:"${fen}". Valid:[${moves}]. Pick best move. Output: MOVE|MESSAGE. Ex:"e5|Good." SAN only. Msg max 10 words.`;
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
            });
            const d = await responseSafe(r);
            let txt = d.candidates[0].content.parts[0].text.trim().split('|');
            let move = txt[0].replace(/[\n\r."]/g,'').trim(), msg = txt[1]||"";
            if(msg) aiSpeak(msg);
            if(!game.move(move)) makeRandomAI(); else animateMove(game.history({verbose:true}).pop());
        } catch(e) { console.error(e); aiSpeak("(AI 離線)"); makeRandomAI(); }
    }
    async function responseSafe(r) { if(!r.ok) throw new Error('API Fail'); return await r.json(); }

    // --- 3D & Game Core ---
    function init() {
        clock=new THREE.Clock(); scene=new THREE.Scene(); scene.background=new THREE.Color(0x220000); scene.fog=new THREE.FogExp2(0x990044,0.0005);
        camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,0.1,6000); camera.position.set(0,60,100);
        renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(window.innerWidth,window.innerHeight); renderer.shadowMap.enabled=true;
        renderer.toneMapping=THREE.ACESFilmicToneMapping; document.body.appendChild(renderer.domElement);
        controls=new THREE.OrbitControls(camera,renderer.domElement); controls.enableDamping=true; controls.target.set(0,15,0);
        
        const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
        const sun = new THREE.DirectionalLight(0xffaa00, 2); sun.position.set(-100,100,-100); sun.castShadow=true; scene.add(sun);
        const sky = new THREE.Sky(); sky.scale.setScalar(450000); scene.add(sky); sky.material.uniforms.sunPosition.value.copy(sun.position);
        
        createProceduralTerrain(); createVegetation(); createHighAltitudeClouds(); createFloatingBoard();
        window.addEventListener('resize', onResize);
        window.addEventListener('touchstart', onTouch, {passive:false});
        window.addEventListener('click', onClick);
        animate();
    }

    function createProceduralTerrain(){
        const g=new THREE.PlaneGeometry(3500,3500,120,120); g.rotateX(-Math.PI/2);
        const p=g.attributes.position; const c=[]; const c1=new THREE.Color(0x226622); const c2=new THREE.Color(0x665544);
        for(let i=0;i<p.count;i++){
            const h=getTerrainHeight(p.getX(i),p.getZ(i)); p.setY(i,h);
            const b=smoothstep(-12,8,h); const f=c1.clone().lerp(c2,b); c.push(f.r,f.g,f.b);
        }
        g.setAttribute('color',new THREE.Float32BufferAttribute(c,3)); g.computeVertexNormals();
        const m=new THREE.MeshStandardMaterial({vertexColors:true,roughness:0.9}); 
        const mesh=new THREE.Mesh(g,m); mesh.receiveShadow=true; scene.add(mesh);
    }
    
    function createVegetation() {
        const grp=new THREE.Group();
        const tGeo=new THREE.CylinderGeometry(0.7,1,6,6); tGeo.translate(0,3,0);
        const lGeo=new THREE.DodecahedronGeometry(4);
        const tMat=new THREE.MeshStandardMaterial({color:0x3d2817});
        const lMat=new THREE.MeshStandardMaterial({color:0x1a3d1a});
        
        for(let i=0;i<600;i++){
            const a=Math.random()*Math.PI*2, r=70+Math.random()*400;
            const x=Math.cos(a)*r, z=Math.sin(a)*r, h=getTerrainHeight(x,z);
            const t=new THREE.Mesh(tGeo,tMat); const l=new THREE.Mesh(lGeo,lMat);
            l.position.y=6; t.add(l); t.position.set(x,h,z); t.scale.setScalar(0.8+Math.random()*0.5);
            grp.add(t);
        }
        scene.add(grp);
    }

    function createHighAltitudeClouds() {
        const g=new THREE.Group();
        const m=new THREE.MeshBasicMaterial({color:0xffaa88, transparent:true, opacity:0.3});
        for(let i=0;i<20;i++){
            const c=new THREE.Mesh(new THREE.BoxGeometry(400,20,200),m);
            c.position.set((Math.random()-0.5)*3000, 300+Math.random()*100, (Math.random()-0.5)*3000);
            g.add(c);
        }
        scene.add(g); cloudParticles=g.children;
    }

    function createFloatingBoard() {
        const boardBox = new THREE.Mesh(new THREE.BoxGeometry(9,0.5,9), new THREE.MeshStandardMaterial({color:0x111111, roughness:0.5}));
        boardBox.position.y = 14.75; boardBox.receiveShadow=true; scene.add(boardBox);
        for(let r=0;r<8;r++) for(let c=0;c<8;c++) {
            const isW = (r+c)%2!==0;
            const tile = new THREE.Mesh(new THREE.BoxGeometry(1,0.2,1), new THREE.MeshStandardMaterial({color:isW?0xeeeeee:0x222222}));
            tile.position.set(c-3.5, 15, 3.5-r); tile.userData={sq:String.fromCharCode(97+c)+(r+1)};
            scene.add(tile); tilesMap[tile.userData.sq] = tile;
        }
        syncPieces();
    }

    function createPiece(type, color, skin) {
        const grp = new THREE.Group();
        let col = color==='w'?0xeeeeee:0x222222, emi = color==='w'?0x00e5ff:0xff0055;
        
        if(skin==='skin_gold') { col=0xffd700; emi=0xffaa00; }
        else if(skin==='skin_silver') { col=0xcccccc; emi=0xffffff; }
        else if(skin==='skin_bronze') { col=0xcd7f32; emi=0xff4400; }
        else if(skin==='skin_crystal') { col=color==='w'?0xaaddff:0xaa00ff; emi=col; }
        else if(skin==='skin_cosmic') { col=0x000000; emi=color==='w'?0x00ffff:0xff00ff; }

        const mat = new THREE.MeshStandardMaterial({color:col, roughness:0.3, metalness:0.8, emissive:emi, emissiveIntensity:0.3});
        
        let geo, head;
        const base = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.45, 0.2, 32), mat);
        base.position.y=0.1; grp.add(base);

        if(type==='p') {
            geo = new THREE.CylinderGeometry(0.15, 0.35, 0.6, 16);
            head = new THREE.Mesh(new THREE.SphereGeometry(0.25), mat); head.position.y=0.95; grp.add(head);
        }
        else if(type==='r') { geo = new THREE.BoxGeometry(0.5, 0.8, 0.5); }
        else if(type==='n') { geo = new THREE.CylinderGeometry(0.25, 0.35, 0.6, 16); head=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.5,0.3),mat); head.position.set(0,0.9,0.1); grp.add(head); }
        else if(type==='b') { geo = new THREE.CylinderGeometry(0.15, 0.3, 0.9, 16); head=new THREE.Mesh(new THREE.SphereGeometry(0.15),mat); head.position.y=1.2; grp.add(head); }
        else if(type==='q') { geo = new THREE.CylinderGeometry(0.2, 0.35, 1.3, 16); head=new THREE.Mesh(new THREE.SphereGeometry(0.2),mat); head.position.y=1.6; grp.add(head); }
        else { geo = new THREE.CylinderGeometry(0.25, 0.4, 1.5, 16); head=new THREE.Mesh(new THREE.BoxGeometry(0.15,0.4,0.15),mat); head.position.y=1.8; grp.add(head); }

        const body = new THREE.Mesh(geo, mat); body.position.y=0.5; grp.add(body);
        return grp;
    }

    function syncPieces(d) {
        for(let k in piecesMap) scene.remove(piecesMap[k]); piecesMap={};
        const b = game.board();
        let wSkin = userSkin, bSkin = userSkin;
        if(isOnline && d) { if(d.white) wSkin=d.white.skin; if(d.black) bSkin=d.black.skin; }

        for(let r=0;r<8;r++) for(let c=0;c<8;c++) {
            const p = b[r][c];
            if(p) {
                const s = createPiece(p.type, p.color, p.color==='w'?wSkin:bSkin);
                s.position.set(c-3.5, 15, r-3.5); 
                s.position.set(c-3.5, 15, (r-3.5)); 
                scene.add(s); piecesMap[String.fromCharCode(97+c)+(8-r)] = s;
            }
        }
    }

    function onTouch(e) {
        if(e.target.closest('.modal-overlay') || e.target.closest('.hud-box') || e.target.tagName==='BUTTON' || e.target.tagName==='INPUT') return;
        if(e.touches.length>1) return;
        e.preventDefault();
        mouse.x = (e.touches[0].clientX/window.innerWidth)*2-1;
        mouse.y = -(e.touches[0].clientY/window.innerHeight)*2+1;
        checkHit();
    }
    function onClick(e) { if(isProcessing) return; mouse.x=(e.clientX/window.innerWidth)*2-1; mouse.y=-(e.clientY/window.innerHeight)*2+1; checkHit(); }
    
    function checkHit() {
        raycaster.setFromCamera(mouse, camera);
        const i = raycaster.intersectObjects(Object.values(tilesMap));
        if(i.length>0) handleSq(i[0].object.userData.sq);
    }

    function handleSq(sq) {
        if(isVsAI && game.turn()==='b') return;
        if(isOnline && game.turn()!==playerColor) return;
        
        if(selectedSquare) {
            const m = game.move({from:selectedSquare, to:sq, promotion:'q'});
            if(m) {
                animateMove(m);
                if(isOnline) sendMove(m);
                if(isVsAI) setTimeout(makeAiMove, 500);
            }
            selectedSquare=null; clearHigh();
        } else {
            const p = game.get(sq);
            if(p && p.color === game.turn()) {
                if(isOnline && p.color!==playerColor) return;
                selectedSquare=sq; highlight(sq);
            }
        }
    }

    function highlight(sq) {
        clearHigh(); tilesMap[sq].material.emissive.setHex(0x00ff00);
        game.moves({square:sq, verbose:true}).forEach(m => tilesMap[m.to].material.emissive.setHex(0x555500));
    }
    function clearHigh() { for(let k in tilesMap) tilesMap[k].material.emissive.setHex(0x000000); }

    function animateMove(m) {
        isProcessing=true; clearHigh();
        const p = piecesMap[m.from];
        const dest = tilesMap[m.to].position.clone();
        if(m.captured) scene.remove(piecesMap[m.to]);
        
        new TWEEN.Tween(p.position).to({x:dest.x, z:dest.z}, 300).easing(TWEEN.Easing.Quadratic.Out)
            .onComplete(() => {
                // PVP 狀態下傳遞遊戲資料以保持 Skin
                if(isOnline) get(ref(db,'games/'+gameId)).then(s=>syncPieces(s.val()));
                else syncPieces();
                
                updateHUD();
                if(!isOnline && !isVsAI && game.turn()==='b') makeRandomAI(); 
                else if(!isVsAI) isProcessing=false;
            }).start();
    }

    function makeRandomAI() {
        const m = game.moves(); if(m.length===0) return;
        const move = m[Math.floor(Math.random()*m.length)];
        game.move(move); animateMove(game.history({verbose:true}).pop());
    }

    function updateHUD() {
        const t = game.turn()==='w'?"白方":"黑方";
        document.getElementById('turn-txt').innerText = isVsAI ? (game.turn()==='w'?"你的回合":"AI 思考") : t+"回合";
    }

    function moveCam(x,y,z) { new TWEEN.Tween(camera.position).to({x,y,z}, 2000).easing(TWEEN.Easing.Cubic.Out).start(); }
    function onResize() { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); }
    function animate() { requestAnimationFrame(animate); TWEEN.update(); controls.update(); 
        cloudParticles.forEach(c=>c.position.x+=0.1); 
        renderer.render(scene,camera); 
    }
    
    function getTerrainHeight(x,z){const d=Math.sqrt(x*x+z*z);if(d<400)return-12+Math.sin(x*0.004)*Math.cos(z*0.004)*2.0;const b=smoothstep(400,700,d);let h=b*140;h+=Math.sin(x*0.015)*Math.cos(z*0.015)*25;h+=Math.sin(x*0.03+z*0.02)*10;return h-12;}
    function smoothstep(min,max,v){var x=Math.max(0,Math.min(1,(v-min)/(max-min)));return x*x*(3-2*x);}

    init();
</script>
</body>
</html>
