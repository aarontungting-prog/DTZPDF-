<!DOCTYPE html>
<html lang="zh-TW">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>DTZ PDF v20.5 - æ——è‰¦ 2.0 å®Œçµå‚³èªªç‰ˆ</title>
   <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
   <style>
     :root {
       --primary-red: #e74c3c; --primary-green: #2ecc71; --primary-blue: #3498db;
       --bg-color: #f8fafc; --card-shadow: 0 10px 40px rgba(0,0,0,0.06);
     }
     body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg-color); color: #1e293b; }
     
     /* è¦–è¦ºé€²åº¦æ¢ */
     #loader-bar { position: fixed; top: 0; left: 0; width: 0%; height: 5px; background: linear-gradient(90deg, #e74c3c, #3498db); z-index: 2001; transition: width 0.3s ease; }
     
     /* é ‚éƒ¨å°èˆª */
     nav { background: white; padding: 1.2rem 8%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.03); position: sticky; top: 0; z-index: 1000; }
     .logo { font-size: 1.6rem; font-weight: 900; color: var(--primary-red); text-decoration: none; letter-spacing: -1px; }

     /* å´é‚ŠæŠ½å±œ */
     #side-toggle { position: fixed; left: 0; top: 50%; transform: translateY(-50%); background: var(--primary-red); color: white; padding: 20px 8px; border-radius: 0 12px 12px 0; cursor: pointer; z-index: 2000; writing-mode: vertical-lr; font-size: 12px; font-weight: bold; }
     .sidebar { position: fixed; left: -280px; top: 90px; width: 240px; height: calc(100vh - 120px); background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 20px; box-shadow: 10px 0 30px rgba(0,0,0,0.05); transition: 0.5s cubic-bezier(0.77, 0, 0.175, 1); z-index: 1500; overflow-y: auto; border-radius: 0 24px 24px 0; }
     .sidebar.open { left: 0; }
     .side-thumb-wrap { margin-bottom: 20px; border-radius: 12px; border: 3px solid #eee; overflow: hidden; transition: 0.3s; background: #fff; cursor: pointer; }
     .side-thumb-wrap.active { border-color: var(--primary-green); transform: scale(1.02); }

     /* ä¸»å·¥ä½œé¢æ¿ */
     .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; text-align: center; }
     .work-panel { background: white; padding: 40px; border-radius: 32px; box-shadow: var(--card-shadow); min-height: 550px; display: none; }
     .work-panel.active { display: block; animation: slideUp 0.5s ease-out; }
     .tab-btn { padding: 12px 28px; border-radius: 50px; border: 2px solid var(--primary-red); background: white; color: var(--primary-red); font-weight: 700; cursor: pointer; transition: 0.3s; margin: 5px; }
     .tab-btn.active { background: var(--primary-red); color: white; box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3); }

     /* å¡ç‰‡èˆ‡æ—‹è½‰ */
     .page-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
     .page-card { background: #fff; border: 2px solid #f1f5f9; padding: 15px; border-radius: 20px; position: relative; cursor: grab; transition: 0.3s; }
     .page-card.selected { border-color: var(--primary-green); background: #f0fff4; }
     .rot-0 { transform: rotate(0deg); } .rot-90 { transform: rotate(90deg); } .rot-180 { transform: rotate(180deg); } .rot-270 { transform: rotate(270deg); }
     canvas { max-width: 100%; max-height: 100%; border-radius: 8px; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: center center; }

     @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
   </style>
</head>
<body>
<div id="loader-bar"></div>
<div id="side-toggle">ğŸ“„ é é¢å°è¦½</div>
<aside class="sidebar"><div id="side-grid"></div></aside>

<nav>
   <a href="#" class="logo">DTZ PDF <span style="font-size:0.7rem; background:var(--primary-red); color:white; padding:3px 10px; border-radius:50px;">v20.5</span></a>
   <div style="font-size: 0.85rem; color: #2ecc71; font-weight: 900;">â— æœ€çµ‚è–æˆ°åˆ†æ®µç‰ˆ</div>
</nav>

<div class="container">
   <div class="tab-nav">
     <button class="tab-btn active" onclick="switchTab(event, 'main')">æ•´ç†èˆ‡åˆ†å‰²</button>
     <button class="tab-btn" onclick="switchTab(event, 'adv')">é«˜ç´šè£é£¾</button>
     <button class="tab-btn" onclick="switchTab(event, 'safe')">å®‰å…¨å±¬æ€§</button>
   </div>

   </div>

<script>
   // âœ… åˆå§‹åŒ–è®Šæ•¸
   const { PDFDocument, degrees, rgb, StandardFonts } = PDFLib;
   pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
   let pagesData = []; let fileBuffers = {}; let pdfCache = {}; let sigImage = null; let sigTargetId = null;
   const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

   // âœ… æª”æ¡ˆè§£æé‚è¼¯
   async function handleFiles(files) {
     updateProgress(10);
     for (let i = 0; i < files.length; i++) {
       const file = files[i];
       const fId = crypto.randomUUID();
       const buf = await file.arrayBuffer();
       fileBuffers[fId] = buf;
       if (file.name.toLowerCase().endsWith('.pdf')) {
         const pdf = await pdfjsLib.getDocument({ data: buf.slice(0) }).promise;
         for (let j = 1; j <= pdf.numPages; j++) {
           const pId = crypto.randomUUID();
           const page = await pdf.getPage(j);
           const txt = (await page.getTextContent()).items.map(s => s.str).join(' ');
           pagesData.push({ fId, pIdx: j-1, rot: 0, pId, type: 'pdf', selected: false, text: txt, fileName: file.name });
           await renderThumb(page, pId, j);
           if (j % 5 === 0) await new Promise(r => setTimeout(r, 0)); // å‘¼å¸
         }
       } else {
         const pId = crypto.randomUUID();
         pagesData.push({ fId, pIdx: 0, rot: 0, pId, type: 'img', file, selected: false, text:'', fileName: file.name });
         renderImgThumb(file, pId);
       }
     }
     document.getElementById('org-ctrl').style.display = 'block';
     updateProgress(0);
   }
   // ...ç¸®åœ–èˆ‡ UI æ§åˆ¶å‡½å¼...
</script>
<script>
   // âœ… æ ¸å¿ƒè™•ç†ï¼šåˆ†æ®µä»»å‹™èª¿åº¦
   async function processPdf(mode) {
     updateProgress(5);
     const zip = mode === 'split' ? new JSZip() : null;
     try {
       const mainDoc = mode === 'merge' ? await PDFDocument.create() : null;
       let mainFont = null;
       if (mainDoc) {
         mainFont = await mainDoc.embedFont(StandardFonts.HelveticaBold);
         mainDoc.setTitle(document.getElementById('m-title').value || "DTZ_Merged");
       }

       const list = mode === 'split' ? pagesData.filter(p => p.selected) : pagesData;

       for (let i = 0; i < list.length; i++) {
         const p = list[i];
         let curDoc = mode === 'merge' ? mainDoc : await PDFDocument.create();
         const curFont = mode === 'merge' ? mainFont : await curDoc.embedFont(StandardFonts.HelveticaBold);
         
         let newPage;
         if (p.type === 'pdf') {
           if (!pdfCache[p.fId]) pdfCache[p.fId] = await PDFDocument.load(fileBuffers[p.fId]);
           const [copy] = await curDoc.copyPages(pdfCache[p.fId], [p.pIdx]);
           copy.setRotation(degrees((p.rot + (copy.getRotation().angle || 0)) % 360));
           newPage = curDoc.addPage(copy);
         } else if (p.type === 'img') {
           const img = await curDoc.embedPng(await p.file.arrayBuffer());
           newPage = curDoc.addPage([img.width, img.height]);
           newPage.drawImage(img, { x:0, y:0, width:img.width, height:img.height, rotate:degrees(p.rot) });
         }

         // âœ… å¹¾ä½•é©æ‡‰æµ®æ°´å°
         const wm = document.getElementById('wm-text').value;
         if(wm) {
           const { width, height } = newPage.getSize();
           let fontSize = width / 12;
           // å­—é«”éæ¸›æ¼”ç®—æ³•é˜²æ­¢æº¢å‡º
           while (curFont.widthOfTextAtSize(wm, fontSize) > width * 0.7 && fontSize > 10) fontSize -= 2;
           const tw = curFont.widthOfTextAtSize(wm, fontSize);
           newPage.drawText(wm, { x: width/2 - tw/2, y: height/2.2, size: fontSize, font: curFont, color: rgb(0.85, 0.85, 0.85), opacity: parseFloat(document.getElementById('wm-op').value), rotate: degrees(35) });
         }

         // âœ… æ‰¹é‡ç°½å
         if (p.selected && sigImage) {
           const sig = await curDoc.embedPng(sigImage);
           const { width: pW } = newPage.getSize();
           const sW = pW / 4.5; const sH = sW * (sig.height / sig.width);
           newPage.drawImage(sig, { x: pW - sW - 40, y: 40, width: sW, height: sH });
         }

         if (mode === 'split') zip.file(`Page_${i+1}.pdf`, await curDoc.save());
         updateProgress(5 + (90 * (i/list.length)));
         if (i % 8 === 0) await new Promise(r => setTimeout(r, 0)); // å‘¼å¸é˜²å¡æ­»
       }

       // âœ… iOS ä¸‹è¼‰å…¼å®¹æ€§è™•ç†
       const bytes = await (mode === 'merge' ? mainDoc.save() : zip.generateAsync({type:'blob'}));
       if (isMobile && mode === 'merge') {
         window.open(URL.createObjectURL(new Blob([bytes], {type:'application/pdf'})));
       } else {
         download(bytes, `DTZ_${Date.now()}.pdf`, 'application/pdf');
       }
     } catch (e) { alert("ç”Ÿæˆå¤±æ•—ï¼Œå»ºè­°æ¸›å°‘é æ•¸å¾Œé‡è©¦ã€‚"); }
     updateProgress(0);
   }
</script>
</body>
</html>
