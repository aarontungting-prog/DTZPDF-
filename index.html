<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>éœ“è™¹è¥¿æ´‹æ£‹ï¼šæ¨¡çµ„åŒ–é€£ç·šç‰ˆ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/objects/Sky.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/BufferGeometryUtils.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .hud { position: absolute; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,1); pointer-events: auto; }
        #status-panel { top: 30px; right: 30px; text-align: right; background: linear-gradient(to left, rgba(0, 255, 255, 0.2), rgba(0,0,0,0)); padding: 20px; border-right: 3px solid #00e5ff; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; color: #00e5ff; margin-bottom: 5px; text-transform: uppercase; }
        #turn-txt { font-size: 2.2rem; font-weight: 900; color: #fff; }
        #menu-panel { top: 30px; left: 30px; background: rgba(0,0,0,0.6); padding: 20px; border-radius: 8px; border: 1px solid #333; }
        button { background: #00e5ff; color: #000; border: none; padding: 8px 15px; margin-top: 5px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #fff; box-shadow: 0 0 10px #00e5ff; }
        button.join { background: #ff0055; color: #fff; }
        .room-info { color: #aaa; font-size: 12px; margin-bottom: 10px; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ffaa00; font-size: 20px; font-weight: bold; text-shadow: 0 0 20px #ffaa00; z-index: 999; transition: opacity 0.5s; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js",
            "firebase/database": "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js"
        }
    }
    </script>
</head>
<body>

<div id="loading">æ­£åœ¨é€£ç·šè‡³ Firebase (Modular Mode)...</div>

<div id="ui" style="display:none;">
    <div id="menu-panel" class="hud">
        <div style="color:#fff; font-weight:bold; margin-bottom:5px;">ONLINE PVP</div>
        <div id="room-display" class="room-info">ç‹€æ…‹ï¼šå–®æ©Ÿæ¨¡å¼</div>
        <button id="btn-create">å‰µå»ºæˆ¿é–“ (åŸ·ç™½)</button><br>
        <button id="btn-join" class="join">åŠ å…¥æˆ¿é–“ (åŸ·é»‘)</button>
    </div>
    <div id="status-panel" class="hud">
        <h1>NEON CHESS</h1>
        <div id="turn-txt">WHITE TURN</div>
        <div id="player-role" style="font-size: 12px; color: #aaa; margin-top:5px;">You are: Observer</div>
    </div>
</div>

<script type="module">
    // --- 1. æ¨¡çµ„åŒ–å°å…¥ Firebase ---
    import { initializeApp } from "firebase/app";
    import { getDatabase, ref, set, get, update, onValue, child } from "firebase/database";

    // --- 2. ä½ çš„è¨­å®šæª” ---
    const firebaseConfig = {
        apiKey: "AIzaSyCxPppnUG864v3E2j1OzykzFmhLpsEJCSE",
        authDomain: "chess-1885a.firebaseapp.com",
        databaseURL: "https://chess-1885a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "chess-1885a",
        storageBucket: "chess-1885a.firebasestorage.app",
        messagingSenderId: "824383572856",
        appId: "1:824383572856:web:7c663d6bf0f970f6acd68d",
        measurementId: "G-0EMJ4W2KLS"
    };

    // --- 3. åˆå§‹åŒ– Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    console.log("Firebase Modular SDK Initialized!");

    // --- éŠæˆ²å…¨åŸŸè®Šæ•¸ ---
    let gameId = null;
    let playerColor = 'w';
    let isOnline = false;

    // --- 3D å¼•æ“è®Šæ•¸ ---
    let scene, camera, renderer, controls, raycaster, mouse, clock;
    let game = new Chess();
    let tilesMap = {}, piecesMap = {};
    let selectedSquare = null, isProcessing = false;
    let grassMat, cloudParticles = [];
    const BOARD_HEIGHT = 15;
    const CHESS_NAMES = { k: 'KING', q: 'QUEEN', r: 'ROOK', b: 'BISHOP', n: 'KNIGHT', p: 'PAWN' };

    // ==========================================
    // ğŸ”¥ Firebase æ–°ç‰ˆèªæ³•é‚è¼¯ ğŸ”¥
    // ==========================================

    // 1. å‰µå»ºæˆ¿é–“
    window.createGameRoom = function() {
        gameId = Math.floor(1000 + Math.random() * 9000).toString();
        
        // æ–°èªæ³•: set(ref(db, path), data)
        set(ref(db, 'games/' + gameId), {
            fen: game.fen(),
            turn: 'w',
            lastMove: null
        }).then(() => {
            playerColor = 'w';
            isOnline = true;
            
            document.getElementById('room-display').innerText = `æˆ¿é–“è™Ÿï¼š${gameId} (ç­‰å¾…åŠ å…¥...)`;
            document.getElementById('room-display').style.color = "#00ff00";
            document.getElementById('player-role').innerText = "ä½ æ˜¯ï¼šç™½æ–¹ (HOST)";
            
            listenForUpdates();
            alert(`æˆ¿é–“å·²å»ºç«‹ï¼è™Ÿç¢¼æ˜¯ï¼š${gameId}\nè«‹å«æœ‹å‹è¼¸å…¥é€™å€‹è™Ÿç¢¼åŠ å…¥ã€‚`);
        }).catch(err => {
            console.error(err);
            alert("å‰µå»ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¦å‰‡");
        });
    }

    // 2. åŠ å…¥æˆ¿é–“
    window.joinGameRoom = function() {
        const id = prompt('è¼¸å…¥æˆ¿é–“è™Ÿç¢¼:');
        if(!id) return;
        gameId = id;

        // æ–°èªæ³•: get(ref(db, path))
        get(ref(db, 'games/' + gameId)).then((snapshot) => {
            if (snapshot.exists()) {
                playerColor = 'b';
                isOnline = true;
                
                document.getElementById('room-display').innerText = `æˆ¿é–“è™Ÿï¼š${gameId} (å·²é€£ç·š)`;
                document.getElementById('player-role').innerText = "ä½ æ˜¯ï¼šé»‘æ–¹ (CLIENT)";
                document.getElementById('player-role').style.color = "#ff0055";

                // è½‰è¦–è§’
                new TWEEN.Tween(camera.position).to({x: 0, y: 60, z: -100}, 2000).easing(TWEEN.Easing.Cubic.Out).start();
                
                const data = snapshot.val();
                game.load(data.fen);
                syncPieces();
                updateStatusHUD();

                listenForUpdates();
            } else {
                alert("æ‰¾ä¸åˆ°æˆ¿é–“ï¼è«‹ç¢ºèªè™Ÿç¢¼ã€‚");
            }
        }).catch((error) => {
            console.error(error);
        });
    }

    // 3. ç›£è½åŒæ­¥
    function listenForUpdates() {
        // æ–°èªæ³•: onValue(ref(db, path), callback)
        onValue(ref(db, 'games/' + gameId), (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            if (data.fen !== game.fen()) {
                console.log("æ”¶åˆ°å°æ‰‹ç§»å‹•...");
                game.load(data.fen);
                if(data.lastMove) {
                    syncPieces(); // ç°¡å–®é‡ç¹ª
                } else {
                    syncPieces();
                }
                updateStatusHUD();
            }
        });
    }

    // 4. ç™¼é€ç§»å‹•
    function sendMove(move) {
        if (!isOnline) return;
        // æ–°èªæ³•: update(ref(db, path), data)
        update(ref(db, 'games/' + gameId), {
            fen: game.fen(),
            turn: game.turn(),
            lastMove: move
        });
    }

    // ç¶å®šæŒ‰éˆ•äº‹ä»¶ (å› ç‚º module å…§çš„å‡½æ•¸ä¸æ˜¯å…¨åŸŸçš„)
    document.getElementById('btn-create').addEventListener('click', window.createGameRoom);
    document.getElementById('btn-join').addEventListener('click', window.joinGameRoom);


    // ==========================================
    // ğŸŒ 3D å ´æ™¯é‚è¼¯ (ä¿æŒå²è©©è¦–è¦ºæ•ˆæœ)
    // ==========================================

    function getTerrainHeight(x, z) {
        const dist = Math.sqrt(x*x + z*z);
        if (dist < 400) return -12 + Math.sin(x*0.004)*Math.cos(z*0.004)*2.0;
        const blend = smoothstep(400, 700, dist);
        let h = blend * 140; 
        h += Math.sin(x * 0.015) * Math.cos(z * 0.015) * 25;
        h += Math.sin(x * 0.03 + z * 0.02) * 10;
        return h - 12;
    }
    function smoothstep(min, max, value) {
      var x = Math.max(0, Math.min(1, (value - min) / (max - min)));
      return x * x * (3 - 2 * x);
    }

    function init() {
        clock = new THREE.Clock();
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0xff9966, 0.0008);
        scene.background = new THREE.Color(0x331111);

        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 6000);
        camera.position.set(0, 60, 100); 

        renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.1; 
        document.body.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.maxPolarAngle = Math.PI / 2.05;
        controls.minDistance = 10; controls.maxDistance = 450;
        controls.target.set(0, BOARD_HEIGHT, 0);

        setupSunsetLighting();
        
        setTimeout(() => {
            createProceduralTerrain(); 
            createVegetation(); 
            createHighAltitudeClouds(); 
            createFloatingBoard();
            syncPieces();
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
        }, 100);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        window.addEventListener('click', onMouseClick);
        window.addEventListener('resize', onResize);

        animate();
    }

    function setupSunsetLighting() {
        const ambient = new THREE.AmbientLight(0xffccaa, 0.75);
        scene.add(ambient);
        const sunLight = new THREE.DirectionalLight(0xff8800, 3.2);
        sunLight.position.set(-300, 100, -300); 
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.set(2048, 2048);
        const d = 700; 
        sunLight.shadow.camera.left = -d; sunLight.shadow.camera.right = d;
        sunLight.shadow.camera.top = d; sunLight.shadow.camera.bottom = -d;
        scene.add(sunLight);
        const sky = new THREE.Sky(); sky.scale.setScalar(450000); scene.add(sky);
        const uniforms = sky.material.uniforms;
        uniforms['turbidity'].value = 10; uniforms['rayleigh'].value = 3;
        uniforms['mieCoefficient'].value = 0.005; uniforms['mieDirectionalG'].value = 0.8;
        uniforms['sunPosition'].value.copy(sunLight.position);
        const sunGeo = new THREE.SphereGeometry(80, 32, 32);
        const sunMat = new THREE.MeshBasicMaterial({ color: 0xff5500, fog: false });
        const sunSphere = new THREE.Mesh(sunGeo, sunMat);
        sunSphere.position.copy(sunLight.position).normalize().multiplyScalar(3000);
        scene.add(sunSphere);
    }

    function createProceduralTerrain() {
        const terrainGeo = new THREE.PlaneGeometry(3500, 3500, 180, 180);
        terrainGeo.rotateX(-Math.PI / 2);
        const pos = terrainGeo.attributes.position;
        const colors = [];
        const grassColor = new THREE.Color(0x226622); 
        const rockColor = new THREE.Color(0x665544);
        for(let i = 0; i < pos.count; i++) {
            const x = pos.getX(i); const z = pos.getZ(i);
            const h = getTerrainHeight(x, z);
            pos.setY(i, h);
            const colorBlend = smoothstep(-12, 8, h);
            const finalColor = grassColor.clone().lerp(rockColor, colorBlend);
            colors.push(finalColor.r, finalColor.g, finalColor.b);
        }
        terrainGeo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
        terrainGeo.computeVertexNormals();
        const terrainMat = new THREE.MeshStandardMaterial({ vertexColors: true, roughness: 0.9, metalness: 0.1, flatShading: true });
        const terrain = new THREE.Mesh(terrainGeo, terrainMat);
        terrain.receiveShadow = true;
        scene.add(terrain);
    }

    function createVegetation() {
        const treeGroup = new THREE.Group();
        const leafMat = new THREE.MeshStandardMaterial({ color: 0x1a3d1a, roughness: 0.9, flatShading: true });
        const trunkMat = new THREE.MeshStandardMaterial({ color: 0x3d2817, roughness: 1.0 });
        const leafGeo = new THREE.DodecahedronGeometry(4, 0);
        const trunkGeo = new THREE.CylinderGeometry(0.7, 1.0, 6, 7); trunkGeo.translate(0, 3, 0);
        for (let i = 0; i < 850; i++) {
            const angle = Math.random() * Math.PI * 2;
            const r = 70 + Math.random() * 380; 
            const x = Math.cos(angle) * r; const z = Math.sin(angle) * r;
            const h = getTerrainHeight(x, z);
            const tree = new THREE.Group();
            const trunk = new THREE.Mesh(trunkGeo, trunkMat); trunk.castShadow = true; tree.add(trunk);
            for(let j=0; j<5; j++){
                const leaf = new THREE.Mesh(leafGeo, leafMat);
                leaf.position.set((Math.random()-0.5)*5, 5.5+Math.random()*3.5, (Math.random()-0.5)*5);
                leaf.scale.setScalar(0.8+Math.random()*0.4); leaf.castShadow = true; tree.add(leaf);
            }
            tree.position.set(x, h, z); 
            tree.scale.setScalar(0.9 + Math.random()*0.6);
            treeGroup.add(tree);
        }
        scene.add(treeGroup);
        
        const bladeGeo = new THREE.PlaneGeometry(0.25, 1.2); bladeGeo.translate(0, 0.6, 0);
        grassMat = new THREE.MeshStandardMaterial({ color: 0x226622, side: THREE.DoubleSide });
        grassMat.onBeforeCompile = s => {
            s.uniforms.time={value:0}; s.vertexShader=`uniform float time;\n`+s.vertexShader;
            s.vertexShader=s.vertexShader.replace(`#include <begin_vertex>`, `vec3 transformed=vec3(position); float w=sin(time*1.5+position.x*0.5)*0.2*position.y; transformed.x+=w; #include <begin_vertex>`);
            grassMat.userData.shader=s;
        };
        const iGrass = new THREE.InstancedMesh(bladeGeo, grassMat, 80000);
        const dum = new THREE.Object3D();
        let grassCount = 0;
        for(let i=0; i<100000; i++){ 
            if(grassCount >= 80000) break;
            const r = Math.random() * 420;
            const a = Math.random() * Math.PI * 2;
            const x = Math.cos(a)*r; const z = Math.sin(a)*r;
            const h = getTerrainHeight(x, z);
            if(h < -8) {
                dum.position.set(x, h, z);
                dum.rotation.y = Math.random() * Math.PI;
                dum.scale.setScalar(0.7 + Math.random()*0.6);
                dum.updateMatrix();
                iGrass.setMatrixAt(grassCount++, dum.matrix);
            }
        }
        iGrass.receiveShadow = true; scene.add(iGrass);
    }

    function createHighAltitudeClouds() {
        const cv=document.createElement('canvas'); cv.width=128; cv.height=128;
        const cx=cv.getContext('2d'), g=cx.createRadialGradient(64,64,0,64,64,64);
        g.addColorStop(0, 'rgba(255, 180, 120, 0.5)'); g.addColorStop(1, 'rgba(0,0,0,0)');
        cx.fillStyle=g; cx.fillRect(0,0,128,128);
        const mat = new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(cv), transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });
        const cGrp = new THREE.Group();
        for(let i=0; i<45; i++) {
            const cl = new THREE.Group();
            for(let j=0; j<18; j++) {
                const p = new THREE.Sprite(mat); 
                p.position.set((Math.random()-0.5)*50, (Math.random()-0.5)*20, (Math.random()-0.5)*50); 
                p.scale.setScalar(40+Math.random()*40); cl.add(p);
            }
            cl.position.set((Math.random()-0.5)*3200, 250+Math.random()*150, (Math.random()-0.5)*3200); 
            cGrp.add(cl); cloudParticles.push(cl);
        }
        scene.add(cGrp);
    }

    function createFloatingBoard() {
        const ringGeo = new THREE.TorusGeometry(8, 0.3, 16, 64);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0xffaa00 });
        const ring = new THREE.Mesh(ringGeo, ringMat);
        ring.rotation.x = Math.PI / 2; ring.position.y = BOARD_HEIGHT - 3;
        scene.add(ring);
        const boardBox = new THREE.Mesh(new THREE.BoxGeometry(9, 0.5, 9), new THREE.MeshStandardMaterial({color: 0x221111, roughness: 0.5}));
        boardBox.position.y = BOARD_HEIGHT - 0.25; boardBox.receiveShadow = true; scene.add(boardBox);
        for(let r=0;r<8;r++)for(let c=0;c<8;c++){
            const n=String.fromCharCode(97+c)+(r+1), isW=(r+c)%2!==0;
            const t=new THREE.Mesh(new THREE.BoxGeometry(1,0.2,1), new THREE.MeshStandardMaterial({color:isW?0xffddbb:0x443333, roughness:0.2, metalness:0.3}));
            t.position.set(c-3.5, BOARD_HEIGHT, 3.5-r); t.userData={square:n,isTile:true}; t.receiveShadow=true; t.castShadow=true; scene.add(t); tilesMap[n]=t;
        }
    }

    function createSolidPiece(t,c){
        const g=new THREE.Group();
        const mat=c==='w'?new THREE.MeshStandardMaterial({color:0xeeeeff,roughness:0.2,metalness:0.5}):new THREE.MeshStandardMaterial({color:0x222222,roughness:0.3,metalness:0.8});
        const glow=c==='w'?new THREE.MeshStandardMaterial({color:0x00e5ff,emissive:0x00e5ff,emissiveIntensity:2}):new THREE.MeshStandardMaterial({color:0xff0055,emissive:0xff0055,emissiveIntensity:2});
        const base=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.45,0.2,32),mat); base.position.y=0.1; base.castShadow=true; g.add(base);
        if(t==='p'){const b=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.35,0.6,16),mat);b.position.y=0.5;b.castShadow=true;const h=new THREE.Mesh(new THREE.SphereGeometry(0.25,32,32),mat);h.position.y=0.95;h.castShadow=true;g.add(b,h);}else if(t==='r'){const b=new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.35,0.8,32),mat);b.position.y=0.6;b.castShadow=true;const tp=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.3,32),mat);tp.position.y=1.1;tp.castShadow=true;const rg=new THREE.Mesh(new THREE.TorusGeometry(0.2,0.05,16,32),glow);rg.position.y=1.25;rg.rotation.x=Math.PI/2;g.add(b,tp,rg);}else if(t==='b'){const b=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.35,1.0,16),mat);b.position.y=0.7;b.castShadow=true;const h=new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.25,0.5,16),mat);h.position.y=1.4;h.castShadow=true;const tp=new THREE.Mesh(new THREE.SphereGeometry(0.08),glow);tp.position.y=1.7;g.add(b,h,tp);}else if(t==='n'){const b=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.35,0.6,16),mat);b.position.y=0.5;b.castShadow=true;const h=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.6,0.2),mat);h.position.set(0,1.0,0.1);h.rotation.x=-Math.PI/6;h.castShadow=true;const m=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.5,0.05),glow);m.position.set(0,1.1,-0.15);m.rotation.x=-Math.PI/6;g.add(b,h,m);if(c==='b')g.rotation.y=Math.PI;}else if(t==='q'){const b=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.4,1.4,32),mat);b.position.y=0.9;b.castShadow=true;const t=new THREE.Mesh(new THREE.SphereGeometry(0.15),glow);t.position.y=1.7;g.add(b,t);}else if(t==='k'){const b=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.45,1.6,32),mat);b.position.y=1.0;b.castShadow=true;const c=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.4,0.1),glow);c.position.y=1.95;g.add(b,c);}
        return g;
    }

    function syncPieces(){for(let sq in piecesMap)scene.remove(piecesMap[sq]);piecesMap={};const b=game.board();for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=b[r][c];if(p){const sq=String.fromCharCode(97+c)+(8-r),s=createSolidPiece(p.type,p.color);s.position.set(c-3.5, BOARD_HEIGHT, r-3.5);scene.add(s);piecesMap[sq]=s;}}}

    // äº¤äº’é‚è¼¯
    function onMouseClick(e){if(isProcessing)return;mouse.x=(e.clientX/window.innerWidth)*2-1;mouse.y=-(e.clientY/window.innerHeight)*2+1;raycaster.setFromCamera(mouse,camera);const i=raycaster.intersectObjects(Object.values(tilesMap));if(i.length>0)handleInteraction(i[0].object.userData.square);}

    function handleInteraction(sq){
        if(isOnline && game.turn() !== playerColor) {
            console.log("ç¾åœ¨ä¸æ˜¯ä½ çš„å›åˆï¼");
            return;
        }

        const p = game.get(sq);
        if(!selectedSquare){
            if(p && p.color === game.turn()){
                if(!isOnline || (isOnline && p.color === playerColor)) {
                    selectSquare(sq);
                }
            }
        } else {
            if(p && p.color === game.turn()){
                selectSquare(sq); return;
            }
            const m = game.move({from:selectedSquare, to:sq, promotion:'q'});
            if(m) {
                animateMove(m);
                if(isOnline) sendMove(m);
            } else {
                clearHighlights(); selectedSquare=null;
            }
        }
    }

    function selectSquare(sq){clearHighlights();selectedSquare=sq;tilesMap[sq].material.emissive.setHex(0xffff00);tilesMap[sq].material.emissiveIntensity=0.8;game.moves({square:sq,verbose:true}).forEach(m=>{tilesMap[m.to].material.emissive.setHex(m.captured?0xff3300:0x00aaff);tilesMap[m.to].material.emissiveIntensity=0.5;});}
    function clearHighlights(){for(let sq in tilesMap){tilesMap[sq].material.emissive.setHex(0x000000);tilesMap[sq].material.emissiveIntensity=0;}}

    function animateMove(m){
        isProcessing=true; clearHighlights();
        const s=piecesMap[m.from], e=tilesMap[m.to].position.clone();
        if(m.captured&&piecesMap[m.to])scene.remove(piecesMap[m.to]);
        
        new TWEEN.Tween(s.position).to(e,500).easing(TWEEN.Easing.Quadratic.Out).onComplete(()=>{
            syncPieces(); updateStatusHUD();
            if(!isOnline && game.turn()==='b') setTimeout(makeRandomAI,500); 
            else isProcessing=false;
        }).start();
    }

    function makeRandomAI(){const ms=game.moves();if(ms.length===0)return;game.move(ms[Math.floor(Math.random()*ms.length)]);syncPieces();updateStatusHUD();isProcessing=false;}

    function updateStatusHUD(){
        const t=document.getElementById('turn-txt');
        const turn = game.turn();
        if(isOnline) {
            t.innerText = turn === 'w' ? "WHITE TURN" : "BLACK TURN";
            t.style.color = turn === 'w' ? "#00e5ff" : "#ff0055";
        } else {
            t.innerText = turn === 'w' ? "BLUE'S TURN" : "PURPLE AI";
            t.style.color = turn === 'w' ? "#00e5ff" : "#ff0055";
        }
    }

    function onResize(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);}

    function animate(){
        requestAnimationFrame(animate); const t=clock.getElapsedTime(); TWEEN.update(); controls.update();
        if(grassMat&&grassMat.userData.shader) grassMat.userData.shader.uniforms.time.value=t;
        cloudParticles.forEach(c => { c.rotation.y += 0.0003; });
        renderer.render(scene,camera);
    }
    
    // å‘¼å« init (æ¨¡çµ„æœ€å¾ŒåŸ·è¡Œ)
    init();
</script>
</body>
</html>
