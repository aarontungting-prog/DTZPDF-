<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>éœ“è™¹è¥¿æ´‹æ£‹ï¼šDTZ æœ€çµ‚ä»‹é¢ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/objects/Sky.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/BufferGeometryUtils.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js",
            "firebase/database": "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"
        }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; touch-action: none; color: white; }
        
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .hud { position: absolute; pointer-events: auto; }
        
        /* é€šç”¨å½ˆçª—æ¨£å¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000; display: none;
            justify-content: center; align-items: center; pointer-events: auto;
            backdrop-filter: blur(10px);
        }
        .auth-box {
            background: rgba(20, 20, 30, 0.95); border: 1px solid #00e5ff;
            padding: 30px; border-radius: 15px; width: 320px; text-align: center;
            box-shadow: 0 0 40px rgba(0, 229, 255, 0.3); max-height: 90vh; overflow-y: auto;
        }
        .auth-box h2 { color: #00e5ff; margin-top: 0; margin-bottom: 15px; letter-spacing: 2px; }
        .auth-hint { color: #888; font-size: 13px; margin-bottom: 15px; min-height: 1.5em; }
        
        .auth-input {
            width: 100%; padding: 12px; margin: 8px 0;
            background: #111; border: 1px solid #444; color: #fff;
            border-radius: 6px; box-sizing: border-box; font-size: 14px;
        }
        .auth-input:focus { border-color: #00e5ff; outline: none; }
        
        .btn-base {
            width: 100%; padding: 12px; margin-top: 10px;
            border: none; font-weight: bold; cursor: pointer; 
            border-radius: 6px; transition: 0.3s; font-size: 16px;
        }
        .auth-btn { background: #00e5ff; color: #000; }
        .auth-btn:hover { background: #fff; box-shadow: 0 0 15px #00e5ff; }
        .guest-btn { background: transparent; color: #aaa; border: 1px solid #444; }
        .guest-btn:hover { border-color: #fff; color: #fff; }
        .game-btn { background: #00e5ff; color: #000; padding: 10px; font-size: 14px; margin-top: 8px; }
        .game-btn:hover { background: #fff; }
        button.join-btn { background: #ff0055; color: #fff; }
        button.ai-btn { background: #9d00ff; color: #fff; } 
        button.settings-btn { background: #333; color: #ccc; border: 1px solid #555; width: auto; padding: 5px 10px; font-size: 12px; position: absolute; top: 10px; right: 10px;}
        button.logout-btn { background: #333; color: #aaa; border: 1px solid #444; margin-top:5px; font-size: 12px; padding: 8px;}

        /* é ­åƒæ¡†æ¨£å¼ */
        .avatar-container {
            width: 80px; height: 80px; margin: 20px auto 15px auto;
            border-radius: 50%; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        .avatar-img { width: 100%; height: 100%; border-radius: 50%; background: #333; object-fit: cover; }
        
        /* åŸºç¤æ¡† */
        .frame-basic-1 { border: 3px solid #555; }
        .frame-basic-2 { border: 3px solid #888; }
        .frame-basic-3 { border: 3px solid #fff; }
        .frame-basic-4 { border: 3px dashed #00e5ff; }
        .frame-basic-5 { border: 3px double #ff0055; }

        /* æ’ä½ç‰¹æ•ˆæ¡† */
        .frame-bronze { border: 4px solid #cd7f32; box-shadow: 0 0 10px #cd7f32; }
        .frame-silver { border: 4px solid #c0c0c0; box-shadow: 0 0 15px #c0c0c0; }
        .frame-gold { border: 4px solid #ffd700; box-shadow: 0 0 20px #ffd700, inset 0 0 10px #ffd700; }
        .frame-diamond { border: 4px solid #b9f2ff; box-shadow: 0 0 20px #b9f2ff, 0 0 40px #00e5ff; animation: pulse-blue 2s infinite; }
        .frame-master { border: 4px solid #ff0055; box-shadow: 0 0 25px #ff0055, 0 0 50px #ff0000; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 15px #b9f2ff; } 50% { box-shadow: 0 0 30px #00e5ff; } 100% { box-shadow: 0 0 15px #b9f2ff; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 20px #ff0055; transform: scale(1); } 50% { box-shadow: 0 0 40px #ff0000; transform: scale(1.05); } 100% { box-shadow: 0 0 20px #ff0055; transform: scale(1); } }

        .frames-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .frame-option { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; position: relative; }
        .frame-option.locked { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
        .frame-option.locked::after { content: 'ğŸ”’'; position: absolute; top: 12px; left: 15px; font-size: 20px; }
        .frame-option.selected { transform: scale(1.2); z-index: 10; border: 2px solid #fff; }

        /* å·¦å´é¸å–®å®¹å™¨ */
        #left-container {
            position: absolute; top: 20px; left: 20px; width: 260px;
            display: flex; flex-direction: column; gap: 15px; pointer-events: none;
        }
        
        /* ç¨ç«‹çš„ UI æ¡†æ¡† */
        .hud-box {
            background: rgba(0,0,0,0.8); border: 1px solid #333; 
            border-radius: 12px; padding: 15px; pointer-events: auto;
            backdrop-filter: blur(5px); transition: 0.3s;
        }
        .hud-box:hover { border-color: #555; }
        .hud-title { color: #aaa; font-size: 12px; font-weight: bold; margin-bottom: 8px; letter-spacing: 1px; text-transform: uppercase; }

        /* AI é¸æ“‡å¡ç‰‡ */
        .ai-list { display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto; }
        .ai-card {
            background: #222; padding: 10px; border-radius: 8px; border: 1px solid #444;
            text-align: left; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .ai-card:hover { background: #333; border-color: #00e5ff; }
        .ai-name-txt { font-weight: bold; color: #fff; }
        .ai-desc-txt { font-size: 11px; color: #aaa; display:block; margin-top:2px;}
        .ai-rank-txt { font-size: 12px; font-weight: bold; }

        /* éŠæˆ²å…§ç‹€æ…‹ */
        #status-panel { top: 20px; right: 20px; text-align: right; background: linear-gradient(to left, rgba(0, 255, 255, 0.1), rgba(0,0,0,0)); padding: 15px; border-right: 3px solid #00e5ff; }
        
        /* AI å°è©±æ°£æ³¡ (ç§»åˆ°æ­£ä¸Šæ–¹) */
        #ai-chat-bubble {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            width: 300px; background: rgba(0, 0, 0, 0.85); border: 1px solid #9d00ff;
            border-radius: 20px; padding: 15px; color: #fff; font-size: 14px; text-align: center;
            display: none; box-shadow: 0 0 20px rgba(157, 0, 255, 0.4); z-index: 2000;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { opacity: 0; transform: translateX(-50%) scale(0.8); } to { opacity: 1; transform: translateX(-50%) scale(1); } }
        .ai-thinking { color: #ff00ff; animation: pulse 1s infinite; }

        .rank-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; font-weight: bold; vertical-align: middle; }
        .rank-bronze { background: #cd7f32; color: #000; }
        .rank-silver { background: #c0c0c0; color: #000; }
        .rank-gold { background: #ffd700; color: #000; }
        .rank-diamond { background: #b9f2ff; color: #000; box-shadow: 0 0 5px #b9f2ff; }
        .rank-master { background: #ff0055; color: #fff; box-shadow: 0 0 10px #ff0055; }

        /* å•è™ŸæŒ‰éˆ• (å³ä¸‹è§’) */
        #tutorial-btn { 
            position: absolute; bottom: 30px; right: 30px; 
            width: 45px; height: 45px; border-radius: 50%; 
            background: rgba(0,0,0,0.8); border: 2px solid #ffaa00; 
            color: #ffaa00; font-weight: bold; font-size: 22px; 
            display: flex; justify-content: center; align-items: center; 
            cursor: pointer; z-index: 2500; pointer-events: auto; /* ç¢ºä¿å¯é»æ“Š */
            transition: 0.3s;
        }
        #tutorial-btn:hover { background: #ffaa00; color: #000; transform: scale(1.1); }

        #tutorial-content { 
            position: absolute; bottom: 85px; right: 30px; width: 300px; 
            background: rgba(0, 0, 0, 0.95); border: 1px solid #ffaa00; 
            border-radius: 12px; padding: 20px; display: none; 
            z-index: 2500; max-height: 70vh; overflow-y: auto; pointer-events: auto;
        }
        .key-highlight { color: #00e5ff; font-weight: bold; }
        table.rank-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        table.rank-table th, table.rank-table td { border: 1px solid #444; padding: 5px; text-align: left; color: #ccc; }
        table.rank-table th { color: #ffaa00; }

        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; color: #ffaa00; font-size: 18px; font-weight: bold; z-index: 1500; transition: opacity 0.5s; }
        #footer-watermark { position: absolute; bottom: 10px; width: 100%; text-align: center; color: rgba(255,255,255,0.3); font-size: 12px; pointer-events: none; }
        
        @media (max-width: 600px) {
            #status-panel { top: auto; bottom: 40px; right: 20px; left: 20px; text-align: center; border-right: none; border-top: 3px solid #00e5ff; background: rgba(0,0,0,0.8); }
            #left-container { top: 10px; left: 10px; width: calc(100% - 20px); }
            #tutorial-btn { bottom: 130px; right: 20px; }
            #tutorial-content { bottom: 180px; right: 20px; left: 20px; width: auto; }
            #ai-chat-bubble { width: 90%; top: 100px; }
        }
    </style>
</head>
<body>

<div id="loading">æ­£åœ¨é€£ç·šä¼ºæœå™¨...</div>

<div id="auth-modal" class="modal-overlay" style="display: flex;">
    <div class="auth-box">
        <h2>DTZ CHESS</h2>
        <div id="auth-error" style="color:#ff0055; font-size:12px; margin-bottom:10px;"></div>
        <input type="email" id="email" class="auth-input" placeholder="Email (ä¾‹å¦‚ user@gmail.com)">
        <input type="password" id="password" class="auth-input" placeholder="å¯†ç¢¼">
        <div id="nickname-container" style="display:none; animation: slideDown 0.3s;">
            <input type="text" id="nickname" class="auth-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„éŠæˆ²æš±ç¨±" style="border-color:#00ff00;">
        </div>
        <button id="auth-action-btn" class="btn-base auth-btn">ç™»å…¥ / è¨»å†Š</button>
        <div id="forgot-pw" style="margin-top:10px; font-size:12px; color:#aaa; cursor:pointer; text-decoration:underline;">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</div>
        <button id="guest-btn" class="btn-base guest-btn">è¨ªå®¢è©¦ç©</button>
    </div>
</div>

<div id="ai-modal" class="modal-overlay">
    <div class="auth-box">
        <h2>é¸æ“‡ AI å°æ‰‹</h2>
        <p style="color:#ccc; font-size:12px; margin-bottom:15px;">ä¸åŒæ’ä½çš„ AI æ“æœ‰ä¸åŒçš„å€‹æ€§å’Œå¯¦åŠ›</p>
        <div class="ai-list" id="ai-list-container">
            </div>
        <button onclick="closeAIModal()" class="btn-base guest-btn" style="margin-top:15px;">å–æ¶ˆ</button>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="auth-box" style="width: 350px;">
        <h2>å€‹äººè¨­å®š</h2>
        <div style="margin-bottom: 15px; text-align: left;">
            <label style="color:#aaa; font-size:12px;">æ›´æ”¹æš±ç¨±:</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="setting-name" class="auth-input" style="margin:0;">
                <button onclick="saveName()" class="btn-base auth-btn" style="width:60px; margin:0; padding:0;">å„²å­˜</button>
            </div>
        </div>

        <div style="margin-bottom: 15px; text-align: left;">
            <label style="color:#aaa; font-size:12px;">è‡ªè¨‚é ­åƒ (åœ–ç‰‡ç¶²å€):</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="setting-avatar-url" class="auth-input" placeholder="https://..." style="margin:0;">
                <button onclick="saveAvatarUrl()" class="btn-base auth-btn" style="width:60px; margin:0; padding:0;">è¨­å®š</button>
            </div>
            <div style="font-size:10px; color:#666; margin-top:3px;">æ”¯æ´ Imgur, Discord ç­‰åœ–ç‰‡é€£çµ</div>
        </div>
        
        <div style="text-align:left;">
            <label style="color:#aaa; font-size:12px;">é¸æ“‡é ­åƒæ¡† (æ’ä½è§£é–):</label>
            <div class="frames-grid" id="frames-grid">
                </div>
        </div>
        
        <button onclick="closeSettingsModal()" class="btn-base guest-btn" style="margin-top:20px;">é—œé–‰</button>
    </div>
</div>

<div id="ui" style="display:none;">
    <div id="left-container">
        
        <div class="hud-box" id="profile-card">
            <button id="btn-settings" class="settings-btn">âš™ï¸ è¨­å®š</button>
            <div class="avatar-container">
                <div id="user-frame" class="frame-basic-1" style="width:100%; height:100%; border-radius:50%; position:absolute; pointer-events:none;"></div>
                <img src="" class="avatar-img" id="user-avatar-img">
            </div>
            <div style="text-align:center; margin-bottom:5px;">
                <span id="user-name" style="font-weight:bold; font-size:16px; color:#fff;">Player</span>
            </div>
            <div style="text-align:center; font-size:12px; color:#aaa;">
                <span id="user-rank" class="rank-badge rank-bronze">éŠ…ç‰Œ</span> 
                ELO: <span id="user-elo" style="color:#00e5ff;">0</span>
            </div>
            <button id="btn-logout" class="btn-base logout-btn" style="width:100%;">ç™»å‡º</button>
        </div>

        <div class="hud-box">
            <div class="hud-title">é€£ç·šå°æˆ° (PVP)</div>
            <div id="room-display" style="font-size:12px; color:#0f0; margin-bottom:5px;">ç‹€æ…‹ï¼šé–’ç½®</div>
            <button id="btn-create" class="btn-base game-btn">å‰µå»ºæˆ¿é–“</button>
            <button id="btn-join" class="btn-base game-btn join-btn">åŠ å…¥æˆ¿é–“</button>
        </div>

        <div class="hud-box">
            <div class="hud-title">å–®äººæŒ‘æˆ° (PVE)</div>
            <button id="btn-ai" class="btn-base game-btn ai-btn">æŒ‘æˆ° AI å°æ‰‹</button>
        </div>

    </div>

    <div id="ai-chat-bubble" class="hud">
        <span class="ai-name" id="ai-name-label" style="display:block; font-weight:bold; margin-bottom:5px; color:#9d00ff;">GEMINI:</span>
        <span id="ai-message">...</span>
    </div>

    <div id="tutorial-btn">?</div>
    <div id="tutorial-content" class="hud">
        <h3>ğŸ† æ’ä½ç³»çµ±</h3>
        <table class="rank-table">
            <tr><th>æ’ä½</th><th>ç©åˆ† (ELO)</th><th>çå‹µ</th></tr>
            <tr><td style="color:#aaa">æ–°æ‰‹</td><td>0 - 499</td><td>åŸºç¤æ¡†</td></tr>
            <tr><td style="color:#cd7f32">éŠ…ç‰Œ</td><td>500 - 999</td><td>éŠ…è‰²æ¡†</td></tr>
            <tr><td style="color:#c0c0c0">éŠ€ç‰Œ</td><td>1000 - 1499</td><td>éŠ€è‰²æ¡†</td></tr>
            <tr><td style="color:#ffd700">é‡‘ç‰Œ</td><td>1500 - 1999</td><td>é‡‘è‰²å…‰æ•ˆæ¡†</td></tr>
            <tr><td style="color:#00e5ff">é‘½çŸ³</td><td>2000 - 2499</td><td>è—é‘½å‘¼å¸æ¡†</td></tr>
            <tr><td style="color:#ff0055">å®—å¸«</td><td>2500+</td><td>ç´…ç„°ç‰¹æ•ˆæ¡†</td></tr>
        </table>
        
        <h4 style="margin-top:15px; color:#ddd; border-bottom:1px solid #555;">æ“ä½œèˆ‡è¦å‰‡</h4>
        <ul style="font-size:12px; color:#aaa;">
            <li><span class="key-highlight">ç§»å‹•:</span> é»é¸æ£‹å­ -> é»é¸æ ¼å­</li>
            <li><span class="key-highlight">è¦–è§’:</span> é›»è…¦æ‹–æ›³ / æ‰‹æ©Ÿå–®æŒ‡æ»‘å‹•</li>
            <li><span class="key-highlight">å…µ:</span> ç›´èµ°æ–œåƒ, é¦–æ­¥å¯èµ°2</li>
            <li><span class="key-highlight">é¦¬:</span> Lå½¢, å”¯ä¸€å¯è¶Šå­</li>
            <li><span class="key-highlight">ç‹:</span> èµ°ä¸€æ ¼, è¢«åƒå³è¼¸</li>
        </ul>
    </div>

    <div id="status-panel" class="hud">
        <h1>NEON CHESS</h1>
        <div id="turn-txt">ç­‰å¾…å°æˆ°</div>
        <div id="opponent-info" style="font-size: 12px; color: #aaa; margin-top:5px;">å°æ‰‹: ---</div>
    </div>
    
    <div id="footer-watermark">Made by DTZ with Gemini Pro</div>
</div>

<script type="module">
    import { initializeApp } from "firebase/app";
    import { getDatabase, ref, set, get, update, onValue, child } from "firebase/database";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut, sendPasswordResetEmail } from "firebase/auth";

    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const CONFIG = {
        grassCount: isMobile ? 20000 : 80000,
        treeCount: isMobile ? 300 : 850,
        shadowSize: isMobile ? 1024 : 2048,
        pixelRatio: isMobile ? Math.min(window.devicePixelRatio, 2) : window.devicePixelRatio
    };

    const firebaseConfig = {
        apiKey: "AIzaSyCxPppnUG864v3E2j1OzykzFmhLpsEJCSE",
        authDomain: "chess-1885a.firebaseapp.com",
        databaseURL: "https://chess-1885a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "chess-1885a",
        storageBucket: "chess-1885a.firebasestorage.app",
        messagingSenderId: "824383572856",
        appId: "1:824383572856:web:7c663d6bf0f970f6acd68d",
        measurementId: "G-0EMJ4W2KLS"
    };
    const GEMINI_API_KEY = "AIzaSyBEueRZXZUidaSKfyl8dKoCJF4ha1Y1TcY";

    let app, db, auth;
    try {
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        auth = getAuth(app);
    } catch(e) { console.error("Firebase Config Error:", e); }

    let currentUser = null;
    let userElo = 0; 
    let gameId = null;
    let playerColor = 'w';
    let isOnline = false;
    let isVsAI = false; 
    let isRegistering = false; 
    let currentAiPersona = null;

    let scene, camera, renderer, controls, raycaster, mouse, clock;
    let game = new Chess();
    let tilesMap = {}, piecesMap = {};
    let selectedSquare = null, isProcessing = false;
    let grassMat, cloudParticles = [];
    const BOARD_HEIGHT = 15;

    // --- æ•™å­¸é¢æ¿é–‹é—œ (ä¿®å¾©ç‰ˆ) ---
    document.getElementById('tutorial-btn').addEventListener('click', (e) => {
        e.stopPropagation(); // é˜²æ­¢è§¸ç™¼ canvas é»æ“Š
        const p = document.getElementById('tutorial-content');
        p.style.display = p.style.display === 'none' ? 'block' : 'none';
    });

    // ==========================================
    // ğŸ­ AI è§’è‰²è¨­å®š
    // ==========================================
    const AI_PERSONAS = [
        { id: 'bot_novice', name: 'æ³¢æ³¢ (Bob)', rank: 'æ–°æ‰‹', elo: 400, color: '#aaa', desc: 'å‰›å­¸æœƒä¸‹æ£‹ï¼Œç¶“å¸¸é€é ­ã€‚', prompt: 'You are Bob, a novice chess player. You make silly mistakes. You speak in a short, confused, and cute way. ELO 400.' },
        { id: 'bot_bronze', name: 'æ„›éº—çµ² (Alice)', rank: 'éŠ…ç‰Œ', elo: 800, color: '#cd7f32', desc: 'åŠªåŠ›æƒ³è´ï¼Œæ€§æ ¼æº«å’Œã€‚', prompt: 'You are Alice, a beginner player. You try your best but miss tactics. You are polite and encouraging. ELO 800.' },
        { id: 'bot_silver', name: 'æ¯’è›‡ (Viper)', rank: 'éŠ€ç‰Œ', elo: 1200, color: '#c0c0c0', desc: 'å–œæ­¡å˜²è«·ï¼Œæ”»æ“Šæ€§å¼·ã€‚', prompt: 'You are Viper, a toxic chess player. You trash talk the opponent aggressively. You are arrogant but make mistakes. ELO 1200.' },
        { id: 'bot_gold', name: 'ç­–å£« (Strategos)', rank: 'é‡‘ç‰Œ', elo: 1600, color: '#ffd700', desc: 'å†·éœåˆ†æï¼Œåªèªªæˆ°è¡“ã€‚', prompt: 'You are Strategos, a serious tactical player. You speak briefly and logically. No emotion. ELO 1600.' },
        { id: 'bot_diamond', name: 'è«¾å¨ƒ (Nova)', rank: 'é‘½çŸ³', elo: 2000, color: '#00e5ff', desc: 'å¤©æ‰å°‘å¥³ï¼Œå–œæ­¡ç‚«è€€ã€‚', prompt: 'You are Nova, a flashy genius player. You are confident and playful. You like to show off. ELO 2000.' },
        { id: 'bot_master', name: 'å¥§ç±³åŠ  (Omega)', rank: 'éœ“è™¹å®—å¸«', elo: 2800, color: '#ff0055', desc: 'è¶…è¶Šäººé¡ï¼Œè¬›è©±åƒç¥è«­ã€‚', prompt: 'You are Omega, a god-like chess AI. You play perfect moves. You speak in philosophical, cryptic riddles about destiny. ELO 2800.' }
    ];

    // ==========================================
    // ğŸ–¼ï¸ é ­åƒæ¡†è¨­å®š
    // ==========================================
    const AVATAR_FRAMES = [
        { id: 'frame-basic-1', name: 'ç°¡ç´„é»‘', req: 0, class: 'frame-basic-1' },
        { id: 'frame-basic-2', name: 'ç¶“å…¸ç°', req: 0, class: 'frame-basic-2' },
        { id: 'frame-basic-3', name: 'ç´”ç™½æ¡†', req: 0, class: 'frame-basic-3' },
        { id: 'frame-basic-4', name: 'è™›ç·šè—', req: 0, class: 'frame-basic-4' },
        { id: 'frame-basic-5', name: 'é›™ç·šç´…', req: 0, class: 'frame-basic-5' },
        { id: 'frame-bronze', name: 'éŠ…ç‰Œæ¡†', req: 500, class: 'frame-bronze' },
        { id: 'frame-silver', name: 'éŠ€ç‰Œæ¡†', req: 1000, class: 'frame-silver' },
        { id: 'frame-gold', name: 'é‡‘ç‰Œå…‰æ•ˆ', req: 1500, class: 'frame-gold' },
        { id: 'frame-diamond', name: 'é‘½çŸ³å‘¼å¸', req: 2000, class: 'frame-diamond' },
        { id: 'frame-master', name: 'å®—å¸«çƒˆç„°', req: 2500, class: 'frame-master' }
    ];

    // ==========================================
    // ğŸ¤– AI é‚è¼¯
    // ==========================================
    
    document.getElementById('btn-ai').addEventListener('click', () => {
        const list = document.getElementById('ai-list-container');
        list.innerHTML = '';
        AI_PERSONAS.forEach((ai, index) => {
            const div = document.createElement('div');
            div.className = 'ai-card';
            div.innerHTML = `
                <div>
                    <span class="ai-name-txt" style="color:${ai.color}">${ai.name}</span>
                    <span class="ai-desc-txt">${ai.desc}</span>
                </div>
                <span class="ai-rank-txt" style="color:${ai.color}">${ai.rank}</span>
            `;
            div.onclick = () => startAI(index);
            list.appendChild(div);
        });
        document.getElementById('ai-modal').style.display = 'flex';
    });
    
    window.closeAIModal = function() { document.getElementById('ai-modal').style.display = 'none'; }

    window.startAI = function(index) {
        closeAIModal();
        const ai = AI_PERSONAS[index];
        currentAiPersona = ai;
        
        gameId = "vs-gemini"; isOnline = false; isVsAI = true; playerColor = 'w';
        game.reset(); syncPieces();
        
        new TWEEN.Tween(camera.position).to({x: 0, y: 60, z: 100}, 2000).easing(TWEEN.Easing.Cubic.Out).start();
        controls.target.set(0, BOARD_HEIGHT, 0);
        
        document.getElementById('room-display').innerText = "æ¨¡å¼ï¼šPVE";
        document.getElementById('room-display').style.color = "#9d00ff";
        document.getElementById('opponent-info').innerText = `å°æ‰‹: ${ai.name}`;
        updateStatusHUD();
        
        document.getElementById('ai-name-label').innerText = ai.name.split(' ')[0] + ":";
        document.getElementById('ai-name-label').style.color = ai.color;
        showAiMessage("... (é€£ç·šä¸­)");
    };

    function showAiMessage(msg) {
        const bubble = document.getElementById('ai-chat-bubble');
        document.getElementById('ai-message').innerText = msg;
        bubble.style.display = 'block';
        setTimeout(() => { bubble.style.display = 'none'; }, 6000);
    }
    
    async function makeGeminiMove() {
        if (game.game_over()) return;
        
        isProcessing = true;
        const turnTxt = document.getElementById('turn-txt');
        turnTxt.innerText = "æ€è€ƒä¸­...";
        turnTxt.classList.add('ai-thinking');

        const fen = game.fen();
        const moves = game.moves({ verbose: true });
        const moveStrings = moves.map(m => m.san).join(', ');
        
        const prompt = `
            ${currentAiPersona.prompt}
            You are playing as Black. Current FEN: "${fen}".
            Valid moves: [${moveStrings}].
            Task: Pick a move.
            Output format: MOVE|MESSAGE
            Example: "e5|Nice try."
            Move must be exact SAN string. Message max 15 words.
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            if(data.error) throw new Error(data.error.message);
            
            let rawText = data.candidates[0].content.parts[0].text.trim();
            let parts = rawText.split('|');
            let aiMoveSan = parts[0].trim().replace(/[\n\r."]/g, '');
            let aiMsg = parts.length > 1 ? parts[1].trim() : "";

            console.log("Gemini:", aiMoveSan, aiMsg);
            if(aiMsg) showAiMessage(aiMsg);

            const move = game.move(aiMoveSan); 
            if (move) {
                animateMove(move);
            } else {
                console.warn("Fallback move");
                makeRandomAI();
            }
        } catch (error) {
            console.error("Gemini Error:", error);
            showAiMessage("(AI é›¢ç·šï¼Œéš¨æ©Ÿä»£ç®¡)");
            makeRandomAI(); 
        } finally {
            turnTxt.classList.remove('ai-thinking');
        }
    }

    // ==========================================
    // âš™ï¸ ä½¿ç”¨è€…è¨­å®šèˆ‡é ­åƒ
    // ==========================================
    
    document.getElementById('btn-settings').addEventListener('click', openSettings);
    
    function openSettings() {
        const modal = document.getElementById('settings-modal');
        const grid = document.getElementById('frames-grid');
        grid.innerHTML = '';
        
        const currentName = document.getElementById('user-name').innerText;
        document.getElementById('setting-name').value = currentName;
        
        // è¼‰å…¥ç•¶å‰é ­åƒ URL ä¾›ä¿®æ”¹
        const img = document.getElementById('user-avatar-img');
        if(!img.src.includes('dicebear')) {
            document.getElementById('setting-avatar-url').value = img.src;
        }

        let currentFrameClass = 'frame-basic-1';
        const frameDiv = document.getElementById('user-frame');
        if(frameDiv.className) currentFrameClass = frameDiv.className;

        AVATAR_FRAMES.forEach(f => {
            const div = document.createElement('div');
            div.className = `frame-option ${f.class}`;
            div.style.background = '#222';
            
            if (userElo < f.req) {
                div.classList.add('locked');
                div.title = `éœ€è¦ ELO ${f.req} è§£é–`;
            } else {
                div.onclick = () => selectFrame(f.class);
                if (f.class === currentFrameClass) div.classList.add('selected');
            }
            grid.appendChild(div);
        });
        
        modal.style.display = 'flex';
    }

    window.closeSettingsModal = function() { document.getElementById('settings-modal').style.display = 'none'; }

    window.saveName = function() {
        const newName = document.getElementById('setting-name').value.trim();
        if(!newName) return alert("åç¨±ä¸èƒ½ç‚ºç©º");
        update(ref(db, 'users/' + currentUser.uid), { name: newName });
        alert("åç¨±å·²æ›´æ–°ï¼");
    }

    window.saveAvatarUrl = function() {
        const url = document.getElementById('setting-avatar-url').value.trim();
        update(ref(db, 'users/' + currentUser.uid), { avatarUrl: url });
        alert("é ­åƒå·²æ›´æ–°ï¼");
    }

    function selectFrame(frameClass) {
        update(ref(db, 'users/' + currentUser.uid), { selectedFrame: frameClass });
        document.querySelectorAll('.frame-option').forEach(el => el.classList.remove('selected'));
        closeSettingsModal();
    }

    // ==========================================
    // ğŸ” èªè­‰ç³»çµ±
    // ==========================================
    
    const authModal = document.getElementById('auth-modal');
    const authActionBtn = document.getElementById('auth-action-btn');
    const nicknameInput = document.getElementById('nickname');
    const nicknameContainer = document.getElementById('nickname-container');
    const errorMsg = document.getElementById('auth-error');
    const loadingScreen = document.getElementById('loading');

    onAuthStateChanged(auth, (user) => {
        loadingScreen.style.display = 'none';
        if (user) {
            currentUser = user;
            authModal.style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            checkAndCreateUserProfile(user);
        } else {
            currentUser = null;
            authModal.style.display = 'flex';
            document.getElementById('ui').style.display = 'none';
            resetAuthForm();
        }
    });

    function resetAuthForm() {
        isRegistering = false;
        nicknameContainer.style.display = 'none';
        authActionBtn.innerText = "ç™»å…¥ / è¨»å†Š";
        errorMsg.innerText = "";
    }

    function checkAndCreateUserProfile(user) {
        const userRef = ref(db, 'users/' + user.uid);
        get(userRef).then((snapshot) => {
            if (!snapshot.exists()) {
                const inputName = nicknameInput.value.trim();
                const name = inputName || (user.isAnonymous ? `è¨ªå®¢_${user.uid.substring(0,4)}` : user.email.split('@')[0]);
                set(userRef, { name: name, email: user.email || "guest", elo: 0, wins: 0, losses: 0, selectedFrame: 'frame-basic-1' }).then(loadUserProfile);
            } else { loadUserProfile(); }
        });
    }

    function loadUserProfile() {
        if (!currentUser) return;
        onValue(ref(db, 'users/' + currentUser.uid), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                userElo = data.elo;
                document.getElementById('user-name').innerText = data.name;
                document.getElementById('user-elo').innerText = data.elo;
                
                // å„ªå…ˆä½¿ç”¨è‡ªè¨‚é ­åƒï¼Œå¦å‰‡ç”¨ DiceBear
                const avatarUrl = data.avatarUrl || `https://api.dicebear.com/7.x/bottts/svg?seed=${data.name}`;
                document.getElementById('user-avatar-img').src = avatarUrl;
                
                const frameDiv = document.getElementById('user-frame');
                frameDiv.className = data.selectedFrame || 'frame-basic-1';
                
                updateRankBadge(data.elo);
            }
        });
    }

    function updateRankBadge(elo) {
        const badge = document.getElementById('user-rank');
        badge.className = 'rank-badge';
        if (elo < 500) { badge.innerText = "æ–°æ‰‹ NOVICE"; badge.classList.add('rank-bronze'); }
        else if (elo < 1000) { badge.innerText = "éŠ…ç‰Œ BRONZE"; badge.classList.add('rank-bronze'); }
        else if (elo < 1500) { badge.innerText = "éŠ€ç‰Œ SILVER"; badge.classList.add('rank-silver'); }
        else if (elo < 2000) { badge.innerText = "é‡‘ç‰Œ GOLD"; badge.classList.add('rank-gold'); }
        else if (elo < 2500) { badge.innerText = "é‘½çŸ³ DIAMOND"; badge.classList.add('rank-diamond'); }
        else { badge.innerText = "éœ“è™¹å®—å¸«"; badge.classList.add('rank-master'); }
    }

    authActionBtn.addEventListener('click', async () => {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        
        if(!email || !password) { errorMsg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
        if(!email.includes('@')) { errorMsg.innerText = "Email æ ¼å¼éŒ¯èª¤"; return; }

        if (isRegistering) {
            const nickname = nicknameInput.value.trim();
            if(!nickname) { errorMsg.innerText = "è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±"; return; }
            try { await createUserWithEmailAndPassword(auth, email, password); } catch (e) { handleAuthError(e); }
            return;
        }

        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                isRegistering = true;
                nicknameContainer.style.display = 'block';
                authActionBtn.innerText = "ç¢ºèªè¨»å†Š";
                errorMsg.innerText = "åˆæ¬¡è¦‹é¢ï¼è«‹è¼¸å…¥æš±ç¨±ä¾†å®Œæˆè¨»å†Šã€‚";
                errorMsg.style.color = "#00ff00";
            } else { handleAuthError(error); }
        }
    });

    function handleAuthError(error) {
        errorMsg.style.color = "#ff0055";
        let msg = error.message;
        if(msg.includes("email-already-in-use")) msg = "ä¿¡ç®±å·²è¢«ä½¿ç”¨";
        if(msg.includes("wrong-password")) msg = "å¯†ç¢¼éŒ¯èª¤";
        errorMsg.innerText = msg;
    }

    document.getElementById('guest-btn').addEventListener('click', async () => {
        try { await signInAnonymously(auth); } catch (e) { errorMsg.innerText = "è¨ªå®¢ç™»å…¥å¤±æ•—"; }
    });
    
    document.getElementById('forgot-pw').addEventListener('click', async () => {
        const email = document.getElementById('email').value.trim();
        if(!email) return alert("è«‹å…ˆè¼¸å…¥ Email");
        try { await sendPasswordResetEmail(auth, email); alert("é‡è¨­ä¿¡å·²ç™¼é€"); } catch(e) { alert("ç™¼é€å¤±æ•—"); }
    });

    document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

    // ==========================================
    // âš”ï¸ PVP é‚è¼¯
    // ==========================================

    document.getElementById('btn-create').addEventListener('click', window.createGameRoom);
    document.getElementById('btn-join').addEventListener('click', window.joinGameRoom);

    window.createGameRoom = function() {
        isVsAI = false;
        gameId = Math.floor(1000 + Math.random() * 9000).toString();
        get(ref(db, 'users/' + currentUser.uid)).then(snap => {
            const userData = snap.val();
            set(ref(db, 'games/' + gameId), {
                fen: game.fen(), turn: 'w', white: { uid: currentUser.uid, elo: userData.elo, name: userData.name }, black: null, status: 'waiting'
            }).then(() => {
                playerColor = 'w'; isOnline = true;
                document.getElementById('room-display').innerText = `æˆ¿é–“è™Ÿï¼š${gameId} (ç­‰å¾…)`;
                document.getElementById('room-display').style.color = "#00ff00";
                document.getElementById('opponent-info').innerText = "ç­‰å¾…å°æ‰‹...";
                new TWEEN.Tween(camera.position).to({x: 0, y: 60, z: 100}, 2000).easing(TWEEN.Easing.Cubic.Out).start();
                controls.target.set(0, BOARD_HEIGHT, 0);
                
                onValue(ref(db, 'games/' + gameId), (snapshot) => {
                    const data = snapshot.val(); if (!data) return;
                    if (data.status === 'playing' && !data.winner && document.getElementById('turn-txt').innerText.includes("ç­‰å¾…")) {
                        if (data.black) {
                            document.getElementById('opponent-info').innerText = `VS: ${data.black.name} (${data.black.elo})`;
                            document.getElementById('room-display').innerText = `æˆ¿é–“è™Ÿï¼š${gameId} (å°æˆ°ä¸­)`;
                            alert(`å°æ‰‹ ${data.black.name} å·²åŠ å…¥ï¼`);
                            updateStatusHUD();
                        }
                    }
                    if (data.fen !== game.fen()) { game.load(data.fen); syncPieces(); updateStatusHUD(); }
                    if (data.winner) handleGameOver(data.winner);
                });
                alert(`æˆ¿é–“å·²å»ºç«‹ï¼è™Ÿç¢¼ï¼š${gameId}`);
            });
        });
    }

    window.joinGameRoom = function() {
        isVsAI = false;
        const id = prompt('è«‹è¼¸å…¥æˆ¿é–“è™Ÿç¢¼:'); if(!id) return;
        gameId = id;
        get(ref(db, 'games/' + gameId)).then((snapshot) => {
            if (snapshot.exists()) {
                const gameData = snapshot.val();
                if(gameData.status !== 'waiting') { alert("æˆ¿é–“å·²æ»¿æˆ–å·²çµæŸ"); return; }
                get(ref(db, 'users/' + currentUser.uid)).then(snap => {
                    const userData = snap.val();
                    update(ref(db, 'games/' + gameId), { black: { uid: currentUser.uid, elo: userData.elo, name: userData.name }, status: 'playing' });
                    playerColor = 'b'; isOnline = true;
                    document.getElementById('room-display').innerText = `æˆ¿é–“è™Ÿï¼š${gameId} (å°æˆ°ä¸­)`;
                    document.getElementById('opponent-info').innerText = `VS: ${gameData.white.name} (${gameData.white.elo})`;
                    new TWEEN.Tween(camera.position).to({x: 0, y: 60, z: -100}, 2000).easing(TWEEN.Easing.Cubic.Out).start();
                    controls.target.set(0, BOARD_HEIGHT, 0);
                    game.load(gameData.fen); syncPieces(); updateStatusHUD();
                    onValue(ref(db, 'games/' + gameId), (snapshot) => {
                        const data = snapshot.val();
                        if(data.fen !== game.fen()) { game.load(data.fen); syncPieces(); updateStatusHUD(); }
                        if (data.winner) handleGameOver(data.winner);
                    });
                });
            } else { alert("æˆ¿é–“ä¸å­˜åœ¨"); }
        });
    }

    function sendMove(move) {
        if (!isOnline) return;
        const nextFen = game.fen();
        let updateData = { fen: nextFen, turn: game.turn(), lastMove: move };
        if (game.in_checkmate()) {
            const winnerColor = game.turn() === 'w' ? 'b' : 'w'; 
            updateData.winner = winnerColor; updateData.status = 'finished';
            calculateELO(winnerColor);
        }
        update(ref(db, 'games/' + gameId), updateData);
    }

    function calculateELO(winnerColor) {
        get(ref(db, 'games/' + gameId)).then(snap => {
            const data = snap.val(); if(data.calculated) return; 
            if(playerColor === 'w') {
                const K = 32; let wElo = data.white.elo; let bElo = data.black.elo;
                const expectW = 1 / (1 + Math.pow(10, (bElo - wElo) / 400));
                const expectB = 1 / (1 + Math.pow(10, (wElo - bElo) / 400));
                let wScore = winnerColor === 'w' ? 1 : 0; let bScore = winnerColor === 'b' ? 1 : 0;
                const newWElo = Math.round(wElo + K * (wScore - expectW));
                const newBElo = Math.round(bElo + K * (bScore - expectB));
                update(ref(db, 'users/' + data.white.uid), { elo: newWElo });
                update(ref(db, 'users/' + data.black.uid), { elo: newBElo });
                update(ref(db, 'games/' + gameId), { calculated: true });
            }
        });
    }

    function handleGameOver(winnerColor) {
        isProcessing = true; 
        let msg = "";
        if (isVsAI) { msg = winnerColor === 'w' ? `æ­å–œï¼ä½ æ“Šæ•—äº† ${currentAiPersona.name}ï¼` : `${currentAiPersona.name} ç²å‹ï¼`; }
        else { if (winnerColor === playerColor) msg = "å‹åˆ©ï¼ç©åˆ†æå‡ï¼"; else msg = "æˆ°æ•—... ç©åˆ†ä¸‹é™"; }
        alert(msg);
        document.getElementById('turn-txt').innerText = winnerColor === 'w' ? "ç™½æ–¹å‹åˆ©" : "é»‘æ–¹å‹åˆ©";
        document.getElementById('turn-txt').style.color = "#ffff00";
    }

    // --- 3D é‚è¼¯ (ä¿ç•™åŸæ¨£) ---
    function getTerrainHeight(x,z){const d=Math.sqrt(x*x+z*z);if(d<400)return-12+Math.sin(x*0.004)*Math.cos(z*0.004)*2.0;const b=smoothstep(400,700,d);let h=b*140;h+=Math.sin(x*0.015)*Math.cos(z*0.015)*25;h+=Math.sin(x*0.03+z*0.02)*10;return h-12;}
    function smoothstep(min,max,v){var x=Math.max(0,Math.min(1,(v-min)/(max-min)));return x*x*(3-2*x);}
    function init(){clock=new THREE.Clock();scene=new THREE.Scene();scene.fog=new THREE.FogExp2(0xff9966,0.0008);scene.background=new THREE.Color(0x331111);camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,0.1,6000);camera.position.set(0,60,100);renderer=new THREE.WebGLRenderer({antialias:true,powerPreference:"high-performance"});renderer.setPixelRatio(CONFIG.pixelRatio);renderer.setSize(window.innerWidth,window.innerHeight);renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.1;document.body.appendChild(renderer.domElement);controls=new THREE.OrbitControls(camera,renderer.domElement);controls.enableDamping=true;controls.maxPolarAngle=Math.PI/2.05;controls.minDistance=10;controls.maxDistance=450;controls.target.set(0,BOARD_HEIGHT,0);setupSunsetLighting();setTimeout(()=>{createProceduralTerrain();createVegetation();createHighAltitudeClouds();createFloatingBoard();syncPieces();},100);raycaster=new THREE.Raycaster();mouse=new THREE.Vector2();window.addEventListener('touchstart',onTouchStart,{passive:false});window.addEventListener('click',onMouseClick);window.addEventListener('resize',onResize);animate();}
    function setupSunsetLighting(){const a=new THREE.AmbientLight(0xffccaa,0.75);scene.add(a);const s=new THREE.DirectionalLight(0xff8800,3.2);s.position.set(-300,100,-300);s.castShadow=true;s.shadow.mapSize.set(CONFIG.shadowSize,CONFIG.shadowSize);const d=700;s.shadow.camera.left=-d;s.shadow.camera.right=d;s.shadow.camera.top=d;s.shadow.camera.bottom=-d;scene.add(s);const sk=new THREE.Sky();sk.scale.setScalar(450000);scene.add(sk);const u=sk.material.uniforms;u['turbidity'].value=10;u['rayleigh'].value=3;u['mieCoefficient'].value=0.005;u['mieDirectionalG'].value=0.8;u['sunPosition'].value.copy(s.position);const g=new THREE.SphereGeometry(80,32,32);const m=new THREE.MeshBasicMaterial({color:0xff5500,fog:false});const sp=new THREE.Mesh(g,m);sp.position.copy(s.position).normalize().multiplyScalar(3000);scene.add(sp);}
    function createProceduralTerrain(){const g=new THREE.PlaneGeometry(3500,3500,isMobile?100:180,isMobile?100:180);g.rotateX(-Math.PI/2);const p=g.attributes.position;const c=[];const c1=new THREE.Color(0x226622);const c2=new THREE.Color(0x665544);for(let i=0;i<p.count;i++){const h=getTerrainHeight(p.getX(i),p.getZ(i));p.setY(i,h);const b=smoothstep(-12,8,h);const f=c1.clone().lerp(c2,b);c.push(f.r,f.g,f.b);}g.setAttribute('color',new THREE.Float32BufferAttribute(c,3));g.computeVertexNormals();const m=new THREE.MeshStandardMaterial({vertexColors:true,roughness:0.9,metalness:0.1,flatShading:true});const mesh=new THREE.Mesh(g,m);mesh.receiveShadow=true;scene.add(mesh);}
    function createVegetation(){const grp=new THREE.Group();const lMat=new THREE.MeshStandardMaterial({color:0x1a3d1a,roughness:0.9,flatShading:true});const tMat=new THREE.MeshStandardMaterial({color:0x3d2817,roughness:1.0});const lGeo=new THREE.DodecahedronGeometry(4,0);const tGeo=new THREE.CylinderGeometry(0.7,1.0,6,6);tGeo.translate(0,3,0);for(let i=0;i<CONFIG.treeCount;i++){const a=Math.random()*Math.PI*2;const r=70+Math.random()*380;const x=Math.cos(a)*r;const z=Math.sin(a)*r;const h=getTerrainHeight(x,z);const tr=new THREE.Group();const t=new THREE.Mesh(tGeo,tMat);t.castShadow=true;tr.add(t);for(let j=0;j<3;j++){const l=new THREE.Mesh(lGeo,lMat);l.position.set((Math.random()-0.5)*5,5.5+Math.random()*3.5,(Math.random()-0.5)*5);l.scale.setScalar(0.8+Math.random()*0.4);l.castShadow=true;tr.add(l);}tr.position.set(x,h,z);tr.scale.setScalar(0.9+Math.random()*0.6);grp.add(tr);}scene.add(grp);const bGeo=new THREE.PlaneGeometry(0.3,1.5);bGeo.translate(0,0.75,0);grassMat=new THREE.MeshStandardMaterial({color:0x226622,side:THREE.DoubleSide});grassMat.onBeforeCompile=s=>{s.uniforms.time={value:0};s.vertexShader=`uniform float time;\n`+s.vertexShader;s.vertexShader=s.vertexShader.replace(`#include <begin_vertex>`,`vec3 transformed=vec3(position);float w=sin(time*1.5+position.x*0.5)*0.2*position.y;transformed.x+=w;#include <begin_vertex>`);grassMat.userData.shader=s;};const iG=new THREE.InstancedMesh(bGeo,grassMat,CONFIG.grassCount);const d=new THREE.Object3D();let c=0;for(let i=0;i<100000;i++){if(c>=CONFIG.grassCount)break;const r=Math.random()*420;const a=Math.random()*Math.PI*2;const x=Math.cos(a)*r;const z=Math.sin(a)*r;const h=getTerrainHeight(x,z);if(h<-8){d.position.set(x,h,z);d.rotation.y=Math.random()*Math.PI;d.scale.setScalar(0.7+Math.random()*0.6);d.updateMatrix();iG.setMatrixAt(c++,d.matrix);}}iG.receiveShadow=true;scene.add(iG);}
    function createHighAltitudeClouds(){const cv=document.createElement('canvas');cv.width=128;cv.height=128;const cx=cv.getContext('2d'),g=cx.createRadialGradient(64,64,0,64,64,64);g.addColorStop(0,'rgba(255,180,120,0.5)');g.addColorStop(1,'rgba(0,0,0,0)');cx.fillStyle=g;cx.fillRect(0,0,128,128);const mat=new THREE.SpriteMaterial({map:new THREE.CanvasTexture(cv),transparent:true,blending:THREE.AdditiveBlending,depthWrite:false});const gp=new THREE.Group();const cc=isMobile?25:45;for(let i=0;i<cc;i++){const cl=new THREE.Group();for(let j=0;j<15;j++){const p=new THREE.Sprite(mat);p.position.set((Math.random()-0.5)*50,(Math.random()-0.5)*20,(Math.random()-0.5)*50);p.scale.setScalar(40+Math.random()*40);cl.add(p);}cl.position.set((Math.random()-0.5)*3200,250+Math.random()*150,(Math.random()-0.5)*3200);gp.add(cl);cloudParticles.push(cl);}scene.add(gp);}
    function createFloatingBoard(){const g=new THREE.TorusGeometry(8,0.3,16,32);const m=new THREE.MeshBasicMaterial({color:0xffaa00});const r=new THREE.Mesh(g,m);r.rotation.x=Math.PI/2;r.position.y=BOARD_HEIGHT-3;scene.add(r);const b=new THREE.Mesh(new THREE.BoxGeometry(9,0.5,9),new THREE.MeshStandardMaterial({color:0x221111,roughness:0.5}));b.position.y=BOARD_HEIGHT-0.25;b.receiveShadow=true;scene.add(b);for(let r=0;r<8;r++)for(let c=0;c<8;c++){const n=String.fromCharCode(97+c)+(r+1),w=(r+c)%2!==0;const t=new THREE.Mesh(new THREE.BoxGeometry(1,0.2,1),new THREE.MeshStandardMaterial({color:w?0xffddbb:0x443333,roughness:0.2,metalness:0.3}));t.position.set(c-3.5,BOARD_HEIGHT,3.5-r);t.userData={square:n,isTile:true};t.receiveShadow=true;t.castShadow=true;scene.add(t);tilesMap[n]=t;}}
    function createSolidPiece(t,c){const g=new THREE.Group(),mat=c==='w'?new THREE.MeshStandardMaterial({color:0xeeeeff,roughness:0.2,metalness:0.5}):new THREE.MeshStandardMaterial({color:0x222222,roughness:0.3,metalness:0.8}),glow=c==='w'?new THREE.MeshStandardMaterial({color:0x00e5ff,emissive:0x00e5ff,emissiveIntensity:2}):new THREE.MeshStandardMaterial({color:0xff0055,emissive:0xff0055,emissiveIntensity:2});const b=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.45,0.2,32),mat);b.position.y=0.1;b.castShadow=true;g.add(b);if(t==='p'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.35,0.6,16),mat);by.position.y=0.5;by.castShadow=true;const h=new THREE.Mesh(new THREE.SphereGeometry(0.25,32,32),mat);h.position.y=0.95;h.castShadow=true;g.add(by,h);}else if(t==='r'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.35,0.35,0.8,32),mat);by.position.y=0.6;by.castShadow=true;const tp=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.3,32),mat);tp.position.y=1.1;tp.castShadow=true;const rg=new THREE.Mesh(new THREE.TorusGeometry(0.2,0.05,16,32),glow);rg.position.y=1.25;rg.rotation.x=Math.PI/2;g.add(by,tp,rg);}else if(t==='b'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.35,1.0,16),mat);by.position.y=0.7;by.castShadow=true;const h=new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.25,0.5,16),mat);h.position.y=1.4;h.castShadow=true;const tp=new THREE.Mesh(new THREE.SphereGeometry(0.08),glow);tp.position.y=1.7;g.add(by,h,tp);}else if(t==='n'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.35,0.6,16),mat);by.position.y=0.5;by.castShadow=true;const h=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.6,0.2),mat);h.position.set(0,1.0,0.1);h.rotation.x=-Math.PI/6;h.castShadow=true;const m=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.5,0.05),glow);m.position.set(0,1.1,-0.15);m.rotation.x=-Math.PI/6;g.add(by,h,m);if(c==='b')g.rotation.y=Math.PI;}else if(t==='q'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.4,1.4,32),mat);by.position.y=0.9;by.castShadow=true;const t=new THREE.Mesh(new THREE.SphereGeometry(0.15),glow);t.position.y=1.7;g.add(by,t);}else if(t==='k'){const by=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.45,1.6,32),mat);by.position.y=1.0;by.castShadow=true;const c=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.4,0.1),glow);c.position.y=1.95;g.add(by,c);}return g;}
    function syncPieces(){for(let sq in piecesMap)scene.remove(piecesMap[sq]);piecesMap={};const b=game.board();for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=b[r][c];if(p){const sq=String.fromCharCode(97+c)+(8-r),s=createSolidPiece(p.type,p.color);s.position.set(c-3.5, BOARD_HEIGHT, r-3.5);scene.add(s);piecesMap[sq]=s;}}}
    
    function onTouchStart(e){
        if(e.target.closest('.modal-overlay') || e.target.closest('.hud') || e.target.closest('.auth-box') || e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
        if(e.touches.length > 1) return;
        e.preventDefault();
        mouse.x = (e.touches[0].clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.touches[0].clientY / window.innerHeight) * 2 + 1;
        chk();
    }
    
    function onMouseClick(e){if(isProcessing)return;mouse.x=(e.clientX/window.innerWidth)*2-1;mouse.y=-(e.clientY/window.innerHeight)*2+1;chk();}
    function chk(){raycaster.setFromCamera(mouse,camera);const i=raycaster.intersectObjects(Object.values(tilesMap));if(i.length>0)hdl(i[0].object.userData.square);}
    function hdl(sq){
        if(isVsAI && game.turn() === 'b') return;
        if(isOnline&&game.turn()!==playerColor)return;
        const p=game.get(sq);
        if(!selectedSquare){
            if(p&&p.color===game.turn()) if(!isOnline || (isOnline&&p.color===playerColor)) sel(sq);
        } else {
            if(p&&p.color===game.turn()){sel(sq);return;}
            const m=game.move({from:selectedSquare,to:sq,promotion:'q'});
            if(m){
                am(m);
                if(isOnline) sendMove(m);
                if(isVsAI) setTimeout(makeGeminiMove, 500); 
            } else {clr();selectedSquare=null;}
        }
    }
    function sel(sq){clr();selectedSquare=sq;tilesMap[sq].material.emissive.setHex(0xffff00);tilesMap[sq].material.emissiveIntensity=0.8;game.moves({square:sq,verbose:true}).forEach(m=>{tilesMap[m.to].material.emissive.setHex(m.captured?0xff3300:0x00aaff);tilesMap[m.to].material.emissiveIntensity=0.5;});}
    function clr(){for(let s in tilesMap){tilesMap[s].material.emissive.setHex(0x000000);tilesMap[s].material.emissiveIntensity=0;}}
    function am(m){isProcessing=true;clr();const s=piecesMap[m.from],e=tilesMap[m.to].position.clone();if(m.captured&&piecesMap[m.to])scene.remove(piecesMap[m.to]);new TWEEN.Tween(s.position).to(e,500).easing(TWEEN.Easing.Quadratic.Out).onComplete(()=>{syncPieces();updateStatusHUD();if(!isOnline&&!isVsAI&&game.turn()==='b')setTimeout(makeRandomAI,500);else if(!isVsAI)isProcessing=false;}).start();}
    function makeRandomAI(){const ms=game.moves();if(ms.length===0)return;game.move(ms[Math.floor(Math.random()*ms.length)]);syncPieces();updateStatusHUD();isProcessing=false;}
    function updateStatusHUD(){
        const t=document.getElementById('turn-txt'), turn=game.turn();
        if(isVsAI){t.innerText=turn==='w'?"ä½ çš„å›åˆ":"Gemini å›åˆ";t.style.color=turn==='w'?"#00e5ff":"#ff00ff";}
        else if(isOnline){t.innerText=turn==='w'?"ç™½æ–¹å›åˆ":"é»‘æ–¹å›åˆ";t.style.color=turn==='w'?"#00e5ff":"#ff0055";}
        else{t.innerText=turn==='w'?"è—æ–¹å›åˆ":"é›»è…¦å›åˆ";t.style.color=turn==='w'?"#00e5ff":"#ff0055";}
    }
    function onResize(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);}
    function animate(){requestAnimationFrame(animate);const t=clock.getElapsedTime();TWEEN.update();controls.update();if(grassMat&&grassMat.userData.shader)grassMat.userData.shader.uniforms.time.value=t;cloudParticles.forEach(c=>{c.rotation.y+=0.0003;});renderer.render(scene,camera);}
    
    init();
</script>
</body>
</html>
