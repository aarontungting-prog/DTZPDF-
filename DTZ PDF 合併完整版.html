<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>DTZ PDF - å°ˆæ¥­ç´šæœ¬åœ°æ–‡ä»¶åˆä½µå·¥å…·</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary-red: #e74c3c;
            --primary-green: #2ecc71;
            --primary-yellow: #f1c40f;
            --primary-blue: #3498db;
            --bg-color: #f7f9fc;
            --text-dark: #2d3436;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, system-ui, -apple-system, sans-serif;
            margin: 0; background-color: var(--bg-color); color: var(--text-dark); line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }

        nav {
            background: white; padding: 1rem 10%; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000;
        }

        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary-red); text-decoration: none; }

        .container { max-width: 1000px; margin: 50px auto; padding: 0 20px; text-align: center; }

        h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .subtitle { color: #555; margin-bottom: 35px; font-size: 1.1rem; line-height: 1.8; }
        .highlight-text { color: var(--primary-red); font-weight: bold; }

        .upload-area {
            background: white; border: 3px dashed #cbd5e0; border-radius: 20px;
            padding: 60px 40px; transition: all 0.3s ease; cursor: pointer; box-shadow: var(--card-shadow);
        }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary-red); background-color: #fffaf9; }
        .upload-icon { font-size: 60px; color: var(--primary-red); margin-bottom: 20px; }

        .btn-upload {
            background: var(--primary-red); color: white; padding: 12px 35px; border-radius: 50px;
            border: none; font-size: 1.1rem; font-weight: bold; margin-top: 20px; cursor: pointer;
        }

        #sortable-list { margin: 25px auto; list-style: none; padding: 0; max-width: 700px; text-align: left; }
        .file-item {
            background: white; margin-bottom: 10px; padding: 15px 20px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; cursor: grab;
        }

        #action-section { display: none; margin-top: 30px; }
        .btn-merge {
            background: var(--primary-green); color: white; padding: 18px 50px; border-radius: 50px;
            border: none; font-size: 1.25rem; font-weight: bold; cursor: pointer; width: 100%; max-width: 450px;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
            transition: background-color 0.3s;
        }

        .features { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 80px; text-align: left; }
        .feature-card { background: white; padding: 30px; border-radius: 15px; box-shadow: var(--card-shadow); transition: transform 0.3s; }
        .feature-card:hover { transform: translateY(-10px); }
        .card-red { border-top: 5px solid var(--primary-red); }
        .card-green { border-top: 5px solid var(--primary-green); }
        .card-yellow { border-top: 5px solid var(--primary-yellow); }

        .qa-section { margin-top: 80px; text-align: left; background: white; padding: 40px; border-radius: 20px; box-shadow: var(--card-shadow); }
        .qa-section h2 { font-size: 1.8rem; margin-bottom: 25px; color: var(--primary-red); }
        .qa-item { margin-bottom: 25px; border-bottom: 1px solid #f1f1f1; padding-bottom: 15px; }

        .remove-btn { border: none; background: #eee; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; color: #888; }
        @media (max-width: 800px) { .features { grid-template-columns: 1fr; } }
        footer { margin-top: 60px; padding: 30px; color: #999; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>

    <nav>
        <a href="#" class="logo">DTZ PDF</a>
        <div style="font-size: 0.85rem; color: #95a5a6;">ç€è¦½å™¨æœ¬åœ°è™•ç† (Local Engine) | éš±ç§æ¨¡å¼</div>
    </nav>

    <div class="container">
        <h1>åˆä½µ PDF</h1>
        <p class="subtitle">
            <span class="highlight-text">ç„¡é™åˆ¶ã€ç„¡å»£å‘Š</span> â€“ å…è²»ã€ç¾è§€ã€ä¸”å®‰å…¨çš„ PDF èˆ‡åœ–ç‰‡åˆä½µå·¥å…·ã€‚<br>
            é©ç”¨æ–¼ Macã€Windowsã€Android èˆ‡ iOSã€‚
        </p>

        <div class="upload-area" id="drop-zone">
            <div class="upload-icon">ğŸ“„â•</div>
            <p style="font-size: 1.2rem; font-weight: 500;">å°‡ PDF æˆ–åœ–ç‰‡æ‹–æ”¾åˆ°æ­¤è™•</p>
            <button class="btn-upload">é¸æ“‡æœ¬åœ°æª”æ¡ˆ</button>
            <input type="file" id="file-input" multiple hidden accept="application/pdf,image/jpeg,image/png">
        </div>

        <ul id="sortable-list"></ul>

        <div id="action-section">
            <button id="merge-btn" class="btn-merge">é–‹å§‹åˆä½µä¸¦ä¸‹è¼‰</button>
        </div>

        <div class="features">
            <div class="feature-card card-red">
                <h3>ğŸ”’ å®‰å…¨å¯é </h3>
                <p>100% éš±ç§ä¿è­·ã€‚æ‰€æœ‰è™•ç†å‡åœ¨æœ¬åœ°å®Œæˆï¼Œæª”æ¡ˆçµ•ä¸å¤–æµã€‚</p>
            </div>
            <div class="feature-card card-green">
                <h3>ğŸ–¼ï¸ å¤šæ ¼å¼æ”¯æ´</h3>
                <p>æ”¯æ´ JPG/PNG åœ–ç‰‡èˆ‡ PDF æ··åˆåˆä½µï¼Œè‡ªå‹•é©æ‡‰é é¢ï¼Œæ¸…æ™°ä¸å¤±çœŸã€‚</p>
            </div>
            <div class="feature-card card-yellow">
                <h3>âœ¨ è‡ªç”±æ’åº</h3>
                <p>æ‹–æ›³å¡ç‰‡é‡æ–°æ’åºï¼ŒæŒæ§æ–‡ä»¶é‚è¼¯ï¼Œä¸¦å³æ™‚æŸ¥çœ‹æª”æ¡ˆè³‡è¨Šã€‚</p>
            </div>
        </div>

        <div class="qa-section">
            <h2>ä½¿ç”¨è€…å¸¸è¦‹å•é¡Œ (Q&A)</h2>
            <div class="qa-item">
                <h4>é»æ“Šä¸‹è¼‰å¾Œæ²’åæ‡‰æ€éº¼è¾¦ï¼Ÿ</h4>
                <p>1. <b>é›»è…¦ç‰ˆï¼š</b>è«‹å…è¨±ç€è¦½å™¨çš„å½ˆå‡ºè¦–çª—ã€‚<br>
                   2. <b>iPhone (Safari)ï¼š</b>åˆä½µå¾Œè‹¥ä¸‹è¼‰æœªå½ˆå‡ºï¼ŒæŒ‰éˆ•æœƒè®Šæ›´ç‚ºè—è‰²ï¼Œå†æ¬¡é»æ“Šå³å¯ç›´æ¥é è¦½ã€‚</p>
            </div>
            <div class="qa-item">
                <h4>é—œæ–¼æœ¬åœ°è™•ç†èˆ‡åœ–ç‰‡ç¸®æ”¾</h4>
                <p>ç‚ºäº†ç©©å®šæ€§ï¼Œæˆ‘å€‘æœƒæ™ºæ…§ç¸®æ”¾ç‰¹å¤§åœ–ç‰‡ï¼Œé€™èƒ½é˜²æ­¢è¡Œå‹•è£ç½®å› è¨˜æ†¶é«”ä¸è¶³è€Œå´©æ½°ã€‚</p>
            </div>
        </div>
    </div>

    <footer>&copy; 2026 DTZ PDF - æ‚¨æœ€ä¿¡ä»»çš„æœ¬åœ°æ–‡ä»¶è™•ç†å·¥å…·</footer>

    <script>
        const { PDFDocument } = PDFLib;
        const ua = navigator.userAgent;
        const isIPhone = /iPhone|iPad|iPod/i.test(ua);
        const isMobile = isIPhone || /Android/i.test(ua);
        
        let fileDataArray = [];

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const sortableList = document.getElementById('sortable-list');
        const mergeBtn = document.getElementById('merge-btn');

        new Sortable(sortableList, {
            animation: 150,
            onEnd: () => {
                const newOrder = Array.from(sortableList.children).map(li => li.dataset.id);
                fileDataArray = newOrder.map(id => fileDataArray.find(f => f.id === id));
                resetButton();
            }
        });

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFiles(e.target.files);
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        async function handleFiles(files) {
            resetButton();
            for (const file of Array.from(files)) {
                const id = crypto.randomUUID();
                const info = (file.type === 'application/pdf' && !isMobile) ? " (PDF)" : (file.type === 'application/pdf' ? " (PDF)" : " (åœ–ç‰‡)");
                fileDataArray.push({ id, file, info });
            }
            render();
        }

        function resetButton() {
            mergeBtn.innerText = 'é–‹å§‹åˆä½µä¸¦ä¸‹è¼‰';
            mergeBtn.style.backgroundColor = 'var(--primary-green)';
            mergeBtn.disabled = false;
            mergeBtn.onclick = startMerge;
        }

        function render() {
            document.getElementById('action-section').style.display = fileDataArray.length > 0 ? 'block' : 'none';
            sortableList.innerHTML = fileDataArray.map(item => `
                <li class="file-item" data-id="${item.id}">
                    <span>â˜° &nbsp; <b>${item.file.name}</b><small style="color:#888">${item.info}</small></span>
                    <button class="remove-btn" onclick="event.stopPropagation(); removeFile('${item.id}')">âœ•</button>
                </li>
            `).join('');
        }

        function removeFile(id) {
            fileDataArray = fileDataArray.filter(f => f.id !== id);
            render();
            if (fileDataArray.length === 0) resetButton();
        }

        async function startMerge() {
            if (isIPhone && fileDataArray.length > 6) return alert("iPhone å»ºè­°æ¯æ¬¡åˆä½µ 6 ä»½ä»¥å…§æª”æ¡ˆã€‚");
            
            mergeBtn.innerText = 'âš™ï¸ è™•ç†ä¸­...';
            mergeBtn.disabled = true;

            try {
                const mergedPdf = await PDFDocument.create();
                for (const item of fileDataArray) {
                    await new Promise(r => setTimeout(r, 0)); // iOS å‘¼å¸è£œä¸
                    const arrayBuffer = await item.file.arrayBuffer();

                    if (item.file.type === 'application/pdf') {
                        const pdf = await PDFDocument.load(arrayBuffer);
                        const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        pages.forEach(p => mergedPdf.addPage(p));
                    } else {
                        const image = item.file.type === 'image/jpeg' ? 
                            await mergedPdf.embedJpg(arrayBuffer) : await mergedPdf.embedPng(arrayBuffer);
                        const maxWidth = isMobile ? 1200 : 2500;
                        let scale = 1;
                        if (image.width > maxWidth) scale = maxWidth / image.width;
                        const page = mergedPdf.addPage([image.width * scale, image.height * scale]);
                        page.drawImage(image, { x: 0, y: 0, width: image.width * scale, height: image.height * scale });
                    }
                }

                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const now = new Date();
                const dateTag = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
                const fileName = `DTZ_PDF_Merged_${dateTag}.pdf`;

                if (isIPhone) {
                    mergeBtn.innerText = 'âœ… åˆä½µå®Œæˆï¼é»æ­¤é–‹å•Ÿ';
                    mergeBtn.style.backgroundColor = 'var(--primary-blue)';
                    mergeBtn.disabled = false;
                    mergeBtn.onclick = () => window.location.href = url;
                    window.open(url, '_blank');
                } else {
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    mergeBtn.innerText = 'âœ… ä¸‹è¼‰æˆåŠŸ';
                    setTimeout(() => resetButton(), 3000);
                }
            } catch (err) {
                alert('è™•ç†å¤±æ•—ï¼Œæª”æ¡ˆå¯èƒ½å¤ªå¤§ã€‚');
                resetButton();
            }
        }
    </script>
</body>
</html>

